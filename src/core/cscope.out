cscope 15 $HOME/Desktop/nginx-1.2.2/src/core               0000405512
	@nginx.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

10 
	~<ngöx.h
>

13 
ngx_öt_t
 
ngx_add_öhîôed_sockës
(
ngx_cy˛e_t
 *
cy˛e
);

14 
ngx_öt_t
 
ngx_gë_›ti⁄s
(
¨gc
, *c⁄° *
¨gv
);

15 
ngx_öt_t
 
ngx_¥o˚ss_›ti⁄s
(
ngx_cy˛e_t
 *
cy˛e
);

16 
ngx_öt_t
 
ngx_ßve_¨gv
(
ngx_cy˛e_t
 *
cy˛e
, 
¨gc
, *c⁄° *
¨gv
);

17 *
ngx_c‹e_moduÀ_¸óã_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
);

18 *
ngx_c‹e_moduÀ_öô_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
, *
c⁄f
);

19 *
ngx_£t_u£r
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

20 *
ngx_£t_ív
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

21 *
ngx_£t_¥i‹ôy
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

22 *
ngx_£t_˝u_afföôy
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

23 *
c⁄f
);

26 
ngx_c⁄f_íum_t
 
	gngx_debug_poöts
[] = {

27 { 
ngx_°rög
("°›"), 
NGX_DEBUG_POINTS_STOP
 },

28 { 
ngx_°rög
("ab‹t"), 
NGX_DEBUG_POINTS_ABORT
 },

29 { 
ngx_nuŒ_°rög
, 0 }

33 
ngx_comm™d_t
 
	gngx_c‹e_comm™ds
[] = {

35 { 
ngx_°rög
("daemon"),

36 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_FLAG
,

37 
ngx_c⁄f_£t_Êag_¶Ÿ
,

39 
off£tof
(
ngx_c‹e_c⁄f_t
, 
d´m⁄
),

40 
NULL
 },

42 { 
ngx_°rög
("master_process"),

43 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_FLAG
,

44 
ngx_c⁄f_£t_Êag_¶Ÿ
,

46 
off£tof
(
ngx_c‹e_c⁄f_t
, 
ma°î
),

47 
NULL
 },

49 { 
ngx_°rög
("timer_resolution"),

50 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

51 
ngx_c⁄f_£t_m£c_¶Ÿ
,

53 
off£tof
(
ngx_c‹e_c⁄f_t
, 
timî_ªsﬁuti⁄
),

54 
NULL
 },

56 { 
ngx_°rög
("pid"),

57 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_c⁄f_£t_°r_¶Ÿ
,

60 
off£tof
(
ngx_c‹e_c⁄f_t
, 
pid
),

61 
NULL
 },

63 { 
ngx_°rög
("lock_file"),

64 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

65 
ngx_c⁄f_£t_°r_¶Ÿ
,

67 
off£tof
(
ngx_c‹e_c⁄f_t
, 
lock_fûe
),

68 
NULL
 },

70 { 
ngx_°rög
("worker_processes"),

71 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

72 
ngx_c⁄f_£t_num_¶Ÿ
,

74 
off£tof
(
ngx_c‹e_c⁄f_t
, 
w‹kî_¥o˚s£s
),

75 
NULL
 },

77 { 
ngx_°rög
("debug_points"),

78 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

79 
ngx_c⁄f_£t_íum_¶Ÿ
,

81 
off£tof
(
ngx_c‹e_c⁄f_t
, 
debug_poöts
),

82 &
ngx_debug_poöts
 },

84 { 
ngx_°rög
("user"),

85 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE12
,

86 
ngx_£t_u£r
,

89 
NULL
 },

91 { 
ngx_°rög
("worker_priority"),

92 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

93 
ngx_£t_¥i‹ôy
,

96 
NULL
 },

98 { 
ngx_°rög
("worker_cpu_affinity"),

99 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_1MORE
,

100 
ngx_£t_˝u_afföôy
,

103 
NULL
 },

105 { 
ngx_°rög
("worker_rlimit_nofile"),

106 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

107 
ngx_c⁄f_£t_num_¶Ÿ
,

109 
off£tof
(
ngx_c‹e_c⁄f_t
, 
æimô_nofûe
),

110 
NULL
 },

112 { 
ngx_°rög
("worker_rlimit_core"),

113 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

114 
ngx_c⁄f_£t_off_¶Ÿ
,

116 
off£tof
(
ngx_c‹e_c⁄f_t
, 
æimô_c‹e
),

117 
NULL
 },

119 { 
ngx_°rög
("worker_rlimit_sigpending"),

120 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

121 
ngx_c⁄f_£t_num_¶Ÿ
,

123 
off£tof
(
ngx_c‹e_c⁄f_t
, 
æimô_sig≥ndög
),

124 
NULL
 },

126 { 
ngx_°rög
("working_directory"),

127 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

128 
ngx_c⁄f_£t_°r_¶Ÿ
,

130 
off£tof
(
ngx_c‹e_c⁄f_t
, 
w‹kög_dúe˘‹y
),

131 
NULL
 },

133 { 
ngx_°rög
("env"),

134 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

135 
ngx_£t_ív
,

138 
NULL
 },

140 #i‡(
NGX_THREADS
)

142 { 
ngx_°rög
("worker_threads"),

143 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

144 
ngx_c⁄f_£t_num_¶Ÿ
,

146 
off£tof
(
ngx_c‹e_c⁄f_t
, 
w‹kî_thªads
),

147 
NULL
 },

149 { 
ngx_°rög
("thread_stack_size"),

150 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

151 
ngx_c⁄f_£t_size_¶Ÿ
,

153 
off£tof
(
ngx_c‹e_c⁄f_t
, 
thªad_°ack_size
),

154 
NULL
 },

158 
ngx_nuŒ_comm™d


162 
ngx_c‹e_moduÀ_t
 
	gngx_c‹e_moduÀ_˘x
 = {

163 
ngx_°rög
("core"),

164 
ngx_c‹e_moduÀ_¸óã_c⁄f
,

165 
ngx_c‹e_moduÀ_öô_c⁄f


169 
ngx_moduÀ_t
 
	gngx_c‹e_moduÀ
 = {

170 
NGX_MODULE_V1
,

171 &
ngx_c‹e_moduÀ_˘x
,

172 
ngx_c‹e_comm™ds
,

173 
NGX_CORE_MODULE
,

174 
NULL
,

175 
NULL
,

176 
NULL
,

177 
NULL
,

178 
NULL
,

179 
NULL
,

180 
NULL
,

181 
NGX_MODULE_V1_PADDING


185 
ngx_uöt_t
 
	gngx_max_moduÀ
;

187 
ngx_uöt_t
 
	gngx_show_hñp
;

188 
ngx_uöt_t
 
	gngx_show_vîsi⁄
;

189 
ngx_uöt_t
 
	gngx_show_c⁄figuª
;

190 
u_ch¨
 *
	gngx_¥efix
;

191 
u_ch¨
 *
	gngx_c⁄f_fûe
;

192 
u_ch¨
 *
	gngx_c⁄f_∑øms
;

193 *
	gngx_sig«l
;

196 **
	gngx_os_ívú⁄
;

199 
ngx_cde˛


200 
	$maö
(
¨gc
, *c⁄° *
¨gv
)

202 
ngx_öt_t
 
i
;

203 
ngx_log_t
 *
log
;

204 
ngx_cy˛e_t
 *
cy˛e
, 
öô_cy˛e
;

205 
ngx_c‹e_c⁄f_t
 *
ccf
;

207 
	`ngx_debug_öô
();

209 i‡(
	`ngx_°ªº‹_öô
(Ë!
NGX_OK
) {

213 i‡(
	`ngx_gë_›ti⁄s
(
¨gc
, 
¨gv
Ë!
NGX_OK
) {

217 i‡(
ngx_show_vîsi⁄
) {

218 
	`ngx_wrôe_°dîr
("ngöx vîsi⁄: " 
NGINX_VER
 
NGX_LINEFEED
);

220 i‡(
ngx_show_hñp
) {

221 
	`ngx_wrôe_°dîr
(

223 "[-∞¥efix] [-g dúe˘ives]" 
NGX_LINEFEED


224 
NGX_LINEFEED


225 "O±i⁄s:" 
NGX_LINEFEED


226 " -?,-h :Åhi†hñp" 
NGX_LINEFEED


227 " -v : show vîsi⁄ándÉxô" 
NGX_LINEFEED


229 
NGX_LINEFEED


230 " -à :Åe° c⁄figuøti⁄ándÉxô" 
NGX_LINEFEED


232 "durög c⁄figuøti⁄Åe°ög" 
NGX_LINEFEED


234 "°›, quô,Ñe›í,Ññﬂd" 
NGX_LINEFEED


235 #ifde‡
NGX_PREFIX


237 
NGX_PREFIX
 ")" 
NGX_LINEFEED


239 " -∞¥efix : sëÖªfixÖ©h (deÁu…: NONE)" 
NGX_LINEFEED


242 
NGX_CONF_PATH
 ")" 
NGX_LINEFEED


244 "fûe" 
NGX_LINEFEED
 NGX_LINEFEED

248 i‡(
ngx_show_c⁄figuª
) {

249 
	`ngx_wrôe_°dîr
(

250 #ifde‡
NGX_COMPILER


251 "buûàby " 
NGX_COMPILER
 
NGX_LINEFEED


253 #i‡(
NGX_SSL
)

254 #ifde‡
SSL_CTRL_SET_TLSEXT_HOSTNAME


255 "TLS SNI suµ‹àíabÀd" 
NGX_LINEFEED


257 "TLS SNI suµ‹àdißbÀd" 
NGX_LINEFEED


260 "c⁄figuªárgumíts:" 
NGX_CONFIGURE
 
NGX_LINEFEED
);

263 i‡(!
ngx_ã°_c⁄fig
) {

268  
ngx_max_sockës
 = -1;

270 
	`ngx_time_öô
();

272 #i‡(
NGX_PCRE
)

273 
	`ngx_ªgex_öô
();

276 
ngx_pid
 = 
	`ngx_gëpid
();

278 
log
 = 
	`ngx_log_öô
(
ngx_¥efix
);

279 i‡(
log
 =
NULL
) {

284 #i‡(
NGX_OPENSSL
)

285 
	`ngx_s¶_öô
(
log
);

293 
	`ngx_memzîo
(&
öô_cy˛e
, (
ngx_cy˛e_t
));

294 
öô_cy˛e
.
log
 =Üog;

295 
ngx_cy˛e
 = &
öô_cy˛e
;

297 
öô_cy˛e
.
poﬁ
 = 
	`ngx_¸óã_poﬁ
(1024, 
log
);

298 i‡(
öô_cy˛e
.
poﬁ
 =
NULL
) {

302 i‡(
	`ngx_ßve_¨gv
(&
öô_cy˛e
, 
¨gc
, 
¨gv
Ë!
NGX_OK
) {

306 i‡(
	`ngx_¥o˚ss_›ti⁄s
(&
öô_cy˛e
Ë!
NGX_OK
) {

310 i‡(
	`ngx_os_öô
(
log
Ë!
NGX_OK
) {

318 i‡(
	`ngx_¸c32_èbÀ_öô
(Ë!
NGX_OK
) {

322 i‡(
	`ngx_add_öhîôed_sockës
(&
öô_cy˛e
Ë!
NGX_OK
) {

326 
ngx_max_moduÀ
 = 0;

327 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

328 
ngx_moduÀs
[
i
]->
ödex
 = 
ngx_max_moduÀ
++;

331 
cy˛e
 = 
	`ngx_öô_cy˛e
(&
öô_cy˛e
);

332 i‡(
cy˛e
 =
NULL
) {

333 i‡(
ngx_ã°_c⁄fig
) {

334 
	`ngx_log_°dîr
(0, "configuration file %sÅest failed",

335 
öô_cy˛e
.
c⁄f_fûe
.
d©a
);

341 i‡(
ngx_ã°_c⁄fig
) {

342 i‡(!
ngx_quõt_mode
) {

343 
	`ngx_log_°dîr
(0, "configuration file %sÅest is successful",

344 
cy˛e
->
c⁄f_fûe
.
d©a
);

350 i‡(
ngx_sig«l
) {

351  
	`ngx_sig«l_¥o˚ss
(
cy˛e
, 
ngx_sig«l
);

354 
	`ngx_os_°©us
(
cy˛e
->
log
);

356 
ngx_cy˛e
 = 
cy˛e
;

358 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_c‹e_moduÀ
);

360 i‡(
ccf
->
ma°î
 && 
ngx_¥o˚ss
 =
NGX_PROCESS_SINGLE
) {

361 
ngx_¥o˚ss
 = 
NGX_PROCESS_MASTER
;

364 #i‡!(
NGX_WIN32
)

366 i‡(
	`ngx_öô_sig«ls
(
cy˛e
->
log
Ë!
NGX_OK
) {

370 i‡(!
ngx_öhîôed
 && 
ccf
->
d´m⁄
) {

371 i‡(
	`ngx_d´m⁄
(
cy˛e
->
log
Ë!
NGX_OK
) {

375 
ngx_d´m⁄ized
 = 1;

378 i‡(
ngx_öhîôed
) {

379 
ngx_d´m⁄ized
 = 1;

384 i‡(
	`ngx_¸óã_pidfûe
(&
ccf
->
pid
, 
cy˛e
->
log
Ë!
NGX_OK
) {

388 i‡(
cy˛e
->
log
->
fûe
->
fd
 !
ngx_°dîr
) {

390 i‡(
	`ngx_£t_°dîr
(
cy˛e
->
log
->
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

391 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

392 
ngx_£t_°dîr_n
 " failed");

397 i‡(
log
->
fûe
->
fd
 !
ngx_°dîr
) {

398 i‡(
	`ngx_˛o£_fûe
(
log
->
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

399 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

400 
ngx_˛o£_fûe_n
 " built-inÜog failed");

404 
ngx_u£_°dîr
 = 0;

406 i‡(
ngx_¥o˚ss
 =
NGX_PROCESS_SINGLE
) {

407 
	`ngx_sögÀ_¥o˚ss_cy˛e
(
cy˛e
);

410 
	`ngx_ma°î_¥o˚ss_cy˛e
(
cy˛e
);

414 
	}
}

417 
ngx_öt_t


418 
	$ngx_add_öhîôed_sockës
(
ngx_cy˛e_t
 *
cy˛e
)

420 
u_ch¨
 *
p
, *
v
, *
öhîôed
;

421 
ngx_öt_t
 
s
;

422 
ngx_li°íög_t
 *
ls
;

424 
öhîôed
 = (
u_ch¨
 *Ë
	`gëív
(
NGINX_VAR
);

426 i‡(
öhîôed
 =
NULL
) {

427  
NGX_OK
;

430 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
cy˛e
->
log
, 0,

431 "usög inhîôed sockë†‰om \"%s\"", 
öhîôed
);

433 i‡(
	`ngx_¨øy_öô
(&
cy˛e
->
li°íög
, cy˛e->
poﬁ
, 10,

434 (
ngx_li°íög_t
))

435 !
NGX_OK
)

437  
NGX_ERROR
;

440 
p
 = 
öhîôed
, 
v
 =Ö; *p;Ö++) {

441 i‡(*
p
 == ':' || *p == ';') {

442 
s
 = 
	`ngx_©oi
(
v
, 
p
 - v);

443 i‡(
s
 =
NGX_ERROR
) {

444 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 0,

445 "övÆid sockëÇumbî \"%s\" i¿" 
NGINX_VAR


447 " o‡thêv¨übÀ", 
v
);

451 
v
 = 
p
 + 1;

453 
ls
 = 
	`ngx_¨øy_push
(&
cy˛e
->
li°íög
);

454 i‡(
ls
 =
NULL
) {

455  
NGX_ERROR
;

458 
	`ngx_memzîo
(
ls
, (
ngx_li°íög_t
));

460 
ls
->
fd
 = (
ngx_sockë_t
Ë
s
;

464 
ngx_öhîôed
 = 1;

466  
	`ngx_£t_öhîôed_sockës
(
cy˛e
);

467 
	}
}

471 
	$ngx_£t_ívú⁄mít
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_uöt_t
 *
œ°
)

473 **
p
, **
ív
;

474 
ngx_°r_t
 *
v¨
;

475 
ngx_uöt_t
 
i
, 
n
;

476 
ngx_c‹e_c⁄f_t
 *
ccf
;

478 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_c‹e_moduÀ
);

480 i‡(
œ°
 =
NULL
 && 
ccf
->
ívú⁄mít
) {

481  
ccf
->
ívú⁄mít
;

484 
v¨
 = 
ccf
->
ív
.
ñts
;

486 
i
 = 0; i < 
ccf
->
ív
.
√…s
; i++) {

487 i‡(
	`ngx_°rcmp
(
v¨
[
i
].
d©a
, "TZ") == 0

488 || 
	`ngx_°∫cmp
(
v¨
[
i
].
d©a
, "TZ=", 3) == 0)

490 
tz_found
;

494 
v¨
 = 
	`ngx_¨øy_push
(&
ccf
->
ív
);

495 i‡(
v¨
 =
NULL
) {

496  
NULL
;

499 
v¨
->
Àn
 = 2;

500 
v¨
->
d©a
 = (
u_ch¨
 *) "TZ";

502 
v¨
 = 
ccf
->
ív
.
ñts
;

504 
tz_found
:

506 
n
 = 0;

508 
i
 = 0; i < 
ccf
->
ív
.
√…s
; i++) {

510 i‡(
v¨
[
i
].
d©a
[v¨[i].
Àn
] == '=') {

511 
n
++;

515 
p
 = 
ngx_os_ívú⁄
; *p;Ö++) {

517 i‡(
	`ngx_°∫cmp
(*
p
, 
v¨
[
i
].
d©a
, v¨[i].
Àn
) == 0

518 && (*
p
)[
v¨
[
i
].
Àn
] == '=')

520 
n
++;

526 i‡(
œ°
) {

527 
ív
 = 
	`ngx_Æloc
((*
œ°
 + 
n
 + 1Ë* (*), 
cy˛e
->
log
);

528 *
œ°
 = 
n
;

531 
ív
 = 
	`ngx_∑Œoc
(
cy˛e
->
poﬁ
, (
n
 + 1) * (*));

534 i‡(
ív
 =
NULL
) {

535  
NULL
;

538 
n
 = 0;

540 
i
 = 0; i < 
ccf
->
ív
.
√…s
; i++) {

542 i‡(
v¨
[
i
].
d©a
[v¨[i].
Àn
] == '=') {

543 
ív
[
n
++] = (*Ë
v¨
[
i
].
d©a
;

547 
p
 = 
ngx_os_ívú⁄
; *p;Ö++) {

549 i‡(
	`ngx_°∫cmp
(*
p
, 
v¨
[
i
].
d©a
, v¨[i].
Àn
) == 0

550 && (*
p
)[
v¨
[
i
].
Àn
] == '=')

552 
ív
[
n
++] = *
p
;

558 
ív
[
n
] = 
NULL
;

560 i‡(
œ°
 =
NULL
) {

561 
ccf
->
ívú⁄mít
 = 
ív
;

562 
ívú⁄
 = 
ív
;

565  
ív
;

566 
	}
}

569 
ngx_pid_t


570 
	$ngx_exec_√w_bö¨y
(
ngx_cy˛e_t
 *
cy˛e
, *c⁄° *
¨gv
)

572 **
ív
, *
v¨
;

573 
u_ch¨
 *
p
;

574 
ngx_uöt_t
 
i
, 
n
;

575 
ngx_pid_t
 
pid
;

576 
ngx_exec_˘x_t
 
˘x
;

577 
ngx_c‹e_c⁄f_t
 *
ccf
;

578 
ngx_li°íög_t
 *
ls
;

580 
	`ngx_memzîo
(&
˘x
, (
ngx_exec_˘x_t
));

582 
˘x
.
∑th
 = 
¨gv
[0];

583 
˘x
.
«me
 = "new binaryÖrocess";

584 
˘x
.
¨gv
 =árgv;

586 
n
 = 2;

587 
ív
 = 
	`ngx_£t_ívú⁄mít
(
cy˛e
, &
n
);

588 i‡(
ív
 =
NULL
) {

589  
NGX_INVALID_PID
;

592 
v¨
 = 
	`ngx_Æloc
((
NGINX_VAR
)

593 + 
cy˛e
->
li°íög
.
√…s
 * (
NGX_INT32_LEN
 + 1) + 2,

594 
cy˛e
->
log
);

596 
p
 = 
	`ngx_˝ymem
(
v¨
, 
NGINX_VAR
 "=", (NGINX_VAR));

598 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

599 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

600 
p
 = 
	`ngx_•rötf
’, "%ud;", 
ls
[
i
].
fd
);

603 *
p
 = '\0';

605 
ív
[
n
++] = 
v¨
;

607 #i‡(
NGX_SETPROCTITLE_USES_ENV
)

611 
ív
[
n
++] = "SPARE=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

619 
ív
[
n
] = 
NULL
;

621 #i‡(
NGX_DEBUG
)

623 **
e
;

624 
e
 = 
ív
; *e;É++) {

625 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cy˛e
->
log
, 0, "ív: %s", *
e
);

630 
˘x
.
ívp
 = (*c⁄° *Ë
ív
;

632 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_c‹e_moduÀ
);

634 i‡(
	`ngx_ª«me_fûe
(
ccf
->
pid
.
d©a
, ccf->
ﬁdpid
.d©aË!
NGX_OK
) {

635 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

636 
ngx_ª«me_fûe_n
 " %sÅo %s failed "

638 
ccf
->
pid
.
d©a
, ccf->
ﬁdpid
.d©a, 
¨gv
[0]);

640 
	`ngx_‰ì
(
ív
);

641 
	`ngx_‰ì
(
v¨
);

643  
NGX_INVALID_PID
;

646 
pid
 = 
	`ngx_execuã
(
cy˛e
, &
˘x
);

648 i‡(
pid
 =
NGX_INVALID_PID
) {

649 i‡(
	`ngx_ª«me_fûe
(
ccf
->
ﬁdpid
.
d©a
, ccf->
pid
.d©aË!
NGX_OK
) {

650 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

651 
ngx_ª«me_fûe_n
 " %s backÅo %s failedáfter "

653 
ccf
->
ﬁdpid
.
d©a
, ccf->
pid
.d©a, 
¨gv
[0]);

657 
	`ngx_‰ì
(
ív
);

658 
	`ngx_‰ì
(
v¨
);

660  
pid
;

661 
	}
}

664 
ngx_öt_t


665 
	$ngx_gë_›ti⁄s
(
¨gc
, *c⁄° *
¨gv
)

667 
u_ch¨
 *
p
;

668 
ngx_öt_t
 
i
;

670 
i
 = 1; i < 
¨gc
; i++) {

672 
p
 = (
u_ch¨
 *Ë
¨gv
[
i
];

674 i‡(*
p
++ != '-') {

675 
	`ngx_log_°dîr
(0, "övÆid o±i⁄: \"%s\"", 
¨gv
[
i
]);

676  
NGX_ERROR
;

679 *
p
) {

681 *
p
++) {

685 
ngx_show_vîsi⁄
 = 1;

686 
ngx_show_hñp
 = 1;

690 
ngx_show_vîsi⁄
 = 1;

694 
ngx_show_vîsi⁄
 = 1;

695 
ngx_show_c⁄figuª
 = 1;

699 
ngx_ã°_c⁄fig
 = 1;

703 
ngx_quõt_mode
 = 1;

707 i‡(*
p
) {

708 
ngx_¥efix
 = 
p
;

709 
√xt
;

712 i‡(
¨gv
[++
i
]) {

713 
ngx_¥efix
 = (
u_ch¨
 *Ë
¨gv
[
i
];

714 
√xt
;

717 
	`ngx_log_°dîr
(0, "option \"-p\"Ñequires directoryÇame");

718  
NGX_ERROR
;

721 i‡(*
p
) {

722 
ngx_c⁄f_fûe
 = 
p
;

723 
√xt
;

726 i‡(
¨gv
[++
i
]) {

727 
ngx_c⁄f_fûe
 = (
u_ch¨
 *Ë
¨gv
[
i
];

728 
√xt
;

731 
	`ngx_log_°dîr
(0, "option \"-c\"Ñequires fileÇame");

732  
NGX_ERROR
;

735 i‡(*
p
) {

736 
ngx_c⁄f_∑øms
 = 
p
;

737 
√xt
;

740 i‡(
¨gv
[++
i
]) {

741 
ngx_c⁄f_∑øms
 = (
u_ch¨
 *Ë
¨gv
[
i
];

742 
√xt
;

745 
	`ngx_log_°dîr
(0, "option \"-g\"ÑequiresÖarameter");

746  
NGX_ERROR
;

749 i‡(*
p
) {

750 
ngx_sig«l
 = (*Ë
p
;

752 } i‡(
¨gv
[++
i
]) {

753 
ngx_sig«l
 = 
¨gv
[
i
];

756 
	`ngx_log_°dîr
(0, "option \"-s\"ÑequiresÖarameter");

757  
NGX_ERROR
;

760 i‡(
	`ngx_°rcmp
(
ngx_sig«l
, "stop") == 0

761 || 
	`ngx_°rcmp
(
ngx_sig«l
, "quit") == 0

762 || 
	`ngx_°rcmp
(
ngx_sig«l
, "reopen") == 0

763 || 
	`ngx_°rcmp
(
ngx_sig«l
, "reload") == 0)

765 
ngx_¥o˚ss
 = 
NGX_PROCESS_SIGNALLER
;

766 
√xt
;

769 
	`ngx_log_°dîr
(0, "övÆid o±i⁄: \"-†%s\"", 
ngx_sig«l
);

770  
NGX_ERROR
;

773 
	`ngx_log_°dîr
(0, "övÆid o±i⁄: \"%c\"", *(
p
 - 1));

774  
NGX_ERROR
;

778 
√xt
:

783  
NGX_OK
;

784 
	}
}

787 
ngx_öt_t


788 
	$ngx_ßve_¨gv
(
ngx_cy˛e_t
 *
cy˛e
, 
¨gc
, *c⁄° *
¨gv
)

790 #i‡(
NGX_FREEBSD
)

792 
ngx_os_¨gv
 = (**Ë
¨gv
;

793 
ngx_¨gc
 = 
¨gc
;

794 
ngx_¨gv
 = (**Ë
¨gv
;

797 
size_t
 
Àn
;

798 
ngx_öt_t
 
i
;

800 
ngx_os_¨gv
 = (**Ë
¨gv
;

801 
ngx_¨gc
 = 
¨gc
;

803 
ngx_¨gv
 = 
	`ngx_Æloc
((
¨gc
 + 1Ë* (*), 
cy˛e
->
log
);

804 i‡(
ngx_¨gv
 =
NULL
) {

805  
NGX_ERROR
;

808 
i
 = 0; i < 
¨gc
; i++) {

809 
Àn
 = 
	`ngx_°æí
(
¨gv
[
i
]) + 1;

811 
ngx_¨gv
[
i
] = 
	`ngx_Æloc
(
Àn
, 
cy˛e
->
log
);

812 i‡(
ngx_¨gv
[
i
] =
NULL
) {

813  
NGX_ERROR
;

816 (Ë
	`ngx_˝y°∫
((
u_ch¨
 *Ë
ngx_¨gv
[
i
], (u_ch¨ *Ë
¨gv
[i], 
Àn
);

819 
ngx_¨gv
[
i
] = 
NULL
;

823 
ngx_os_ívú⁄
 = 
ívú⁄
;

825  
NGX_OK
;

826 
	}
}

829 
ngx_öt_t


830 
	$ngx_¥o˚ss_›ti⁄s
(
ngx_cy˛e_t
 *
cy˛e
)

832 
u_ch¨
 *
p
;

833 
size_t
 
Àn
;

835 i‡(
ngx_¥efix
) {

836 
Àn
 = 
	`ngx_°æí
(
ngx_¥efix
);

837 
p
 = 
ngx_¥efix
;

839 i‡(!
	`ngx_∑th_£∑øt‹
(*
p
)) {

840 
p
 = 
	`ngx_≤Æloc
(
cy˛e
->
poﬁ
, 
Àn
 + 1);

841 i‡(
p
 =
NULL
) {

842  
NGX_ERROR
;

845 
	`ngx_mem˝y
(
p
, 
ngx_¥efix
, 
Àn
);

846 
p
[
Àn
++] = '/';

849 
cy˛e
->
c⁄f_¥efix
.
Àn
 =Üen;

850 
cy˛e
->
c⁄f_¥efix
.
d©a
 = 
p
;

851 
cy˛e
->
¥efix
.
Àn
 =Üen;

852 
cy˛e
->
¥efix
.
d©a
 = 
p
;

856 #i‚de‡
NGX_PREFIX


858 
p
 = 
	`ngx_≤Æloc
(
cy˛e
->
poﬁ
, 
NGX_MAX_PATH
);

859 i‡(
p
 =
NULL
) {

860  
NGX_ERROR
;

863 i‡(
	`ngx_gëcwd
(
p
, 
NGX_MAX_PATH
) == 0) {

864 
	`ngx_log_°dîr
(
ngx_î∫o
, "[emîg]: " 
ngx_gëcwd_n
 " failed");

865  
NGX_ERROR
;

868 
Àn
 = 
	`ngx_°æí
(
p
);

870 
p
[
Àn
++] = '/';

872 
cy˛e
->
c⁄f_¥efix
.
Àn
 =Üen;

873 
cy˛e
->
c⁄f_¥efix
.
d©a
 = 
p
;

874 
cy˛e
->
¥efix
.
Àn
 =Üen;

875 
cy˛e
->
¥efix
.
d©a
 = 
p
;

879 #ifde‡
NGX_CONF_PREFIX


880 
	`ngx_°r_£t
(&
cy˛e
->
c⁄f_¥efix
, 
NGX_CONF_PREFIX
);

882 
	`ngx_°r_£t
(&
cy˛e
->
c⁄f_¥efix
, 
NGX_PREFIX
);

884 
	`ngx_°r_£t
(&
cy˛e
->
¥efix
, 
NGX_PREFIX
);

889 i‡(
ngx_c⁄f_fûe
) {

890 
cy˛e
->
c⁄f_fûe
.
Àn
 = 
	`ngx_°æí
(
ngx_c⁄f_fûe
);

891 
cy˛e
->
c⁄f_fûe
.
d©a
 = 
ngx_c⁄f_fûe
;

894 
	`ngx_°r_£t
(&
cy˛e
->
c⁄f_fûe
, 
NGX_CONF_PATH
);

897 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cy˛e
, &cy˛e->
c⁄f_fûe
, 0Ë!
NGX_OK
) {

898  
NGX_ERROR
;

901 
p
 = 
cy˛e
->
c⁄f_fûe
.
d©a
 + cy˛e->c⁄f_fûe.
Àn
 - 1;

902 
p
 > 
cy˛e
->
c⁄f_fûe
.
d©a
;

903 
p
--)

905 i‡(
	`ngx_∑th_£∑øt‹
(*
p
)) {

906 
cy˛e
->
c⁄f_¥efix
.
Àn
 = 
p
 - 
ngx_cy˛e
->
c⁄f_fûe
.
d©a
 + 1;

907 
cy˛e
->
c⁄f_¥efix
.
d©a
 = 
ngx_cy˛e
->
c⁄f_fûe
.data;

912 i‡(
ngx_c⁄f_∑øms
) {

913 
cy˛e
->
c⁄f_∑øm
.
Àn
 = 
	`ngx_°æí
(
ngx_c⁄f_∑øms
);

914 
cy˛e
->
c⁄f_∑øm
.
d©a
 = 
ngx_c⁄f_∑øms
;

917 i‡(
ngx_ã°_c⁄fig
) {

918 
cy˛e
->
log
->
log_Àvñ
 = 
NGX_LOG_INFO
;

921  
NGX_OK
;

922 
	}
}

926 
	$ngx_c‹e_moduÀ_¸óã_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
)

928 
ngx_c‹e_c⁄f_t
 *
ccf
;

930 
ccf
 = 
	`ngx_pˇŒoc
(
cy˛e
->
poﬁ
, (
ngx_c‹e_c⁄f_t
));

931 i‡(
ccf
 =
NULL
) {

932  
NULL
;

945 
ccf
->
d´m⁄
 = 
NGX_CONF_UNSET
;

946 
ccf
->
ma°î
 = 
NGX_CONF_UNSET
;

947 
ccf
->
timî_ªsﬁuti⁄
 = 
NGX_CONF_UNSET_MSEC
;

949 
ccf
->
w‹kî_¥o˚s£s
 = 
NGX_CONF_UNSET
;

950 
ccf
->
debug_poöts
 = 
NGX_CONF_UNSET
;

952 
ccf
->
æimô_nofûe
 = 
NGX_CONF_UNSET
;

953 
ccf
->
æimô_c‹e
 = 
NGX_CONF_UNSET
;

954 
ccf
->
æimô_sig≥ndög
 = 
NGX_CONF_UNSET
;

956 
ccf
->
u£r
 = (
ngx_uid_t
Ë
NGX_CONF_UNSET_UINT
;

957 
ccf
->
group
 = (
ngx_gid_t
Ë
NGX_CONF_UNSET_UINT
;

959 #i‡(
NGX_THREADS
)

960 
ccf
->
w‹kî_thªads
 = 
NGX_CONF_UNSET
;

961 
ccf
->
thªad_°ack_size
 = 
NGX_CONF_UNSET_SIZE
;

964 i‡(
	`ngx_¨øy_öô
(&
ccf
->
ív
, 
cy˛e
->
poﬁ
, 1, (
ngx_°r_t
))

965 !
NGX_OK
)

967  
NULL
;

970  
ccf
;

971 
	}
}

975 
	$ngx_c‹e_moduÀ_öô_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
, *
c⁄f
)

977 
ngx_c‹e_c⁄f_t
 *
ccf
 = 
c⁄f
;

979 
	`ngx_c⁄f_öô_vÆue
(
ccf
->
d´m⁄
, 1);

980 
	`ngx_c⁄f_öô_vÆue
(
ccf
->
ma°î
, 1);

981 
	`ngx_c⁄f_öô_m£c_vÆue
(
ccf
->
timî_ªsﬁuti⁄
, 0);

983 
	`ngx_c⁄f_öô_vÆue
(
ccf
->
w‹kî_¥o˚s£s
, 1);

984 
	`ngx_c⁄f_öô_vÆue
(
ccf
->
debug_poöts
, 0);

986 #i‡(
NGX_HAVE_CPU_AFFINITY
)

988 i‡(
ccf
->
˝u_afföôy_n


989 && 
ccf
->
˝u_afföôy_n
 != 1

990 && 
ccf
->
˝u_afföôy_n
 !(
ngx_uöt_t
Ëccf->
w‹kî_¥o˚s£s
)

992 
	`ngx_log_îr‹
(
NGX_LOG_WARN
, 
cy˛e
->
log
, 0,

1000 #i‡(
NGX_THREADS
)

1002 
	`ngx_c⁄f_öô_vÆue
(
ccf
->
w‹kî_thªads
, 0);

1003 
ngx_thªads_n
 = 
ccf
->
w‹kî_thªads
;

1004 
	`ngx_c⁄f_öô_size_vÆue
(
ccf
->
thªad_°ack_size
, 2 * 1024 * 1024);

1009 i‡(
ccf
->
pid
.
Àn
 == 0) {

1010 
	`ngx_°r_£t
(&
ccf
->
pid
, 
NGX_PID_PATH
);

1013 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cy˛e
, &
ccf
->
pid
, 0Ë!
NGX_OK
) {

1014  
NGX_CONF_ERROR
;

1017 
ccf
->
ﬁdpid
.
Àn
 = ccf->
pid
.À¿+ (
NGX_OLDPID_EXT
);

1019 
ccf
->
ﬁdpid
.
d©a
 = 
	`ngx_≤Æloc
(
cy˛e
->
poﬁ
, ccf->ﬁdpid.
Àn
);

1020 i‡(
ccf
->
ﬁdpid
.
d©a
 =
NULL
) {

1021  
NGX_CONF_ERROR
;

1024 
	`ngx_mem˝y
(
	`ngx_˝ymem
(
ccf
->
ﬁdpid
.
d©a
, ccf->
pid
.d©a, ccf->pid.
Àn
),

1025 
NGX_OLDPID_EXT
, (NGX_OLDPID_EXT));

1028 #i‡!(
NGX_WIN32
)

1030 i‡(
ccf
->
u£r
 =(
uid_t
Ë
NGX_CONF_UNSET_UINT
 && 
	`gëeuid
() == 0) {

1031 
group
 *
gΩ
;

1032 
∑sswd
 *
pwd
;

1034 
	`ngx_£t_î∫o
(0);

1035 
pwd
 = 
	`gëpw«m
(
NGX_USER
);

1036 i‡(
pwd
 =
NULL
) {

1037 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1038 "gëpw«m(\"" 
NGX_USER
 "\") failed");

1039  
NGX_CONF_ERROR
;

1042 
ccf
->
u£∫ame
 = 
NGX_USER
;

1043 
ccf
->
u£r
 = 
pwd
->
pw_uid
;

1045 
	`ngx_£t_î∫o
(0);

1046 
gΩ
 = 
	`gëg∫am
(
NGX_GROUP
);

1047 i‡(
gΩ
 =
NULL
) {

1048 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1049 "gëg∫am(\"" 
NGX_GROUP
 "\") failed");

1050  
NGX_CONF_ERROR
;

1053 
ccf
->
group
 = 
gΩ
->
gr_gid
;

1057 i‡(
ccf
->
lock_fûe
.
Àn
 == 0) {

1058 
	`ngx_°r_£t
(&
ccf
->
lock_fûe
, 
NGX_LOCK_PATH
);

1061 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cy˛e
, &
ccf
->
lock_fûe
, 0Ë!
NGX_OK
) {

1062  
NGX_CONF_ERROR
;

1066 
ngx_°r_t
 
lock_fûe
;

1068 
lock_fûe
 = 
cy˛e
->
ﬁd_cy˛e
->lock_file;

1070 i‡(
lock_fûe
.
Àn
) {

1071 
lock_fûe
.
Àn
--;

1073 i‡(
ccf
->
lock_fûe
.
Àn
 !=Üock_file.len

1074 || 
	`ngx_°∫cmp
(
ccf
->
lock_fûe
.
d©a
,Üock_fûe.d©a,Üock_fûe.
Àn
)

1077 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 0,

1081 
cy˛e
->
lock_fûe
.
Àn
 =Üock_file.len + 1;

1082 
lock_fûe
.
Àn
 += (".accept");

1084 
cy˛e
->
lock_fûe
.
d©a
 = 
	`ngx_p°rdup
(cy˛e->
poﬁ
, &lock_file);

1085 i‡(
cy˛e
->
lock_fûe
.
d©a
 =
NULL
) {

1086  
NGX_CONF_ERROR
;

1090 
cy˛e
->
lock_fûe
.
Àn
 = 
ccf
->lock_file.len + 1;

1091 
cy˛e
->
lock_fûe
.
d©a
 = 
	`ngx_≤Æloc
(cy˛e->
poﬁ
,

1092 
ccf
->
lock_fûe
.
Àn
 + (".accept"));

1093 i‡(
cy˛e
->
lock_fûe
.
d©a
 =
NULL
) {

1094  
NGX_CONF_ERROR
;

1097 
	`ngx_mem˝y
(
	`ngx_˝ymem
(
cy˛e
->
lock_fûe
.
d©a
, 
ccf
->lock_file.data,

1098 
ccf
->
lock_fûe
.
Àn
),

1105  
NGX_CONF_OK
;

1106 
	}
}

1110 
	$ngx_£t_u£r
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1112 #i‡(
NGX_WIN32
)

1114 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1117  
NGX_CONF_OK
;

1121 
ngx_c‹e_c⁄f_t
 *
ccf
 = 
c⁄f
;

1123 *
group
;

1124 
∑sswd
 *
pwd
;

1125 
group
 *
gΩ
;

1126 
ngx_°r_t
 *
vÆue
;

1128 i‡(
ccf
->
u£r
 !(
uid_t
Ë
NGX_CONF_UNSET_UINT
) {

1132 i‡(
	`gëeuid
() != 0) {

1133 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1137  
NGX_CONF_OK
;

1140 
vÆue
 = (
ngx_°r_t
 *Ë
cf
->
¨gs
->
ñts
;

1142 
ccf
->
u£∫ame
 = (*Ë
vÆue
[1].
d©a
;

1144 
	`ngx_£t_î∫o
(0);

1145 
pwd
 = 
	`gëpw«m
((c⁄° *Ë
vÆue
[1].
d©a
);

1146 i‡(
pwd
 =
NULL
) {

1147 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 
ngx_î∫o
,

1148 "gëpw«m(\"%s\"ËÁûed", 
vÆue
[1].
d©a
);

1149  
NGX_CONF_ERROR
;

1152 
ccf
->
u£r
 = 
pwd
->
pw_uid
;

1154 
group
 = (*Ë((
cf
->
¨gs
->
√…s
 =2Ë? 
vÆue
[1].
d©a
 : value[2].data);

1156 
	`ngx_£t_î∫o
(0);

1157 
gΩ
 = 
	`gëg∫am
(
group
);

1158 i‡(
gΩ
 =
NULL
) {

1159 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 
ngx_î∫o
,

1160 "gëg∫am(\"%s\"ËÁûed", 
group
);

1161  
NGX_CONF_ERROR
;

1164 
ccf
->
group
 = 
gΩ
->
gr_gid
;

1166  
NGX_CONF_OK
;

1169 
	}
}

1173 
	$ngx_£t_ív
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1175 
ngx_c‹e_c⁄f_t
 *
ccf
 = 
c⁄f
;

1177 
ngx_°r_t
 *
vÆue
, *
v¨
;

1178 
ngx_uöt_t
 
i
;

1180 
v¨
 = 
	`ngx_¨øy_push
(&
ccf
->
ív
);

1181 i‡(
v¨
 =
NULL
) {

1182  
NGX_CONF_ERROR
;

1185 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1186 *
v¨
 = 
vÆue
[1];

1188 
i
 = 0; i < 
vÆue
[1].
Àn
; i++) {

1190 i‡(
vÆue
[1].
d©a
[
i
] == '=') {

1192 
v¨
->
Àn
 = 
i
;

1194  
NGX_CONF_OK
;

1198  
NGX_CONF_OK
;

1199 
	}
}

1203 
	$ngx_£t_¥i‹ôy
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1205 
ngx_c‹e_c⁄f_t
 *
ccf
 = 
c⁄f
;

1207 
ngx_°r_t
 *
vÆue
;

1208 
ngx_uöt_t
 
n
, 
möus
;

1210 i‡(
ccf
->
¥i‹ôy
 != 0) {

1214 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1216 i‡(
vÆue
[1].
d©a
[0] == '-') {

1217 
n
 = 1;

1218 
möus
 = 1;

1220 } i‡(
vÆue
[1].
d©a
[0] == '+') {

1221 
n
 = 1;

1222 
möus
 = 0;

1225 
n
 = 0;

1226 
möus
 = 0;

1229 
ccf
->
¥i‹ôy
 = 
	`ngx_©oi
(&
vÆue
[1].
d©a
[
n
], vÆue[1].
Àn
 -Ç);

1230 i‡(
ccf
->
¥i‹ôy
 =
NGX_ERROR
) {

1234 i‡(
möus
) {

1235 
ccf
->
¥i‹ôy
 = -ccf->priority;

1238  
NGX_CONF_OK
;

1239 
	}
}

1243 
	$ngx_£t_˝u_afföôy
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1245 #i‡(
NGX_HAVE_CPU_AFFINITY
)

1246 
ngx_c‹e_c⁄f_t
 *
ccf
 = 
c⁄f
;

1248 
u_ch¨
 
ch
;

1249 
uöt64_t
 *
mask
;

1250 
ngx_°r_t
 *
vÆue
;

1251 
ngx_uöt_t
 
i
, 
n
;

1253 i‡(
ccf
->
˝u_afföôy
) {

1257 
mask
 = 
	`ngx_∑Œoc
(
cf
->
poﬁ
, (cf->
¨gs
->
√…s
 - 1Ë* (
uöt64_t
));

1258 i‡(
mask
 =
NULL
) {

1259  
NGX_CONF_ERROR
;

1262 
ccf
->
˝u_afföôy_n
 = 
cf
->
¨gs
->
√…s
 - 1;

1263 
ccf
->
˝u_afföôy
 = 
mask
;

1265 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1267 
n
 = 1;Ç < 
cf
->
¨gs
->
√…s
;Ç++) {

1269 i‡(
vÆue
[
n
].
Àn
 > 64) {

1270 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1272  
NGX_CONF_ERROR
;

1275 
mask
[
n
 - 1] = 0;

1277 
i
 = 0; i < 
vÆue
[
n
].
Àn
; i++) {

1279 
ch
 = 
vÆue
[
n
].
d©a
[
i
];

1281 i‡(
ch
 == ' ') {

1285 
mask
[
n
 - 1] <<= 1;

1287 i‡(
ch
 == '0') {

1291 i‡(
ch
 == '1') {

1292 
mask
[
n
 - 1] |= 1;

1296 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1298 
ch
);

1299  
NGX_CONF_ERROR
;

1305 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1310  
NGX_CONF_OK
;

1311 
	}
}

1314 
uöt64_t


1315 
	$ngx_gë_˝u_afföôy
(
ngx_uöt_t
 
n
)

1317 
ngx_c‹e_c⁄f_t
 *
ccf
;

1319 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ngx_cy˛e
->
c⁄f_˘x
,

1320 
ngx_c‹e_moduÀ
);

1322 i‡(
ccf
->
˝u_afföôy
 =
NULL
) {

1326 i‡(
ccf
->
˝u_afföôy_n
 > 
n
) {

1327  
ccf
->
˝u_afföôy
[
n
];

1330  
ccf
->
˝u_afföôy
[ccf->
˝u_afföôy_n
 - 1];

1331 
	}
}

	@nginx.h

8 #i‚de‡
_NGINX_H_INCLUDED_


9 
	#_NGINX_H_INCLUDED_


	)

12 
	#ngöx_vîsi⁄
 1002002

	)

13 
	#NGINX_VERSION
 "1.2.2"

	)

14 
	#NGINX_VER
 "ngöx/" 
NGINX_VERSION


	)

16 
	#NGINX_VAR
 "NGINX"

	)

17 
	#NGX_OLDPID_EXT
 ".ﬁdbö"

	)

	@ngx_array.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
ngx_¨øy_t
 *

13 
	$ngx_¨øy_¸óã
(
ngx_poﬁ_t
 *
p
, 
ngx_uöt_t
 
n
, 
size_t
 
size
)

15 
ngx_¨øy_t
 *
a
;

17 
a
 = 
	`ngx_∑Œoc
(
p
, (
ngx_¨øy_t
));

18 i‡(
a
 =
NULL
) {

19  
NULL
;

22 
a
->
ñts
 = 
	`ngx_∑Œoc
(
p
, 
n
 * 
size
);

23 i‡(
a
->
ñts
 =
NULL
) {

24  
NULL
;

27 
a
->
√…s
 = 0;

28 
a
->
size
 = size;

29 
a
->
«Œoc
 = 
n
;

30 
a
->
poﬁ
 = 
p
;

32  
a
;

33 
	}
}

37 
	$ngx_¨øy_de°roy
(
ngx_¨øy_t
 *
a
)

39 
ngx_poﬁ_t
 *
p
;

41 
p
 = 
a
->
poﬁ
;

43 i‡((
u_ch¨
 *Ë
a
->
ñts
 +á->
size
 *á->
«Œoc
 =
p
->
d
.
œ°
) {

44 
p
->
d
.
œ°
 -
a
->
size
 *á->
«Œoc
;

47 i‡((
u_ch¨
 *Ë
a
 + (
ngx_¨øy_t
Ë=
p
->
d
.
œ°
) {

48 
p
->
d
.
œ°
 = (
u_ch¨
 *Ë
a
;

50 
	}
}

54 
	$ngx_¨øy_push
(
ngx_¨øy_t
 *
a
)

56 *
ñt
, *
√w
;

57 
size_t
 
size
;

58 
ngx_poﬁ_t
 *
p
;

60 i‡(
a
->
√…s
 =a->
«Œoc
) {

64 
size
 = 
a
->sizê*á->
«Œoc
;

66 
p
 = 
a
->
poﬁ
;

68 i‡((
u_ch¨
 *Ë
a
->
ñts
 + 
size
 =
p
->
d
.
œ°


69 && 
p
->
d
.
œ°
 + 
a
->
size
 <p->d.
íd
)

76 
p
->
d
.
œ°
 +
a
->
size
;

77 
a
->
«Œoc
++;

82 
√w
 = 
	`ngx_∑Œoc
(
p
, 2 * 
size
);

83 i‡(
√w
 =
NULL
) {

84  
NULL
;

87 
	`ngx_mem˝y
(
√w
, 
a
->
ñts
, 
size
);

88 
a
->
ñts
 = 
√w
;

89 
a
->
«Œoc
 *= 2;

93 
ñt
 = (
u_ch¨
 *Ë
a
->
ñts
 +á->
size
 *á->
√…s
;

94 
a
->
√…s
++;

96  
ñt
;

97 
	}
}

101 
	$ngx_¨øy_push_n
(
ngx_¨øy_t
 *
a
, 
ngx_uöt_t
 
n
)

103 *
ñt
, *
√w
;

104 
size_t
 
size
;

105 
ngx_uöt_t
 
«Œoc
;

106 
ngx_poﬁ_t
 *
p
;

108 
size
 = 
n
 * 
a
->size;

110 i‡(
a
->
√…s
 + 
n
 >á->
«Œoc
) {

114 
p
 = 
a
->
poﬁ
;

116 i‡((
u_ch¨
 *Ë
a
->
ñts
 +á->
size
 *á->
«Œoc
 =
p
->
d
.
œ°


117 && 
p
->
d
.
œ°
 + 
size
 <p->d.
íd
)

124 
p
->
d
.
œ°
 +
size
;

125 
a
->
«Œoc
 +
n
;

130 
«Œoc
 = 2 * ((
n
 >
a
->nalloc) ?Ç :á->nalloc);

132 
√w
 = 
	`ngx_∑Œoc
(
p
, 
«Œoc
 * 
a
->
size
);

133 i‡(
√w
 =
NULL
) {

134  
NULL
;

137 
	`ngx_mem˝y
(
√w
, 
a
->
ñts
,á->
√…s
 *á->
size
);

138 
a
->
ñts
 = 
√w
;

139 
a
->
«Œoc
 =Çalloc;

143 
ñt
 = (
u_ch¨
 *Ë
a
->
ñts
 +á->
size
 *á->
√…s
;

144 
a
->
√…s
 +
n
;

146  
ñt
;

147 
	}
}

	@ngx_array.h

8 #i‚de‡
_NGX_ARRAY_H_INCLUDED_


9 
	#_NGX_ARRAY_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
	sngx_¨øy_s
 {

17 *
	mñts
;

18 
ngx_uöt_t
 
	m√…s
;

19 
size_t
 
	msize
;

20 
ngx_uöt_t
 
	m«Œoc
;

21 
ngx_poﬁ_t
 *
	mpoﬁ
;

25 
ngx_¨øy_t
 *
ngx_¨øy_¸óã
(
ngx_poﬁ_t
 *
p
, 
ngx_uöt_t
 
n
, 
size_t
 
size
);

26 
ngx_¨øy_de°roy
(
ngx_¨øy_t
 *
a
);

27 *
ngx_¨øy_push
(
ngx_¨øy_t
 *
a
);

28 *
ngx_¨øy_push_n
(
ngx_¨øy_t
 *
a
, 
ngx_uöt_t
 
n
);

31 
ngx_ölöe
 
ngx_öt_t


32 
	$ngx_¨øy_öô
(
ngx_¨øy_t
 *
¨øy
, 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
n
, 
size_t
 
size
)

39 
¨øy
->
√…s
 = 0;

40 
¨øy
->
size
 = size;

41 
¨øy
->
«Œoc
 = 
n
;

42 
¨øy
->
poﬁ
 =Öool;

44 
¨øy
->
ñts
 = 
	`ngx_∑Œoc
(
poﬁ
, 
n
 * 
size
);

45 i‡(
¨øy
->
ñts
 =
NULL
) {

46  
NGX_ERROR
;

49  
NGX_OK
;

50 
	}
}

	@ngx_buf.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
ngx_buf_t
 *

13 
	$ngx_¸óã_ãmp_buf
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

15 
ngx_buf_t
 *
b
;

17 
b
 = 
	`ngx_ˇŒoc_buf
(
poﬁ
);

18 i‡(
b
 =
NULL
) {

19  
NULL
;

22 
b
->
°¨t
 = 
	`ngx_∑Œoc
(
poﬁ
, 
size
);

23 i‡(
b
->
°¨t
 =
NULL
) {

24  
NULL
;

38 
b
->
pos
 = b->
°¨t
;

39 
b
->
œ°
 = b->
°¨t
;

40 
b
->
íd
 = b->
œ°
 + 
size
;

41 
b
->
ãmp‹¨y
 = 1;

43  
b
;

44 
	}
}

47 
ngx_chaö_t
 *

48 
	$ngx_Æloc_chaö_lök
(
ngx_poﬁ_t
 *
poﬁ
)

50 
ngx_chaö_t
 *
˛
;

52 
˛
 = 
poﬁ
->
chaö
;

54 i‡(
˛
) {

55 
poﬁ
->
chaö
 = 
˛
->
√xt
;

56  
˛
;

59 
˛
 = 
	`ngx_∑Œoc
(
poﬁ
, (
ngx_chaö_t
));

60 i‡(
˛
 =
NULL
) {

61  
NULL
;

64  
˛
;

65 
	}
}

68 
ngx_chaö_t
 *

69 
	$ngx_¸óã_chaö_of_bufs
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_bufs_t
 *
bufs
)

71 
u_ch¨
 *
p
;

72 
ngx_öt_t
 
i
;

73 
ngx_buf_t
 *
b
;

74 
ngx_chaö_t
 *
chaö
, *
˛
, **
Œ
;

76 
p
 = 
	`ngx_∑Œoc
(
poﬁ
, 
bufs
->
num
 * bufs->
size
);

77 i‡(
p
 =
NULL
) {

78  
NULL
;

81 
Œ
 = &
chaö
;

83 
i
 = 0; i < 
bufs
->
num
; i++) {

85 
b
 = 
	`ngx_ˇŒoc_buf
(
poﬁ
);

86 i‡(
b
 =
NULL
) {

87  
NULL
;

102 
b
->
pos
 = 
p
;

103 
b
->
œ°
 = 
p
;

104 
b
->
ãmp‹¨y
 = 1;

106 
b
->
°¨t
 = 
p
;

107 
p
 +
bufs
->
size
;

108 
b
->
íd
 = 
p
;

110 
˛
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

111 i‡(
˛
 =
NULL
) {

112  
NULL
;

115 
˛
->
buf
 = 
b
;

116 *
Œ
 = 
˛
;

117 
Œ
 = &
˛
->
√xt
;

120 *
Œ
 = 
NULL
;

122  
chaö
;

123 
	}
}

126 
ngx_öt_t


127 
	$ngx_chaö_add_c›y
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_chaö_t
 **
chaö
,Çgx_chaö_à*
ö
)

129 
ngx_chaö_t
 *
˛
, **
Œ
;

131 
Œ
 = 
chaö
;

133 
˛
 = *
chaö
; cl; c»˛->
√xt
) {

134 
Œ
 = &
˛
->
√xt
;

137 
ö
) {

138 
˛
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

139 i‡(
˛
 =
NULL
) {

140  
NGX_ERROR
;

143 
˛
->
buf
 = 
ö
->buf;

144 *
Œ
 = 
˛
;

145 
Œ
 = &
˛
->
√xt
;

146 
ö
 = in->
√xt
;

149 *
Œ
 = 
NULL
;

151  
NGX_OK
;

152 
	}
}

155 
ngx_chaö_t
 *

156 
	$ngx_chaö_gë_‰ì_buf
(
ngx_poﬁ_t
 *
p
, 
ngx_chaö_t
 **
‰ì
)

158 
ngx_chaö_t
 *
˛
;

160 i‡(*
‰ì
) {

161 
˛
 = *
‰ì
;

162 *
‰ì
 = 
˛
->
√xt
;

163 
˛
->
√xt
 = 
NULL
;

164  
˛
;

167 
˛
 = 
	`ngx_Æloc_chaö_lök
(
p
);

168 i‡(
˛
 =
NULL
) {

169  
NULL
;

172 
˛
->
buf
 = 
	`ngx_ˇŒoc_buf
(
p
);

173 i‡(
˛
->
buf
 =
NULL
) {

174  
NULL
;

177 
˛
->
√xt
 = 
NULL
;

179  
˛
;

180 
	}
}

184 
	$ngx_chaö_upd©e_chaös
(
ngx_poﬁ_t
 *
p
, 
ngx_chaö_t
 **
‰ì
,Çgx_chaö_à**
busy
,

185 
ngx_chaö_t
 **
out
, 
ngx_buf_èg_t
 
èg
)

187 
ngx_chaö_t
 *
˛
;

189 i‡(*
busy
 =
NULL
) {

190 *
busy
 = *
out
;

193 
˛
 = *
busy
; cl->
√xt
; cl = cl->next) { }

195 
˛
->
√xt
 = *
out
;

198 *
out
 = 
NULL
;

200 *
busy
) {

201 
˛
 = *
busy
;

203 i‡(
	`ngx_buf_size
(
˛
->
buf
) != 0) {

207 i‡(
˛
->
buf
->
èg
 !=Åag) {

208 *
busy
 = 
˛
->
√xt
;

209 
	`ngx_‰ì_chaö
(
p
, 
˛
);

213 
˛
->
buf
->
pos
 = cl->buf->
°¨t
;

214 
˛
->
buf
->
œ°
 = cl->buf->
°¨t
;

216 *
busy
 = 
˛
->
√xt
;

217 
˛
->
√xt
 = *
‰ì
;

218 *
‰ì
 = 
˛
;

220 
	}
}

	@ngx_buf.h

8 #i‚de‡
_NGX_BUF_H_INCLUDED_


9 
	#_NGX_BUF_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 * 
	tngx_buf_èg_t
;

18 
ngx_buf_s
 
	tngx_buf_t
;

20 
	sngx_buf_s
 {

21 
u_ch¨
 *
	mpos
;

22 
u_ch¨
 *
	mœ°
;

23 
off_t
 
	mfûe_pos
;

24 
off_t
 
	mfûe_œ°
;

26 
u_ch¨
 *
	m°¨t
;

27 
u_ch¨
 *
	míd
;

28 
ngx_buf_èg_t
 
	mèg
;

29 
ngx_fûe_t
 *
	mfûe
;

30 
ngx_buf_t
 *
	mshadow
;

34 
	mãmp‹¨y
:1;

40 
	mmem‹y
:1;

43 
	mmm≠
:1;

45 
	mªcy˛ed
:1;

46 
	mö_fûe
:1;

47 
	mÊush
:1;

48 
	msync
:1;

49 
	mœ°_buf
:1;

50 
	mœ°_ö_chaö
:1;

52 
	mœ°_shadow
:1;

53 
	mãmp_fûe
:1;

55  
	mnum
;

59 
	sngx_chaö_s
 {

60 
ngx_buf_t
 *
	mbuf
;

61 
ngx_chaö_t
 *
	m√xt
;

66 
ngx_öt_t
 
	mnum
;

67 
size_t
 
	msize
;

68 } 
	tngx_bufs_t
;

71 
ngx_ouçut_chaö_˘x_s
 
	tngx_ouçut_chaö_˘x_t
;

73 
	$ngx_öt_t
 (*
	tngx_ouçut_chaö_fûãr_±
)(*
	t˘x
, 
	tngx_chaö_t
 *
	tö
);

75 #i‡(
NGX_HAVE_FILE_AIO
)

76 (*
	tngx_ouçut_chaö_aio_±
)(
	tngx_ouçut_chaö_˘x_t
 *
	t˘x
,

77 
	tngx_fûe_t
 *
	tfûe
);

80 
	sngx_ouçut_chaö_˘x_s
 {

81 
ngx_buf_t
 *
buf
;

82 
ngx_chaö_t
 *
ö
;

83 
ngx_chaö_t
 *
‰ì
;

84 
ngx_chaö_t
 *
busy
;

86 
£ndfûe
:1;

87 
dúe˘io
:1;

88 #i‡(
NGX_HAVE_ALIGNED_DIRECTIO
)

89 
u«lig√d
:1;

91 
√ed_ö_mem‹y
:1;

92 
√ed_ö_ãmp
:1;

93 #i‡(
NGX_HAVE_FILE_AIO
)

94 
aio
:1;

96 
ngx_ouçut_chaö_aio_±
 
aio_h™dÀr
;

99 
off_t
 
Æignmít
;

101 
ngx_poﬁ_t
 *
poﬁ
;

102 
ngx_öt_t
 
Æloˇãd
;

103 
ngx_bufs_t
 
bufs
;

104 
ngx_buf_èg_t
 
èg
;

106 
ngx_ouçut_chaö_fûãr_±
 
ouçut_fûãr
;

107 *
fûãr_˘x
;

112 
ngx_chaö_t
 *
out
;

113 
ngx_chaö_t
 **
œ°
;

114 
ngx_c⁄√˘i⁄_t
 *
c⁄√˘i⁄
;

115 
ngx_poﬁ_t
 *
poﬁ
;

116 
off_t
 
limô
;

117 } 
	tngx_chaö_wrôî_˘x_t
;

120 
	#NGX_CHAIN_ERROR
 (
ngx_chaö_t
 *Ë
NGX_ERROR


	)

123 
	#ngx_buf_ö_mem‹y
(
b
Ë(b->
ãmp‹¨y
 || b->
mem‹y
 || b->
mm≠
)

	)

124 
	#ngx_buf_ö_mem‹y_⁄ly
(
b
Ë(
	`ngx_buf_ö_mem‹y
(bË&& !b->
ö_fûe
)

	)

126 
	#ngx_buf_•ecül
(
b
) \

127 ((
b
->
Êush
 || b->
œ°_buf
 || b->
sync
) \

128 && !
	`ngx_buf_ö_mem‹y
(
b
Ë&& !b->
ö_fûe
)

	)

130 
	#ngx_buf_sync_⁄ly
(
b
) \

131 (
b
->
sync
 \

132 && !
	`ngx_buf_ö_mem‹y
(
b
Ë&& !b->
ö_fûe
 && !b->
Êush
 && !b->
œ°_buf
)

	)

134 
	#ngx_buf_size
(
b
) \

135 (
	`ngx_buf_ö_mem‹y
(
b
Ë? (
off_t
Ë(b->
œ°
 - b->
pos
): \

136 (
b
->
fûe_œ°
 - b->
fûe_pos
))

	)

138 
ngx_buf_t
 *
	`ngx_¸óã_ãmp_buf
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

139 
ngx_chaö_t
 *
	`ngx_¸óã_chaö_of_bufs
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_bufs_t
 *
bufs
);

142 
	#ngx_Æloc_buf
(
poﬁ
Ë
	`ngx_∑Œoc
’oﬁ, (
ngx_buf_t
))

	)

143 
	#ngx_ˇŒoc_buf
(
poﬁ
Ë
	`ngx_pˇŒoc
’oﬁ, (
ngx_buf_t
))

	)

145 
ngx_chaö_t
 *
	`ngx_Æloc_chaö_lök
(
ngx_poﬁ_t
 *
poﬁ
);

146 
	#ngx_‰ì_chaö
(
poﬁ
, 
˛
) \

147 
˛
->
√xt
 = 
poﬁ
->
chaö
; \

148 
poﬁ
->
chaö
 = 
˛


	)

152 
ngx_öt_t
 
	`ngx_ouçut_chaö
(
ngx_ouçut_chaö_˘x_t
 *
˘x
, 
ngx_chaö_t
 *
ö
);

153 
ngx_öt_t
 
	`ngx_chaö_wrôî
(*
˘x
, 
ngx_chaö_t
 *
ö
);

155 
ngx_öt_t
 
	`ngx_chaö_add_c›y
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_chaö_t
 **
chaö
,

156 
ngx_chaö_t
 *
ö
);

157 
ngx_chaö_t
 *
	`ngx_chaö_gë_‰ì_buf
(
ngx_poﬁ_t
 *
p
,Çgx_chaö_à**
‰ì
);

158 
	`ngx_chaö_upd©e_chaös
(
ngx_poﬁ_t
 *
p
, 
ngx_chaö_t
 **
‰ì
,

159 
ngx_chaö_t
 **
busy
,Çgx_chaö_à**
out
, 
ngx_buf_èg_t
 
èg
);

	@ngx_conf_file.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

11 
	#NGX_CONF_BUFFER
 4096

	)

13 
ngx_öt_t
 
ngx_c⁄f_h™dÀr
(
ngx_c⁄f_t
 *
cf
,Çgx_öt_à
œ°
);

14 
ngx_öt_t
 
ngx_c⁄f_ªad_tokí
(
ngx_c⁄f_t
 *
cf
);

15 *
ngx_c⁄f_ö˛ude
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

16 
ngx_öt_t
 
ngx_c⁄f_ã°_fuŒ_«me
(
ngx_°r_t
 *
«me
);

17 
ngx_c⁄f_Êush_fûes
(
ngx_cy˛e_t
 *
cy˛e
);

20 
ngx_comm™d_t
 
	gngx_c⁄f_comm™ds
[] = {

22 { 
ngx_°rög
("include"),

23 
NGX_ANY_CONF
|
NGX_CONF_TAKE1
,

24 
ngx_c⁄f_ö˛ude
,

27 
NULL
 },

29 
ngx_nuŒ_comm™d


33 
ngx_moduÀ_t
 
	gngx_c⁄f_moduÀ
 = {

34 
NGX_MODULE_V1
,

35 
NULL
,

36 
ngx_c⁄f_comm™ds
,

37 
NGX_CONF_MODULE
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
ngx_c⁄f_Êush_fûes
,

44 
NULL
,

45 
NGX_MODULE_V1_PADDING


51 
ngx_uöt_t
 
	g¨gumít_numbî
[] = {

52 
NGX_CONF_NOARGS
,

53 
NGX_CONF_TAKE1
,

54 
NGX_CONF_TAKE2
,

55 
NGX_CONF_TAKE3
,

56 
NGX_CONF_TAKE4
,

57 
NGX_CONF_TAKE5
,

58 
NGX_CONF_TAKE6
,

59 
NGX_CONF_TAKE7


64 
	$ngx_c⁄f_∑øm
(
ngx_c⁄f_t
 *
cf
)

66 *
rv
;

67 
ngx_°r_t
 *
∑øm
;

68 
ngx_buf_t
 
b
;

69 
ngx_c⁄f_fûe_t
 
c⁄f_fûe
;

71 
∑øm
 = &
cf
->
cy˛e
->
c⁄f_∑øm
;

73 i‡(
∑øm
->
Àn
 == 0) {

74  
NGX_CONF_OK
;

77 
	`ngx_memzîo
(&
c⁄f_fûe
, (
ngx_c⁄f_fûe_t
));

79 
	`ngx_memzîo
(&
b
, (
ngx_buf_t
));

81 
b
.
°¨t
 = 
∑øm
->
d©a
;

82 
b
.
pos
 = 
∑øm
->
d©a
;

83 
b
.
œ°
 = 
∑øm
->
d©a
 +Ö¨am->
Àn
;

84 
b
.
íd
 = b.
œ°
;

85 
b
.
ãmp‹¨y
 = 1;

87 
c⁄f_fûe
.
fûe
.
fd
 = 
NGX_INVALID_FILE
;

88 
c⁄f_fûe
.
fûe
.
«me
.
d©a
 = 
NULL
;

89 
c⁄f_fûe
.
löe
 = 0;

91 
cf
->
c⁄f_fûe
 = &conf_file;

92 
cf
->
c⁄f_fûe
->
buf„r
 = &
b
;

94 
rv
 = 
	`ngx_c⁄f_∑r£
(
cf
, 
NULL
);

96 
cf
->
c⁄f_fûe
 = 
NULL
;

98  
rv
;

99 
	}
}

103 
	$ngx_c⁄f_∑r£
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
fûíame
)

105 *
rv
;

106 
ngx_fd_t
 
fd
;

107 
ngx_öt_t
 
rc
;

108 
ngx_buf_t
 
buf
;

109 
ngx_c⁄f_fûe_t
 *
¥ev
, 
c⁄f_fûe
;

111 
∑r£_fûe
 = 0,

112 
∑r£_block
,

113 
∑r£_∑øm


114 } 
ty≥
;

116 #i‡(
NGX_SUPPRESS_WARN
)

117 
fd
 = 
NGX_INVALID_FILE
;

118 
¥ev
 = 
NULL
;

121 i‡(
fûíame
) {

125 
fd
 = 
	`ngx_›í_fûe
(
fûíame
->
d©a
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
, 0);

126 i‡(
fd
 =
NGX_INVALID_FILE
) {

127 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 
ngx_î∫o
,

128 
ngx_›í_fûe_n
 " \"%s\" failed",

129 
fûíame
->
d©a
);

130  
NGX_CONF_ERROR
;

133 
¥ev
 = 
cf
->
c⁄f_fûe
;

135 
cf
->
c⁄f_fûe
 = &conf_file;

137 i‡(
	`ngx_fd_öfo
(
fd
, &
cf
->
c⁄f_fûe
->
fûe
.
öfo
) == -1) {

138 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cf
->
log
, 
ngx_î∫o
,

139 
ngx_fd_öfo_n
 " \"%s\" faûed", 
fûíame
->
d©a
);

142 
cf
->
c⁄f_fûe
->
buf„r
 = &
buf
;

144 
buf
.
°¨t
 = 
	`ngx_Æloc
(
NGX_CONF_BUFFER
, 
cf
->
log
);

145 i‡(
buf
.
°¨t
 =
NULL
) {

146 
Áûed
;

149 
buf
.
pos
 = buf.
°¨t
;

150 
buf
.
œ°
 = buf.
°¨t
;

151 
buf
.
íd
 = buf.
œ°
 + 
NGX_CONF_BUFFER
;

152 
buf
.
ãmp‹¨y
 = 1;

154 
cf
->
c⁄f_fûe
->
fûe
.
fd
 = fd;

155 
cf
->
c⁄f_fûe
->
fûe
.
«me
.
Àn
 = 
fûíame
->len;

156 
cf
->
c⁄f_fûe
->
fûe
.
«me
.
d©a
 = 
fûíame
->data;

157 
cf
->
c⁄f_fûe
->
fûe
.
off£t
 = 0;

158 
cf
->
c⁄f_fûe
->
fûe
.
log
 = cf->log;

159 
cf
->
c⁄f_fûe
->
löe
 = 1;

161 
ty≥
 = 
∑r£_fûe
;

163 } i‡(
cf
->
c⁄f_fûe
->
fûe
.
fd
 !
NGX_INVALID_FILE
) {

165 
ty≥
 = 
∑r£_block
;

168 
ty≥
 = 
∑r£_∑øm
;

173 
rc
 = 
	`ngx_c⁄f_ªad_tokí
(
cf
);

185 i‡(
rc
 =
NGX_ERROR
) {

186 
d⁄e
;

189 i‡(
rc
 =
NGX_CONF_BLOCK_DONE
) {

191 i‡(
ty≥
 !
∑r£_block
) {

192 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0, "unexpected \"}\"");

193 
Áûed
;

196 
d⁄e
;

199 i‡(
rc
 =
NGX_CONF_FILE_DONE
) {

201 i‡(
ty≥
 =
∑r£_block
) {

202 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

204 
Áûed
;

207 
d⁄e
;

210 i‡(
rc
 =
NGX_CONF_BLOCK_START
) {

212 i‡(
ty≥
 =
∑r£_∑øm
) {

213 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

216 
Áûed
;

222 i‡(
cf
->
h™dÀr
) {

229 
rv
 = (*
cf
->
h™dÀr
)(cf, 
NULL
, cf->
h™dÀr_c⁄f
);

230 i‡(
rv
 =
NGX_CONF_OK
) {

234 i‡(
rv
 =
NGX_CONF_ERROR
) {

235 
Áûed
;

238 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0, 
rv
);

240 
Áûed
;

244 
rc
 = 
	`ngx_c⁄f_h™dÀr
(
cf
,Ñc);

246 i‡(
rc
 =
NGX_ERROR
) {

247 
Áûed
;

251 
Áûed
:

253 
rc
 = 
NGX_ERROR
;

255 
d⁄e
:

257 i‡(
fûíame
) {

258 i‡(
cf
->
c⁄f_fûe
->
buf„r
->
°¨t
) {

259 
	`ngx_‰ì
(
cf
->
c⁄f_fûe
->
buf„r
->
°¨t
);

262 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

263 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

264 
ngx_˛o£_fûe_n
 " %s failed",

265 
fûíame
->
d©a
);

266  
NGX_CONF_ERROR
;

269 
cf
->
c⁄f_fûe
 = 
¥ev
;

272 i‡(
rc
 =
NGX_ERROR
) {

273  
NGX_CONF_ERROR
;

276  
NGX_CONF_OK
;

277 
	}
}

280 
ngx_öt_t


281 
	$ngx_c⁄f_h™dÀr
(
ngx_c⁄f_t
 *
cf
, 
ngx_öt_t
 
œ°
)

283 *
rv
;

284 *
c⁄f
, **
c⁄Â
;

285 
ngx_uöt_t
 
i
, 
mu…i
;

286 
ngx_°r_t
 *
«me
;

287 
ngx_comm™d_t
 *
cmd
;

289 
«me
 = 
cf
->
¨gs
->
ñts
;

291 
mu…i
 = 0;

293 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

297 i‡(
ngx_moduÀs
[
i
]->
ty≥
 !
NGX_CONF_MODULE


298 && 
ngx_moduÀs
[
i
]->
ty≥
 !
cf
->
moduÀ_ty≥
)

303 
cmd
 = 
ngx_moduÀs
[
i
]->
comm™ds
;

304 i‡(
cmd
 =
NULL
) {

308  ; 
cmd
->
«me
.
Àn
; cmd++) {

310 i‡(
«me
->
Àn
 !
cmd
->name.len) {

314 i‡(
	`ngx_°rcmp
(
«me
->
d©a
, 
cmd
->name.data) != 0) {

321 i‡(!(
cmd
->
ty≥
 & 
cf
->
cmd_ty≥
)) {

322 i‡(
cmd
->
ty≥
 & 
NGX_CONF_MULTI
) {

323 
mu…i
 = 1;

327 
nŸ_Ælowed
;

330 i‡(!(
cmd
->
ty≥
 & 
NGX_CONF_BLOCK
Ë&& 
œ°
 !
NGX_OK
) {

331 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

333 
«me
->
d©a
);

334  
NGX_ERROR
;

337 i‡((
cmd
->
ty≥
 & 
NGX_CONF_BLOCK
Ë&& 
œ°
 !
NGX_CONF_BLOCK_START
) {

338 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

340 
«me
->
d©a
);

341  
NGX_ERROR
;

346 i‡(!(
cmd
->
ty≥
 & 
NGX_CONF_ANY
)) {

348 i‡(
cmd
->
ty≥
 & 
NGX_CONF_FLAG
) {

350 i‡(
cf
->
¨gs
->
√…s
 != 2) {

351 
övÆid
;

354 } i‡(
cmd
->
ty≥
 & 
NGX_CONF_1MORE
) {

356 i‡(
cf
->
¨gs
->
√…s
 < 2) {

357 
övÆid
;

360 } i‡(
cmd
->
ty≥
 & 
NGX_CONF_2MORE
) {

362 i‡(
cf
->
¨gs
->
√…s
 < 3) {

363 
övÆid
;

366 } i‡(
cf
->
¨gs
->
√…s
 > 
NGX_CONF_MAX_ARGS
) {

368 
övÆid
;

370 } i‡(!(
cmd
->
ty≥
 & 
¨gumít_numbî
[
cf
->
¨gs
->
√…s
 - 1]))

372 
övÆid
;

378 
c⁄f
 = 
NULL
;

380 i‡(
cmd
->
ty≥
 & 
NGX_DIRECT_CONF
) {

381 
c⁄f
 = ((**Ë
cf
->
˘x
)[
ngx_moduÀs
[
i
]->
ödex
];

383 } i‡(
cmd
->
ty≥
 & 
NGX_MAIN_CONF
) {

384 
c⁄f
 = &(((**Ë
cf
->
˘x
)[
ngx_moduÀs
[
i
]->
ödex
]);

386 } i‡(
cf
->
˘x
) {

387 
c⁄Â
 = *(**Ë((*Ë
cf
->
˘x
 + 
cmd
->
c⁄f
);

389 i‡(
c⁄Â
) {

390 
c⁄f
 = 
c⁄Â
[
ngx_moduÀs
[
i
]->
˘x_ödex
];

394 
rv
 = 
cmd
->
	`£t
(
cf
, cmd, 
c⁄f
);

396 i‡(
rv
 =
NGX_CONF_OK
) {

397  
NGX_OK
;

400 i‡(
rv
 =
NGX_CONF_ERROR
) {

401  
NGX_ERROR
;

404 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

405 "\"%s\" dúe˘ivê%s", 
«me
->
d©a
, 
rv
);

407  
NGX_ERROR
;

411 i‡(
mu…i
 == 0) {

412 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

413 "unknow¿dúe˘ivê\"%s\"", 
«me
->
d©a
);

415  
NGX_ERROR
;

418 
nŸ_Ælowed
:

420 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

421 "\"%s\" dúe˘ivêi†nŸáŒowed hîe", 
«me
->
d©a
);

422  
NGX_ERROR
;

424 
övÆid
:

426 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

428 
«me
->
d©a
);

430  
NGX_ERROR
;

431 
	}
}

434 
ngx_öt_t


435 
	$ngx_c⁄f_ªad_tokí
(
ngx_c⁄f_t
 *
cf
)

437 
u_ch¨
 *
°¨t
, 
ch
, *
§c
, *
d°
;

438 
off_t
 
fûe_size
;

439 
size_t
 
Àn
;

440 
ssize_t
 
n
, 
size
;

441 
ngx_uöt_t
 
found
, 
√ed_•a˚
, 
œ°_•a˚
, 
sh¨p_commít
, 
v¨übÀ
;

442 
ngx_uöt_t
 
quŸed
, 
s_quŸed
, 
d_quŸed
, 
°¨t_löe
;

443 
ngx_°r_t
 *
w‹d
;

444 
ngx_buf_t
 *
b
;

446 
found
 = 0;

447 
√ed_•a˚
 = 0;

448 
œ°_•a˚
 = 1;

449 
sh¨p_commít
 = 0;

450 
v¨übÀ
 = 0;

451 
quŸed
 = 0;

452 
s_quŸed
 = 0;

453 
d_quŸed
 = 0;

455 
cf
->
¨gs
->
√…s
 = 0;

456 
b
 = 
cf
->
c⁄f_fûe
->
buf„r
;

457 
°¨t
 = 
b
->
pos
;

458 
°¨t_löe
 = 
cf
->
c⁄f_fûe
->
löe
;

460 
fûe_size
 = 
	`ngx_fûe_size
(&
cf
->
c⁄f_fûe
->
fûe
.
öfo
);

464 i‡(
b
->
pos
 >b->
œ°
) {

466 i‡(
cf
->
c⁄f_fûe
->
fûe
.
off£t
 >
fûe_size
) {

468 i‡(
cf
->
¨gs
->
√…s
 > 0 || !
œ°_•a˚
) {

470 i‡(
cf
->
c⁄f_fûe
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

471 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

474  
NGX_ERROR
;

477 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

480  
NGX_ERROR
;

483  
NGX_CONF_FILE_DONE
;

486 
Àn
 = 
b
->
pos
 - 
°¨t
;

488 i‡(
Àn
 =
NGX_CONF_BUFFER
) {

489 
cf
->
c⁄f_fûe
->
löe
 = 
°¨t_löe
;

491 i‡(
d_quŸed
) {

492 
ch
 = '"';

494 } i‡(
s_quŸed
) {

495 
ch
 = '\'';

498 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

500 10, 
°¨t
);

501  
NGX_ERROR
;

504 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

506 "missögÅîmö©ög \"%c\" ch¨a˘î", 
ch
);

507  
NGX_ERROR
;

510 i‡(
Àn
) {

511 
	`ngx_memmove
(
b
->
°¨t
, sèπ, 
Àn
);

514 
size
 = (
ssize_t
Ë(
fûe_size
 - 
cf
->
c⁄f_fûe
->
fûe
.
off£t
);

516 i‡(
size
 > 
b
->
íd
 - (b->
°¨t
 + 
Àn
)) {

517 
size
 = 
b
->
íd
 - (b->
°¨t
 + 
Àn
);

520 
n
 = 
	`ngx_ªad_fûe
(&
cf
->
c⁄f_fûe
->
fûe
, 
b
->
°¨t
 + 
Àn
, 
size
,

521 
cf
->
c⁄f_fûe
->
fûe
.
off£t
);

523 i‡(
n
 =
NGX_ERROR
) {

524  
NGX_ERROR
;

527 i‡(
n
 !
size
) {

528 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

529 
ngx_ªad_fûe_n
 "Ñeturned "

531 
n
, 
size
);

532  
NGX_ERROR
;

535 
b
->
pos
 = b->
°¨t
 + 
Àn
;

536 
b
->
œ°
 = b->
pos
 + 
n
;

537 
°¨t
 = 
b
->start;

540 
ch
 = *
b
->
pos
++;

542 i‡(
ch
 =
LF
) {

543 
cf
->
c⁄f_fûe
->
löe
++;

545 i‡(
sh¨p_commít
) {

546 
sh¨p_commít
 = 0;

550 i‡(
sh¨p_commít
) {

554 i‡(
quŸed
) {

555 
quŸed
 = 0;

559 i‡(
√ed_•a˚
) {

560 i‡(
ch
 =' ' || ch ='\t' || ch =
CR
 || ch =
LF
) {

561 
œ°_•a˚
 = 1;

562 
√ed_•a˚
 = 0;

566 i‡(
ch
 == ';') {

567  
NGX_OK
;

570 i‡(
ch
 == '{') {

571  
NGX_CONF_BLOCK_START
;

574 i‡(
ch
 == ')') {

575 
œ°_•a˚
 = 1;

576 
√ed_•a˚
 = 0;

579 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

580 "u√x≥˘ed \"%c\"", 
ch
);

581  
NGX_ERROR
;

585 i‡(
œ°_•a˚
) {

586 i‡(
ch
 =' ' || ch ='\t' || ch =
CR
 || ch =
LF
) {

590 
°¨t
 = 
b
->
pos
 - 1;

591 
°¨t_löe
 = 
cf
->
c⁄f_fûe
->
löe
;

593 
ch
) {

597 i‡(
cf
->
¨gs
->
√…s
 == 0) {

598 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

599 "u√x≥˘ed \"%c\"", 
ch
);

600  
NGX_ERROR
;

603 i‡(
ch
 == '{') {

604  
NGX_CONF_BLOCK_START
;

607  
NGX_OK
;

610 i‡(
cf
->
¨gs
->
√…s
 != 0) {

611 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

613  
NGX_ERROR
;

616  
NGX_CONF_BLOCK_DONE
;

619 
sh¨p_commít
 = 1;

623 
quŸed
 = 1;

624 
œ°_•a˚
 = 0;

628 
°¨t
++;

629 
d_quŸed
 = 1;

630 
œ°_•a˚
 = 0;

634 
°¨t
++;

635 
s_quŸed
 = 1;

636 
œ°_•a˚
 = 0;

640 
œ°_•a˚
 = 0;

644 i‡(
ch
 ='{' && 
v¨übÀ
) {

648 
v¨übÀ
 = 0;

650 i‡(
ch
 == '\\') {

651 
quŸed
 = 1;

655 i‡(
ch
 == '$') {

656 
v¨übÀ
 = 1;

660 i‡(
d_quŸed
) {

661 i‡(
ch
 == '"') {

662 
d_quŸed
 = 0;

663 
√ed_•a˚
 = 1;

664 
found
 = 1;

667 } i‡(
s_quŸed
) {

668 i‡(
ch
 == '\'') {

669 
s_quŸed
 = 0;

670 
√ed_•a˚
 = 1;

671 
found
 = 1;

674 } i‡(
ch
 =' ' || ch ='\t' || ch =
CR
 || ch =
LF


675 || 
ch
 == ';' || ch == '{')

677 
œ°_•a˚
 = 1;

678 
found
 = 1;

681 i‡(
found
) {

682 
w‹d
 = 
	`ngx_¨øy_push
(
cf
->
¨gs
);

683 i‡(
w‹d
 =
NULL
) {

684  
NGX_ERROR
;

687 
w‹d
->
d©a
 = 
	`ngx_≤Æloc
(
cf
->
poﬁ
, 
b
->
pos
 - 
°¨t
 + 1);

688 i‡(
w‹d
->
d©a
 =
NULL
) {

689  
NGX_ERROR
;

692 
d°
 = 
w‹d
->
d©a
, 
§c
 = 
°¨t
, 
Àn
 = 0;

693 
§c
 < 
b
->
pos
 - 1;

694 
Àn
++)

696 i‡(*
§c
 == '\\') {

697 
§c
[1]) {

701 
§c
++;

705 *
d°
++ = '\t';

706 
§c
 += 2;

710 *
d°
++ = '\r';

711 
§c
 += 2;

715 *
d°
++ = '\n';

716 
§c
 += 2;

721 *
d°
++ = *
§c
++;

723 *
d°
 = '\0';

724 
w‹d
->
Àn
 =Üen;

726 i‡(
ch
 == ';') {

727  
NGX_OK
;

730 i‡(
ch
 == '{') {

731  
NGX_CONF_BLOCK_START
;

734 
found
 = 0;

738 
	}
}

742 
	$ngx_c⁄f_ö˛ude
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

744 *
rv
;

745 
ngx_öt_t
 
n
;

746 
ngx_°r_t
 *
vÆue
, 
fûe
, 
«me
;

747 
ngx_glob_t
 
gl
;

749 
vÆue
 = 
cf
->
¨gs
->
ñts
;

750 
fûe
 = 
vÆue
[1];

752 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "ö˛udê%s", 
fûe
.
d©a
);

754 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cf
->
cy˛e
, &
fûe
, 1Ë!
NGX_OK
) {

755  
NGX_CONF_ERROR
;

758 i‡(
	`°Ωbrk
((*Ë
fûe
.
d©a
, "*?["Ë=
NULL
) {

760 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "ö˛udê%s", 
fûe
.
d©a
);

762  
	`ngx_c⁄f_∑r£
(
cf
, &
fûe
);

765 
	`ngx_memzîo
(&
gl
, (
ngx_glob_t
));

767 
gl
.
∑âîn
 = 
fûe
.
d©a
;

768 
gl
.
log
 = 
cf
->log;

769 
gl
.
ã°
 = 1;

771 i‡(
	`ngx_›í_glob
(&
gl
Ë!
NGX_OK
) {

772 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 
ngx_î∫o
,

773 
ngx_›í_glob_n
 " \"%s\" faûed", 
fûe
.
d©a
);

774  
NGX_CONF_ERROR
;

777 
rv
 = 
NGX_CONF_OK
;

780 
n
 = 
	`ngx_ªad_glob
(&
gl
, &
«me
);

782 i‡(
n
 !
NGX_OK
) {

786 
fûe
.
Àn
 = 
«me
.len++;

787 
fûe
.
d©a
 = 
	`ngx_p°rdup
(
cf
->
poﬁ
, &
«me
);

789 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
cf
->
log
, 0, "ö˛udê%s", 
fûe
.
d©a
);

791 
rv
 = 
	`ngx_c⁄f_∑r£
(
cf
, &
fûe
);

793 i‡(
rv
 !
NGX_CONF_OK
) {

798 
	`ngx_˛o£_glob
(&
gl
);

800  
rv
;

801 
	}
}

804 
ngx_öt_t


805 
	$ngx_c⁄f_fuŒ_«me
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_°r_t
 *
«me
, 
ngx_uöt_t
 
c⁄f_¥efix
)

807 
size_t
 
Àn
;

808 
u_ch¨
 *
p
, *
n
, *
¥efix
;

809 
ngx_öt_t
 
rc
;

811 
rc
 = 
	`ngx_c⁄f_ã°_fuŒ_«me
(
«me
);

813 i‡(
rc
 =
NGX_OK
) {

814  
rc
;

817 i‡(
c⁄f_¥efix
) {

818 
Àn
 = 
cy˛e
->
c⁄f_¥efix
.len;

819 
¥efix
 = 
cy˛e
->
c⁄f_¥efix
.
d©a
;

822 
Àn
 = 
cy˛e
->
¥efix
.len;

823 
¥efix
 = 
cy˛e
->¥efix.
d©a
;

826 #i‡(
NGX_WIN32
)

828 i‡(
rc
 == 2) {

829 
Àn
 = 
rc
;

834 
n
 = 
	`ngx_≤Æloc
(
cy˛e
->
poﬁ
, 
Àn
 + 
«me
->len + 1);

835 i‡(
n
 =
NULL
) {

836  
NGX_ERROR
;

839 
p
 = 
	`ngx_˝ymem
(
n
, 
¥efix
, 
Àn
);

840 
	`ngx_˝y°∫
(
p
, 
«me
->
d©a
,Çame->
Àn
 + 1);

842 
«me
->
Àn
 +=Üen;

843 
«me
->
d©a
 = 
n
;

845  
NGX_OK
;

846 
	}
}

849 
ngx_öt_t


850 
	$ngx_c⁄f_ã°_fuŒ_«me
(
ngx_°r_t
 *
«me
)

852 #i‡(
NGX_WIN32
)

853 
u_ch¨
 
c0
, 
c1
;

855 
c0
 = 
«me
->
d©a
[0];

857 i‡(
«me
->
Àn
 < 2) {

858 i‡(
c0
 == '/') {

862  
NGX_DECLINED
;

865 
c1
 = 
«me
->
d©a
[1];

867 i‡(
c1
 == ':') {

868 
c0
 |= 0x20;

870 i‡((
c0
 >= 'a' && c0 <= 'z')) {

871  
NGX_OK
;

874  
NGX_DECLINED
;

877 i‡(
c1
 == '/') {

878  
NGX_OK
;

881 i‡(
c0
 == '/') {

885  
NGX_DECLINED
;

889 i‡(
«me
->
d©a
[0] == '/') {

890  
NGX_OK
;

893  
NGX_DECLINED
;

896 
	}
}

899 
ngx_›í_fûe_t
 *

900 
	$ngx_c⁄f_›í_fûe
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_°r_t
 *
«me
)

902 
ngx_°r_t
 
fuŒ
;

903 
ngx_uöt_t
 
i
;

904 
ngx_li°_∑π_t
 *
∑π
;

905 
ngx_›í_fûe_t
 *
fûe
;

907 #i‡(
NGX_SUPPRESS_WARN
)

908 
	`ngx_°r_nuŒ
(&
fuŒ
);

911 i‡(
«me
->
Àn
) {

912 
fuŒ
 = *
«me
;

914 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cy˛e
, &
fuŒ
, 0Ë!
NGX_OK
) {

915  
NULL
;

918 
∑π
 = &
cy˛e
->
›í_fûes
.part;

919 
fûe
 = 
∑π
->
ñts
;

921 
i
 = 0; ; i++) {

923 i‡(
i
 >
∑π
->
√…s
) {

924 i‡(
∑π
->
√xt
 =
NULL
) {

927 
∑π
 =Ö¨t->
√xt
;

928 
fûe
 = 
∑π
->
ñts
;

929 
i
 = 0;

932 i‡(
fuŒ
.
Àn
 !
fûe
[
i
].
«me
.len) {

936 i‡(
	`ngx_°rcmp
(
fuŒ
.
d©a
, 
fûe
[
i
].
«me
.data) == 0) {

937  &
fûe
[
i
];

942 
fûe
 = 
	`ngx_li°_push
(&
cy˛e
->
›í_fûes
);

943 i‡(
fûe
 =
NULL
) {

944  
NULL
;

947 i‡(
«me
->
Àn
) {

948 
fûe
->
fd
 = 
NGX_INVALID_FILE
;

949 
fûe
->
«me
 = 
fuŒ
;

952 
fûe
->
fd
 = 
ngx_°dîr
;

953 
fûe
->
«me
 = *name;

956 
fûe
->
buf„r
 = 
NULL
;

958  
fûe
;

959 
	}
}

963 
	$ngx_c⁄f_Êush_fûes
(
ngx_cy˛e_t
 *
cy˛e
)

965 
ssize_t
 
n
, 
Àn
;

966 
ngx_uöt_t
 
i
;

967 
ngx_li°_∑π_t
 *
∑π
;

968 
ngx_›í_fûe_t
 *
fûe
;

970 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
cy˛e
->
log
, 0, "flush files");

972 
∑π
 = &
cy˛e
->
›í_fûes
.part;

973 
fûe
 = 
∑π
->
ñts
;

975 
i
 = 0; ; i++) {

977 i‡(
i
 >
∑π
->
√…s
) {

978 i‡(
∑π
->
√xt
 =
NULL
) {

981 
∑π
 =Ö¨t->
√xt
;

982 
fûe
 = 
∑π
->
ñts
;

983 
i
 = 0;

986 
Àn
 = 
fûe
[
i
].
pos
 - fûe[i].
buf„r
;

988 i‡(
fûe
[
i
].
buf„r
 =
NULL
 || 
Àn
 == 0) {

992 
n
 = 
	`ngx_wrôe_fd
(
fûe
[
i
].
fd
, fûe[i].
buf„r
, 
Àn
);

994 i‡(
n
 =
NGX_FILE_ERROR
) {

995 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

996 
ngx_wrôe_fd_n
 "Åo \"%s\" failed",

997 
fûe
[
i
].
«me
.
d©a
);

999 } i‡(
n
 !
Àn
) {

1000 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 0,

1001 
ngx_wrôe_fd_n
 "Åo \"%s\" was incomplete: %z of %uz",

1002 
fûe
[
i
].
«me
.
d©a
, 
n
, 
Àn
);

1005 
	}
}

1008 
ngx_cde˛


1009 
	$ngx_c⁄f_log_îr‹
(
ngx_uöt_t
 
Àvñ
, 
ngx_c⁄f_t
 *
cf
, 
ngx_îr_t
 
îr
,

1010 c⁄° *
fmt
, ...)

1012 
u_ch¨
 
îr°r
[
NGX_MAX_CONF_ERRSTR
], *
p
, *
œ°
;

1013 
va_li°
 
¨gs
;

1015 
œ°
 = 
îr°r
 + 
NGX_MAX_CONF_ERRSTR
;

1017 
	`va_°¨t
(
¨gs
, 
fmt
);

1018 
p
 = 
	`ngx_v¶¥ötf
(
îr°r
, 
œ°
, 
fmt
, 
¨gs
);

1019 
	`va_íd
(
¨gs
);

1021 i‡(
îr
) {

1022 
p
 = 
	`ngx_log_î∫o
’, 
œ°
, 
îr
);

1025 i‡(
cf
->
c⁄f_fûe
 =
NULL
) {

1026 
	`ngx_log_îr‹
(
Àvñ
, 
cf
->
log
, 0, "%*s", 
p
 - 
îr°r
,Érrstr);

1030 i‡(
cf
->
c⁄f_fûe
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

1031 
	`ngx_log_îr‹
(
Àvñ
, 
cf
->
log
, 0, "%*s in commandÜine",

1032 
p
 - 
îr°r
,Érrstr);

1036 
	`ngx_log_îr‹
(
Àvñ
, 
cf
->
log
, 0, "%*s in %s:%ui",

1037 
p
 - 
îr°r
,Érrstr,

1038 
cf
->
c⁄f_fûe
->
fûe
.
«me
.
d©a
, cf->c⁄f_fûe->
löe
);

1039 
	}
}

1043 
	$ngx_c⁄f_£t_Êag_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1045 *
p
 = 
c⁄f
;

1047 
ngx_°r_t
 *
vÆue
;

1048 
ngx_Êag_t
 *
Â
;

1049 
ngx_c⁄f_po°_t
 *
po°
;

1051 
Â
 = (
ngx_Êag_t
 *Ë(
p
 + 
cmd
->
off£t
);

1053 i‡(*
Â
 !
NGX_CONF_UNSET
) {

1057 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1059 i‡(
	`ngx_°rˇ£cmp
(
vÆue
[1].
d©a
, (
u_ch¨
 *) "on") == 0) {

1060 *
Â
 = 1;

1062 } i‡(
	`ngx_°rˇ£cmp
(
vÆue
[1].
d©a
, (
u_ch¨
 *) "off") == 0) {

1063 *
Â
 = 0;

1066 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1069 
vÆue
[1].
d©a
, 
cmd
->
«me
.data);

1070  
NGX_CONF_ERROR
;

1073 i‡(
cmd
->
po°
) {

1074 
po°
 = 
cmd
->post;

1075  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
Â
);

1078  
NGX_CONF_OK
;

1079 
	}
}

1083 
	$ngx_c⁄f_£t_°r_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1085 *
p
 = 
c⁄f
;

1087 
ngx_°r_t
 *
fõld
, *
vÆue
;

1088 
ngx_c⁄f_po°_t
 *
po°
;

1090 
fõld
 = (
ngx_°r_t
 *Ë(
p
 + 
cmd
->
off£t
);

1092 i‡(
fõld
->
d©a
) {

1096 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1098 *
fõld
 = 
vÆue
[1];

1100 i‡(
cmd
->
po°
) {

1101 
po°
 = 
cmd
->post;

1102  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
fõld
);

1105  
NGX_CONF_OK
;

1106 
	}
}

1110 
	$ngx_c⁄f_£t_°r_¨øy_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1112 *
p
 = 
c⁄f
;

1114 
ngx_°r_t
 *
vÆue
, *
s
;

1115 
ngx_¨øy_t
 **
a
;

1116 
ngx_c⁄f_po°_t
 *
po°
;

1118 
a
 = (
ngx_¨øy_t
 **Ë(
p
 + 
cmd
->
off£t
);

1120 i‡(*
a
 =
NGX_CONF_UNSET_PTR
) {

1121 *
a
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 4, (
ngx_°r_t
));

1122 i‡(*
a
 =
NULL
) {

1123  
NGX_CONF_ERROR
;

1127 
s
 = 
	`ngx_¨øy_push
(*
a
);

1128 i‡(
s
 =
NULL
) {

1129  
NGX_CONF_ERROR
;

1132 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1134 *
s
 = 
vÆue
[1];

1136 i‡(
cmd
->
po°
) {

1137 
po°
 = 
cmd
->post;

1138  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
s
);

1141  
NGX_CONF_OK
;

1142 
	}
}

1146 
	$ngx_c⁄f_£t_keyvÆ_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1148 *
p
 = 
c⁄f
;

1150 
ngx_°r_t
 *
vÆue
;

1151 
ngx_¨øy_t
 **
a
;

1152 
ngx_keyvÆ_t
 *
kv
;

1153 
ngx_c⁄f_po°_t
 *
po°
;

1155 
a
 = (
ngx_¨øy_t
 **Ë(
p
 + 
cmd
->
off£t
);

1157 i‡(*
a
 =
NULL
) {

1158 *
a
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 4, (
ngx_keyvÆ_t
));

1159 i‡(*
a
 =
NULL
) {

1160  
NGX_CONF_ERROR
;

1164 
kv
 = 
	`ngx_¨øy_push
(*
a
);

1165 i‡(
kv
 =
NULL
) {

1166  
NGX_CONF_ERROR
;

1169 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1171 
kv
->
key
 = 
vÆue
[1];

1172 
kv
->
vÆue
 = value[2];

1174 i‡(
cmd
->
po°
) {

1175 
po°
 = 
cmd
->post;

1176  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
kv
);

1179  
NGX_CONF_OK
;

1180 
	}
}

1184 
	$ngx_c⁄f_£t_num_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1186 *
p
 = 
c⁄f
;

1188 
ngx_öt_t
 *
≈
;

1189 
ngx_°r_t
 *
vÆue
;

1190 
ngx_c⁄f_po°_t
 *
po°
;

1193 
≈
 = (
ngx_öt_t
 *Ë(
p
 + 
cmd
->
off£t
);

1195 i‡(*
≈
 !
NGX_CONF_UNSET
) {

1199 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1200 *
≈
 = 
	`ngx_©oi
(
vÆue
[1].
d©a
, vÆue[1].
Àn
);

1201 i‡(*
≈
 =
NGX_ERROR
) {

1205 i‡(
cmd
->
po°
) {

1206 
po°
 = 
cmd
->post;

1207  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
≈
);

1210  
NGX_CONF_OK
;

1211 
	}
}

1215 
	$ngx_c⁄f_£t_size_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1217 *
p
 = 
c⁄f
;

1219 
size_t
 *
•
;

1220 
ngx_°r_t
 *
vÆue
;

1221 
ngx_c⁄f_po°_t
 *
po°
;

1224 
•
 = (
size_t
 *Ë(
p
 + 
cmd
->
off£t
);

1225 i‡(*
•
 !
NGX_CONF_UNSET_SIZE
) {

1229 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1231 *
•
 = 
	`ngx_∑r£_size
(&
vÆue
[1]);

1232 i‡(*
•
 =(
size_t
Ë
NGX_ERROR
) {

1236 i‡(
cmd
->
po°
) {

1237 
po°
 = 
cmd
->post;

1238  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
•
);

1241  
NGX_CONF_OK
;

1242 
	}
}

1246 
	$ngx_c⁄f_£t_off_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1248 *
p
 = 
c⁄f
;

1250 
off_t
 *
›
;

1251 
ngx_°r_t
 *
vÆue
;

1252 
ngx_c⁄f_po°_t
 *
po°
;

1255 
›
 = (
off_t
 *Ë(
p
 + 
cmd
->
off£t
);

1256 i‡(*
›
 !
NGX_CONF_UNSET
) {

1260 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1262 *
›
 = 
	`ngx_∑r£_off£t
(&
vÆue
[1]);

1263 i‡(*
›
 =(
off_t
Ë
NGX_ERROR
) {

1267 i‡(
cmd
->
po°
) {

1268 
po°
 = 
cmd
->post;

1269  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
›
);

1272  
NGX_CONF_OK
;

1273 
	}
}

1277 
	$ngx_c⁄f_£t_m£c_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1279 *
p
 = 
c⁄f
;

1281 
ngx_m£c_t
 *
m•
;

1282 
ngx_°r_t
 *
vÆue
;

1283 
ngx_c⁄f_po°_t
 *
po°
;

1286 
m•
 = (
ngx_m£c_t
 *Ë(
p
 + 
cmd
->
off£t
);

1287 i‡(*
m•
 !
NGX_CONF_UNSET_MSEC
) {

1291 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1293 *
m•
 = 
	`ngx_∑r£_time
(&
vÆue
[1], 0);

1294 i‡(*
m•
 =(
ngx_m£c_t
Ë
NGX_ERROR
) {

1298 i‡(
cmd
->
po°
) {

1299 
po°
 = 
cmd
->post;

1300  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
m•
);

1303  
NGX_CONF_OK
;

1304 
	}
}

1308 
	$ngx_c⁄f_£t_£c_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1310 *
p
 = 
c⁄f
;

1312 
time_t
 *
•
;

1313 
ngx_°r_t
 *
vÆue
;

1314 
ngx_c⁄f_po°_t
 *
po°
;

1317 
•
 = (
time_t
 *Ë(
p
 + 
cmd
->
off£t
);

1318 i‡(*
•
 !
NGX_CONF_UNSET
) {

1322 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1324 *
•
 = 
	`ngx_∑r£_time
(&
vÆue
[1], 1);

1325 i‡(*
•
 =(
time_t
Ë
NGX_ERROR
) {

1329 i‡(
cmd
->
po°
) {

1330 
po°
 = 
cmd
->post;

1331  
po°
->
	`po°_h™dÀr
(
cf
,Öo°, 
•
);

1334  
NGX_CONF_OK
;

1335 
	}
}

1339 
	$ngx_c⁄f_£t_bufs_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1341 *
p
 = 
c⁄f
;

1343 
ngx_°r_t
 *
vÆue
;

1344 
ngx_bufs_t
 *
bufs
;

1347 
bufs
 = (
ngx_bufs_t
 *Ë(
p
 + 
cmd
->
off£t
);

1348 i‡(
bufs
->
num
) {

1352 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1354 
bufs
->
num
 = 
	`ngx_©oi
(
vÆue
[1].
d©a
, vÆue[1].
Àn
);

1355 i‡(
bufs
->
num
 =
NGX_ERROR
 || bufs->num == 0) {

1359 
bufs
->
size
 = 
	`ngx_∑r£_size
(&
vÆue
[2]);

1360 i‡(
bufs
->
size
 =(
size_t
Ë
NGX_ERROR
 || bufs->size == 0) {

1364  
NGX_CONF_OK
;

1365 
	}
}

1369 
	$ngx_c⁄f_£t_íum_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1371 *
p
 = 
c⁄f
;

1373 
ngx_uöt_t
 *
≈
, 
i
;

1374 
ngx_°r_t
 *
vÆue
;

1375 
ngx_c⁄f_íum_t
 *
e
;

1377 
≈
 = (
ngx_uöt_t
 *Ë(
p
 + 
cmd
->
off£t
);

1379 i‡(*
≈
 !
NGX_CONF_UNSET_UINT
) {

1383 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1384 
e
 = 
cmd
->
po°
;

1386 
i
 = 0; 
e
[i].
«me
.
Àn
 != 0; i++) {

1387 i‡(
e
[
i
].
«me
.
Àn
 !
vÆue
[1].len

1388 || 
	`ngx_°rˇ£cmp
(
e
[
i
].
«me
.
d©a
, 
vÆue
[1].data) != 0)

1393 *
≈
 = 
e
[
i
].
vÆue
;

1395  
NGX_CONF_OK
;

1398 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1399 "övÆid vÆuê\"%s\"", 
vÆue
[1].
d©a
);

1401  
NGX_CONF_ERROR
;

1402 
	}
}

1406 
	$ngx_c⁄f_£t_bômask_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1408 *
p
 = 
c⁄f
;

1410 
ngx_uöt_t
 *
≈
, 
i
, 
m
;

1411 
ngx_°r_t
 *
vÆue
;

1412 
ngx_c⁄f_bômask_t
 *
mask
;

1415 
≈
 = (
ngx_uöt_t
 *Ë(
p
 + 
cmd
->
off£t
);

1416 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1417 
mask
 = 
cmd
->
po°
;

1419 
i
 = 1; i < 
cf
->
¨gs
->
√…s
; i++) {

1420 
m
 = 0; 
mask
[m].
«me
.
Àn
 != 0; m++) {

1422 i‡(
mask
[
m
].
«me
.
Àn
 !
vÆue
[
i
].len

1423 || 
	`ngx_°rˇ£cmp
(
mask
[
m
].
«me
.
d©a
, 
vÆue
[
i
].data) != 0)

1428 i‡(*
≈
 & 
mask
[
m
].mask) {

1429 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1430 "du∂iˇã vÆuê\"%s\"", 
vÆue
[
i
].
d©a
);

1433 *
≈
 |
mask
[
m
].mask;

1439 i‡(
mask
[
m
].
«me
.
Àn
 == 0) {

1440 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1441 "övÆid vÆuê\"%s\"", 
vÆue
[
i
].
d©a
);

1443  
NGX_CONF_ERROR
;

1447  
NGX_CONF_OK
;

1448 
	}
}

1452 
	$ngx_c⁄f_unsuµ‹ãd
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1455 
	}
}

1459 
	$ngx_c⁄f_dïªˇãd
(
ngx_c⁄f_t
 *
cf
, *
po°
, *
d©a
)

1461 
ngx_c⁄f_dïªˇãd_t
 *
d
 = 
po°
;

1463 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

1466 
d
->
ﬁd_«me
, d->
√w_«me
);

1468  
NGX_CONF_OK
;

1469 
	}
}

1473 
	$ngx_c⁄f_check_num_bounds
(
ngx_c⁄f_t
 *
cf
, *
po°
, *
d©a
)

1475 
ngx_c⁄f_num_bounds_t
 *
bounds
 = 
po°
;

1476 
ngx_öt_t
 *
≈
 = 
d©a
;

1478 i‡(
bounds
->
high
 == -1) {

1479 i‡(*
≈
 >
bounds
->
low
) {

1480  
NGX_CONF_OK
;

1483 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1485 
bounds
->
low
);

1487  
NGX_CONF_ERROR
;

1490 i‡(*
≈
 >
bounds
->
low
 && *≈ <bounds->
high
) {

1491  
NGX_CONF_OK
;

1494 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1496 
bounds
->
low
, bounds->
high
);

1498  
NGX_CONF_ERROR
;

1499 
	}
}

	@ngx_conf_file.h

8 #i‚de‡
_NGX_HTTP_CONF_FILE_H_INCLUDED_


9 
	#_NGX_HTTP_CONF_FILE_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

22 
	#NGX_CONF_NOARGS
 0x00000001

	)

23 
	#NGX_CONF_TAKE1
 0x00000002

	)

24 
	#NGX_CONF_TAKE2
 0x00000004

	)

25 
	#NGX_CONF_TAKE3
 0x00000008

	)

26 
	#NGX_CONF_TAKE4
 0x00000010

	)

27 
	#NGX_CONF_TAKE5
 0x00000020

	)

28 
	#NGX_CONF_TAKE6
 0x00000040

	)

29 
	#NGX_CONF_TAKE7
 0x00000080

	)

31 
	#NGX_CONF_MAX_ARGS
 8

	)

33 
	#NGX_CONF_TAKE12
 (
NGX_CONF_TAKE1
|
NGX_CONF_TAKE2
)

	)

34 
	#NGX_CONF_TAKE13
 (
NGX_CONF_TAKE1
|
NGX_CONF_TAKE3
)

	)

36 
	#NGX_CONF_TAKE23
 (
NGX_CONF_TAKE2
|
NGX_CONF_TAKE3
)

	)

38 
	#NGX_CONF_TAKE123
 (
NGX_CONF_TAKE1
|
NGX_CONF_TAKE2
|
NGX_CONF_TAKE3
)

	)

39 
	#NGX_CONF_TAKE1234
 (
NGX_CONF_TAKE1
|
NGX_CONF_TAKE2
|
NGX_CONF_TAKE3
 \

40 |
NGX_CONF_TAKE4
)

	)

42 
	#NGX_CONF_ARGS_NUMBER
 0x000000ff

	)

43 
	#NGX_CONF_BLOCK
 0x00000100

	)

44 
	#NGX_CONF_FLAG
 0x00000200

	)

45 
	#NGX_CONF_ANY
 0x00000400

	)

46 
	#NGX_CONF_1MORE
 0x00000800

	)

47 
	#NGX_CONF_2MORE
 0x00001000

	)

48 
	#NGX_CONF_MULTI
 0x00002000

	)

50 
	#NGX_DIRECT_CONF
 0x00010000

	)

52 
	#NGX_MAIN_CONF
 0x01000000

	)

53 
	#NGX_ANY_CONF
 0x0F000000

	)

57 
	#NGX_CONF_UNSET
 -1

	)

58 
	#NGX_CONF_UNSET_UINT
 (
ngx_uöt_t
Ë-1

	)

59 
	#NGX_CONF_UNSET_PTR
 (*Ë-1

	)

60 
	#NGX_CONF_UNSET_SIZE
 (
size_t
Ë-1

	)

61 
	#NGX_CONF_UNSET_MSEC
 (
ngx_m£c_t
Ë-1

	)

64 
	#NGX_CONF_OK
 
NULL


	)

65 
	#NGX_CONF_ERROR
 (*Ë-1

	)

67 
	#NGX_CONF_BLOCK_START
 1

	)

68 
	#NGX_CONF_BLOCK_DONE
 2

	)

69 
	#NGX_CONF_FILE_DONE
 3

	)

71 
	#NGX_CORE_MODULE
 0x45524F43

	)

72 
	#NGX_CONF_MODULE
 0x464E4F43

	)

75 
	#NGX_MAX_CONF_ERRSTR
 1024

	)

78 
	sngx_comm™d_s
 {

79 
ngx_°r_t
 
	m«me
;

80 
ngx_uöt_t
 
	mty≥
;

81 *(*
	m£t
)(
ngx_c⁄f_t
 *
	mcf
, 
ngx_comm™d_t
 *
	mcmd
, *
	mc⁄f
);

82 
ngx_uöt_t
 
	mc⁄f
;

83 
ngx_uöt_t
 
	moff£t
;

84 *
	mpo°
;

87 
	#ngx_nuŒ_comm™d
 { 
ngx_nuŒ_°rög
, 0, 
NULL
, 0, 0, NULL }

	)

90 
	sngx_›í_fûe_s
 {

91 
ngx_fd_t
 
	mfd
;

92 
ngx_°r_t
 
	m«me
;

94 
u_ch¨
 *
	mbuf„r
;

95 
u_ch¨
 *
	mpos
;

96 
u_ch¨
 *
	mœ°
;

100 
ngx_uöt_t
 
	mÊags
;

102 
ngx_uöt_t
 (*
h™dÀr
)(*
	md©a
, 
ngx_›í_fûe_t
 *
	mfûe
);

103 *
	md©a
;

108 
	#NGX_MODULE_V1
 0, 0, 0, 0, 0, 0, 1

	)

109 
	#NGX_MODULE_V1_PADDING
 0, 0, 0, 0, 0, 0, 0, 0

	)

111 
	sngx_moduÀ_s
 {

112 
ngx_uöt_t
 
	m˘x_ödex
;

113 
ngx_uöt_t
 
	mödex
;

115 
ngx_uöt_t
 
	m•¨e0
;

116 
ngx_uöt_t
 
	m•¨e1
;

117 
ngx_uöt_t
 
	m•¨e2
;

118 
ngx_uöt_t
 
	m•¨e3
;

120 
ngx_uöt_t
 
	mvîsi⁄
;

122 *
	m˘x
;

123 
ngx_comm™d_t
 *
	mcomm™ds
;

124 
ngx_uöt_t
 
	mty≥
;

126 
ngx_öt_t
 (*
öô_ma°î
)(
ngx_log_t
 *
	mlog
);

128 
ngx_öt_t
 (*
öô_moduÀ
)(
ngx_cy˛e_t
 *
	mcy˛e
);

130 
ngx_öt_t
 (*
öô_¥o˚ss
)(
ngx_cy˛e_t
 *
	mcy˛e
);

131 
ngx_öt_t
 (*
öô_thªad
)(
ngx_cy˛e_t
 *
	mcy˛e
);

132 (*
	mexô_thªad
)(
ngx_cy˛e_t
 *
	mcy˛e
);

133 (*
	mexô_¥o˚ss
)(
ngx_cy˛e_t
 *
	mcy˛e
);

135 (*
	mexô_ma°î
)(
ngx_cy˛e_t
 *
	mcy˛e
);

137 
uöçå_t
 
	m•¨e_hook0
;

138 
uöçå_t
 
	m•¨e_hook1
;

139 
uöçå_t
 
	m•¨e_hook2
;

140 
uöçå_t
 
	m•¨e_hook3
;

141 
uöçå_t
 
	m•¨e_hook4
;

142 
uöçå_t
 
	m•¨e_hook5
;

143 
uöçå_t
 
	m•¨e_hook6
;

144 
uöçå_t
 
	m•¨e_hook7
;

149 
ngx_°r_t
 
	m«me
;

150 *(*
	m¸óã_c⁄f
)(
ngx_cy˛e_t
 *
	mcy˛e
);

151 *(*
	möô_c⁄f
)(
ngx_cy˛e_t
 *
	mcy˛e
, *
	mc⁄f
);

152 } 
	tngx_c‹e_moduÀ_t
;

156 
ngx_fûe_t
 
	mfûe
;

157 
ngx_buf_t
 *
	mbuf„r
;

158 
ngx_uöt_t
 
	mlöe
;

159 } 
	tngx_c⁄f_fûe_t
;

162 *(*
	tngx_c⁄f_h™dÀr_±
)(
	tngx_c⁄f_t
 *
	tcf
,

163 
	tngx_comm™d_t
 *
	tdummy
, *
	tc⁄f
);

166 
	sngx_c⁄f_s
 {

167 *
	m«me
;

168 
ngx_¨øy_t
 *
	m¨gs
;

170 
ngx_cy˛e_t
 *
	mcy˛e
;

171 
ngx_poﬁ_t
 *
	mpoﬁ
;

172 
ngx_poﬁ_t
 *
	mãmp_poﬁ
;

173 
ngx_c⁄f_fûe_t
 *
	mc⁄f_fûe
;

174 
ngx_log_t
 *
	mlog
;

176 *
	m˘x
;

177 
ngx_uöt_t
 
	mmoduÀ_ty≥
;

178 
ngx_uöt_t
 
	mcmd_ty≥
;

180 
ngx_c⁄f_h™dÀr_±
 
	mh™dÀr
;

181 *
	mh™dÀr_c⁄f
;

185 *(*
	tngx_c⁄f_po°_h™dÀr_±
Ë(
	tngx_c⁄f_t
 *
	tcf
,

186 *
	td©a
, *
	tc⁄f
);

189 
ngx_c⁄f_po°_h™dÀr_±
 
	mpo°_h™dÀr
;

190 } 
	tngx_c⁄f_po°_t
;

194 
ngx_c⁄f_po°_h™dÀr_±
 
	mpo°_h™dÀr
;

195 *
	mﬁd_«me
;

196 *
	m√w_«me
;

197 } 
	tngx_c⁄f_dïªˇãd_t
;

201 
ngx_c⁄f_po°_h™dÀr_±
 
	mpo°_h™dÀr
;

202 
ngx_öt_t
 
	mlow
;

203 
ngx_öt_t
 
	mhigh
;

204 } 
	tngx_c⁄f_num_bounds_t
;

208 
ngx_°r_t
 
	m«me
;

209 
ngx_uöt_t
 
	mvÆue
;

210 } 
	tngx_c⁄f_íum_t
;

213 
	#NGX_CONF_BITMASK_SET
 1

	)

216 
ngx_°r_t
 
	m«me
;

217 
ngx_uöt_t
 
	mmask
;

218 } 
	tngx_c⁄f_bômask_t
;

222 * 
ngx_c⁄f_dïªˇãd
(
ngx_c⁄f_t
 *
cf
, *
po°
, *
d©a
);

223 *
ngx_c⁄f_check_num_bounds
(
ngx_c⁄f_t
 *
cf
, *
po°
, *
d©a
);

226 
	#ngx_gë_c⁄f
(
c⁄f_˘x
, 
moduÀ
Ëc⁄f_˘x[moduÀ.
ödex
]

	)

230 
	#ngx_c⁄f_öô_vÆue
(
c⁄f
, ) \

231 i‡(
c⁄f
 =
NGX_CONF_UNSET
) { \

232 
c⁄f
 = ; \

233 }

	)

235 
	#ngx_c⁄f_öô_±r_vÆue
(
c⁄f
, ) \

236 i‡(
c⁄f
 =
NGX_CONF_UNSET_PTR
) { \

237 
c⁄f
 = ; \

238 }

	)

240 
	#ngx_c⁄f_öô_uöt_vÆue
(
c⁄f
, ) \

241 i‡(
c⁄f
 =
NGX_CONF_UNSET_UINT
) { \

242 
c⁄f
 = ; \

243 }

	)

245 
	#ngx_c⁄f_öô_size_vÆue
(
c⁄f
, ) \

246 i‡(
c⁄f
 =
NGX_CONF_UNSET_SIZE
) { \

247 
c⁄f
 = ; \

248 }

	)

250 
	#ngx_c⁄f_öô_m£c_vÆue
(
c⁄f
, ) \

251 i‡(
c⁄f
 =
NGX_CONF_UNSET_MSEC
) { \

252 
c⁄f
 = ; \

253 }

	)

255 
	#ngx_c⁄f_mîge_vÆue
(
c⁄f
, 
¥ev
, ) \

256 i‡(
c⁄f
 =
NGX_CONF_UNSET
) { \

257 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET
) ?  :Örev; \

258 }

	)

260 
	#ngx_c⁄f_mîge_±r_vÆue
(
c⁄f
, 
¥ev
, ) \

261 i‡(
c⁄f
 =
NGX_CONF_UNSET_PTR
) { \

262 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET_PTR
) ?  :Örev; \

263 }

	)

265 
	#ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
, 
¥ev
, ) \

266 i‡(
c⁄f
 =
NGX_CONF_UNSET_UINT
) { \

267 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET_UINT
) ?  :Örev; \

268 }

	)

270 
	#ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
, 
¥ev
, ) \

271 i‡(
c⁄f
 =
NGX_CONF_UNSET_MSEC
) { \

272 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET_MSEC
) ?  :Örev; \

273 }

	)

275 
	#ngx_c⁄f_mîge_£c_vÆue
(
c⁄f
, 
¥ev
, ) \

276 i‡(
c⁄f
 =
NGX_CONF_UNSET
) { \

277 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET
) ?  :Örev; \

278 }

	)

280 
	#ngx_c⁄f_mîge_size_vÆue
(
c⁄f
, 
¥ev
, ) \

281 i‡(
c⁄f
 =
NGX_CONF_UNSET_SIZE
) { \

282 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET_SIZE
) ?  :Örev; \

283 }

	)

285 
	#ngx_c⁄f_mîge_off_vÆue
(
c⁄f
, 
¥ev
, ) \

286 i‡(
c⁄f
 =
NGX_CONF_UNSET
) { \

287 
c⁄f
 = (
¥ev
 =
NGX_CONF_UNSET
) ?  :Örev; \

288 }

	)

290 
	#ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
, 
¥ev
, ) \

291 i‡(
c⁄f
.
d©a
 =
NULL
) { \

292 i‡(
¥ev
.
d©a
) { \

293 
c⁄f
.
Àn
 = 
¥ev
.len; \

294 
c⁄f
.
d©a
 = 
¥ev
.data; \

296 
c⁄f
.
Àn
 = () - 1; \

297 
c⁄f
.
d©a
 = (
u_ch¨
 *) ; \

299 }

	)

301 
	#ngx_c⁄f_mîge_bufs_vÆue
(
c⁄f
, 
¥ev
, 
deÁu…_num
, 
deÁu…_size
) \

302 i‡(
c⁄f
.
num
 == 0) { \

303 i‡(
¥ev
.
num
) { \

304 
c⁄f
.
num
 = 
¥ev
.num; \

305 
c⁄f
.
size
 = 
¥ev
.size; \

307 
c⁄f
.
num
 = 
deÁu…_num
; \

308 
c⁄f
.
size
 = 
deÁu…_size
; \

310 }

	)

312 
	#ngx_c⁄f_mîge_bômask_vÆue
(
c⁄f
, 
¥ev
, ) \

313 i‡(
c⁄f
 == 0) { \

314 
c⁄f
 = (
¥ev
 == 0) ?  :Örev; \

315 }

	)

318 *
ngx_c⁄f_∑øm
(
ngx_c⁄f_t
 *
cf
);

319 *
ngx_c⁄f_∑r£
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
fûíame
);

322 
ngx_öt_t
 
ngx_c⁄f_fuŒ_«me
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_°r_t
 *
«me
,

323 
ngx_uöt_t
 
c⁄f_¥efix
);

324 
ngx_›í_fûe_t
 *
ngx_c⁄f_›í_fûe
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_°r_t
 *
«me
);

325 
ngx_cde˛
 
ngx_c⁄f_log_îr‹
(
ngx_uöt_t
 
Àvñ
, 
ngx_c⁄f_t
 *
cf
,

326 
ngx_îr_t
 
îr
, c⁄° *
fmt
, ...);

329 *
ngx_c⁄f_£t_Êag_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

330 *
ngx_c⁄f_£t_°r_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

331 *
ngx_c⁄f_£t_°r_¨øy_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

332 *
c⁄f
);

333 *
ngx_c⁄f_£t_keyvÆ_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

334 *
ngx_c⁄f_£t_num_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

335 *
ngx_c⁄f_£t_size_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

336 *
ngx_c⁄f_£t_off_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

337 *
ngx_c⁄f_£t_m£c_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

338 *
ngx_c⁄f_£t_£c_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

339 *
ngx_c⁄f_£t_bufs_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

340 *
ngx_c⁄f_£t_íum_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

341 *
ngx_c⁄f_£t_bômask_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

344 
ngx_uöt_t
 
ngx_max_moduÀ
;

345 
ngx_moduÀ_t
 *
ngx_moduÀs
[];

	@ngx_config.h

8 #i‚de‡
_NGX_CONFIG_H_INCLUDED_


9 
	#_NGX_CONFIG_H_INCLUDED_


	)

12 
	~<ngx_auto_hódîs.h
>

15 #i‡
deföed
 
__Døg⁄Fly__
 && !deföed 
__FªeBSD__


16 
	#__FªeBSD__
 4

	)

17 
	#__FªeBSD_vîsi⁄
 480101

	)

21 #i‡(
NGX_FREEBSD
)

22 
	~<ngx_‰ìbsd_c⁄fig.h
>

25 #ñi‡(
NGX_LINUX
)

26 
	~<ngx_löux_c⁄fig.h
>

29 #ñi‡(
NGX_SOLARIS
)

30 
	~<ngx_sﬁ¨is_c⁄fig.h
>

33 #ñi‡(
NGX_DARWIN
)

34 
	~<ngx_d¨wö_c⁄fig.h
>

37 #ñi‡(
NGX_WIN32
)

38 
	~<ngx_wö32_c⁄fig.h
>

42 
	~<ngx_posix_c⁄fig.h
>

47 #i‚de‡
NGX_HAVE_SO_SNDLOWAT


48 
	#NGX_HAVE_SO_SNDLOWAT
 1

	)

52 #i‡!(
NGX_WIN32
)

54 
	#ngx_sig«l_hñ≥r
(
n
Ë
SIG
##
	)
n

55 
	#ngx_sig«l_vÆue
(
n
Ë
	`ngx_sig«l_hñ≥r
“)

	)

57 
	#ngx_øndom
 
øndom


	)

60 
	#NGX_SHUTDOWN_SIGNAL
 
QUIT


	)

61 
	#NGX_TERMINATE_SIGNAL
 
TERM


	)

62 
	#NGX_NOACCEPT_SIGNAL
 
WINCH


	)

63 
	#NGX_RECONFIGURE_SIGNAL
 
HUP


	)

65 #i‡(
NGX_LINUXTHREADS
)

66 
	#NGX_REOPEN_SIGNAL
 
INFO


	)

67 
	#NGX_CHANGEBIN_SIGNAL
 
XCPU


	)

69 
	#NGX_REOPEN_SIGNAL
 
USR1


	)

70 
	#NGX_CHANGEBIN_SIGNAL
 
USR2


	)

73 
	#ngx_cde˛


	)

74 
	#ngx_libc_cde˛


	)

78 
öçå_t
 
	tngx_öt_t
;

79 
uöçå_t
 
	tngx_uöt_t
;

80 
öçå_t
 
	tngx_Êag_t
;

83 
	#NGX_INT32_LEN
 ("-2147483648"Ë- 1

	)

84 
	#NGX_INT64_LEN
 ("-9223372036854775808"Ë- 1

	)

86 #i‡(
NGX_PTR_SIZE
 == 4)

87 
	#NGX_INT_T_LEN
 
NGX_INT32_LEN


	)

89 
	#NGX_INT_T_LEN
 
NGX_INT64_LEN


	)

93 #i‚de‡
NGX_ALIGNMENT


94 
	#NGX_ALIGNMENT
 (Ë

	)

97 
	#ngx_Æign
(
d
, 
a
Ë(((dË+ (®- 1)Ë& ~◊ - 1))

	)

98 
	#ngx_Æign_±r
(
p
, 
a
) \

99 (
u_ch¨
 *Ë(((
uöçå_t
Ë(
p
Ë+ ((uöçå_tË
a
 - 1)Ë& ~((uöçå_tË®- 1))

	)

102 
	#ngx_ab‹t
 
ab‹t


	)

106 
	#NGX_INVALID_ARRAY_INDEX
 0x80000000

	)

110 #i‚de‡
ngx_ölöe


111 
	#ngx_ölöe
 
ölöe


	)

114 #i‚de‡
INADDR_NONE


115 
	#INADDR_NONE
 ((Ë-1)

	)

118 #ifde‡
MAXHOSTNAMELEN


119 
	#NGX_MAXHOSTNAMELEN
 
MAXHOSTNAMELEN


	)

121 
	#NGX_MAXHOSTNAMELEN
 256

	)

125 #i‡((
__GNU__
 =2Ë&& (
__GNUC_MINOR__
 < 8))

126 
	#NGX_MAX_UINT32_VALUE
 (
uöt32_t
Ë0xffffffffLL

	)

128 
	#NGX_MAX_UINT32_VALUE
 (
uöt32_t
Ë0xffffffff

	)

131 
	#NGX_MAX_INT32_VALUE
 (
uöt32_t
Ë0x7fffffff

	)

	@ngx_connection.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

10 
	~<ngx_evít.h
>

13 
ngx_os_io_t
 
	gngx_io
;

16 
ngx_døö_c⁄√˘i⁄s
();

19 
ngx_li°íög_t
 *

20 
	$ngx_¸óã_li°íög
(
ngx_c⁄f_t
 *
cf
, *
sockaddr
, 
sockÀn_t
 
sockÀn
)

22 
size_t
 
Àn
;

23 
ngx_li°íög_t
 *
ls
;

24 
sockaddr
 *
ß
;

25 
u_ch¨
 
ãxt
[
NGX_SOCKADDR_STRLEN
];

27 
ls
 = 
	`ngx_¨øy_push
(&
cf
->
cy˛e
->
li°íög
);

28 i‡(
ls
 =
NULL
) {

29  
NULL
;

32 
	`ngx_memzîo
(
ls
, (
ngx_li°íög_t
));

34 
ß
 = 
	`ngx_∑Œoc
(
cf
->
poﬁ
, 
sockÀn
);

35 i‡(
ß
 =
NULL
) {

36  
NULL
;

39 
	`ngx_mem˝y
(
ß
, 
sockaddr
, 
sockÀn
);

41 
ls
->
sockaddr
 = 
ß
;

42 
ls
->
sockÀn
 = socklen;

44 
Àn
 = 
	`ngx_sock_¡›
(
ß
, 
ãxt
, 
NGX_SOCKADDR_STRLEN
, 1);

45 
ls
->
addr_ãxt
.
Àn
 =Üen;

47 
ls
->
sockaddr
->
ß_Ámûy
) {

48 #i‡(
NGX_HAVE_INET6
)

49 
AF_INET6
:

50 
ls
->
addr_ãxt_max_Àn
 = 
NGX_INET6_ADDRSTRLEN
;

53 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

54 
AF_UNIX
:

55 
ls
->
addr_ãxt_max_Àn
 = 
NGX_UNIX_ADDRSTRLEN
;

56 
Àn
++;

59 
AF_INET
:

60 
ls
->
addr_ãxt_max_Àn
 = 
NGX_INET_ADDRSTRLEN
;

63 
ls
->
addr_ãxt_max_Àn
 = 
NGX_SOCKADDR_STRLEN
;

67 
ls
->
addr_ãxt
.
d©a
 = 
	`ngx_≤Æloc
(
cf
->
poﬁ
, 
Àn
);

68 i‡(
ls
->
addr_ãxt
.
d©a
 =
NULL
) {

69  
NULL
;

72 
	`ngx_mem˝y
(
ls
->
addr_ãxt
.
d©a
, 
ãxt
, 
Àn
);

74 
ls
->
fd
 = (
ngx_sockë_t
) -1;

75 
ls
->
ty≥
 = 
SOCK_STREAM
;

77 
ls
->
backlog
 = 
NGX_LISTEN_BACKLOG
;

78 
ls
->
rcvbuf
 = -1;

79 
ls
->
¢dbuf
 = -1;

81 #i‡(
NGX_HAVE_SETFIB
)

82 
ls
->
£tfib
 = -1;

85  
ls
;

86 
	}
}

89 
ngx_öt_t


90 
	$ngx_£t_öhîôed_sockës
(
ngx_cy˛e_t
 *
cy˛e
)

92 
size_t
 
Àn
;

93 
ngx_uöt_t
 
i
;

94 
ngx_li°íög_t
 *
ls
;

95 
sockÀn_t
 
ﬁí
;

96 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
SO_ACCEPTFILTER
)

97 
ngx_îr_t
 
îr
;

98 
ac˚±_fûãr_¨g
 
af
;

100 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
TCP_DEFER_ACCEPT
)

101 
timeout
;

104 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

105 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

107 
ls
[
i
].
sockaddr
 = 
	`ngx_∑Œoc
(
cy˛e
->
poﬁ
, 
NGX_SOCKADDRLEN
);

108 i‡(
ls
[
i
].
sockaddr
 =
NULL
) {

109  
NGX_ERROR
;

112 
ls
[
i
].
sockÀn
 = 
NGX_SOCKADDRLEN
;

113 i‡(
	`gësock«me
(
ls
[
i
].
fd
,Üs[i].
sockaddr
, &ls[i].
sockÀn
) == -1) {

114 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

116 "sockë #%d faûed", 
ls
[
i
].
fd
);

117 
ls
[
i
].
ign‹e
 = 1;

121 
ls
[
i
].
sockaddr
->
ß_Ámûy
) {

123 #i‡(
NGX_HAVE_INET6
)

124 
AF_INET6
:

125 
ls
[
i
].
addr_ãxt_max_Àn
 = 
NGX_INET6_ADDRSTRLEN
;

126 
Àn
 = 
NGX_INET6_ADDRSTRLEN
 + (":65535") - 1;

130 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

131 
AF_UNIX
:

132 
ls
[
i
].
addr_ãxt_max_Àn
 = 
NGX_UNIX_ADDRSTRLEN
;

133 
Àn
 = 
NGX_UNIX_ADDRSTRLEN
;

137 
AF_INET
:

138 
ls
[
i
].
addr_ãxt_max_Àn
 = 
NGX_INET_ADDRSTRLEN
;

139 
Àn
 = 
NGX_INET_ADDRSTRLEN
 + (":65535") - 1;

143 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

145 "™ unsuµ‹ãdÖrŸocﬁ famûy", 
ls
[
i
].
fd
);

146 
ls
[
i
].
ign‹e
 = 1;

150 
ls
[
i
].
addr_ãxt
.
d©a
 = 
	`ngx_≤Æloc
(
cy˛e
->
poﬁ
, 
Àn
);

151 i‡(
ls
[
i
].
addr_ãxt
.
d©a
 =
NULL
) {

152  
NGX_ERROR
;

155 
Àn
 = 
	`ngx_sock_¡›
(
ls
[
i
].
sockaddr
,Üs[i].
addr_ãxt
.
d©a
,Üen, 1);

156 i‡(
Àn
 == 0) {

157  
NGX_ERROR
;

160 
ls
[
i
].
addr_ãxt
.
Àn
 =Üen;

162 
ls
[
i
].
backlog
 = 
NGX_LISTEN_BACKLOG
;

164 
ﬁí
 = ();

166 i‡(
	`gësock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*Ë&ls[i].
rcvbuf
,

167 &
ﬁí
)

170 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

172 &
ls
[
i
].
addr_ãxt
);

174 
ls
[
i
].
rcvbuf
 = -1;

177 
ﬁí
 = ();

179 i‡(
	`gësock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*Ë&ls[i].
¢dbuf
,

180 &
ﬁí
)

183 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

185 &
ls
[
i
].
addr_ãxt
);

187 
ls
[
i
].
¢dbuf
 = -1;

193 #i‡(
NGX_HAVE_SETFIB
)

195 i‡(
	`gësock›t
(
ls
[
i
].
£tfib
, 
SOL_SOCKET
, 
SO_SETFIB
,

196 (*Ë&
ls
[
i
].
£tfib
, &
ﬁí
)

199 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

201 &
ls
[
i
].
addr_ãxt
);

203 
ls
[
i
].
£tfib
 = -1;

209 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
SO_ACCEPTFILTER
)

211 
	`ngx_memzîo
(&
af
, (
ac˚±_fûãr_¨g
));

212 
ﬁí
 = (
ac˚±_fûãr_¨g
);

214 i‡(
	`gësock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
, &
af
, &
ﬁí
)

217 
îr
 = 
ngx_î∫o
;

219 i‡(
îr
 =
NGX_EINVAL
) {

223 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
cy˛e
->
log
, 
îr
,

225 &
ls
[
i
].
addr_ãxt
);

229 i‡(
ﬁí
 < (
ac˚±_fûãr_¨g
Ë|| 
af
.
af_«me
[0] == '\0') {

233 
ls
[
i
].
ac˚±_fûãr
 = 
	`ngx_∑Œoc
(
cy˛e
->
poﬁ
, 16);

234 i‡(
ls
[
i
].
ac˚±_fûãr
 =
NULL
) {

235  
NGX_ERROR
;

238 (Ë
	`ngx_˝y°∫
((
u_ch¨
 *Ë
ls
[
i
].
ac˚±_fûãr
,

239 (
u_ch¨
 *Ë
af
.
af_«me
, 16);

242 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
TCP_DEFER_ACCEPT
)

244 
timeout
 = 0;

245 
ﬁí
 = ();

247 i‡(
	`gësock›t
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_DEFER_ACCEPT
, &
timeout
, &
ﬁí
)

250 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
cy˛e
->
log
, 
ngx_î∫o
,

252 &
ls
[
i
].
addr_ãxt
);

256 i‡(
ﬁí
 < (Ë|| 
timeout
 == 0) {

260 
ls
[
i
].
de„ºed_ac˚±
 = 1;

264  
NGX_OK
;

265 
	}
}

268 
ngx_öt_t


269 
	$ngx_›í_li°íög_sockës
(
ngx_cy˛e_t
 *
cy˛e
)

271 
ªu£addr
;

272 
ngx_uöt_t
 
i
, 
åõs
, 
Áûed
;

273 
ngx_îr_t
 
îr
;

274 
ngx_log_t
 *
log
;

275 
ngx_sockë_t
 
s
;

276 
ngx_li°íög_t
 *
ls
;

278 
ªu£addr
 = 1;

279 #i‡(
NGX_SUPPRESS_WARN
)

280 
Áûed
 = 0;

283 
log
 = 
cy˛e
->log;

287 
åõs
 = 5;Åries;Åries--) {

288 
Áûed
 = 0;

292 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

293 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

295 i‡(
ls
[
i
].
ign‹e
) {

299 i‡(
ls
[
i
].
fd
 != -1) {

303 i‡(
ls
[
i
].
öhîôed
) {

312 
s
 = 
	`ngx_sockë
(
ls
[
i
].
sockaddr
->
ß_Ámûy
,Üs[i].
ty≥
, 0);

314 i‡(
s
 == -1) {

315 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

316 
ngx_sockë_n
 " %V faûed", &
ls
[
i
].
addr_ãxt
);

317  
NGX_ERROR
;

320 i‡(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

321 (c⁄° *Ë&
ªu£addr
, ())

324 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

326 &
ls
[
i
].
addr_ãxt
);

328 i‡(
	`ngx_˛o£_sockë
(
s
) == -1) {

329 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

330 
ngx_˛o£_sockë_n
 " %V failed",

331 &
ls
[
i
].
addr_ãxt
);

334  
NGX_ERROR
;

337 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

339 i‡(
ls
[
i
].
sockaddr
->
ß_Ámûy
 =
AF_INET6
 &&Üs[i].
ùv6⁄ly
) {

340 
ùv6⁄ly
;

342 
ùv6⁄ly
 = (
ls
[
i
].ipv6only == 1);

344 i‡(
	`£tsock›t
(
s
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
,

345 (c⁄° *Ë&
ùv6⁄ly
, ())

348 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

350 &
ls
[
i
].
addr_ãxt
);

356 i‡(!(
ngx_evít_Êags
 & 
NGX_USE_AIO_EVENT
)) {

357 i‡(
	`ngx_n⁄blockög
(
s
) == -1) {

358 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

359 
ngx_n⁄blockög_n
 " %V failed",

360 &
ls
[
i
].
addr_ãxt
);

362 i‡(
	`ngx_˛o£_sockë
(
s
) == -1) {

363 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

364 
ngx_˛o£_sockë_n
 " %V failed",

365 &
ls
[
i
].
addr_ãxt
);

368  
NGX_ERROR
;

372 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

373 "böd(Ë%V #%d ", &
ls
[
i
].
addr_ãxt
, 
s
);

375 i‡(
	`böd
(
s
, 
ls
[
i
].
sockaddr
,Üs[i].
sockÀn
) == -1) {

376 
îr
 = 
ngx_sockë_î∫o
;

378 i‡(
îr
 =
NGX_EADDRINUSE
 && 
ngx_ã°_c⁄fig
) {

382 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
îr
,

383 "böd(Ëtÿ%V faûed", &
ls
[
i
].
addr_ãxt
);

385 i‡(
	`ngx_˛o£_sockë
(
s
) == -1) {

386 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

387 
ngx_˛o£_sockë_n
 " %V failed",

388 &
ls
[
i
].
addr_ãxt
);

391 i‡(
îr
 !
NGX_EADDRINUSE
) {

392  
NGX_ERROR
;

395 
Áûed
 = 1;

400 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

402 i‡(
ls
[
i
].
sockaddr
->
ß_Ámûy
 =
AF_UNIX
) {

403 
mode_t
 
mode
;

404 
u_ch¨
 *
«me
;

406 
«me
 = 
ls
[
i
].
addr_ãxt
.
d©a
 + ("unix:") - 1;

407 
mode
 = (
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IWGRP
|
S_IROTH
|
S_IWOTH
);

409 i‡(
	`chmod
((*Ë
«me
, 
mode
) == -1) {

410 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

411 "chmod(Ë\"%s\" faûed", 
«me
);

414 i‡(
ngx_ã°_c⁄fig
) {

415 i‡(
	`ngx_dñëe_fûe
(
«me
) == -1) {

416 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

417 
ngx_dñëe_fûe_n
 " %†Áûed", 
«me
);

423 i‡(
	`li°í
(
s
, 
ls
[
i
].
backlog
) == -1) {

424 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

426 &
ls
[
i
].
addr_ãxt
,Üs[i].
backlog
);

428 i‡(
	`ngx_˛o£_sockë
(
s
) == -1) {

429 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

430 
ngx_˛o£_sockë_n
 " %V failed",

431 &
ls
[
i
].
addr_ãxt
);

434  
NGX_ERROR
;

437 
ls
[
i
].
li°í
 = 1;

439 
ls
[
i
].
fd
 = 
s
;

442 i‡(!
Áûed
) {

448 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
log
, 0,

451 
	`ngx_m¶ìp
(500);

454 i‡(
Áûed
) {

455 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 0, "still couldÇot bind()");

456  
NGX_ERROR
;

459  
NGX_OK
;

460 
	}
}

464 
	$ngx_c⁄figuª_li°íög_sockës
(
ngx_cy˛e_t
 *
cy˛e
)

466 
kì∑live
;

467 
ngx_uöt_t
 
i
;

468 
ngx_li°íög_t
 *
ls
;

470 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
SO_ACCEPTFILTER
)

471 
ac˚±_fûãr_¨g
 
af
;

473 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
TCP_DEFER_ACCEPT
)

474 
timeout
;

477 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

478 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

480 
ls
[
i
].
log
 = *ls[i].
logp
;

482 i‡(
ls
[
i
].
rcvbuf
 != -1) {

483 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
,

484 (c⁄° *Ë&
ls
[
i
].
rcvbuf
, ())

487 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

489 
ls
[
i
].
rcvbuf
, &ls[i].
addr_ãxt
);

493 i‡(
ls
[
i
].
¢dbuf
 != -1) {

494 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
,

495 (c⁄° *Ë&
ls
[
i
].
¢dbuf
, ())

498 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

500 
ls
[
i
].
¢dbuf
, &ls[i].
addr_ãxt
);

504 i‡(
ls
[
i
].
kì∑live
) {

505 
kì∑live
 = (
ls
[
i
].keepalive == 1) ? 1 : 0;

507 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
,

508 (c⁄° *Ë&
kì∑live
, ())

511 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

513 
kì∑live
, &
ls
[
i
].
addr_ãxt
);

517 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

519 i‡(
ls
[
i
].
kìpidÀ
) {

520 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
,

521 (c⁄° *Ë&
ls
[
i
].
kìpidÀ
, ())

524 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

526 
ls
[
i
].
kìpidÀ
, &ls[i].
addr_ãxt
);

530 i‡(
ls
[
i
].
kìpötvl
) {

531 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
,

532 (c⁄° *Ë&
ls
[
i
].
kìpötvl
, ())

535 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

537 
ls
[
i
].
kìpötvl
, &ls[i].
addr_ãxt
);

541 i‡(
ls
[
i
].
kìp˙t
) {

542 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
,

543 (c⁄° *Ë&
ls
[
i
].
kìp˙t
, ())

546 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

548 
ls
[
i
].
kìp˙t
, &ls[i].
addr_ãxt
);

554 #i‡(
NGX_HAVE_SETFIB
)

555 i‡(
ls
[
i
].
£tfib
 != -1) {

556 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_SETFIB
,

557 (c⁄° *Ë&
ls
[
i
].
£tfib
, ())

560 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

562 
ls
[
i
].
£tfib
, &ls[i].
addr_ãxt
);

569 
t˝_nodñay
 = 1;

571 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

572 (c⁄° *Ë&
t˝_nodñay
, ())

575 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

577 &
ls
[
i
].
addr_ãxt
);

582 i‡(
ls
[
i
].
li°í
) {

586 i‡(
	`li°í
(
ls
[
i
].
fd
,Üs[i].
backlog
) == -1) {

587 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

589 &
ls
[
i
].
addr_ãxt
,Üs[i].
backlog
);

598 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
)

600 #ifde‡
SO_ACCEPTFILTER


602 i‡(
ls
[
i
].
dñëe_de„ºed
) {

603 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
, 
NULL
, 0)

606 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

609 &
ls
[
i
].
addr_ãxt
);

611 i‡(
ls
[
i
].
ac˚±_fûãr
) {

612 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 0,

615 
ls
[
i
].
ac˚±_fûãr
, &ls[i].
addr_ãxt
);

621 
ls
[
i
].
de„ºed_ac˚±
 = 0;

624 i‡(
ls
[
i
].
add_de„ºed
) {

625 
	`ngx_memzîo
(&
af
, (
ac˚±_fûãr_¨g
));

626 (Ë
	`ngx_˝y°∫
((
u_ch¨
 *Ë
af
.
af_«me
,

627 (
u_ch¨
 *Ë
ls
[
i
].
ac˚±_fûãr
, 16);

629 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
,

630 &
af
, (
ac˚±_fûãr_¨g
))

633 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

636 
ls
[
i
].
ac˚±_fûãr
, &ls[i].
addr_ãxt
);

640 
ls
[
i
].
de„ºed_ac˚±
 = 1;

645 #ifde‡
TCP_DEFER_ACCEPT


647 i‡(
ls
[
i
].
add_de„ºed
 ||Üs[i].
dñëe_de„ºed
) {

649 i‡(
ls
[
i
].
add_de„ºed
) {

650 
timeout
 = (Ë(
ls
[
i
].
po°_ac˚±_timeout
 / 1000);

653 
timeout
 = 0;

656 i‡(
	`£tsock›t
(
ls
[
i
].
fd
, 
IPPROTO_TCP
, 
TCP_DEFER_ACCEPT
,

657 &
timeout
, ())

660 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

663 
timeout
, &
ls
[
i
].
addr_ãxt
);

669 i‡(
ls
[
i
].
add_de„ºed
) {

670 
ls
[
i
].
de„ºed_ac˚±
 = 1;

679 
	}
}

683 
	$ngx_˛o£_li°íög_sockës
(
ngx_cy˛e_t
 *
cy˛e
)

685 
ngx_uöt_t
 
i
;

686 
ngx_li°íög_t
 *
ls
;

687 
ngx_c⁄√˘i⁄_t
 *
c
;

689 i‡(
ngx_evít_Êags
 & 
NGX_USE_IOCP_EVENT
) {

693 
ngx_ac˚±_muãx_hñd
 = 0;

694 
ngx_u£_ac˚±_muãx
 = 0;

696 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

697 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

699 
c
 = 
ls
[
i
].
c⁄√˘i⁄
;

701 i‡(
c
) {

702 i‡(
c
->
ªad
->
a˘ive
) {

703 i‡(
ngx_evít_Êags
 & 
NGX_USE_RTSIG_EVENT
) {

704 
	`ngx_dñ_c⁄n
(
c
, 
NGX_CLOSE_EVENT
);

706 } i‡(
ngx_evít_Êags
 & 
NGX_USE_EPOLL_EVENT
) {

714 
	`ngx_dñ_evít
(
c
->
ªad
, 
NGX_READ_EVENT
, 0);

717 
	`ngx_dñ_evít
(
c
->
ªad
, 
NGX_READ_EVENT
, 
NGX_CLOSE_EVENT
);

721 
	`ngx_‰ì_c⁄√˘i⁄
(
c
);

723 
c
->
fd
 = (
ngx_sockë_t
) -1;

726 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
cy˛e
->
log
, 0,

727 "˛o£Üi°íög %V #%d ", &
ls
[
i
].
addr_ãxt
,Üs[i].
fd
);

729 i‡(
	`ngx_˛o£_sockë
(
ls
[
i
].
fd
) == -1) {

730 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

731 
ngx_˛o£_sockë_n
 " %V faûed", &
ls
[
i
].
addr_ãxt
);

734 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

736 i‡(
ls
[
i
].
sockaddr
->
ß_Ámûy
 =
AF_UNIX


737 && 
ngx_¥o˚ss
 <
NGX_PROCESS_MASTER


738 && 
ngx_√w_bö¨y
 == 0)

740 
u_ch¨
 *
«me
 = 
ls
[
i
].
addr_ãxt
.
d©a
 + ("unix:") - 1;

742 i‡(
	`ngx_dñëe_fûe
(
«me
) == -1) {

743 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

744 
ngx_dñëe_fûe_n
 " %†Áûed", 
«me
);

750 
ls
[
i
].
fd
 = (
ngx_sockë_t
) -1;

752 
	}
}

755 
ngx_c⁄√˘i⁄_t
 *

756 
	$ngx_gë_c⁄√˘i⁄
(
ngx_sockë_t
 
s
, 
ngx_log_t
 *
log
)

758 
ngx_uöt_t
 
ö°™˚
;

759 
ngx_evít_t
 *
ªv
, *
wev
;

760 
ngx_c⁄√˘i⁄_t
 *
c
;

764 i‡(
ngx_cy˛e
->
fûes
 && (
ngx_uöt_t
Ë
s
 >ngx_cy˛e->
fûes_n
) {

765 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 0,

768 
s
, 
ngx_cy˛e
->
fûes_n
);

769  
NULL
;

774 
c
 = 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄s
;

776 i‡(
c
 =
NULL
) {

777 
	`ngx_døö_c⁄√˘i⁄s
();

778 
c
 = 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄s
;

781 i‡(
c
 =
NULL
) {

782 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 0,

784 
ngx_cy˛e
->
c⁄√˘i⁄_n
);

788  
NULL
;

791 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄s
 = 
c
->
d©a
;

792 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄_n
--;

796 i‡(
ngx_cy˛e
->
fûes
) {

797 
ngx_cy˛e
->
fûes
[
s
] = 
c
;

800 
ªv
 = 
c
->
ªad
;

801 
wev
 = 
c
->
wrôe
;

803 
	`ngx_memzîo
(
c
, (
ngx_c⁄√˘i⁄_t
));

805 
c
->
ªad
 = 
ªv
;

806 
c
->
wrôe
 = 
wev
;

807 
c
->
fd
 = 
s
;

808 
c
->
log
 =Üog;

810 
ö°™˚
 = 
ªv
->instance;

812 
	`ngx_memzîo
(
ªv
, (
ngx_evít_t
));

813 
	`ngx_memzîo
(
wev
, (
ngx_evít_t
));

815 
ªv
->
ö°™˚
 = !instance;

816 
wev
->
ö°™˚
 = !instance;

818 
ªv
->
ödex
 = 
NGX_INVALID_INDEX
;

819 
wev
->
ödex
 = 
NGX_INVALID_INDEX
;

821 
ªv
->
d©a
 = 
c
;

822 
wev
->
d©a
 = 
c
;

824 
wev
->
wrôe
 = 1;

826  
c
;

827 
	}
}

831 
	$ngx_‰ì_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
)

835 
c
->
d©a
 = 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄s
;

836 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄s
 = 
c
;

837 
ngx_cy˛e
->
‰ì_c⁄√˘i⁄_n
++;

841 i‡(
ngx_cy˛e
->
fûes
) {

842 
ngx_cy˛e
->
fûes
[
c
->
fd
] = 
NULL
;

844 
	}
}

848 
	$ngx_˛o£_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
)

850 
ngx_îr_t
 
îr
;

851 
ngx_uöt_t
 
log_îr‹
, 
Àvñ
;

852 
ngx_sockë_t
 
fd
;

854 i‡(
c
->
fd
 == -1) {

855 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
c
->
log
, 0, "connectionálready closed");

859 i‡(
c
->
ªad
->
timî_£t
) {

860 
	`ngx_dñ_timî
(
c
->
ªad
);

863 i‡(
c
->
wrôe
->
timî_£t
) {

864 
	`ngx_dñ_timî
(
c
->
wrôe
);

867 i‡(
ngx_dñ_c⁄n
) {

868 
	`ngx_dñ_c⁄n
(
c
, 
NGX_CLOSE_EVENT
);

871 i‡(
c
->
ªad
->
a˘ive
 || c->ªad->
dißbÀd
) {

872 
	`ngx_dñ_evít
(
c
->
ªad
, 
NGX_READ_EVENT
, 
NGX_CLOSE_EVENT
);

875 i‡(
c
->
wrôe
->
a˘ive
 || c->wrôe->
dißbÀd
) {

876 
	`ngx_dñ_evít
(
c
->
wrôe
, 
NGX_WRITE_EVENT
, 
NGX_CLOSE_EVENT
);

880 #i‡(
NGX_THREADS
)

888 
	`ngx_muãx_lock
(
ngx_po°ed_evíts_muãx
);

890 i‡(
c
->
ªad
->
¥ev
) {

891 
	`ngx_dñëe_po°ed_evít
(
c
->
ªad
);

894 i‡(
c
->
wrôe
->
¥ev
) {

895 
	`ngx_dñëe_po°ed_evít
(
c
->
wrôe
);

898 
c
->
ªad
->
˛o£d
 = 1;

899 
c
->
wrôe
->
˛o£d
 = 1;

901 i‡(
c
->
sögÀ_c⁄√˘i⁄
) {

902 
	`ngx_u∆ock
(&
c
->
lock
);

903 
c
->
ªad
->
locked
 = 0;

904 
c
->
wrôe
->
locked
 = 0;

907 
	`ngx_muãx_u∆ock
(
ngx_po°ed_evíts_muãx
);

911 i‡(
c
->
ªad
->
¥ev
) {

912 
	`ngx_dñëe_po°ed_evít
(
c
->
ªad
);

915 i‡(
c
->
wrôe
->
¥ev
) {

916 
	`ngx_dñëe_po°ed_evít
(
c
->
wrôe
);

919 
c
->
ªad
->
˛o£d
 = 1;

920 
c
->
wrôe
->
˛o£d
 = 1;

924 
	`ngx_ªußbÀ_c⁄√˘i⁄
(
c
, 0);

926 
log_îr‹
 = 
c
->log_error;

928 
	`ngx_‰ì_c⁄√˘i⁄
(
c
);

930 
fd
 = 
c
->fd;

931 
c
->
fd
 = (
ngx_sockë_t
) -1;

933 i‡(
	`ngx_˛o£_sockë
(
fd
) == -1) {

935 
îr
 = 
ngx_sockë_î∫o
;

937 i‡(
îr
 =
NGX_ECONNRESET
 ||Éº =
NGX_ENOTCONN
) {

939 
log_îr‹
) {

941 
NGX_ERROR_INFO
:

942 
Àvñ
 = 
NGX_LOG_INFO
;

945 
NGX_ERROR_ERR
:

946 
Àvñ
 = 
NGX_LOG_ERR
;

950 
Àvñ
 = 
NGX_LOG_CRIT
;

954 
Àvñ
 = 
NGX_LOG_CRIT
;

959 
	`ngx_log_îr‹
(
Àvñ
, 
ngx_cy˛e
->
log
, 
îr
,

960 
ngx_˛o£_sockë_n
 " %d faûed", 
fd
);

962 
	}
}

966 
	$ngx_ªußbÀ_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_uöt_t
 
ªußbÀ
)

968 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

969 "ªußbÀ c⁄√˘i⁄: %ui", 
ªußbÀ
);

971 i‡(
c
->
ªußbÀ
) {

972 
	`ngx_queue_ªmove
(&
c
->
queue
);

975 
c
->
ªußbÀ
 =Ñeusable;

977 i‡(
ªußbÀ
) {

980 
	`ngx_queue_ö£π_hód
(

981 (
ngx_queue_t
 *Ë&
ngx_cy˛e
->
ªußbÀ_c⁄√˘i⁄s_queue
, &
c
->
queue
);

983 
	}
}

987 
	$ngx_døö_c⁄√˘i⁄s
()

989 
ngx_öt_t
 
i
;

990 
ngx_queue_t
 *
q
;

991 
ngx_c⁄√˘i⁄_t
 *
c
;

993 
i
 = 0; i < 32; i++) {

994 i‡(
	`ngx_queue_em±y
(&
ngx_cy˛e
->
ªußbÀ_c⁄√˘i⁄s_queue
)) {

998 
q
 = 
	`ngx_queue_œ°
(&
ngx_cy˛e
->
ªußbÀ_c⁄√˘i⁄s_queue
);

999 
c
 = 
	`ngx_queue_d©a
(
q
, 
ngx_c⁄√˘i⁄_t
, 
queue
);

1001 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

1004 
c
->
˛o£
 = 1;

1005 
c
->
ªad
->
	`h™dÀr
(c->read);

1007 
	}
}

1010 
ngx_öt_t


1011 
	$ngx_c⁄√˘i⁄_loˇl_sockaddr
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_°r_t
 *
s
,

1012 
ngx_uöt_t
 
p‹t
)

1014 
sockÀn_t
 
Àn
;

1015 
ngx_uöt_t
 
addr
;

1016 
u_ch¨
 
ß
[
NGX_SOCKADDRLEN
];

1017 
sockaddr_ö
 *
sö
;

1018 #i‡(
NGX_HAVE_INET6
)

1019 
ngx_uöt_t
 
i
;

1020 
sockaddr_ö6
 *
sö6
;

1023 
c
->
loˇl_sockaddr
->
ß_Ámûy
) {

1025 #i‡(
NGX_HAVE_INET6
)

1026 
AF_INET6
:

1027 
sö6
 = (
sockaddr_ö6
 *Ë
c
->
loˇl_sockaddr
;

1029 
addr
 = 0, 
i
 = 0;áddr == 0 && i < 16; i++) {

1030 
addr
 |
sö6
->
sö6_addr
.
s6_addr
[
i
];

1037 
sö
 = (
sockaddr_ö
 *Ë
c
->
loˇl_sockaddr
;

1038 
addr
 = 
sö
->
sö_addr
.
s_addr
;

1042 i‡(
addr
 == 0) {

1044 
Àn
 = 
NGX_SOCKADDRLEN
;

1046 i‡(
	`gësock«me
(
c
->
fd
, (
sockaddr
 *Ë&
ß
, &
Àn
) == -1) {

1047 
	`ngx_c⁄√˘i⁄_îr‹
(
c
, 
ngx_sockë_î∫o
, "getsockname() failed");

1048  
NGX_ERROR
;

1051 
c
->
loˇl_sockaddr
 = 
	`ngx_∑Œoc
(c->
poﬁ
, 
Àn
);

1052 i‡(
c
->
loˇl_sockaddr
 =
NULL
) {

1053  
NGX_ERROR
;

1056 
	`ngx_mem˝y
(
c
->
loˇl_sockaddr
, &
ß
, 
Àn
);

1059 i‡(
s
 =
NULL
) {

1060  
NGX_OK
;

1063 
s
->
Àn
 = 
	`ngx_sock_¡›
(
c
->
loˇl_sockaddr
, s->
d©a
, s->Àn, 
p‹t
);

1065  
NGX_OK
;

1066 
	}
}

1069 
ngx_öt_t


1070 
	$ngx_c⁄√˘i⁄_îr‹
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_îr_t
 
îr
, *
ãxt
)

1072 
ngx_uöt_t
 
Àvñ
;

1076 i‡((
îr
 =
NGX_ECONNRESET


1077 #i‡(
NGX_WIN32
)

1078 || 
îr
 =
NGX_ECONNABORTED


1080 Ë&& 
c
->
log_îr‹
 =
NGX_ERROR_IGNORE_ECONNRESET
)

1085 #i‡(
NGX_SOLARIS
)

1086 i‡(
îr
 =
NGX_EINVAL
 && 
c
->
log_îr‹
 =
NGX_ERROR_IGNORE_EINVAL
) {

1091 i‡(
îr
 == 0

1092 || 
îr
 =
NGX_ECONNRESET


1093 #i‡(
NGX_WIN32
)

1094 || 
îr
 =
NGX_ECONNABORTED


1096 || 
îr
 =
NGX_EPIPE


1098 || 
îr
 =
NGX_ENOTCONN


1099 || 
îr
 =
NGX_ETIMEDOUT


1100 || 
îr
 =
NGX_ECONNREFUSED


1101 || 
îr
 =
NGX_ENETDOWN


1102 || 
îr
 =
NGX_ENETUNREACH


1103 || 
îr
 =
NGX_EHOSTDOWN


1104 || 
îr
 =
NGX_EHOSTUNREACH
)

1106 
c
->
log_îr‹
) {

1108 
NGX_ERROR_IGNORE_EINVAL
:

1109 
NGX_ERROR_IGNORE_ECONNRESET
:

1110 
NGX_ERROR_INFO
:

1111 
Àvñ
 = 
NGX_LOG_INFO
;

1115 
Àvñ
 = 
NGX_LOG_ERR
;

1119 
Àvñ
 = 
NGX_LOG_ALERT
;

1122 
	`ngx_log_îr‹
(
Àvñ
, 
c
->
log
, 
îr
, 
ãxt
);

1124  
NGX_ERROR
;

1125 
	}
}

	@ngx_connection.h

8 #i‚de‡
_NGX_CONNECTION_H_INCLUDED_


9 
	#_NGX_CONNECTION_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
ngx_li°íög_s
 
	tngx_li°íög_t
;

18 
	sngx_li°íög_s
 {

19 
ngx_sockë_t
 
	mfd
;

21 
sockaddr
 *
	msockaddr
;

22 
sockÀn_t
 
	msockÀn
;

23 
size_t
 
	maddr_ãxt_max_Àn
;

24 
ngx_°r_t
 
	maddr_ãxt
;

26 
	mty≥
;

28 
	mbacklog
;

29 
	mrcvbuf
;

30 
	m¢dbuf
;

31 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

32 
	mkìpidÀ
;

33 
	mkìpötvl
;

34 
	mkìp˙t
;

38 
ngx_c⁄√˘i⁄_h™dÀr_±
 
	mh™dÀr
;

40 *
	m£rvîs
;

42 
ngx_log_t
 
	mlog
;

43 
ngx_log_t
 *
	mlogp
;

45 
size_t
 
	mpoﬁ_size
;

47 
size_t
 
	mpo°_ac˚±_buf„r_size
;

49 
ngx_m£c_t
 
	mpo°_ac˚±_timeout
;

51 
ngx_li°íög_t
 *
	m¥evious
;

52 
ngx_c⁄√˘i⁄_t
 *
	mc⁄√˘i⁄
;

54 
	m›í
:1;

55 
	mªmaö
:1;

56 
	mign‹e
:1;

58 
	mbound
:1;

59 
	möhîôed
:1;

60 
	mn⁄blockög_ac˚±
:1;

61 
	mli°í
:1;

62 
	mn⁄blockög
:1;

63 
	msh¨ed
:1;

64 
	maddr_¡›
:1;

66 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

67 
	mùv6⁄ly
:2;

69 
	mkì∑live
:2;

71 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
)

72 
	mde„ºed_ac˚±
:1;

73 
	mdñëe_de„ºed
:1;

74 
	madd_de„ºed
:1;

75 #ifde‡
SO_ACCEPTFILTER


76 *
	mac˚±_fûãr
;

79 #i‡(
NGX_HAVE_SETFIB
)

80 
	m£tfib
;

87 
	mNGX_ERROR_ALERT
 = 0,

88 
	mNGX_ERROR_ERR
,

89 
	mNGX_ERROR_INFO
,

90 
	mNGX_ERROR_IGNORE_ECONNRESET
,

91 
	mNGX_ERROR_IGNORE_EINVAL


92 } 
	tngx_c⁄√˘i⁄_log_îr‹_e
;

96 
	mNGX_TCP_NODELAY_UNSET
 = 0,

97 
	mNGX_TCP_NODELAY_SET
,

98 
	mNGX_TCP_NODELAY_DISABLED


99 } 
	tngx_c⁄√˘i⁄_t˝_nodñay_e
;

103 
	mNGX_TCP_NOPUSH_UNSET
 = 0,

104 
	mNGX_TCP_NOPUSH_SET
,

105 
	mNGX_TCP_NOPUSH_DISABLED


106 } 
	tngx_c⁄√˘i⁄_t˝_n›ush_e
;

109 
	#NGX_LOWLEVEL_BUFFERED
 0x0f

	)

110 
	#NGX_SSL_BUFFERED
 0x01

	)

113 
	sngx_c⁄√˘i⁄_s
 {

114 *
	md©a
;

115 
ngx_evít_t
 *
	mªad
;

116 
ngx_evít_t
 *
	mwrôe
;

118 
ngx_sockë_t
 
	mfd
;

120 
ngx_ªcv_±
 
	mªcv
;

121 
ngx_£nd_±
 
	m£nd
;

122 
ngx_ªcv_chaö_±
 
	mªcv_chaö
;

123 
ngx_£nd_chaö_±
 
	m£nd_chaö
;

125 
ngx_li°íög_t
 *
	mli°íög
;

127 
off_t
 
	m£¡
;

129 
ngx_log_t
 *
	mlog
;

131 
ngx_poﬁ_t
 *
	mpoﬁ
;

133 
sockaddr
 *
	msockaddr
;

134 
sockÀn_t
 
	msockÀn
;

135 
ngx_°r_t
 
	maddr_ãxt
;

137 #i‡(
NGX_SSL
)

138 
ngx_s¶_c⁄√˘i⁄_t
 *
	ms¶
;

141 
sockaddr
 *
	mloˇl_sockaddr
;

143 
ngx_buf_t
 *
	mbuf„r
;

145 
ngx_queue_t
 
	mqueue
;

147 
ngx_©omic_uöt_t
 
	mnumbî
;

149 
ngx_uöt_t
 
	mªque°s
;

151 
	mbuf„ªd
:8;

153 
	mlog_îr‹
:3;

155 
	msögÀ_c⁄√˘i⁄
:1;

156 
	mu√x≥˘ed_eof
:1;

157 
	mtimedout
:1;

158 
	mîr‹
:1;

159 
	mde°royed
:1;

161 
	midÀ
:1;

162 
	mªußbÀ
:1;

163 
	m˛o£
:1;

165 
	m£ndfûe
:1;

166 
	m¢dlow©
:1;

167 
	mt˝_nodñay
:2;

168 
	mt˝_n›ush
:2;

170 #i‡(
NGX_HAVE_IOCP
)

171 
	mac˚±_c⁄ãxt_upd©ed
:1;

174 #i‡(
NGX_HAVE_AIO_SENDFILE
)

175 
	maio_£ndfûe
:1;

176 
ngx_buf_t
 *
	mbusy_£ndfûe
;

179 #i‡(
NGX_THREADS
)

180 
ngx_©omic_t
 
	mlock
;

185 
ngx_li°íög_t
 *
ngx_¸óã_li°íög
(
ngx_c⁄f_t
 *
cf
, *
sockaddr
,

186 
sockÀn_t
 
sockÀn
);

187 
ngx_öt_t
 
ngx_£t_öhîôed_sockës
(
ngx_cy˛e_t
 *
cy˛e
);

188 
ngx_öt_t
 
ngx_›í_li°íög_sockës
(
ngx_cy˛e_t
 *
cy˛e
);

189 
ngx_c⁄figuª_li°íög_sockës
(
ngx_cy˛e_t
 *
cy˛e
);

190 
ngx_˛o£_li°íög_sockës
(
ngx_cy˛e_t
 *
cy˛e
);

191 
ngx_˛o£_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
);

192 
ngx_öt_t
 
ngx_c⁄√˘i⁄_loˇl_sockaddr
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_°r_t
 *
s
,

193 
ngx_uöt_t
 
p‹t
);

194 
ngx_öt_t
 
ngx_c⁄√˘i⁄_îr‹
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_îr_t
 
îr
, *
ãxt
);

196 
ngx_c⁄√˘i⁄_t
 *
ngx_gë_c⁄√˘i⁄
(
ngx_sockë_t
 
s
, 
ngx_log_t
 *
log
);

197 
ngx_‰ì_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
);

199 
ngx_ªußbÀ_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_uöt_t
 
ªußbÀ
);

	@ngx_core.h

8 #i‚de‡
_NGX_CORE_H_INCLUDED_


9 
	#_NGX_CORE_H_INCLUDED_


	)

12 
ngx_moduÀ_s
 
	tngx_moduÀ_t
;

13 
ngx_c⁄f_s
 
	tngx_c⁄f_t
;

14 
ngx_cy˛e_s
 
	tngx_cy˛e_t
;

15 
ngx_poﬁ_s
 
	tngx_poﬁ_t
;

16 
ngx_chaö_s
 
	tngx_chaö_t
;

17 
ngx_log_s
 
	tngx_log_t
;

18 
ngx_¨øy_s
 
	tngx_¨øy_t
;

19 
ngx_›í_fûe_s
 
	tngx_›í_fûe_t
;

20 
ngx_comm™d_s
 
	tngx_comm™d_t
;

21 
ngx_fûe_s
 
	tngx_fûe_t
;

22 
ngx_evít_s
 
	tngx_evít_t
;

23 
ngx_evít_aio_s
 
	tngx_evít_aio_t
;

24 
ngx_c⁄√˘i⁄_s
 
	tngx_c⁄√˘i⁄_t
;

26 (*
	tngx_evít_h™dÀr_±
)(
	tngx_evít_t
 *
	tev
);

27 (*
	tngx_c⁄√˘i⁄_h™dÀr_±
)(
	tngx_c⁄√˘i⁄_t
 *
	tc
);

30 
	#NGX_OK
 0

	)

31 
	#NGX_ERROR
 -1

	)

32 
	#NGX_AGAIN
 -2

	)

33 
	#NGX_BUSY
 -3

	)

34 
	#NGX_DONE
 -4

	)

35 
	#NGX_DECLINED
 -5

	)

36 
	#NGX_ABORT
 -6

	)

39 
	~<ngx_î∫o.h
>

40 
	~<ngx_©omic.h
>

41 
	~<ngx_thªad.h
>

42 
	~<ngx_rbåì.h
>

43 
	~<ngx_time.h
>

44 
	~<ngx_sockë.h
>

45 
	~<ngx_°rög.h
>

46 
	~<ngx_fûes.h
>

47 
	~<ngx_shmem.h
>

48 
	~<ngx_¥o˚ss.h
>

49 
	~<ngx_u£r.h
>

50 
	~<ngx_∑r£.h
>

51 
	~<ngx_log.h
>

52 
	~<ngx_Æloc.h
>

53 
	~<ngx_∑Œoc.h
>

54 
	~<ngx_buf.h
>

55 
	~<ngx_queue.h
>

56 
	~<ngx_¨øy.h
>

57 
	~<ngx_li°.h
>

58 
	~<ngx_hash.h
>

59 
	~<ngx_fûe.h
>

60 
	~<ngx_¸c.h
>

61 
	~<ngx_¸c32.h
>

62 
	~<ngx_murmurhash.h
>

63 #i‡(
NGX_PCRE
)

64 
	~<ngx_ªgex.h
>

66 
	~<ngx_ødix_åì.h
>

67 
	~<ngx_times.h
>

68 
	~<ngx_shmtx.h
>

69 
	~<ngx_¶ab.h
>

70 
	~<ngx_öë.h
>

71 
	~<ngx_cy˛e.h
>

72 #i‡(
NGX_OPENSSL
)

73 
	~<ngx_evít_›ís¶.h
>

75 
	~<ngx_¥o˚ss_cy˛e.h
>

76 
	~<ngx_c⁄f_fûe.h
>

77 
	~<ngx_ªsﬁvî.h
>

78 
	~<ngx_›í_fûe_ˇche.h
>

79 
	~<ngx_os.h
>

80 
	~<ngx_c⁄√˘i⁄.h
>

83 
	#LF
 (
u_ch¨
Ë10

	)

84 
	#CR
 (
u_ch¨
Ë13

	)

85 
	#CRLF
 "\x0d\x0a"

	)

88 
	#ngx_abs
(
vÆue
Ë(((vÆueË>0Ë? (vÆueË: - (vÆue))

	)

89 
	#ngx_max
(
vÆ1
, 
vÆ2
Ë((vÆ1 < vÆ2Ë? (vÆ2Ë: (vÆ1))

	)

90 
	#ngx_mö
(
vÆ1
, 
vÆ2
Ë((vÆ1 > vÆ2Ë? (vÆ2Ë: (vÆ1))

	)

92 
	`ngx_˝uöfo
();

94 #i‡(
NGX_HAVE_OPENAT
)

95 
	#NGX_DISABLE_SYMLINKS_OFF
 0

	)

96 
	#NGX_DISABLE_SYMLINKS_ON
 1

	)

97 
	#NGX_DISABLE_SYMLINKS_NOTOWNER
 2

	)

	@ngx_cpuinfo.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 #i‡(–
__i386__
 || 
__amd64__
 ) && ( 
__GNUC__
 || 
__INTEL_COMPILER
 ))

15 
ngx_ölöe
 
ngx_˝uid
(
uöt32_t
 
i
, uöt32_à*
buf
);

18 #i‡–
__i386__
 )

20 
ngx_ölöe
 

21 
	$ngx_˝uid
(
uöt32_t
 
i
, uöt32_à*
buf
)

30 
	`__asm__
 (

42 : : "a" (
i
), "D" (
buf
) : "ecx", "edx", "esi", "memory" );

43 
	}
}

49 
ngx_ölöe
 

50 
	$ngx_˝uid
(
uöt32_t
 
i
, uöt32_à*
buf
)

52 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

54 
	`__asm__
 (

58 : "˜" (
óx
), "=b" (
ebx
), "=c" (
ecx
), "=d" (
edx
Ë: "a" (
i
) );

60 
buf
[0] = 
óx
;

61 
buf
[1] = 
ebx
;

62 
buf
[2] = 
edx
;

63 
buf
[3] = 
ecx
;

64 
	}
}

73 
	$ngx_˝uöfo
()

75 
u_ch¨
 *
víd‹
;

76 
uöt32_t
 
vbuf
[5], 
˝u
[4], 
modñ
;

78 
vbuf
[0] = 0;

79 
vbuf
[1] = 0;

80 
vbuf
[2] = 0;

81 
vbuf
[3] = 0;

82 
vbuf
[4] = 0;

84 
	`ngx_˝uid
(0, 
vbuf
);

86 
víd‹
 = (
u_ch¨
 *Ë&
vbuf
[1];

88 i‡(
vbuf
[0] == 0) {

92 
	`ngx_˝uid
(1, 
˝u
);

94 i‡(
	`ngx_°rcmp
(
víd‹
, "GenuineIntel") == 0) {

96 (
˝u
[0] & 0xf00) >> 8) {

100 
ngx_ˇchñöe_size
 = 32;

105 
ngx_ˇchñöe_size
 = 32;

107 
modñ
 = ((
˝u
[0] & 0xf0000) >> 8) | (cpu[0] & 0xf0);

109 i‡(
modñ
 >= 0xd0) {

111 
ngx_ˇchñöe_size
 = 64;

121 
ngx_ˇchñöe_size
 = 128;

125 } i‡(
	`ngx_°rcmp
(
víd‹
, "AuthenticAMD") == 0) {

126 
ngx_ˇchñöe_size
 = 64;

128 
	}
}

134 
	$ngx_˝uöfo
()

136 
	}
}

	@ngx_crc.h

8 #i‚de‡
_NGX_CRC_H_INCLUDED_


9 
	#_NGX_CRC_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

18 
ngx_ölöe
 
uöt32_t


19 
	$ngx_¸c
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
)

21 
uöt32_t
 
sum
;

23 
sum
 = 0; 
Àn
;Üen--) {

30 
sum
 = sum >> 1 | sum << 31;

32 
sum
 +*
d©a
++;

35  
sum
;

36 
	}
}

	@ngx_crc32.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

26 
uöt32_t
 
	gngx_¸c32_èbÀ16
[] = {

34 
uöt32_t
 
	gngx_¸c32_èbÀ256
[] = {

102 
uöt32_t
 *
	gngx_¸c32_èbÀ_sh‹t
 = 
ngx_¸c32_èbÀ16
;

105 
ngx_öt_t


106 
	$ngx_¸c32_èbÀ_öô
()

108 *
p
;

110 i‡(((
uöçå_t
Ë
ngx_¸c32_èbÀ_sh‹t


111 & ~((
uöçå_t
Ë
ngx_ˇchñöe_size
 - 1))

112 =(
uöçå_t
Ë
ngx_¸c32_èbÀ_sh‹t
)

114  
NGX_OK
;

117 
p
 = 
	`ngx_Æloc
(16 * (
uöt32_t
Ë+ 
ngx_ˇchñöe_size
, 
ngx_cy˛e
->
log
);

118 i‡(
p
 =
NULL
) {

119  
NGX_ERROR
;

122 
p
 = 
	`ngx_Æign_±r
’, 
ngx_ˇchñöe_size
);

124 
	`ngx_mem˝y
(
p
, 
ngx_¸c32_èbÀ16
, 16 * (
uöt32_t
));

126 
ngx_¸c32_èbÀ_sh‹t
 = 
p
;

128  
NGX_OK
;

129 
	}
}

	@ngx_crc32.h

8 #i‚de‡
_NGX_CRC32_H_INCLUDED_


9 
	#_NGX_CRC32_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
uöt32_t
 *
ngx_¸c32_èbÀ_sh‹t
;

17 
uöt32_t
 
ngx_¸c32_èbÀ256
[];

20 
ngx_ölöe
 
uöt32_t


21 
	$ngx_¸c32_sh‹t
(
u_ch¨
 *
p
, 
size_t
 
Àn
)

23 
u_ch¨
 
c
;

24 
uöt32_t
 
¸c
;

26 
¸c
 = 0xffffffff;

28 
Àn
--) {

29 
c
 = *
p
++;

30 
¸c
 = 
ngx_¸c32_èbÀ_sh‹t
[(¸¯^ (
c
 & 0xf)) & 0xf] ^ (crc >> 4);

31 
¸c
 = 
ngx_¸c32_èbÀ_sh‹t
[(¸¯^ (
c
 >> 4)) & 0xf] ^ (crc >> 4);

34  
¸c
 ^ 0xffffffff;

35 
	}
}

38 
ngx_ölöe
 
uöt32_t


39 
	$ngx_¸c32_l⁄g
(
u_ch¨
 *
p
, 
size_t
 
Àn
)

41 
uöt32_t
 
¸c
;

43 
¸c
 = 0xffffffff;

45 
Àn
--) {

46 
¸c
 = 
ngx_¸c32_èbÀ256
[(¸¯^ *
p
++) & 0xff] ^ (crc >> 8);

49  
¸c
 ^ 0xffffffff;

50 
	}
}

53 
	#ngx_¸c32_öô
(
¸c
) \

54 
¸c
 = 0xffffffff

	)

57 
ngx_ölöe
 

58 
	$ngx_¸c32_upd©e
(
uöt32_t
 *
¸c
, 
u_ch¨
 *
p
, 
size_t
 
Àn
)

60 
uöt32_t
 
c
;

62 
c
 = *
¸c
;

64 
Àn
--) {

65 
c
 = 
ngx_¸c32_èbÀ256
[(¯^ *
p
++) & 0xff] ^ (c >> 8);

68 *
¸c
 = 
c
;

69 
	}
}

72 
	#ngx_¸c32_föÆ
(
¸c
) \

73 
¸c
 ^0xffffffff

	)

76 
ngx_öt_t
 
ngx_¸c32_èbÀ_öô
();

	@ngx_crypt.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_md5.h
>

10 #i‡(
NGX_HAVE_SHA1
)

11 
	~<ngx_sha1.h
>

15 #i‡(
NGX_CRYPT
)

17 
ngx_öt_t
 
ngx_¸y±_≠r1
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
,

18 
u_ch¨
 **
í¸y±ed
);

19 
ngx_öt_t
 
ngx_¸y±_∂aö
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
,

20 
u_ch¨
 **
í¸y±ed
);

22 #i‡(
NGX_HAVE_SHA1
)

24 
ngx_öt_t
 
ngx_¸y±_ssha
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
,

25 
u_ch¨
 **
í¸y±ed
);

30 
u_ch¨
 *
ngx_¸y±_to64
(u_ch¨ *
p
, 
uöt32_t
 
v
, 
size_t
 
n
);

33 
ngx_öt_t


34 
	$ngx_¸y±
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
, u_ch¨ **
í¸y±ed
)

36 i‡(
	`ngx_°∫cmp
(
ß…
, "$apr1$", ("$apr1$") - 1) == 0) {

37  
	`ngx_¸y±_≠r1
(
poﬁ
, 
key
, 
ß…
, 
í¸y±ed
);

39 } i‡(
	`ngx_°∫cmp
(
ß…
, "{PLAIN}", ("{PLAIN}") - 1) == 0) {

40  
	`ngx_¸y±_∂aö
(
poﬁ
, 
key
, 
ß…
, 
í¸y±ed
);

42 #i‡(
NGX_HAVE_SHA1
)

43 } i‡(
	`ngx_°∫cmp
(
ß…
, "{SSHA}", ("{SSHA}") - 1) == 0) {

44  
	`ngx_¸y±_ssha
(
poﬁ
, 
key
, 
ß…
, 
í¸y±ed
);

50  
	`ngx_libc_¸y±
(
poﬁ
, 
key
, 
ß…
, 
í¸y±ed
);

51 
	}
}

54 
ngx_öt_t


55 
	$ngx_¸y±_≠r1
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
, u_ch¨ **
í¸y±ed
)

57 
ngx_öt_t
 
n
;

58 
ngx_uöt_t
 
i
;

59 
u_ch¨
 *
p
, *
œ°
, 
föÆ
[16];

60 
size_t
 
ß…Àn
, 
keyÀn
;

61 
ngx_md5_t
 
md5
, 
˘x1
;

65 
keyÀn
 = 
	`ngx_°æí
(
key
);

69 
ß…
 += ("$apr1$") - 1;

70 
œ°
 = 
ß…
 + 8;

71 
p
 = 
ß…
; *∞&& *∞!'$' &&Ö < 
œ°
;Ö++) { }

72 
ß…Àn
 = 
p
 - 
ß…
;

76 
	`ngx_md5_öô
(&
md5
);

77 
	`ngx_md5_upd©e
(&
md5
, 
key
, 
keyÀn
);

78 
	`ngx_md5_upd©e
(&
md5
, (
u_ch¨
 *) "$apr1$", ("$apr1$") - 1);

79 
	`ngx_md5_upd©e
(&
md5
, 
ß…
, 
ß…Àn
);

81 
	`ngx_md5_öô
(&
˘x1
);

82 
	`ngx_md5_upd©e
(&
˘x1
, 
key
, 
keyÀn
);

83 
	`ngx_md5_upd©e
(&
˘x1
, 
ß…
, 
ß…Àn
);

84 
	`ngx_md5_upd©e
(&
˘x1
, 
key
, 
keyÀn
);

85 
	`ngx_md5_föÆ
(
föÆ
, &
˘x1
);

87 
n
 = 
keyÀn
;Ç > 0;Ç -= 16) {

88 
	`ngx_md5_upd©e
(&
md5
, 
föÆ
, 
n
 > 16 ? 16 :Ç);

91 
	`ngx_memzîo
(
föÆ
, (final));

93 
i
 = 
keyÀn
; i; i >>= 1) {

94 i‡(
i
 & 1) {

95 
	`ngx_md5_upd©e
(&
md5
, 
föÆ
, 1);

98 
	`ngx_md5_upd©e
(&
md5
, 
key
, 1);

102 
	`ngx_md5_föÆ
(
föÆ
, &
md5
);

104 
i
 = 0; i < 1000; i++) {

105 
	`ngx_md5_öô
(&
˘x1
);

107 i‡(
i
 & 1) {

108 
	`ngx_md5_upd©e
(&
˘x1
, 
key
, 
keyÀn
);

111 
	`ngx_md5_upd©e
(&
˘x1
, 
föÆ
, 16);

114 i‡(
i
 % 3) {

115 
	`ngx_md5_upd©e
(&
˘x1
, 
ß…
, 
ß…Àn
);

118 i‡(
i
 % 7) {

119 
	`ngx_md5_upd©e
(&
˘x1
, 
key
, 
keyÀn
);

122 i‡(
i
 & 1) {

123 
	`ngx_md5_upd©e
(&
˘x1
, 
föÆ
, 16);

126 
	`ngx_md5_upd©e
(&
˘x1
, 
key
, 
keyÀn
);

129 
	`ngx_md5_föÆ
(
föÆ
, &
˘x1
);

134 *
í¸y±ed
 = 
	`ngx_≤Æloc
(
poﬁ
, ("$≠r1$"Ë- 1 + 
ß…Àn
 + 16 + 1);

135 i‡(*
í¸y±ed
 =
NULL
) {

136  
NGX_ERROR
;

139 
p
 = 
	`ngx_˝ymem
(*
í¸y±ed
, "$apr1$", ("$apr1$") - 1);

140 
p
 = 
	`ngx_c›y
’, 
ß…
, 
ß…Àn
);

141 *
p
++ = '$';

143 
p
 = 
	`ngx_¸y±_to64
’, (
föÆ
[ 0]<<16) | (final[ 6]<<8) | final[12], 4);

144 
p
 = 
	`ngx_¸y±_to64
’, (
föÆ
[ 1]<<16) | (final[ 7]<<8) | final[13], 4);

145 
p
 = 
	`ngx_¸y±_to64
’, (
föÆ
[ 2]<<16) | (final[ 8]<<8) | final[14], 4);

146 
p
 = 
	`ngx_¸y±_to64
’, (
föÆ
[ 3]<<16) | (final[ 9]<<8) | final[15], 4);

147 
p
 = 
	`ngx_¸y±_to64
’, (
föÆ
[ 4]<<16) | (final[10]<<8) | final[ 5], 4);

148 
p
 = 
	`ngx_¸y±_to64
’, 
föÆ
[11], 2);

149 *
p
 = '\0';

151  
NGX_OK
;

152 
	}
}

155 
u_ch¨
 *

156 
	$ngx_¸y±_to64
(
u_ch¨
 *
p
, 
uöt32_t
 
v
, 
size_t
 
n
)

158 
u_ch¨
 
ôﬂ64
[] =

161 
n
--) {

162 *
p
++ = 
ôﬂ64
[
v
 & 0x3f];

163 
v
 >>= 6;

166  
p
;

167 
	}
}

170 
ngx_öt_t


171 
	$ngx_¸y±_∂aö
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
, u_ch¨ **
í¸y±ed
)

173 
size_t
 
Àn
;

174 
u_ch¨
 *
p
;

176 
Àn
 = 
	`ngx_°æí
(
key
);

178 *
í¸y±ed
 = 
	`ngx_≤Æloc
(
poﬁ
, ("{PLAIN}"Ë- 1 + 
Àn
 + 1);

179 i‡(*
í¸y±ed
 =
NULL
) {

180  
NGX_ERROR
;

183 
p
 = 
	`ngx_˝ymem
(*
í¸y±ed
, "{PLAIN}", ("{PLAIN}") - 1);

184 
	`ngx_mem˝y
(
p
, 
key
, 
Àn
 + 1);

186  
NGX_OK
;

187 
	}
}

190 #i‡(
NGX_HAVE_SHA1
)

192 
ngx_öt_t


193 
	$ngx_¸y±_ssha
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
, u_ch¨ **
í¸y±ed
)

195 
size_t
 
Àn
;

196 
ngx_°r_t
 
ícoded
, 
decoded
;

197 
ngx_sha1_t
 
sha1
;

203 
ícoded
.
d©a
 = 
ß…
 + ("{SSHA}") - 1;

204 
ícoded
.
Àn
 = 
	`ngx_°æí
”ncoded.
d©a
);

206 
decoded
.
d©a
 = 
	`ngx_≤Æloc
(
poﬁ
, 
	`ngx_ba£64_decoded_Àngth
(
ícoded
.
Àn
));

207 i‡(
decoded
.
d©a
 =
NULL
) {

208  
NGX_ERROR
;

211 
	`ngx_decode_ba£64
(&
decoded
, &
ícoded
);

215 
	`ngx_sha1_öô
(&
sha1
);

216 
	`ngx_sha1_upd©e
(&
sha1
, 
key
, 
	`ngx_°æí
(key));

217 
	`ngx_sha1_upd©e
(&
sha1
, 
decoded
.
d©a
 + 20, decoded.
Àn
 - 20);

218 
	`ngx_sha1_föÆ
(
decoded
.
d©a
, &
sha1
);

222 
Àn
 = ("{SSHA}"Ë- 1 + 
	`ngx_ba£64_ícoded_Àngth
(
decoded
.len) + 1;

224 *
í¸y±ed
 = 
	`ngx_≤Æloc
(
poﬁ
, 
Àn
);

225 i‡(*
í¸y±ed
 =
NULL
) {

226  
NGX_ERROR
;

229 
ícoded
.
d©a
 = 
	`ngx_˝ymem
(*
í¸y±ed
, "{SSHA}", ("{SSHA}") - 1);

230 
	`ngx_ícode_ba£64
(&
ícoded
, &
decoded
);

231 
ícoded
.
d©a
[ícoded.
Àn
] = '\0';

233  
NGX_OK
;

234 
	}
}

	@ngx_crypt.h

8 #i‚de‡
_NGX_CRYPT_H_INCLUDED_


9 
	#_NGX_CRYPT_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
ngx_öt_t
 
ngx_¸y±
(
ngx_poﬁ_t
 *
poﬁ
, 
u_ch¨
 *
key
, u_ch¨ *
ß…
,

17 
u_ch¨
 **
í¸y±ed
);

	@ngx_cycle.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

10 
	~<ngx_evít.h
>

13 
ngx_de°roy_cy˛e_poﬁs
(
ngx_c⁄f_t
 *
c⁄f
);

14 
ngx_öt_t
 
ngx_cmp_sockaddr
(
sockaddr
 *
ß1
, sockadd∏*
ß2
);

15 
ngx_öt_t
 
ngx_öô_z⁄e_poﬁ
(
ngx_cy˛e_t
 *
cy˛e
,

16 
ngx_shm_z⁄e_t
 *
shm_z⁄e
);

17 
ngx_öt_t
 
ngx_ã°_lockfûe
(
u_ch¨
 *
fûe
, 
ngx_log_t
 *
log
);

18 
ngx_˛ón_ﬁd_cy˛es
(
ngx_evít_t
 *
ev
);

21 vﬁ©ûê
ngx_cy˛e_t
 *
	gngx_cy˛e
;

22 
ngx_¨øy_t
 
	gngx_ﬁd_cy˛es
;

24 
ngx_poﬁ_t
 *
	gngx_ãmp_poﬁ
;

25 
ngx_evít_t
 
	gngx_˛ó√r_evít
;

27 
ngx_uöt_t
 
	gngx_ã°_c⁄fig
;

28 
ngx_uöt_t
 
	gngx_quõt_mode
;

30 #i‡(
NGX_THREADS
)

31 
ngx_és_key_t
 
	gngx_c‹e_és_key
;

36 
ngx_c⁄√˘i⁄_t
 
	gdumb
;

39 
ngx_°r_t
 
	gîr‹_log
 = 
ngx_°rög
(
NGX_ERROR_LOG_PATH
);

42 
ngx_cy˛e_t
 *

43 
	$ngx_öô_cy˛e
(
ngx_cy˛e_t
 *
ﬁd_cy˛e
)

45 *
rv
;

46 **
£nv
, **
ív
;

47 
ngx_uöt_t
 
i
, 
n
;

48 
ngx_log_t
 *
log
;

49 
ngx_time_t
 *
ç
;

50 
ngx_c⁄f_t
 
c⁄f
;

51 
ngx_poﬁ_t
 *
poﬁ
;

52 
ngx_cy˛e_t
 *
cy˛e
, **
ﬁd
;

53 
ngx_shm_z⁄e_t
 *
shm_z⁄e
, *
oshm_z⁄e
;

54 
ngx_li°_∑π_t
 *
∑π
, *
›¨t
;

55 
ngx_›í_fûe_t
 *
fûe
;

56 
ngx_li°íög_t
 *
ls
, *
∆s
;

57 
ngx_c‹e_c⁄f_t
 *
ccf
, *
ﬁd_ccf
;

58 
ngx_c‹e_moduÀ_t
 *
moduÀ
;

59 
ho°«me
[
NGX_MAXHOSTNAMELEN
];

61 
	`ngx_timez⁄e_upd©e
();

65 
ç
 = 
	`ngx_timeofday
();

66 
ç
->
£c
 = 0;

68 
	`ngx_time_upd©e
();

71 
log
 = 
ﬁd_cy˛e
->log;

73 
poﬁ
 = 
	`ngx_¸óã_poﬁ
(
NGX_CYCLE_POOL_SIZE
, 
log
);

74 i‡(
poﬁ
 =
NULL
) {

75  
NULL
;

77 
poﬁ
->
log
 =Üog;

79 
cy˛e
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_cy˛e_t
));

80 i‡(
cy˛e
 =
NULL
) {

81 
	`ngx_de°roy_poﬁ
(
poﬁ
);

82  
NULL
;

85 
cy˛e
->
poﬁ
 =Öool;

86 
cy˛e
->
log
 =Üog;

87 
cy˛e
->
√w_log
.
log_Àvñ
 = 
NGX_LOG_ERR
;

88 
cy˛e
->
ﬁd_cy˛e
 = old_cycle;

90 
cy˛e
->
c⁄f_¥efix
.
Àn
 = 
ﬁd_cy˛e
->conf_prefix.len;

91 
cy˛e
->
c⁄f_¥efix
.
d©a
 = 
	`ngx_p°rdup
(
poﬁ
, &
ﬁd_cy˛e
->conf_prefix);

92 i‡(
cy˛e
->
c⁄f_¥efix
.
d©a
 =
NULL
) {

93 
	`ngx_de°roy_poﬁ
(
poﬁ
);

94  
NULL
;

97 
cy˛e
->
¥efix
.
Àn
 = 
ﬁd_cy˛e
->prefix.len;

98 
cy˛e
->
¥efix
.
d©a
 = 
	`ngx_p°rdup
(
poﬁ
, &
ﬁd_cy˛e
->prefix);

99 i‡(
cy˛e
->
¥efix
.
d©a
 =
NULL
) {

100 
	`ngx_de°roy_poﬁ
(
poﬁ
);

101  
NULL
;

104 
cy˛e
->
c⁄f_fûe
.
Àn
 = 
ﬁd_cy˛e
->conf_file.len;

105 
cy˛e
->
c⁄f_fûe
.
d©a
 = 
	`ngx_≤Æloc
(
poﬁ
, 
ﬁd_cy˛e
->c⁄f_fûe.
Àn
 + 1);

106 i‡(
cy˛e
->
c⁄f_fûe
.
d©a
 =
NULL
) {

107 
	`ngx_de°roy_poﬁ
(
poﬁ
);

108  
NULL
;

110 
	`ngx_˝y°∫
(
cy˛e
->
c⁄f_fûe
.
d©a
, 
ﬁd_cy˛e
->conf_file.data,

111 
ﬁd_cy˛e
->
c⁄f_fûe
.
Àn
 + 1);

113 
cy˛e
->
c⁄f_∑øm
.
Àn
 = 
ﬁd_cy˛e
->conf_param.len;

114 
cy˛e
->
c⁄f_∑øm
.
d©a
 = 
	`ngx_p°rdup
(
poﬁ
, &
ﬁd_cy˛e
->conf_param);

115 i‡(
cy˛e
->
c⁄f_∑øm
.
d©a
 =
NULL
) {

116 
	`ngx_de°roy_poﬁ
(
poﬁ
);

117  
NULL
;

121 
n
 = 
ﬁd_cy˛e
->
∑thes
.
√…s
 ? old_cycle->pathes.nelts : 10;

123 
cy˛e
->
∑thes
.
ñts
 = 
	`ngx_pˇŒoc
(
poﬁ
, 
n
 * (
ngx_∑th_t
 *));

124 i‡(
cy˛e
->
∑thes
.
ñts
 =
NULL
) {

125 
	`ngx_de°roy_poﬁ
(
poﬁ
);

126  
NULL
;

129 
cy˛e
->
∑thes
.
√…s
 = 0;

130 
cy˛e
->
∑thes
.
size
 = (
ngx_∑th_t
 *);

131 
cy˛e
->
∑thes
.
«Œoc
 = 
n
;

132 
cy˛e
->
∑thes
.
poﬁ
 =Öool;

135 i‡(
ﬁd_cy˛e
->
›í_fûes
.
∑π
.
√…s
) {

136 
n
 = 
ﬁd_cy˛e
->
›í_fûes
.
∑π
.
√…s
;

137 
∑π
 = 
ﬁd_cy˛e
->
›í_fûes
.∑π.
√xt
;Öart;Öart =Öart->next) {

138 
n
 +
∑π
->
√…s
;

142 
n
 = 20;

145 i‡(
	`ngx_li°_öô
(&
cy˛e
->
›í_fûes
, 
poﬁ
, 
n
, (
ngx_›í_fûe_t
))

146 !
NGX_OK
)

148 
	`ngx_de°roy_poﬁ
(
poﬁ
);

149  
NULL
;

153 i‡(
ﬁd_cy˛e
->
sh¨ed_mem‹y
.
∑π
.
√…s
) {

154 
n
 = 
ﬁd_cy˛e
->
sh¨ed_mem‹y
.
∑π
.
√…s
;

155 
∑π
 = 
ﬁd_cy˛e
->
sh¨ed_mem‹y
.∑π.
√xt
;Öart;Öart =Öart->next)

157 
n
 +
∑π
->
√…s
;

161 
n
 = 1;

164 i‡(
	`ngx_li°_öô
(&
cy˛e
->
sh¨ed_mem‹y
, 
poﬁ
, 
n
, (
ngx_shm_z⁄e_t
))

165 !
NGX_OK
)

167 
	`ngx_de°roy_poﬁ
(
poﬁ
);

168  
NULL
;

171 
n
 = 
ﬁd_cy˛e
->
li°íög
.
√…s
 ? old_cycle->listening.nelts : 10;

173 
cy˛e
->
li°íög
.
ñts
 = 
	`ngx_pˇŒoc
(
poﬁ
, 
n
 * (
ngx_li°íög_t
));

174 i‡(
cy˛e
->
li°íög
.
ñts
 =
NULL
) {

175 
	`ngx_de°roy_poﬁ
(
poﬁ
);

176  
NULL
;

179 
cy˛e
->
li°íög
.
√…s
 = 0;

180 
cy˛e
->
li°íög
.
size
 = (
ngx_li°íög_t
);

181 
cy˛e
->
li°íög
.
«Œoc
 = 
n
;

182 
cy˛e
->
li°íög
.
poﬁ
 =Öool;

185 
	`ngx_queue_öô
(&
cy˛e
->
ªußbÀ_c⁄√˘i⁄s_queue
);

188 
cy˛e
->
c⁄f_˘x
 = 
	`ngx_pˇŒoc
(
poﬁ
, 
ngx_max_moduÀ
 * (*));

189 i‡(
cy˛e
->
c⁄f_˘x
 =
NULL
) {

190 
	`ngx_de°roy_poﬁ
(
poﬁ
);

191  
NULL
;

195 i‡(
	`gëho°«me
(
ho°«me
, 
NGX_MAXHOSTNAMELEN
) == -1) {

196 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
, "gethostname() failed");

197 
	`ngx_de°roy_poﬁ
(
poﬁ
);

198  
NULL
;

203 
ho°«me
[
NGX_MAXHOSTNAMELEN
 - 1] = '\0';

204 
cy˛e
->
ho°«me
.
Àn
 = 
	`ngx_°æí
(hostname);

206 
cy˛e
->
ho°«me
.
d©a
 = 
	`ngx_≤Æloc
(
poﬁ
, cy˛e->ho°«me.
Àn
);

207 i‡(
cy˛e
->
ho°«me
.
d©a
 =
NULL
) {

208 
	`ngx_de°roy_poﬁ
(
poﬁ
);

209  
NULL
;

212 
	`ngx_°æow
(
cy˛e
->
ho°«me
.
d©a
, (
u_ch¨
 *Ëho°«me, cy˛e->ho°«me.
Àn
);

215 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

216 i‡(
ngx_moduÀs
[
i
]->
ty≥
 !
NGX_CORE_MODULE
) {

220 
moduÀ
 = 
ngx_moduÀs
[
i
]->
˘x
;

222 i‡(
moduÀ
->
¸óã_c⁄f
) {

223 
rv
 = 
moduÀ
->
	`¸óã_c⁄f
(
cy˛e
);

224 i‡(
rv
 =
NULL
) {

225 
	`ngx_de°roy_poﬁ
(
poﬁ
);

226  
NULL
;

228 
cy˛e
->
c⁄f_˘x
[
ngx_moduÀs
[
i
]->
ödex
] = 
rv
;

233 
£nv
 = 
ívú⁄
;

236 
	`ngx_memzîo
(&
c⁄f
, (
ngx_c⁄f_t
));

238 
c⁄f
.
¨gs
 = 
	`ngx_¨øy_¸óã
(
poﬁ
, 10, (
ngx_°r_t
));

239 i‡(
c⁄f
.
¨gs
 =
NULL
) {

240 
	`ngx_de°roy_poﬁ
(
poﬁ
);

241  
NULL
;

244 
c⁄f
.
ãmp_poﬁ
 = 
	`ngx_¸óã_poﬁ
(
NGX_CYCLE_POOL_SIZE
, 
log
);

245 i‡(
c⁄f
.
ãmp_poﬁ
 =
NULL
) {

246 
	`ngx_de°roy_poﬁ
(
poﬁ
);

247  
NULL
;

251 
c⁄f
.
˘x
 = 
cy˛e
->
c⁄f_˘x
;

252 
c⁄f
.
cy˛e
 = cycle;

253 
c⁄f
.
poﬁ
 =Öool;

254 
c⁄f
.
log
 =Üog;

255 
c⁄f
.
moduÀ_ty≥
 = 
NGX_CORE_MODULE
;

256 
c⁄f
.
cmd_ty≥
 = 
NGX_MAIN_CONF
;

259 
log
->
log_Àvñ
 = 
NGX_LOG_DEBUG_ALL
;

262 i‡(
	`ngx_c⁄f_∑øm
(&
c⁄f
Ë!
NGX_CONF_OK
) {

263 
ívú⁄
 = 
£nv
;

264 
	`ngx_de°roy_cy˛e_poﬁs
(&
c⁄f
);

265  
NULL
;

268 i‡(
	`ngx_c⁄f_∑r£
(&
c⁄f
, &
cy˛e
->
c⁄f_fûe
Ë!
NGX_CONF_OK
) {

269 
ívú⁄
 = 
£nv
;

270 
	`ngx_de°roy_cy˛e_poﬁs
(&
c⁄f
);

271  
NULL
;

274 i‡(
ngx_ã°_c⁄fig
 && !
ngx_quõt_mode
) {

275 
	`ngx_log_°dîr
(0, "the configuration file %s syntax is ok",

276 
cy˛e
->
c⁄f_fûe
.
d©a
);

279 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

280 i‡(
ngx_moduÀs
[
i
]->
ty≥
 !
NGX_CORE_MODULE
) {

284 
moduÀ
 = 
ngx_moduÀs
[
i
]->
˘x
;

286 i‡(
moduÀ
->
öô_c⁄f
) {

287 i‡(
moduÀ
->
	`öô_c⁄f
(
cy˛e
, cy˛e->
c⁄f_˘x
[
ngx_moduÀs
[
i
]->
ödex
])

288 =
NGX_CONF_ERROR
)

290 
ívú⁄
 = 
£nv
;

291 
	`ngx_de°roy_cy˛e_poﬁs
(&
c⁄f
);

292  
NULL
;

297 i‡(
ngx_¥o˚ss
 =
NGX_PROCESS_SIGNALLER
) {

298  
cy˛e
;

301 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_c‹e_moduÀ
);

303 i‡(
ngx_ã°_c⁄fig
) {

305 i‡(
	`ngx_¸óã_pidfûe
(&
ccf
->
pid
, 
log
Ë!
NGX_OK
) {

306 
Áûed
;

309 } i‡(!
	`ngx_is_öô_cy˛e
(
ﬁd_cy˛e
)) {

316 
ﬁd_ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ﬁd_cy˛e
->
c⁄f_˘x
,

317 
ngx_c‹e_moduÀ
);

318 i‡(
ccf
->
pid
.
Àn
 !
ﬁd_ccf
->pid.len

319 || 
	`ngx_°rcmp
(
ccf
->
pid
.
d©a
, 
ﬁd_ccf
->pid.data) != 0)

323 i‡(
	`ngx_¸óã_pidfûe
(&
ccf
->
pid
, 
log
Ë!
NGX_OK
) {

324 
Áûed
;

327 
	`ngx_dñëe_pidfûe
(
ﬁd_cy˛e
);

332 i‡(
	`ngx_ã°_lockfûe
(
cy˛e
->
lock_fûe
.
d©a
, 
log
Ë!
NGX_OK
) {

333 
Áûed
;

337 i‡(
	`ngx_¸óã_∑thes
(
cy˛e
, 
ccf
->
u£r
Ë!
NGX_OK
) {

338 
Áûed
;

342 i‡(
cy˛e
->
√w_log
.
fûe
 =
NULL
) {

343 
cy˛e
->
√w_log
.
fûe
 = 
	`ngx_c⁄f_›í_fûe
(cy˛e, &
îr‹_log
);

344 i‡(
cy˛e
->
√w_log
.
fûe
 =
NULL
) {

345 
Áûed
;

351 
∑π
 = &
cy˛e
->
›í_fûes
.part;

352 
fûe
 = 
∑π
->
ñts
;

354 
i
 = 0; ; i++) {

356 i‡(
i
 >
∑π
->
√…s
) {

357 i‡(
∑π
->
√xt
 =
NULL
) {

360 
∑π
 =Ö¨t->
√xt
;

361 
fûe
 = 
∑π
->
ñts
;

362 
i
 = 0;

365 i‡(
fûe
[
i
].
«me
.
Àn
 == 0) {

369 
fûe
[
i
].
fd
 = 
	`ngx_›í_fûe
(fûe[i].
«me
.
d©a
,

370 
NGX_FILE_APPEND
,

371 
NGX_FILE_CREATE_OR_OPEN
,

372 
NGX_FILE_DEFAULT_ACCESS
);

374 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

376 &
fûe
[
i
], fûe[i].
fd
, fûe[i].
«me
.
d©a
);

378 i‡(
fûe
[
i
].
fd
 =
NGX_INVALID_FILE
) {

379 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
,

380 
ngx_›í_fûe_n
 " \"%s\" failed",

381 
fûe
[
i
].
«me
.
d©a
);

382 
Áûed
;

385 #i‡!(
NGX_WIN32
)

386 i‡(
	`f˙é
(
fûe
[
i
].
fd
, 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

387 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
,

389 
fûe
[
i
].
«me
.
d©a
);

390 
Áûed
;

395 
cy˛e
->
log
 = &cy˛e->
√w_log
;

396 
poﬁ
->
log
 = &
cy˛e
->
√w_log
;

401 
∑π
 = &
cy˛e
->
sh¨ed_mem‹y
.part;

402 
shm_z⁄e
 = 
∑π
->
ñts
;

404 
i
 = 0; ; i++) {

406 i‡(
i
 >
∑π
->
√…s
) {

407 i‡(
∑π
->
√xt
 =
NULL
) {

410 
∑π
 =Ö¨t->
√xt
;

411 
shm_z⁄e
 = 
∑π
->
ñts
;

412 
i
 = 0;

415 i‡(
shm_z⁄e
[
i
].
shm
.
size
 == 0) {

416 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 0,

418 &
shm_z⁄e
[
i
].
shm
.
«me
);

419 
Áûed
;

422 
shm_z⁄e
[
i
].
shm
.
log
 = 
cy˛e
->log;

424 
›¨t
 = &
ﬁd_cy˛e
->
sh¨ed_mem‹y
.
∑π
;

425 
oshm_z⁄e
 = 
›¨t
->
ñts
;

427 
n
 = 0; ;Ç++) {

429 i‡(
n
 >
›¨t
->
√…s
) {

430 i‡(
›¨t
->
√xt
 =
NULL
) {

433 
›¨t
 = o∑π->
√xt
;

434 
oshm_z⁄e
 = 
›¨t
->
ñts
;

435 
n
 = 0;

438 i‡(
shm_z⁄e
[
i
].
shm
.
«me
.
Àn
 !
oshm_z⁄e
[
n
].shm.name.len) {

442 i‡(
	`ngx_°∫cmp
(
shm_z⁄e
[
i
].
shm
.
«me
.
d©a
,

443 
oshm_z⁄e
[
n
].
shm
.
«me
.
d©a
,

444 
shm_z⁄e
[
i
].
shm
.
«me
.
Àn
)

450 i‡(
shm_z⁄e
[
i
].
shm
.
size
 =
oshm_z⁄e
[
n
].shm.size) {

451 
shm_z⁄e
[
i
].
shm
.
addr
 = 
oshm_z⁄e
[
n
].shm.addr;

453 i‡(
shm_z⁄e
[
i
].
	`öô
(&shm_z⁄e[i], 
oshm_z⁄e
[
n
].
d©a
)

454 !
NGX_OK
)

456 
Áûed
;

459 
shm_z⁄e_found
;

462 
	`ngx_shm_‰ì
(&
oshm_z⁄e
[
n
].
shm
);

467 i‡(
	`ngx_shm_Æloc
(&
shm_z⁄e
[
i
].
shm
Ë!
NGX_OK
) {

468 
Áûed
;

471 i‡(
	`ngx_öô_z⁄e_poﬁ
(
cy˛e
, &
shm_z⁄e
[
i
]Ë!
NGX_OK
) {

472 
Áûed
;

475 i‡(
shm_z⁄e
[
i
].
	`öô
(&shm_z⁄e[i], 
NULL
Ë!
NGX_OK
) {

476 
Áûed
;

479 
shm_z⁄e_found
:

487 i‡(
ﬁd_cy˛e
->
li°íög
.
√…s
) {

488 
ls
 = 
ﬁd_cy˛e
->
li°íög
.
ñts
;

489 
i
 = 0; i < 
ﬁd_cy˛e
->
li°íög
.
√…s
; i++) {

490 
ls
[
i
].
ªmaö
 = 0;

493 
∆s
 = 
cy˛e
->
li°íög
.
ñts
;

494 
n
 = 0;Ç < 
cy˛e
->
li°íög
.
√…s
;Ç++) {

496 
i
 = 0; i < 
ﬁd_cy˛e
->
li°íög
.
√…s
; i++) {

497 i‡(
ls
[
i
].
ign‹e
) {

501 i‡(
	`ngx_cmp_sockaddr
(
∆s
[
n
].
sockaddr
, 
ls
[
i
].sockaddrË=
NGX_OK
)

503 
∆s
[
n
].
fd
 = 
ls
[
i
].fd;

504 
∆s
[
n
].
¥evious
 = &
ls
[
i
];

505 
ls
[
i
].
ªmaö
 = 1;

507 i‡(
ls
[
n
].
backlog
 !
∆s
[
i
].backlog) {

508 
∆s
[
n
].
li°í
 = 1;

511 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
SO_ACCEPTFILTER
)

517 
∆s
[
n
].
de„ºed_ac˚±
 = 
ls
[
i
].deferred_accept;

519 i‡(
ls
[
i
].
ac˚±_fûãr
 && 
∆s
[
n
].accept_filter) {

520 i‡(
	`ngx_°rcmp
(
ls
[
i
].
ac˚±_fûãr
,

521 
∆s
[
n
].
ac˚±_fûãr
)

524 
∆s
[
n
].
dñëe_de„ºed
 = 1;

525 
∆s
[
n
].
add_de„ºed
 = 1;

528 } i‡(
ls
[
i
].
ac˚±_fûãr
) {

529 
∆s
[
n
].
dñëe_de„ºed
 = 1;

531 } i‡(
∆s
[
n
].
ac˚±_fûãr
) {

532 
∆s
[
n
].
add_de„ºed
 = 1;

536 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
TCP_DEFER_ACCEPT
)

538 i‡(
ls
[
n
].
de„ºed_ac˚±
 && !
∆s
[n].deferred_accept) {

539 
∆s
[
n
].
dñëe_de„ºed
 = 1;

541 } i‡(
ls
[
i
].
de„ºed_ac˚±
 !
∆s
[
n
].deferred_accept)

543 
∆s
[
n
].
add_de„ºed
 = 1;

550 i‡(
∆s
[
n
].
fd
 == -1) {

551 
∆s
[
n
].
›í
 = 1;

556 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

557 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

558 
ls
[
i
].
›í
 = 1;

559 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
SO_ACCEPTFILTER
)

560 i‡(
ls
[
i
].
ac˚±_fûãr
) {

561 
ls
[
i
].
add_de„ºed
 = 1;

564 #i‡(
NGX_HAVE_DEFERRED_ACCEPT
 && 
deföed
 
TCP_DEFER_ACCEPT
)

565 i‡(
ls
[
i
].
de„ºed_ac˚±
) {

566 
ls
[
i
].
add_de„ºed
 = 1;

572 i‡(
	`ngx_›í_li°íög_sockës
(
cy˛e
Ë!
NGX_OK
) {

573 
Áûed
;

576 i‡(!
ngx_ã°_c⁄fig
) {

577 
	`ngx_c⁄figuª_li°íög_sockës
(
cy˛e
);

583 i‡(!
ngx_u£_°dîr
 && 
cy˛e
->
log
->
fûe
->
fd
 !
ngx_°dîr
) {

585 i‡(
	`ngx_£t_°dîr
(
cy˛e
->
log
->
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

586 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

587 
ngx_£t_°dîr_n
 " failed");

591 
poﬁ
->
log
 = 
cy˛e
->log;

593 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

594 i‡(
ngx_moduÀs
[
i
]->
öô_moduÀ
) {

595 i‡(
ngx_moduÀs
[
i
]->
	`öô_moduÀ
(
cy˛e
Ë!
NGX_OK
) {

597 
	`exô
(1);

607 
›¨t
 = &
ﬁd_cy˛e
->
sh¨ed_mem‹y
.
∑π
;

608 
oshm_z⁄e
 = 
›¨t
->
ñts
;

610 
i
 = 0; ; i++) {

612 i‡(
i
 >
›¨t
->
√…s
) {

613 i‡(
›¨t
->
√xt
 =
NULL
) {

614 
ﬁd_shm_z⁄e_d⁄e
;

616 
›¨t
 = o∑π->
√xt
;

617 
oshm_z⁄e
 = 
›¨t
->
ñts
;

618 
i
 = 0;

621 
∑π
 = &
cy˛e
->
sh¨ed_mem‹y
.part;

622 
shm_z⁄e
 = 
∑π
->
ñts
;

624 
n
 = 0; ;Ç++) {

626 i‡(
n
 >
∑π
->
√…s
) {

627 i‡(
∑π
->
√xt
 =
NULL
) {

630 
∑π
 =Ö¨t->
√xt
;

631 
shm_z⁄e
 = 
∑π
->
ñts
;

632 
n
 = 0;

635 i‡(
oshm_z⁄e
[
i
].
shm
.
«me
.
Àn
 =
shm_z⁄e
[
n
].shm.name.len

636 && 
	`ngx_°∫cmp
(
oshm_z⁄e
[
i
].
shm
.
«me
.
d©a
,

637 
shm_z⁄e
[
n
].
shm
.
«me
.
d©a
,

638 
oshm_z⁄e
[
i
].
shm
.
«me
.
Àn
)

641 
live_shm_z⁄e
;

645 
	`ngx_shm_‰ì
(&
oshm_z⁄e
[
i
].
shm
);

647 
live_shm_z⁄e
:

652 
ﬁd_shm_z⁄e_d⁄e
:

657 
ls
 = 
ﬁd_cy˛e
->
li°íög
.
ñts
;

658 
i
 = 0; i < 
ﬁd_cy˛e
->
li°íög
.
√…s
; i++) {

660 i‡(
ls
[
i
].
ªmaö
 ||Üs[i].
fd
 == -1) {

664 i‡(
	`ngx_˛o£_sockë
(
ls
[
i
].
fd
) == -1) {

665 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

666 
ngx_˛o£_sockë_n
 "Üistening socket on %V failed",

667 &
ls
[
i
].
addr_ãxt
);

670 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

672 i‡(
ls
[
i
].
sockaddr
->
ß_Ámûy
 =
AF_UNIX
) {

673 
u_ch¨
 *
«me
;

675 
«me
 = 
ls
[
i
].
addr_ãxt
.
d©a
 + ("unix:") - 1;

677 
	`ngx_log_îr‹
(
NGX_LOG_WARN
, 
cy˛e
->
log
, 0,

678 "dñëög sockë %s", 
«me
);

680 i‡(
	`ngx_dñëe_fûe
(
«me
) == -1) {

681 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

682 
ngx_dñëe_fûe_n
 " %†Áûed", 
«me
);

692 
∑π
 = &
ﬁd_cy˛e
->
›í_fûes
.part;

693 
fûe
 = 
∑π
->
ñts
;

695 
i
 = 0; ; i++) {

697 i‡(
i
 >
∑π
->
√…s
) {

698 i‡(
∑π
->
√xt
 =
NULL
) {

701 
∑π
 =Ö¨t->
√xt
;

702 
fûe
 = 
∑π
->
ñts
;

703 
i
 = 0;

706 i‡(
fûe
[
i
].
fd
 =
NGX_INVALID_FILE
 || fûe[i].fd =
ngx_°dîr
) {

710 i‡(
	`ngx_˛o£_fûe
(
fûe
[
i
].
fd
Ë=
NGX_FILE_ERROR
) {

711 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
,

712 
ngx_˛o£_fûe_n
 " \"%s\" failed",

713 
fûe
[
i
].
«me
.
d©a
);

717 
	`ngx_de°roy_poﬁ
(
c⁄f
.
ãmp_poﬁ
);

719 i‡(
ngx_¥o˚ss
 =
NGX_PROCESS_MASTER
 || 
	`ngx_is_öô_cy˛e
(
ﬁd_cy˛e
)) {

727 
ív
 = 
ívú⁄
;

728 
ívú⁄
 = 
£nv
;

730 
	`ngx_de°roy_poﬁ
(
ﬁd_cy˛e
->
poﬁ
);

731 
cy˛e
->
ﬁd_cy˛e
 = 
NULL
;

733 
ívú⁄
 = 
ív
;

735  
cy˛e
;

739 i‡(
ngx_ãmp_poﬁ
 =
NULL
) {

740 
ngx_ãmp_poﬁ
 = 
	`ngx_¸óã_poﬁ
(128, 
cy˛e
->
log
);

741 i‡(
ngx_ãmp_poﬁ
 =
NULL
) {

742 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 0,

744 
	`exô
(1);

747 
n
 = 10;

748 
ngx_ﬁd_cy˛es
.
ñts
 = 
	`ngx_pˇŒoc
(
ngx_ãmp_poﬁ
,

749 
n
 * (
ngx_cy˛e_t
 *));

750 i‡(
ngx_ﬁd_cy˛es
.
ñts
 =
NULL
) {

751 
	`exô
(1);

753 
ngx_ﬁd_cy˛es
.
√…s
 = 0;

754 
ngx_ﬁd_cy˛es
.
size
 = (
ngx_cy˛e_t
 *);

755 
ngx_ﬁd_cy˛es
.
«Œoc
 = 
n
;

756 
ngx_ﬁd_cy˛es
.
poﬁ
 = 
ngx_ãmp_poﬁ
;

758 
ngx_˛ó√r_evít
.
h™dÀr
 = 
ngx_˛ón_ﬁd_cy˛es
;

759 
ngx_˛ó√r_evít
.
log
 = 
cy˛e
->log;

760 
ngx_˛ó√r_evít
.
d©a
 = &
dumb
;

761 
dumb
.
fd
 = (
ngx_sockë_t
) -1;

764 
ngx_ãmp_poﬁ
->
log
 = 
cy˛e
->log;

766 
ﬁd
 = 
	`ngx_¨øy_push
(&
ngx_ﬁd_cy˛es
);

767 i‡(
ﬁd
 =
NULL
) {

768 
	`exô
(1);

770 *
ﬁd
 = 
ﬁd_cy˛e
;

772 i‡(!
ngx_˛ó√r_evít
.
timî_£t
) {

773 
	`ngx_add_timî
(&
ngx_˛ó√r_evít
, 30000);

774 
ngx_˛ó√r_evít
.
timî_£t
 = 1;

777  
cy˛e
;

780 
Áûed
:

782 i‡(!
	`ngx_is_öô_cy˛e
(
ﬁd_cy˛e
)) {

783 
ﬁd_ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ﬁd_cy˛e
->
c⁄f_˘x
,

784 
ngx_c‹e_moduÀ
);

785 i‡(
ﬁd_ccf
->
ívú⁄mít
) {

786 
ívú⁄
 = 
ﬁd_ccf
->
ívú⁄mít
;

792 
∑π
 = &
cy˛e
->
›í_fûes
.part;

793 
fûe
 = 
∑π
->
ñts
;

795 
i
 = 0; ; i++) {

797 i‡(
i
 >
∑π
->
√…s
) {

798 i‡(
∑π
->
√xt
 =
NULL
) {

801 
∑π
 =Ö¨t->
√xt
;

802 
fûe
 = 
∑π
->
ñts
;

803 
i
 = 0;

806 i‡(
fûe
[
i
].
fd
 =
NGX_INVALID_FILE
 || fûe[i].fd =
ngx_°dîr
) {

810 i‡(
	`ngx_˛o£_fûe
(
fûe
[
i
].
fd
Ë=
NGX_FILE_ERROR
) {

811 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
,

812 
ngx_˛o£_fûe_n
 " \"%s\" failed",

813 
fûe
[
i
].
«me
.
d©a
);

817 i‡(
ngx_ã°_c⁄fig
) {

818 
	`ngx_de°roy_cy˛e_poﬁs
(&
c⁄f
);

819  
NULL
;

822 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

823 
i
 = 0; i < 
cy˛e
->
li°íög
.
√…s
; i++) {

824 i‡(
ls
[
i
].
fd
 =-1 || !ls[i].
›í
) {

828 i‡(
	`ngx_˛o£_sockë
(
ls
[
i
].
fd
) == -1) {

829 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_sockë_î∫o
,

830 
ngx_˛o£_sockë_n
 " %V failed",

831 &
ls
[
i
].
addr_ãxt
);

835 
	`ngx_de°roy_cy˛e_poﬁs
(&
c⁄f
);

837  
NULL
;

838 
	}
}

842 
	$ngx_de°roy_cy˛e_poﬁs
(
ngx_c⁄f_t
 *
c⁄f
)

844 
	`ngx_de°roy_poﬁ
(
c⁄f
->
ãmp_poﬁ
);

845 
	`ngx_de°roy_poﬁ
(
c⁄f
->
poﬁ
);

846 
	}
}

849 
ngx_öt_t


850 
	$ngx_cmp_sockaddr
(
sockaddr
 *
ß1
, sockadd∏*
ß2
)

852 
sockaddr_ö
 *
sö1
, *
sö2
;

853 #i‡(
NGX_HAVE_INET6
)

854 
sockaddr_ö6
 *
sö61
, *
sö62
;

856 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

857 
sockaddr_un
 *
ßun1
, *
ßun2
;

860 i‡(
ß1
->
ß_Ámûy
 !
ß2
->sa_family) {

861  
NGX_DECLINED
;

864 
ß1
->
ß_Ámûy
) {

866 #i‡(
NGX_HAVE_INET6
)

867 
AF_INET6
:

868 
sö61
 = (
sockaddr_ö6
 *Ë
ß1
;

869 
sö62
 = (
sockaddr_ö6
 *Ë
ß2
;

871 i‡(
sö61
->
sö6_p‹t
 !
sö62
->sin6_port) {

872  
NGX_DECLINED
;

875 i‡(
	`ngx_memcmp
(&
sö61
->
sö6_addr
, &
sö62
->sin6_addr, 16) != 0) {

876  
NGX_DECLINED
;

882 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

883 
AF_UNIX
:

884 
ßun1
 = (
sockaddr_un
 *Ë
ß1
;

885 
ßun2
 = (
sockaddr_un
 *Ë
ß2
;

887 i‡(
	`ngx_memcmp
(&
ßun1
->
sun_∑th
, &
ßun2
->sun_path,

888 (
ßun1
->
sun_∑th
))

891  
NGX_DECLINED
;

899 
sö1
 = (
sockaddr_ö
 *Ë
ß1
;

900 
sö2
 = (
sockaddr_ö
 *Ë
ß2
;

902 i‡(
sö1
->
sö_p‹t
 !
sö2
->sin_port) {

903  
NGX_DECLINED
;

906 i‡(
sö1
->
sö_addr
.
s_addr
 !
sö2
->sin_addr.s_addr) {

907  
NGX_DECLINED
;

913  
NGX_OK
;

914 
	}
}

917 
ngx_öt_t


918 
	$ngx_öô_z⁄e_poﬁ
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_shm_z⁄e_t
 *
zn
)

920 
u_ch¨
 *
fûe
;

921 
ngx_¶ab_poﬁ_t
 *
•
;

923 
•
 = (
ngx_¶ab_poﬁ_t
 *Ë
zn
->
shm
.
addr
;

925 i‡(
zn
->
shm
.
exi°s
) {

927 i‡(
•
 =•->
addr
) {

928  
NGX_OK
;

931 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 0,

933 &
zn
->
shm
.
«me
, 
•
->
addr
, sp);

934  
NGX_ERROR
;

937 
•
->
íd
 = 
zn
->
shm
.
addr
 + zn->shm.
size
;

938 
•
->
mö_shi·
 = 3;

939 
•
->
addr
 = 
zn
->
shm
.addr;

941 #i‡(
NGX_HAVE_ATOMIC_OPS
)

943 
fûe
 = 
NULL
;

947 
fûe
 = 
	`ngx_≤Æloc
(
cy˛e
->
poﬁ
, cy˛e->
lock_fûe
.
Àn
 + 
zn
->
shm
.
«me
.len);

948 i‡(
fûe
 =
NULL
) {

949  
NGX_ERROR
;

952 (Ë
	`ngx_•rötf
(
fûe
, "%V%V%Z", &
cy˛e
->
lock_fûe
, &
zn
->
shm
.
«me
);

956 i‡(
	`ngx_shmtx_¸óã
(&
•
->
muãx
, &•->
lock
, 
fûe
Ë!
NGX_OK
) {

957  
NGX_ERROR
;

960 
	`ngx_¶ab_öô
(
•
);

962  
NGX_OK
;

963 
	}
}

966 
ngx_öt_t


967 
	$ngx_¸óã_pidfûe
(
ngx_°r_t
 *
«me
, 
ngx_log_t
 *
log
)

969 
size_t
 
Àn
;

970 
ngx_uöt_t
 
¸óã
;

971 
ngx_fûe_t
 
fûe
;

972 
u_ch¨
 
pid
[
NGX_INT64_LEN
 + 2];

974 i‡(
ngx_¥o˚ss
 > 
NGX_PROCESS_MASTER
) {

975  
NGX_OK
;

978 
	`ngx_memzîo
(&
fûe
, (
ngx_fûe_t
));

980 
fûe
.
«me
 = *name;

981 
fûe
.
log
 =Üog;

983 
¸óã
 = 
ngx_ã°_c⁄fig
 ? 
NGX_FILE_CREATE_OR_OPEN
 : 
NGX_FILE_TRUNCATE
;

985 
fûe
.
fd
 = 
	`ngx_›í_fûe
(fûe.
«me
.
d©a
, 
NGX_FILE_RDWR
,

986 
¸óã
, 
NGX_FILE_DEFAULT_ACCESS
);

988 i‡(
fûe
.
fd
 =
NGX_INVALID_FILE
) {

989 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
,

990 
ngx_›í_fûe_n
 " \"%s\" faûed", 
fûe
.
«me
.
d©a
);

991  
NGX_ERROR
;

994 i‡(!
ngx_ã°_c⁄fig
) {

995 
Àn
 = 
	`ngx_¢¥ötf
(
pid
, 
NGX_INT64_LEN
 + 2, "%P%N", 
ngx_pid
) -Öid;

997 i‡(
	`ngx_wrôe_fûe
(&
fûe
, 
pid
, 
Àn
, 0Ë=
NGX_ERROR
) {

998  
NGX_ERROR
;

1002 i‡(
	`ngx_˛o£_fûe
(
fûe
.
fd
Ë=
NGX_FILE_ERROR
) {

1003 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

1004 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
fûe
.
«me
.
d©a
);

1007  
NGX_OK
;

1008 
	}
}

1012 
	$ngx_dñëe_pidfûe
(
ngx_cy˛e_t
 *
cy˛e
)

1014 
u_ch¨
 *
«me
;

1015 
ngx_c‹e_c⁄f_t
 *
ccf
;

1017 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_c‹e_moduÀ
);

1019 
«me
 = 
ngx_√w_bö¨y
 ? 
ccf
->
ﬁdpid
.
d©a
 : ccf->
pid
.data;

1021 i‡(
	`ngx_dñëe_fûe
(
«me
Ë=
NGX_FILE_ERROR
) {

1022 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

1023 
ngx_dñëe_fûe_n
 " \"%s\" faûed", 
«me
);

1025 
	}
}

1028 
ngx_öt_t


1029 
	$ngx_sig«l_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
, *
sig
)

1031 
ssize_t
 
n
;

1032 
ngx_öt_t
 
pid
;

1033 
ngx_fûe_t
 
fûe
;

1034 
ngx_c‹e_c⁄f_t
 *
ccf
;

1035 
u_ch¨
 
buf
[
NGX_INT64_LEN
 + 2];

1037 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
cy˛e
->
log
, 0, "signalÖrocess started");

1039 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_c‹e_moduÀ
);

1041 
fûe
.
«me
 = 
ccf
->
pid
;

1042 
fûe
.
log
 = 
cy˛e
->log;

1044 
fûe
.
fd
 = 
	`ngx_›í_fûe
(fûe.
«me
.
d©a
, 
NGX_FILE_RDONLY
,

1045 
NGX_FILE_OPEN
, 
NGX_FILE_DEFAULT_ACCESS
);

1047 i‡(
fûe
.
fd
 =
NGX_INVALID_FILE
) {

1048 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
cy˛e
->
log
, 
ngx_î∫o
,

1049 
ngx_›í_fûe_n
 " \"%s\" faûed", 
fûe
.
«me
.
d©a
);

1053 
n
 = 
	`ngx_ªad_fûe
(&
fûe
, 
buf
, 
NGX_INT64_LEN
 + 2, 0);

1055 i‡(
	`ngx_˛o£_fûe
(
fûe
.
fd
Ë=
NGX_FILE_ERROR
) {

1056 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

1057 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
fûe
.
«me
.
d©a
);

1060 i‡(
n
 =
NGX_ERROR
) {

1064 
n
-- && (
buf
[n] =
CR
 || buf[n] =
LF
)) { }

1066 
pid
 = 
	`ngx_©oi
(
buf
, ++
n
);

1068 i‡(
pid
 =
NGX_ERROR
) {

1069 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
cy˛e
->
log
, 0,

1071 
n
, 
buf
, 
fûe
.
«me
.
d©a
);

1075  
	`ngx_os_sig«l_¥o˚ss
(
cy˛e
, 
sig
, 
pid
);

1077 
	}
}

1080 
ngx_öt_t


1081 
	$ngx_ã°_lockfûe
(
u_ch¨
 *
fûe
, 
ngx_log_t
 *
log
)

1083 #i‡!(
NGX_HAVE_ATOMIC_OPS
)

1084 
ngx_fd_t
 
fd
;

1086 
fd
 = 
	`ngx_›í_fûe
(
fûe
, 
NGX_FILE_RDWR
, 
NGX_FILE_CREATE_OR_OPEN
,

1087 
NGX_FILE_DEFAULT_ACCESS
);

1089 i‡(
fd
 =
NGX_INVALID_FILE
) {

1090 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
log
, 
ngx_î∫o
,

1091 
ngx_›í_fûe_n
 " \"%s\" faûed", 
fûe
);

1092  
NGX_ERROR
;

1095 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

1096 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

1097 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
fûe
);

1100 i‡(
	`ngx_dñëe_fûe
(
fûe
Ë=
NGX_FILE_ERROR
) {

1101 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

1102 
ngx_dñëe_fûe_n
 " \"%s\" faûed", 
fûe
);

1107  
NGX_OK
;

1108 
	}
}

1112 
	$ngx_ª›í_fûes
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_uid_t
 
u£r
)

1114 
ssize_t
 
n
, 
Àn
;

1115 
ngx_fd_t
 
fd
;

1116 
ngx_uöt_t
 
i
;

1117 
ngx_li°_∑π_t
 *
∑π
;

1118 
ngx_›í_fûe_t
 *
fûe
;

1120 
∑π
 = &
cy˛e
->
›í_fûes
.part;

1121 
fûe
 = 
∑π
->
ñts
;

1123 
i
 = 0; ; i++) {

1125 i‡(
i
 >
∑π
->
√…s
) {

1126 i‡(
∑π
->
√xt
 =
NULL
) {

1129 
∑π
 =Ö¨t->
√xt
;

1130 
fûe
 = 
∑π
->
ñts
;

1131 
i
 = 0;

1134 i‡(
fûe
[
i
].
«me
.
Àn
 == 0) {

1138 
Àn
 = 
fûe
[
i
].
pos
 - fûe[i].
buf„r
;

1140 i‡(
fûe
[
i
].
buf„r
 && 
Àn
 != 0) {

1142 
n
 = 
	`ngx_wrôe_fd
(
fûe
[
i
].
fd
, fûe[i].
buf„r
, 
Àn
);

1144 i‡(
n
 =
NGX_FILE_ERROR
) {

1145 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

1146 
ngx_wrôe_fd_n
 "Åo \"%s\" failed",

1147 
fûe
[
i
].
«me
.
d©a
);

1149 } i‡(
n
 !
Àn
) {

1150 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 0,

1151 
ngx_wrôe_fd_n
 "Åo \"%s\" was incomplete: %z of %uz",

1152 
fûe
[
i
].
«me
.
d©a
, 
n
, 
Àn
);

1155 
fûe
[
i
].
pos
 = fûe[i].
buf„r
;

1158 
fd
 = 
	`ngx_›í_fûe
(
fûe
[
i
].
«me
.
d©a
, 
NGX_FILE_APPEND
,

1159 
NGX_FILE_CREATE_OR_OPEN
, 
NGX_FILE_DEFAULT_ACCESS
);

1161 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, 
cy˛e
->
log
, 0,

1163 
fûe
[
i
].
«me
.
d©a
, fûe[i].
fd
, fd);

1165 i‡(
fd
 =
NGX_INVALID_FILE
) {

1166 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1167 
ngx_›í_fûe_n
 " \"%s\" faûed", 
fûe
[
i
].
«me
.
d©a
);

1171 #i‡!(
NGX_WIN32
)

1172 i‡(
u£r
 !(
ngx_uid_t
Ë
NGX_CONF_UNSET_UINT
) {

1173 
ngx_fûe_öfo_t
 
fi
;

1175 i‡(
	`ngx_fûe_öfo
((c⁄° *Ë
fûe
[
i
].
«me
.
d©a
, &
fi
)

1176 =
NGX_FILE_ERROR
)

1178 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1179 
ngx_fûe_öfo_n
 " \"%s\" failed",

1180 
fûe
[
i
].
«me
.
d©a
);

1182 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

1183 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1184 
ngx_˛o£_fûe_n
 " \"%s\" failed",

1185 
fûe
[
i
].
«me
.
d©a
);

1189 i‡(
fi
.
°_uid
 !
u£r
) {

1190 i‡(
	`chown
((c⁄° *Ë
fûe
[
i
].
«me
.
d©a
, 
u£r
, -1) == -1) {

1191 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1193 
fûe
[
i
].
«me
.
d©a
, 
u£r
);

1195 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

1196 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1197 
ngx_˛o£_fûe_n
 " \"%s\" failed",

1198 
fûe
[
i
].
«me
.
d©a
);

1203 i‡((
fi
.
°_mode
 & (
S_IRUSR
|
S_IWUSR
)) != (S_IRUSR|S_IWUSR)) {

1205 
fi
.
°_mode
 |(
S_IRUSR
|
S_IWUSR
);

1207 i‡(
	`chmod
((c⁄° *Ë
fûe
[
i
].
«me
.
d©a
, 
fi
.
°_mode
) == -1) {

1208 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1209 "chmod(Ë\"%s\" faûed", 
fûe
[
i
].
«me
.
d©a
);

1211 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

1212 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1213 
ngx_˛o£_fûe_n
 " \"%s\" failed",

1214 
fûe
[
i
].
«me
.
d©a
);

1220 i‡(
	`f˙é
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

1221 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1223 
fûe
[
i
].
«me
.
d©a
);

1225 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

1226 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1227 
ngx_˛o£_fûe_n
 " \"%s\" failed",

1228 
fûe
[
i
].
«me
.
d©a
);

1235 i‡(
	`ngx_˛o£_fûe
(
fûe
[
i
].
fd
Ë=
NGX_FILE_ERROR
) {

1236 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1237 
ngx_˛o£_fûe_n
 " \"%s\" failed",

1238 
fûe
[
i
].
«me
.
d©a
);

1241 
fûe
[
i
].
fd
 = fd;

1244 #i‡!(
NGX_WIN32
)

1246 i‡(
cy˛e
->
log
->
fûe
->
fd
 !
STDERR_FILENO
) {

1247 i‡(
	`dup2
(
cy˛e
->
log
->
fûe
->
fd
, 
STDERR_FILENO
) == -1) {

1248 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

1254 
	}
}

1257 
ngx_shm_z⁄e_t
 *

1258 
	$ngx_sh¨ed_mem‹y_add
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
«me
, 
size_t
 
size
, *
èg
)

1260 
ngx_uöt_t
 
i
;

1261 
ngx_shm_z⁄e_t
 *
shm_z⁄e
;

1262 
ngx_li°_∑π_t
 *
∑π
;

1264 
∑π
 = &
cf
->
cy˛e
->
sh¨ed_mem‹y
.part;

1265 
shm_z⁄e
 = 
∑π
->
ñts
;

1267 
i
 = 0; ; i++) {

1269 i‡(
i
 >
∑π
->
√…s
) {

1270 i‡(
∑π
->
√xt
 =
NULL
) {

1273 
∑π
 =Ö¨t->
√xt
;

1274 
shm_z⁄e
 = 
∑π
->
ñts
;

1275 
i
 = 0;

1278 i‡(
«me
->
Àn
 !
shm_z⁄e
[
i
].
shm
.name.len) {

1282 i‡(
	`ngx_°∫cmp
(
«me
->
d©a
, 
shm_z⁄e
[
i
].
shm
.«me.d©a,Çame->
Àn
)

1288 i‡(
size
 && sizê!
shm_z⁄e
[
i
].
shm
.size) {

1289 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1292 
size
, &
shm_z⁄e
[
i
].
shm
.
«me
, shm_zone[i].shm.size);

1293  
NULL
;

1296 i‡(
èg
 !
shm_z⁄e
[
i
].tag) {

1297 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1300 &
shm_z⁄e
[
i
].
shm
.
«me
);

1301  
NULL
;

1304  &
shm_z⁄e
[
i
];

1307 
shm_z⁄e
 = 
	`ngx_li°_push
(&
cf
->
cy˛e
->
sh¨ed_mem‹y
);

1309 i‡(
shm_z⁄e
 =
NULL
) {

1310  
NULL
;

1313 
shm_z⁄e
->
d©a
 = 
NULL
;

1314 
shm_z⁄e
->
shm
.
log
 = 
cf
->
cy˛e
->log;

1315 
shm_z⁄e
->
shm
.
size
 = size;

1316 
shm_z⁄e
->
shm
.
«me
 = *name;

1317 
shm_z⁄e
->
shm
.
exi°s
 = 0;

1318 
shm_z⁄e
->
öô
 = 
NULL
;

1319 
shm_z⁄e
->
èg
 =Åag;

1321  
shm_z⁄e
;

1322 
	}
}

1326 
	$ngx_˛ón_ﬁd_cy˛es
(
ngx_evít_t
 *
ev
)

1328 
ngx_uöt_t
 
i
, 
n
, 
found
, 
live
;

1329 
ngx_log_t
 *
log
;

1330 
ngx_cy˛e_t
 **
cy˛e
;

1332 
log
 = 
ngx_cy˛e
->log;

1333 
ngx_ãmp_poﬁ
->
log
 =Üog;

1335 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "clean old cycles");

1337 
live
 = 0;

1339 
cy˛e
 = 
ngx_ﬁd_cy˛es
.
ñts
;

1340 
i
 = 0; i < 
ngx_ﬁd_cy˛es
.
√…s
; i++) {

1342 i‡(
cy˛e
[
i
] =
NULL
) {

1346 
found
 = 0;

1348 
n
 = 0;Ç < 
cy˛e
[
i
]->
c⁄√˘i⁄_n
;Ç++) {

1349 i‡(
cy˛e
[
i
]->
c⁄√˘i⁄s
[
n
].
fd
 !(
ngx_sockë_t
) -1) {

1350 
found
 = 1;

1352 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "livêfd:%d", 
n
);

1358 i‡(
found
) {

1359 
live
 = 1;

1363 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "˛ó¿ﬁd cy˛e: %d", 
i
);

1365 
	`ngx_de°roy_poﬁ
(
cy˛e
[
i
]->
poﬁ
);

1366 
cy˛e
[
i
] = 
NULL
;

1369 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0, "ﬁd cy˛e†°©us: %d", 
live
);

1371 i‡(
live
) {

1372 
	`ngx_add_timî
(
ev
, 30000);

1375 
	`ngx_de°roy_poﬁ
(
ngx_ãmp_poﬁ
);

1376 
ngx_ãmp_poﬁ
 = 
NULL
;

1377 
ngx_ﬁd_cy˛es
.
√…s
 = 0;

1379 
	}
}

	@ngx_cycle.h

8 #i‚de‡
_NGX_CYCLE_H_INCLUDED_


9 
	#_NGX_CYCLE_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 #i‚de‡
NGX_CYCLE_POOL_SIZE


17 
	#NGX_CYCLE_POOL_SIZE
 16384

	)

21 
	#NGX_DEBUG_POINTS_STOP
 1

	)

22 
	#NGX_DEBUG_POINTS_ABORT
 2

	)

25 
ngx_shm_z⁄e_s
 
	tngx_shm_z⁄e_t
;

27 
	$ngx_öt_t
 (*
	tngx_shm_z⁄e_öô_±
Ë(
	tngx_shm_z⁄e_t
 *
	tz⁄e
, *
	td©a
);

29 
	sngx_shm_z⁄e_s
 {

30 *
d©a
;

31 
ngx_shm_t
 
shm
;

32 
ngx_shm_z⁄e_öô_±
 
öô
;

33 *
èg
;

37 
	sngx_cy˛e_s
 {

38 ****
c⁄f_˘x
;

39 
ngx_poﬁ_t
 *
poﬁ
;

41 
ngx_log_t
 *
log
;

42 
ngx_log_t
 
√w_log
;

44 
ngx_c⁄√˘i⁄_t
 **
fûes
;

45 
ngx_c⁄√˘i⁄_t
 *
‰ì_c⁄√˘i⁄s
;

46 
ngx_uöt_t
 
‰ì_c⁄√˘i⁄_n
;

48 
ngx_queue_t
 
ªußbÀ_c⁄√˘i⁄s_queue
;

50 
ngx_¨øy_t
 
li°íög
;

51 
ngx_¨øy_t
 
∑thes
;

52 
ngx_li°_t
 
›í_fûes
;

53 
ngx_li°_t
 
sh¨ed_mem‹y
;

55 
ngx_uöt_t
 
c⁄√˘i⁄_n
;

56 
ngx_uöt_t
 
fûes_n
;

58 
ngx_c⁄√˘i⁄_t
 *
c⁄√˘i⁄s
;

59 
ngx_evít_t
 *
ªad_evíts
;

60 
ngx_evít_t
 *
wrôe_evíts
;

62 
ngx_cy˛e_t
 *
ﬁd_cy˛e
;

64 
ngx_°r_t
 
c⁄f_fûe
;

65 
ngx_°r_t
 
c⁄f_∑øm
;

66 
ngx_°r_t
 
c⁄f_¥efix
;

67 
ngx_°r_t
 
¥efix
;

68 
ngx_°r_t
 
lock_fûe
;

69 
ngx_°r_t
 
ho°«me
;

74 
ngx_Êag_t
 
d´m⁄
;

75 
ngx_Êag_t
 
ma°î
;

77 
ngx_m£c_t
 
timî_ªsﬁuti⁄
;

79 
ngx_öt_t
 
w‹kî_¥o˚s£s
;

80 
ngx_öt_t
 
debug_poöts
;

82 
ngx_öt_t
 
æimô_nofûe
;

83 
ngx_öt_t
 
æimô_sig≥ndög
;

84 
off_t
 
æimô_c‹e
;

86 
¥i‹ôy
;

88 
ngx_uöt_t
 
˝u_afföôy_n
;

89 
uöt64_t
 *
˝u_afföôy
;

91 *
u£∫ame
;

92 
ngx_uid_t
 
u£r
;

93 
ngx_gid_t
 
group
;

95 
ngx_°r_t
 
w‹kög_dúe˘‹y
;

96 
ngx_°r_t
 
lock_fûe
;

98 
ngx_°r_t
 
pid
;

99 
ngx_°r_t
 
ﬁdpid
;

101 
ngx_¨øy_t
 
ív
;

102 **
ívú⁄mít
;

104 #i‡(
NGX_THREADS
)

105 
ngx_öt_t
 
w‹kî_thªads
;

106 
size_t
 
thªad_°ack_size
;

109 } 
	tngx_c‹e_c⁄f_t
;

113 
ngx_poﬁ_t
 *
poﬁ
;

114 } 
	tngx_c‹e_és_t
;

117 
	#ngx_is_öô_cy˛e
(
cy˛e
Ë(cy˛e->
c⁄f_˘x
 =
NULL
)

	)

120 
ngx_cy˛e_t
 *
	`ngx_öô_cy˛e
“gx_cy˛e_à*
ﬁd_cy˛e
);

121 
ngx_öt_t
 
	`ngx_¸óã_pidfûe
(
ngx_°r_t
 *
«me
, 
ngx_log_t
 *
log
);

122 
	`ngx_dñëe_pidfûe
(
ngx_cy˛e_t
 *
cy˛e
);

123 
ngx_öt_t
 
	`ngx_sig«l_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
, *
sig
);

124 
	`ngx_ª›í_fûes
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_uid_t
 
u£r
);

125 **
	`ngx_£t_ívú⁄mít
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_uöt_t
 *
œ°
);

126 
ngx_pid_t
 
	`ngx_exec_√w_bö¨y
(
ngx_cy˛e_t
 *
cy˛e
, *c⁄° *
¨gv
);

127 
uöt64_t
 
	`ngx_gë_˝u_afföôy
(
ngx_uöt_t
 
n
);

128 
ngx_shm_z⁄e_t
 *
	`ngx_sh¨ed_mem‹y_add
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
«me
,

129 
size_t
 
size
, *
èg
);

132 vﬁ©ûê
ngx_cy˛e_t
 *
ngx_cy˛e
;

133 
ngx_¨øy_t
 
ngx_ﬁd_cy˛es
;

134 
ngx_moduÀ_t
 
ngx_c‹e_moduÀ
;

135 
ngx_uöt_t
 
ngx_ã°_c⁄fig
;

136 
ngx_uöt_t
 
ngx_quõt_mode
;

137 #i‡(
NGX_THREADS
)

138 
ngx_és_key_t
 
ngx_c‹e_és_key
;

	@ngx_file.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
ngx_©omic_t
 
	gãmp_numbî
 = 0;

13 
ngx_©omic_t
 *
	gngx_ãmp_numbî
 = &
ãmp_numbî
;

14 
ngx_©omic_öt_t
 
	gngx_øndom_numbî
 = 123456;

17 
ssize_t


18 
	$ngx_wrôe_chaö_to_ãmp_fûe
(
ngx_ãmp_fûe_t
 *
tf
, 
ngx_chaö_t
 *
chaö
)

20 
ngx_öt_t
 
rc
;

22 i‡(
tf
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

23 
rc
 = 
	`ngx_¸óã_ãmp_fûe
(&
tf
->
fûe
,Åf->
∑th
,Åf->
poﬁ
,

24 
tf
->
≥rsi°ít
,Åf->
˛ón
,Åf->
ac˚ss
);

26 i‡(
rc
 =
NGX_ERROR
 ||Ñ¯=
NGX_AGAIN
) {

27  
rc
;

30 i‡(
tf
->
log_Àvñ
) {

31 
	`ngx_log_îr‹
(
tf
->
log_Àvñ
,Åf->
fûe
.
log
, 0, "%s %V",

32 
tf
->
w¨n
, &tf->
fûe
.
«me
);

36  
	`ngx_wrôe_chaö_to_fûe
(&
tf
->
fûe
, 
chaö
,Åf->
off£t
,Åf->
poﬁ
);

37 
	}
}

40 
ngx_öt_t


41 
	$ngx_¸óã_ãmp_fûe
(
ngx_fûe_t
 *
fûe
, 
ngx_∑th_t
 *
∑th
, 
ngx_poﬁ_t
 *
poﬁ
,

42 
ngx_uöt_t
 
≥rsi°ít
,Çgx_uöt_à
˛ón
,Çgx_uöt_à
ac˚ss
)

44 
uöt32_t
 
n
;

45 
ngx_îr_t
 
îr
;

46 
ngx_poﬁ_˛ónup_t
 *
˛n
;

47 
ngx_poﬁ_˛ónup_fûe_t
 *
˛nf
;

49 
fûe
->
«me
.
Àn
 = 
∑th
->name.len + 1 +Öath->len + 10;

51 
fûe
->
«me
.
d©a
 = 
	`ngx_≤Æloc
(
poﬁ
, fûe->«me.
Àn
 + 1);

52 i‡(
fûe
->
«me
.
d©a
 =
NULL
) {

53  
NGX_ERROR
;

57 
i
 = 0; i < 
fûe
->
«me
.
Àn
; i++) {

58 
fûe
->
«me
.
d©a
[
i
] = 'X';

62 
	`ngx_mem˝y
(
fûe
->
«me
.
d©a
, 
∑th
->«me.d©a,Ö©h->«me.
Àn
);

64 
n
 = (
uöt32_t
Ë
	`ngx_√xt_ãmp_numbî
(0);

66 
˛n
 = 
	`ngx_poﬁ_˛ónup_add
(
poﬁ
, (
ngx_poﬁ_˛ónup_fûe_t
));

67 i‡(
˛n
 =
NULL
) {

68  
NGX_ERROR
;

72 (Ë
	`ngx_•rötf
(
fûe
->
«me
.
d©a
 + 
∑th
->«me.
Àn
 + 1 +Öath->len,

73 "%010uD%Z", 
n
);

75 
	`ngx_¸óã_hashed_fûíame
(
∑th
, 
fûe
->
«me
.
d©a
, fûe->«me.
Àn
);

77 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fûe
->
log
, 0,

78 "hashedÖ©h: %s", 
fûe
->
«me
.
d©a
);

80 
fûe
->
fd
 = 
	`ngx_›í_ãmpfûe
(fûe->
«me
.
d©a
, 
≥rsi°ít
, 
ac˚ss
);

82 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fûe
->
log
, 0,

83 "ãm∞fd:%d", 
fûe
->
fd
);

85 i‡(
fûe
->
fd
 !
NGX_INVALID_FILE
) {

87 
˛n
->
h™dÀr
 = 
˛ón
 ? 
ngx_poﬁ_dñëe_fûe
 : 
ngx_poﬁ_˛ónup_fûe
;

88 
˛nf
 = 
˛n
->
d©a
;

90 
˛nf
->
fd
 = 
fûe
->fd;

91 
˛nf
->
«me
 = 
fûe
->«me.
d©a
;

92 
˛nf
->
log
 = 
poﬁ
->log;

94  
NGX_OK
;

97 
îr
 = 
ngx_î∫o
;

99 i‡(
îr
 =
NGX_EEXIST
) {

100 
n
 = (
uöt32_t
Ë
	`ngx_√xt_ãmp_numbî
(1);

104 i‡((
∑th
->
Àvñ
[0] =0Ë|| (
îr
 !
NGX_ENOPATH
)) {

105 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
fûe
->
log
, 
îr
,

106 
ngx_›í_ãmpfûe_n
 " \"%s\" failed",

107 
fûe
->
«me
.
d©a
);

108  
NGX_ERROR
;

111 i‡(
	`ngx_¸óã_∑th
(
fûe
, 
∑th
Ë=
NGX_ERROR
) {

112  
NGX_ERROR
;

115 
	}
}

119 
	$ngx_¸óã_hashed_fûíame
(
ngx_∑th_t
 *
∑th
, 
u_ch¨
 *
fûe
, 
size_t
 
Àn
)

121 
size_t
 
i
, 
Àvñ
;

122 
ngx_uöt_t
 
n
;

124 
i
 = 
∑th
->
«me
.
Àn
 + 1;

126 
fûe
[
∑th
->
«me
.
Àn
 +Öath->len] = '/';

128 
n
 = 0;Ç < 3;Ç++) {

129 
Àvñ
 = 
∑th
->Àvñ[
n
];

131 i‡(
Àvñ
 == 0) {

135 
Àn
 -
Àvñ
;

136 
fûe
[
i
 - 1] = '/';

137 
	`ngx_mem˝y
(&
fûe
[
i
], &fûe[
Àn
], 
Àvñ
);

138 
i
 +
Àvñ
 + 1;

140 
	}
}

143 
ngx_öt_t


144 
	$ngx_¸óã_∑th
(
ngx_fûe_t
 *
fûe
, 
ngx_∑th_t
 *
∑th
)

146 
size_t
 
pos
;

147 
ngx_îr_t
 
îr
;

148 
ngx_uöt_t
 
i
;

150 
pos
 = 
∑th
->
«me
.
Àn
;

152 
i
 = 0; i < 3; i++) {

153 i‡(
∑th
->
Àvñ
[
i
] == 0) {

157 
pos
 +
∑th
->
Àvñ
[
i
] + 1;

159 
fûe
->
«me
.
d©a
[
pos
] = '\0';

161 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fûe
->
log
, 0,

162 "ãm∞fûe: \"%s\"", 
fûe
->
«me
.
d©a
);

164 i‡(
	`ngx_¸óã_dú
(
fûe
->
«me
.
d©a
, 0700Ë=
NGX_FILE_ERROR
) {

165 
îr
 = 
ngx_î∫o
;

166 i‡(
îr
 !
NGX_EEXIST
) {

167 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
fûe
->
log
, 
îr
,

168 
ngx_¸óã_dú_n
 " \"%s\" failed",

169 
fûe
->
«me
.
d©a
);

170  
NGX_ERROR
;

174 
fûe
->
«me
.
d©a
[
pos
] = '/';

177  
NGX_OK
;

178 
	}
}

181 
ngx_îr_t


182 
	$ngx_¸óã_fuŒ_∑th
(
u_ch¨
 *
dú
, 
ngx_uöt_t
 
ac˚ss
)

184 
u_ch¨
 *
p
, 
ch
;

185 
ngx_îr_t
 
îr
;

187 
îr
 = 0;

189 #i‡(
NGX_WIN32
)

190 
p
 = 
dú
 + 3;

192 
p
 = 
dú
 + 1;

195  ; *
p
;Ö++) {

196 
ch
 = *
p
;

198 i‡(
ch
 != '/') {

202 *
p
 = '\0';

204 i‡(
	`ngx_¸óã_dú
(
dú
, 
ac˚ss
Ë=
NGX_FILE_ERROR
) {

205 
îr
 = 
ngx_î∫o
;

207 
îr
) {

208 
NGX_EEXIST
:

209 
îr
 = 0;

210 
NGX_EACCES
:

214  
îr
;

218 *
p
 = '/';

221  
îr
;

222 
	}
}

225 
ngx_©omic_uöt_t


226 
	$ngx_√xt_ãmp_numbî
(
ngx_uöt_t
 
cﬁlisi⁄
)

228 
ngx_©omic_uöt_t
 
n
, 
add
;

230 
add
 = 
cﬁlisi⁄
 ? 
ngx_øndom_numbî
 : 1;

232 
n
 = 
	`ngx_©omic_„tch_add
(
ngx_ãmp_numbî
, 
add
);

234  
n
 + 
add
;

235 
	}
}

239 
	$ngx_c⁄f_£t_∑th_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

241 *
p
 = 
c⁄f
;

243 
ssize_t
 
Àvñ
;

244 
ngx_°r_t
 *
vÆue
;

245 
ngx_uöt_t
 
i
, 
n
;

246 
ngx_∑th_t
 *
∑th
, **
¶Ÿ
;

248 
¶Ÿ
 = (
ngx_∑th_t
 **Ë(
p
 + 
cmd
->
off£t
);

250 i‡(*
¶Ÿ
) {

254 
∑th
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_∑th_t
));

255 i‡(
∑th
 =
NULL
) {

256  
NGX_CONF_ERROR
;

259 
vÆue
 = 
cf
->
¨gs
->
ñts
;

261 
∑th
->
«me
 = 
vÆue
[1];

263 i‡(
∑th
->
«me
.
d©a
[∑th->«me.
Àn
 - 1] == '/') {

264 
∑th
->
«me
.
Àn
--;

267 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cf
->
cy˛e
, &
∑th
->
«me
, 0Ë!
NGX_OK
) {

268  
NULL
;

271 
∑th
->
Àn
 = 0;

272 
∑th
->
m™agî
 = 
NULL
;

273 
∑th
->
lﬂdî
 = 
NULL
;

274 
∑th
->
c⁄f_fûe
 = 
cf
->c⁄f_fûe->
fûe
.
«me
.
d©a
;

275 
∑th
->
löe
 = 
cf
->
c⁄f_fûe
->line;

277 
i
 = 0, 
n
 = 2;Ç < 
cf
->
¨gs
->
√…s
; i++,Ç++) {

278 
Àvñ
 = 
	`ngx_©oi
(
vÆue
[
n
].
d©a
, vÆue[n].
Àn
);

279 i‡(
Àvñ
 =
NGX_ERROR
 ||Üevel == 0) {

283 
∑th
->
Àvñ
[
i
] =Üevel;

284 
∑th
->
Àn
 +
Àvñ
 + 1;

287 
i
 < 3) {

288 
∑th
->
Àvñ
[
i
++] = 0;

291 *
¶Ÿ
 = 
∑th
;

293 i‡(
	`ngx_add_∑th
(
cf
, 
¶Ÿ
Ë=
NGX_ERROR
) {

294  
NGX_CONF_ERROR
;

297  
NGX_CONF_OK
;

298 
	}
}

302 
	$ngx_c⁄f_mîge_∑th_vÆue
(
ngx_c⁄f_t
 *
cf
, 
ngx_∑th_t
 **
∑th
,Çgx_∑th_à*
¥ev
,

303 
ngx_∑th_öô_t
 *
öô
)

305 i‡(*
∑th
) {

306  
NGX_CONF_OK
;

309 i‡(
¥ev
) {

310 *
∑th
 = 
¥ev
;

311  
NGX_CONF_OK
;

314 *
∑th
 = 
	`ngx_∑Œoc
(
cf
->
poﬁ
, (
ngx_∑th_t
));

315 i‡(*
∑th
 =
NULL
) {

316  
NGX_CONF_ERROR
;

319 (*
∑th
)->
«me
 = 
öô
->name;

321 i‡(
	`ngx_c⁄f_fuŒ_«me
(
cf
->
cy˛e
, &(*
∑th
)->
«me
, 0Ë!
NGX_OK
) {

322  
NGX_CONF_ERROR
;

325 (*
∑th
)->
Àvñ
[0] = 
öô
->level[0];

326 (*
∑th
)->
Àvñ
[1] = 
öô
->level[1];

327 (*
∑th
)->
Àvñ
[2] = 
öô
->level[2];

329 (*
∑th
)->
Àn
 = 
öô
->
Àvñ
[0] + (init->level[0] ? 1 : 0)

330 + 
öô
->
Àvñ
[1] + (init->level[1] ? 1 : 0)

331 + 
öô
->
Àvñ
[2] + (init->level[2] ? 1 : 0);

333 (*
∑th
)->
m™agî
 = 
NULL
;

334 (*
∑th
)->
lﬂdî
 = 
NULL
;

335 (*
∑th
)->
c⁄f_fûe
 = 
NULL
;

337 i‡(
	`ngx_add_∑th
(
cf
, 
∑th
Ë!
NGX_OK
) {

338  
NGX_CONF_ERROR
;

341  
NGX_CONF_OK
;

342 
	}
}

346 
	$ngx_c⁄f_£t_ac˚ss_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

348 *
c⁄Â
 = 
c⁄f
;

350 
u_ch¨
 *
p
;

351 
ngx_°r_t
 *
vÆue
;

352 
ngx_uöt_t
 
i
, 
right
, 
shi·
, *
ac˚ss
;

354 
ac˚ss
 = (
ngx_uöt_t
 *Ë(
c⁄Â
 + 
cmd
->
off£t
);

356 i‡(*
ac˚ss
 !
NGX_CONF_UNSET_UINT
) {

360 
vÆue
 = 
cf
->
¨gs
->
ñts
;

362 *
ac˚ss
 = 0600;

364 
i
 = 1; i < 
cf
->
¨gs
->
√…s
; i++) {

366 
p
 = 
vÆue
[
i
].
d©a
;

368 i‡(
	`ngx_°∫cmp
(
p
, "user:", ("user:") - 1) == 0) {

369 
shi·
 = 6;

370 
p
 += ("user:") - 1;

372 } i‡(
	`ngx_°∫cmp
(
p
, "group:", ("group:") - 1) == 0) {

373 
shi·
 = 3;

374 
p
 += ("group:") - 1;

376 } i‡(
	`ngx_°∫cmp
(
p
, "all:", ("all:") - 1) == 0) {

377 
shi·
 = 0;

378 
p
 += ("all:") - 1;

381 
övÆid
;

384 i‡(
	`ngx_°rcmp
(
p
, "rw") == 0) {

385 
right
 = 6;

387 } i‡(
	`ngx_°rcmp
(
p
, "r") == 0) {

388 
right
 = 4;

391 
övÆid
;

394 *
ac˚ss
 |
right
 << 
shi·
;

397  
NGX_CONF_OK
;

399 
övÆid
:

401 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0, "övÆid vÆuê\"%V\"", &
vÆue
[
i
]);

403  
NGX_CONF_ERROR
;

404 
	}
}

407 
ngx_öt_t


408 
	$ngx_add_∑th
(
ngx_c⁄f_t
 *
cf
, 
ngx_∑th_t
 **
¶Ÿ
)

410 
ngx_uöt_t
 
i
, 
n
;

411 
ngx_∑th_t
 *
∑th
, **
p
;

413 
∑th
 = *
¶Ÿ
;

415 
p
 = 
cf
->
cy˛e
->
∑thes
.
ñts
;

416 
i
 = 0; i < 
cf
->
cy˛e
->
∑thes
.
√…s
; i++) {

417 i‡(
p
[
i
]->
«me
.
Àn
 =
∑th
->name.len

418 && 
	`ngx_°rcmp
(
p
[
i
]->
«me
.
d©a
, 
∑th
->name.data) == 0)

420 
n
 = 0;Ç < 3;Ç++) {

421 i‡(
p
[
i
]->
Àvñ
[
n
] !
∑th
->level[n]) {

422 i‡(
∑th
->
c⁄f_fûe
 =
NULL
) {

423 i‡(
p
[
i
]->
c⁄f_fûe
 =
NULL
) {

424 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

429 &
p
[
i
]->
«me
);

430  
NGX_ERROR
;

433 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

438 &
p
[
i
]->
«me
,Ö[i]->
c⁄f_fûe
,Ö[i]->
löe
);

439  
NGX_ERROR
;

442 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

445 &
p
[
i
]->
«me
,Ö[i]->
c⁄f_fûe
,Ö[i]->
löe
);

446  
NGX_ERROR
;

449 i‡(
p
[
i
]->
Àvñ
[
n
] == 0) {

454 *
¶Ÿ
 = 
p
[
i
];

456  
NGX_OK
;

460 
p
 = 
	`ngx_¨øy_push
(&
cf
->
cy˛e
->
∑thes
);

461 i‡(
p
 =
NULL
) {

462  
NGX_ERROR
;

465 *
p
 = 
∑th
;

467  
NGX_OK
;

468 
	}
}

471 
ngx_öt_t


472 
	$ngx_¸óã_∑thes
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_uid_t
 
u£r
)

474 
ngx_îr_t
 
îr
;

475 
ngx_uöt_t
 
i
;

476 
ngx_∑th_t
 **
∑th
;

478 
∑th
 = 
cy˛e
->
∑thes
.
ñts
;

479 
i
 = 0; i < 
cy˛e
->
∑thes
.
√…s
; i++) {

481 i‡(
	`ngx_¸óã_dú
(
∑th
[
i
]->
«me
.
d©a
, 0700Ë=
NGX_FILE_ERROR
) {

482 
îr
 = 
ngx_î∫o
;

483 i‡(
îr
 !
NGX_EEXIST
) {

484 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
îr
,

485 
ngx_¸óã_dú_n
 " \"%s\" failed",

486 
∑th
[
i
]->
«me
.
d©a
);

487  
NGX_ERROR
;

491 i‡(
u£r
 =(
ngx_uid_t
Ë
NGX_CONF_UNSET_UINT
) {

495 #i‡!(
NGX_WIN32
)

497 
ngx_fûe_öfo_t
 
fi
;

499 i‡(
	`ngx_fûe_öfo
((c⁄° *Ë
∑th
[
i
]->
«me
.
d©a
, &
fi
)

500 =
NGX_FILE_ERROR
)

502 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

503 
ngx_fûe_öfo_n
 " \"%s\" faûed", 
∑th
[
i
]->
«me
.
d©a
);

504  
NGX_ERROR
;

507 i‡(
fi
.
°_uid
 !
u£r
) {

508 i‡(
	`chown
((c⁄° *Ë
∑th
[
i
]->
«me
.
d©a
, 
u£r
, -1) == -1) {

509 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

511 
∑th
[
i
]->
«me
.
d©a
, 
u£r
);

512  
NGX_ERROR
;

516 i‡((
fi
.
°_mode
 & (
S_IRUSR
|
S_IWUSR
|
S_IXUSR
))

517 !(
S_IRUSR
|
S_IWUSR
|
S_IXUSR
))

519 
fi
.
°_mode
 |(
S_IRUSR
|
S_IWUSR
|
S_IXUSR
);

521 i‡(
	`chmod
((c⁄° *Ë
∑th
[
i
]->
«me
.
d©a
, 
fi
.
°_mode
) == -1) {

522 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_î∫o
,

523 "chmod(Ë\"%s\" faûed", 
∑th
[
i
]->
«me
.
d©a
);

524  
NGX_ERROR
;

531  
NGX_OK
;

532 
	}
}

535 
ngx_öt_t


536 
	$ngx_ext_ª«me_fûe
(
ngx_°r_t
 *
§c
,Çgx_°r_à*
to
, 
ngx_ext_ª«me_fûe_t
 *
ext
)

538 
u_ch¨
 *
«me
;

539 
ngx_îr_t
 
îr
;

540 
ngx_c›y_fûe_t
 
cf
;

542 #i‡!(
NGX_WIN32
)

544 i‡(
ext
->
ac˚ss
) {

545 i‡(
	`ngx_ch™ge_fûe_ac˚ss
(
§c
->
d©a
, 
ext
->
ac˚ss
Ë=
NGX_FILE_ERROR
) {

546 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_î∫o
,

547 
ngx_ch™ge_fûe_ac˚ss_n
 " \"%s\" faûed", 
§c
->
d©a
);

548 
îr
 = 0;

549 
Áûed
;

555 i‡(
ext
->
time
 != -1) {

556 i‡(
	`ngx_£t_fûe_time
(
§c
->
d©a
, 
ext
->
fd
,Éxt->
time
Ë!
NGX_OK
) {

557 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_î∫o
,

558 
ngx_£t_fûe_time_n
 " \"%s\" faûed", 
§c
->
d©a
);

559 
îr
 = 0;

560 
Áûed
;

564 i‡(
	`ngx_ª«me_fûe
(
§c
->
d©a
, 
to
->d©aË!
NGX_FILE_ERROR
) {

565  
NGX_OK
;

568 
îr
 = 
ngx_î∫o
;

570 i‡(
îr
 =
NGX_ENOPATH
) {

572 i‡(!
ext
->
¸óã_∑th
) {

573 
Áûed
;

576 
îr
 = 
	`ngx_¸óã_fuŒ_∑th
(
to
->
d©a
, 
	`ngx_dú_ac˚ss
(
ext
->
∑th_ac˚ss
));

578 i‡(
îr
) {

579 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
îr
,

580 
ngx_¸óã_dú_n
 " \"%s\" faûed", 
to
->
d©a
);

581 
îr
 = 0;

582 
Áûed
;

585 i‡(
	`ngx_ª«me_fûe
(
§c
->
d©a
, 
to
->d©aË!
NGX_FILE_ERROR
) {

586  
NGX_OK
;

589 
îr
 = 
ngx_î∫o
;

592 #i‡(
NGX_WIN32
)

594 i‡(
îr
 =
NGX_EEXIST
) {

595 
îr
 = 
	`ngx_wö32_ª«me_fûe
(
§c
, 
to
, 
ext
->
log
);

597 i‡(
îr
 == 0) {

598  
NGX_OK
;

604 i‡(
îr
 =
NGX_EXDEV
) {

606 
cf
.
size
 = -1;

607 
cf
.
buf_size
 = 0;

608 
cf
.
ac˚ss
 = 
ext
->access;

609 
cf
.
time
 = 
ext
->time;

610 
cf
.
log
 = 
ext
->log;

612 
«me
 = 
	`ngx_Æloc
(
to
->
Àn
 + 1 + 10 + 1, 
ext
->
log
);

613 i‡(
«me
 =
NULL
) {

614  
NGX_ERROR
;

617 (Ë
	`ngx_•rötf
(
«me
, "%*s.%010uD%Z", 
to
->
Àn
,Åo->
d©a
,

618 (
uöt32_t
Ë
	`ngx_√xt_ãmp_numbî
(0));

620 i‡(
	`ngx_c›y_fûe
(
§c
->
d©a
, 
«me
, &
cf
Ë=
NGX_OK
) {

622 i‡(
	`ngx_ª«me_fûe
(
«me
, 
to
->
d©a
Ë!
NGX_FILE_ERROR
) {

623 
	`ngx_‰ì
(
«me
);

625 i‡(
	`ngx_dñëe_fûe
(
§c
->
d©a
Ë=
NGX_FILE_ERROR
) {

626 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_î∫o
,

627 
ngx_dñëe_fûe_n
 " \"%s\" failed",

628 
§c
->
d©a
);

629  
NGX_ERROR
;

632  
NGX_OK
;

635 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_î∫o
,

636 
ngx_ª«me_fûe_n
 " \"%s\"Åo \"%s\" failed",

637 
«me
, 
to
->
d©a
);

639 i‡(
	`ngx_dñëe_fûe
(
«me
Ë=
NGX_FILE_ERROR
) {

640 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_î∫o
,

641 
ngx_dñëe_fûe_n
 " \"%s\" faûed", 
«me
);

646 
	`ngx_‰ì
(
«me
);

648 
îr
 = 0;

651 
Áûed
:

653 i‡(
ext
->
dñëe_fûe
) {

654 i‡(
	`ngx_dñëe_fûe
(
§c
->
d©a
Ë=
NGX_FILE_ERROR
) {

655 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
ngx_î∫o
,

656 
ngx_dñëe_fûe_n
 " \"%s\" faûed", 
§c
->
d©a
);

660 i‡(
îr
) {

661 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ext
->
log
, 
îr
,

662 
ngx_ª«me_fûe_n
 " \"%s\"Åo \"%s\" failed",

663 
§c
->
d©a
, 
to
->data);

666  
NGX_ERROR
;

667 
	}
}

670 
ngx_öt_t


671 
	$ngx_c›y_fûe
(
u_ch¨
 *
‰om
, u_ch¨ *
to
, 
ngx_c›y_fûe_t
 *
cf
)

673 *
buf
;

674 
off_t
 
size
;

675 
size_t
 
Àn
;

676 
ssize_t
 
n
;

677 
ngx_fd_t
 
fd
, 
nfd
;

678 
ngx_öt_t
 
rc
;

679 
ngx_fûe_öfo_t
 
fi
;

681 
rc
 = 
NGX_ERROR
;

682 
buf
 = 
NULL
;

683 
nfd
 = 
NGX_INVALID_FILE
;

685 
fd
 = 
	`ngx_›í_fûe
(
‰om
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
, 0);

687 i‡(
fd
 =
NGX_INVALID_FILE
) {

688 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
cf
->
log
, 
ngx_î∫o
,

689 
ngx_›í_fûe_n
 " \"%s\" faûed", 
‰om
);

690 
Áûed
;

693 i‡(
cf
->
size
 != -1) {

694 
size
 = 
cf
->size;

697 i‡(
	`ngx_fd_öfo
(
fd
, &
fi
Ë=
NGX_FILE_ERROR
) {

698 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

699 
ngx_fd_öfo_n
 " \"%s\" faûed", 
‰om
);

701 
Áûed
;

704 
size
 = 
	`ngx_fûe_size
(&
fi
);

707 
Àn
 = 
cf
->
buf_size
 ? cf->buf_size : 65536;

709 i‡((
off_t
Ë
Àn
 > 
size
) {

710 
Àn
 = (
size_t
Ë
size
;

713 
buf
 = 
	`ngx_Æloc
(
Àn
, 
cf
->
log
);

714 i‡(
buf
 =
NULL
) {

715 
Áûed
;

718 
nfd
 = 
	`ngx_›í_fûe
(
to
, 
NGX_FILE_WRONLY
, 
NGX_FILE_CREATE_OR_OPEN
,

719 
cf
->
ac˚ss
);

721 i‡(
nfd
 =
NGX_INVALID_FILE
) {

722 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
cf
->
log
, 
ngx_î∫o
,

723 
ngx_›í_fûe_n
 " \"%s\" faûed", 
to
);

724 
Áûed
;

727 
size
 > 0) {

729 i‡((
off_t
Ë
Àn
 > 
size
) {

730 
Àn
 = (
size_t
Ë
size
;

733 
n
 = 
	`ngx_ªad_fd
(
fd
, 
buf
, 
Àn
);

735 i‡(
n
 =
NGX_FILE_ERROR
) {

736 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

737 
ngx_ªad_fd_n
 " \"%s\" faûed", 
‰om
);

738 
Áûed
;

741 i‡((
size_t
Ë
n
 !
Àn
) {

742 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

743 
ngx_ªad_fd_n
 " hasÑead only %z of %uz from %s",

744 
n
, 
size
, 
‰om
);

745 
Áûed
;

748 
n
 = 
	`ngx_wrôe_fd
(
nfd
, 
buf
, 
Àn
);

750 i‡(
n
 =
NGX_FILE_ERROR
) {

751 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

752 
ngx_wrôe_fd_n
 " \"%s\" faûed", 
to
);

753 
Áûed
;

756 i‡((
size_t
Ë
n
 !
Àn
) {

757 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

758 
ngx_wrôe_fd_n
 " has written only %z of %uzÅo %s",

759 
n
, 
size
, 
to
);

760 
Áûed
;

763 
size
 -
n
;

766 i‡(
cf
->
time
 != -1) {

767 i‡(
	`ngx_£t_fûe_time
(
to
, 
nfd
, 
cf
->
time
Ë!
NGX_OK
) {

768 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

769 
ngx_£t_fûe_time_n
 " \"%s\" faûed", 
to
);

770 
Áûed
;

774 
rc
 = 
NGX_OK
;

776 
Áûed
:

778 i‡(
nfd
 !
NGX_INVALID_FILE
) {

779 i‡(
	`ngx_˛o£_fûe
(
nfd
Ë=
NGX_FILE_ERROR
) {

780 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

781 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
to
);

785 i‡(
fd
 !
NGX_INVALID_FILE
) {

786 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

787 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cf
->
log
, 
ngx_î∫o
,

788 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
‰om
);

792 i‡(
buf
) {

793 
	`ngx_‰ì
(
buf
);

796  
rc
;

797 
	}
}

818 
ngx_öt_t


819 
	$ngx_wÆk_åì
(
ngx_åì_˘x_t
 *
˘x
, 
ngx_°r_t
 *
åì
)

821 *
d©a
, *
¥ev
;

822 
u_ch¨
 *
p
, *
«me
;

823 
size_t
 
Àn
;

824 
ngx_öt_t
 
rc
;

825 
ngx_îr_t
 
îr
;

826 
ngx_°r_t
 
fûe
, 
buf
;

827 
ngx_dú_t
 
dú
;

829 
	`ngx_°r_nuŒ
(&
buf
);

831 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
log
, 0,

832 "wÆkÅªê\"%V\"", 
åì
);

834 i‡(
	`ngx_›í_dú
(
åì
, &
dú
Ë=
NGX_ERROR
) {

835 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
˘x
->
log
, 
ngx_î∫o
,

836 
ngx_›í_dú_n
 " \"%s\" faûed", 
åì
->
d©a
);

837  
NGX_ERROR
;

840 
¥ev
 = 
˘x
->
d©a
;

842 i‡(
˘x
->
Æloc
) {

843 
d©a
 = 
	`ngx_Æloc
(
˘x
->
Æloc
, ctx->
log
);

844 i‡(
d©a
 =
NULL
) {

845 
Áûed
;

848 i‡(
˘x
->
	`öô_h™dÀr
(
d©a
, 
¥ev
Ë=
NGX_ABORT
) {

849 
Áûed
;

852 
˘x
->
d©a
 = data;

855 
d©a
 = 
NULL
;

860 
	`ngx_£t_î∫o
(0);

862 i‡(
	`ngx_ªad_dú
(&
dú
Ë=
NGX_ERROR
) {

863 
îr
 = 
ngx_î∫o
;

865 i‡(
îr
 =
NGX_ENOMOREFILES
) {

866 
rc
 = 
NGX_OK
;

869 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
˘x
->
log
, 
îr
,

870 
ngx_ªad_dú_n
 " \"%s\" faûed", 
åì
->
d©a
);

871 
rc
 = 
NGX_ERROR
;

874 
d⁄e
;

877 
Àn
 = 
	`ngx_de_«mñí
(&
dú
);

878 
«me
 = 
	`ngx_de_«me
(&
dú
);

880 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
log
, 0,

881 "åìÇamê%uz:\"%s\"", 
Àn
, 
«me
);

883 i‡(
Àn
 =1 && 
«me
[0] == '.') {

887 i‡(
Àn
 =2 && 
«me
[0] == '.' &&Çame[1] == '.') {

891 
fûe
.
Àn
 = 
åì
->len + 1 +Üen;

893 i‡(
fûe
.
Àn
 + 
NGX_DIR_MASK_LEN
 > 
buf
.len) {

895 i‡(
buf
.
Àn
) {

896 
	`ngx_‰ì
(
buf
.
d©a
);

899 
buf
.
Àn
 = 
åì
->À¿+ 1 +Üí + 
NGX_DIR_MASK_LEN
;

901 
buf
.
d©a
 = 
	`ngx_Æloc
(buf.
Àn
 + 1, 
˘x
->
log
);

902 i‡(
buf
.
d©a
 =
NULL
) {

903 
Áûed
;

907 
p
 = 
	`ngx_˝ymem
(
buf
.
d©a
, 
åì
->d©a,Åªe->
Àn
);

908 *
p
++ = '/';

909 
	`ngx_mem˝y
(
p
, 
«me
, 
Àn
 + 1);

911 
fûe
.
d©a
 = 
buf
.data;

913 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
log
, 0,

914 "åìÖ©h \"%s\"", 
fûe
.
d©a
);

916 i‡(!
dú
.
vÆid_öfo
) {

917 i‡(
	`ngx_de_öfo
(
fûe
.
d©a
, &
dú
Ë=
NGX_FILE_ERROR
) {

918 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
˘x
->
log
, 
ngx_î∫o
,

919 
ngx_de_öfo_n
 " \"%s\" faûed", 
fûe
.
d©a
);

924 i‡(
	`ngx_de_is_fûe
(&
dú
)) {

926 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
log
, 0,

927 "åì fûê\"%s\"", 
fûe
.
d©a
);

929 
˘x
->
size
 = 
	`ngx_de_size
(&
dú
);

930 
˘x
->
fs_size
 = 
	`ngx_de_fs_size
(&
dú
);

931 
˘x
->
ac˚ss
 = 
	`ngx_de_ac˚ss
(&
dú
);

932 
˘x
->
mtime
 = 
	`ngx_de_mtime
(&
dú
);

934 i‡(
˘x
->
	`fûe_h™dÀr
(˘x, &
fûe
Ë=
NGX_ABORT
) {

935 
Áûed
;

938 } i‡(
	`ngx_de_is_dú
(&
dú
)) {

940 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
log
, 0,

941 "åìÉ¡î dú \"%s\"", 
fûe
.
d©a
);

943 
˘x
->
ac˚ss
 = 
	`ngx_de_ac˚ss
(&
dú
);

944 
˘x
->
mtime
 = 
	`ngx_de_mtime
(&
dú
);

946 i‡(
˘x
->
	`¥e_åì_h™dÀr
(˘x, &
fûe
Ë=
NGX_ABORT
) {

947 
Áûed
;

950 i‡(
	`ngx_wÆk_åì
(
˘x
, &
fûe
Ë=
NGX_ABORT
) {

951 
Áûed
;

954 
˘x
->
ac˚ss
 = 
	`ngx_de_ac˚ss
(&
dú
);

955 
˘x
->
mtime
 = 
	`ngx_de_mtime
(&
dú
);

957 i‡(
˘x
->
	`po°_åì_h™dÀr
(˘x, &
fûe
Ë=
NGX_ABORT
) {

958 
Áûed
;

963 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
log
, 0,

964 "åì s≥cü»\"%s\"", 
fûe
.
d©a
);

966 i‡(
˘x
->
	`•ec_h™dÀr
(˘x, &
fûe
Ë=
NGX_ABORT
) {

967 
Áûed
;

972 
Áûed
:

974 
rc
 = 
NGX_ABORT
;

976 
d⁄e
:

978 i‡(
buf
.
Àn
) {

979 
	`ngx_‰ì
(
buf
.
d©a
);

982 i‡(
d©a
) {

983 
	`ngx_‰ì
(
d©a
);

984 
˘x
->
d©a
 = 
¥ev
;

987 i‡(
	`ngx_˛o£_dú
(&
dú
Ë=
NGX_ERROR
) {

988 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
˘x
->
log
, 
ngx_î∫o
,

989 
ngx_˛o£_dú_n
 " \"%s\" faûed", 
åì
->
d©a
);

992  
rc
;

993 
	}
}

	@ngx_file.h

8 #i‚de‡
_NGX_FILE_H_INCLUDED_


9 
	#_NGX_FILE_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
	sngx_fûe_s
 {

17 
ngx_fd_t
 
	mfd
;

18 
ngx_°r_t
 
	m«me
;

19 
ngx_fûe_öfo_t
 
	möfo
;

21 
off_t
 
	moff£t
;

22 
off_t
 
	msys_off£t
;

24 
ngx_log_t
 *
	mlog
;

26 #i‡(
NGX_HAVE_FILE_AIO
)

27 
ngx_evít_aio_t
 *
	maio
;

30 
	mvÆid_öfo
:1;

31 
	mdúe˘io
:1;

35 
	#NGX_MAX_PATH_LEVEL
 3

	)

38 
	$time_t
 (*
	tngx_∑th_m™agî_±
Ë(*
	td©a
);

39 (*
	tngx_∑th_lﬂdî_±
Ë(*
	td©a
);

43 
ngx_°r_t
 
«me
;

44 
size_t
 
Àn
;

45 
size_t
 
Àvñ
[3];

47 
ngx_∑th_m™agî_±
 
m™agî
;

48 
ngx_∑th_lﬂdî_±
 
lﬂdî
;

49 *
d©a
;

51 
u_ch¨
 *
c⁄f_fûe
;

52 
ngx_uöt_t
 
löe
;

53 } 
	tngx_∑th_t
;

57 
ngx_°r_t
 
«me
;

58 
size_t
 
Àvñ
[3];

59 } 
	tngx_∑th_öô_t
;

63 
ngx_fûe_t
 
fûe
;

64 
off_t
 
off£t
;

65 
ngx_∑th_t
 *
∑th
;

66 
ngx_poﬁ_t
 *
poﬁ
;

67 *
w¨n
;

69 
ngx_uöt_t
 
ac˚ss
;

71 
log_Àvñ
:8;

72 
≥rsi°ít
:1;

73 
˛ón
:1;

74 } 
	tngx_ãmp_fûe_t
;

78 
ngx_uöt_t
 
ac˚ss
;

79 
ngx_uöt_t
 
∑th_ac˚ss
;

80 
time_t
 
time
;

81 
ngx_fd_t
 
fd
;

83 
¸óã_∑th
:1;

84 
dñëe_fûe
:1;

86 
ngx_log_t
 *
log
;

87 } 
	tngx_ext_ª«me_fûe_t
;

91 
off_t
 
size
;

92 
size_t
 
buf_size
;

94 
ngx_uöt_t
 
ac˚ss
;

95 
time_t
 
time
;

97 
ngx_log_t
 *
log
;

98 } 
	tngx_c›y_fûe_t
;

101 
ngx_åì_˘x_s
 
	tngx_åì_˘x_t
;

103 
	$ngx_öt_t
 (*
	tngx_åì_öô_h™dÀr_±
Ë(*
	t˘x
, *
	t¥ev
);

104 
	$ngx_öt_t
 (*
	tngx_åì_h™dÀr_±
Ë(
	tngx_åì_˘x_t
 *
	t˘x
, 
	tngx_°r_t
 *
	t«me
);

106 
	sngx_åì_˘x_s
 {

107 
off_t
 
size
;

108 
off_t
 
fs_size
;

109 
ngx_uöt_t
 
ac˚ss
;

110 
time_t
 
mtime
;

112 
ngx_åì_öô_h™dÀr_±
 
öô_h™dÀr
;

113 
ngx_åì_h™dÀr_±
 
fûe_h™dÀr
;

114 
ngx_åì_h™dÀr_±
 
¥e_åì_h™dÀr
;

115 
ngx_åì_h™dÀr_±
 
po°_åì_h™dÀr
;

116 
ngx_åì_h™dÀr_±
 
•ec_h™dÀr
;

118 *
d©a
;

119 
size_t
 
Æloc
;

121 
ngx_log_t
 *
log
;

125 
ssize_t
 
	`ngx_wrôe_chaö_to_ãmp_fûe
(
ngx_ãmp_fûe_t
 *
tf
, 
ngx_chaö_t
 *
chaö
);

126 
ngx_öt_t
 
	`ngx_¸óã_ãmp_fûe
(
ngx_fûe_t
 *
fûe
, 
ngx_∑th_t
 *
∑th
,

127 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
≥rsi°ít
,Çgx_uöt_à
˛ón
,

128 
ngx_uöt_t
 
ac˚ss
);

129 
	`ngx_¸óã_hashed_fûíame
(
ngx_∑th_t
 *
∑th
, 
u_ch¨
 *
fûe
, 
size_t
 
Àn
);

130 
ngx_öt_t
 
	`ngx_¸óã_∑th
(
ngx_fûe_t
 *
fûe
, 
ngx_∑th_t
 *
∑th
);

131 
ngx_îr_t
 
	`ngx_¸óã_fuŒ_∑th
(
u_ch¨
 *
dú
, 
ngx_uöt_t
 
ac˚ss
);

132 
ngx_öt_t
 
	`ngx_add_∑th
(
ngx_c⁄f_t
 *
cf
, 
ngx_∑th_t
 **
¶Ÿ
);

133 
ngx_öt_t
 
	`ngx_¸óã_∑thes
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_uid_t
 
u£r
);

134 
ngx_öt_t
 
	`ngx_ext_ª«me_fûe
(
ngx_°r_t
 *
§c
,Çgx_°r_à*
to
,

135 
ngx_ext_ª«me_fûe_t
 *
ext
);

136 
ngx_öt_t
 
	`ngx_c›y_fûe
(
u_ch¨
 *
‰om
, u_ch¨ *
to
, 
ngx_c›y_fûe_t
 *
cf
);

137 
ngx_öt_t
 
	`ngx_wÆk_åì
(
ngx_åì_˘x_t
 *
˘x
, 
ngx_°r_t
 *
åì
);

139 
ngx_©omic_uöt_t
 
	`ngx_√xt_ãmp_numbî
(
ngx_uöt_t
 
cﬁlisi⁄
);

141 *
	`ngx_c⁄f_£t_∑th_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

142 *
	`ngx_c⁄f_mîge_∑th_vÆue
(
ngx_c⁄f_t
 *
cf
, 
ngx_∑th_t
 **
∑th
,

143 
ngx_∑th_t
 *
¥ev
, 
ngx_∑th_öô_t
 *
öô
);

144 *
	`ngx_c⁄f_£t_ac˚ss_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

147 
ngx_©omic_t
 *
ngx_ãmp_numbî
;

148 
ngx_©omic_öt_t
 
ngx_øndom_numbî
;

	@ngx_hash.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

13 
	$ngx_hash_föd
(
ngx_hash_t
 *
hash
, 
ngx_uöt_t
 
key
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
)

15 
ngx_uöt_t
 
i
;

16 
ngx_hash_ñt_t
 *
ñt
;

19 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "hf:\"%*s\"", 
Àn
, 
«me
);

22 
ñt
 = 
hash
->
buckës
[
key
 % hash->
size
];

24 i‡(
ñt
 =
NULL
) {

25  
NULL
;

28 
ñt
->
vÆue
) {

29 i‡(
Àn
 !(
size_t
Ë
ñt
->len) {

30 
√xt
;

33 
i
 = 0; i < 
Àn
; i++) {

34 i‡(
«me
[
i
] !
ñt
->name[i]) {

35 
√xt
;

39  
ñt
->
vÆue
;

41 
√xt
:

43 
ñt
 = (
ngx_hash_ñt_t
 *Ë
	`ngx_Æign_±r
(&ñt->
«me
[0] +É…->
Àn
,

48  
NULL
;

49 
	}
}

53 
	$ngx_hash_föd_wc_hód
(
ngx_hash_wûdˇrd_t
 *
hwc
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
)

55 *
vÆue
;

56 
ngx_uöt_t
 
i
, 
n
, 
key
;

59 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "wch:\"%*s\"", 
Àn
, 
«me
);

62 
n
 = 
Àn
;

64 
n
) {

65 i‡(
«me
[
n
 - 1] == '.') {

69 
n
--;

72 
key
 = 0;

74 
i
 = 
n
; i < 
Àn
; i++) {

75 
key
 = 
	`ngx_hash
(key, 
«me
[
i
]);

79 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "key:\"%ui\"", 
key
);

82 
vÆue
 = 
	`ngx_hash_föd
(&
hwc
->
hash
, 
key
, &
«me
[
n
], 
Àn
 -Ç);

85 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "vÆue:\"%p\"", 
vÆue
);

88 i‡(
vÆue
) {

101 i‡((
uöçå_t
Ë
vÆue
 & 2) {

103 i‡(
n
 == 0) {

107 i‡((
uöçå_t
Ë
vÆue
 & 1) {

108  
NULL
;

111 
hwc
 = (
ngx_hash_wûdˇrd_t
 *)

112 ((
uöçå_t
Ë
vÆue
 & (uintptr_t) ~3);

113  
hwc
->
vÆue
;

116 
hwc
 = (
ngx_hash_wûdˇrd_t
 *Ë((
uöçå_t
Ë
vÆue
 & (uintptr_t) ~3);

118 
vÆue
 = 
	`ngx_hash_föd_wc_hód
(
hwc
, 
«me
, 
n
 - 1);

120 i‡(
vÆue
) {

121  
vÆue
;

124  
hwc
->
vÆue
;

127 i‡((
uöçå_t
Ë
vÆue
 & 1) {

129 i‡(
n
 == 0) {

133  
NULL
;

136  (*Ë((
uöçå_t
Ë
vÆue
 & (uintptr_t) ~3);

139  
vÆue
;

142  
hwc
->
vÆue
;

143 
	}
}

147 
	$ngx_hash_föd_wc_èû
(
ngx_hash_wûdˇrd_t
 *
hwc
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
)

149 *
vÆue
;

150 
ngx_uöt_t
 
i
, 
key
;

153 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "w˘:\"%*s\"", 
Àn
, 
«me
);

156 
key
 = 0;

158 
i
 = 0; i < 
Àn
; i++) {

159 i‡(
«me
[
i
] == '.') {

163 
key
 = 
	`ngx_hash
(key, 
«me
[
i
]);

166 i‡(
i
 =
Àn
) {

167  
NULL
;

171 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "key:\"%ui\"", 
key
);

174 
vÆue
 = 
	`ngx_hash_föd
(&
hwc
->
hash
, 
key
, 
«me
, 
i
);

177 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "vÆue:\"%p\"", 
vÆue
);

180 i‡(
vÆue
) {

188 i‡((
uöçå_t
Ë
vÆue
 & 2) {

190 
i
++;

192 
hwc
 = (
ngx_hash_wûdˇrd_t
 *Ë((
uöçå_t
Ë
vÆue
 & (uintptr_t) ~3);

194 
vÆue
 = 
	`ngx_hash_föd_wc_èû
(
hwc
, &
«me
[
i
], 
Àn
 - i);

196 i‡(
vÆue
) {

197  
vÆue
;

200  
hwc
->
vÆue
;

203  
vÆue
;

206  
hwc
->
vÆue
;

207 
	}
}

211 
	$ngx_hash_föd_comböed
(
ngx_hash_comböed_t
 *
hash
, 
ngx_uöt_t
 
key
, 
u_ch¨
 *
«me
,

212 
size_t
 
Àn
)

214 *
vÆue
;

216 i‡(
hash
->hash.
buckës
) {

217 
vÆue
 = 
	`ngx_hash_föd
(&
hash
->hash, 
key
, 
«me
, 
Àn
);

219 i‡(
vÆue
) {

220  
vÆue
;

224 i‡(
Àn
 == 0) {

225  
NULL
;

228 i‡(
hash
->
wc_hód
 && hash->wc_hód->hash.
buckës
) {

229 
vÆue
 = 
	`ngx_hash_föd_wc_hód
(
hash
->
wc_hód
, 
«me
, 
Àn
);

231 i‡(
vÆue
) {

232  
vÆue
;

236 i‡(
hash
->
wc_èû
 && hash->wc_èû->hash.
buckës
) {

237 
vÆue
 = 
	`ngx_hash_föd_wc_èû
(
hash
->
wc_èû
, 
«me
, 
Àn
);

239 i‡(
vÆue
) {

240  
vÆue
;

244  
NULL
;

245 
	}
}

248 
	#NGX_HASH_ELT_SIZE
(
«me
) \

249 ((*Ë+ 
	`ngx_Æign
((
«me
)->
key
.
Àn
 + 2, (*)))

	)

251 
ngx_öt_t


252 
	$ngx_hash_öô
(
ngx_hash_öô_t
 *
höô
, 
ngx_hash_key_t
 *
«mes
, 
ngx_uöt_t
 
√…s
)

254 
u_ch¨
 *
ñts
;

255 
size_t
 
Àn
;

256 
u_sh‹t
 *
ã°
;

257 
ngx_uöt_t
 
i
, 
n
, 
key
, 
size
, 
°¨t
, 
buckë_size
;

258 
ngx_hash_ñt_t
 *
ñt
, **
buckës
;

260 
n
 = 0;Ç < 
√…s
;Ç++) {

261 i‡(
höô
->
buckë_size
 < 
	`NGX_HASH_ELT_SIZE
(&
«mes
[
n
]) + (*))

263 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
höô
->
poﬁ
->
log
, 0,

266 
höô
->
«me
, höô->«me, höô->
buckë_size
);

267  
NGX_ERROR
;

271 
ã°
 = 
	`ngx_Æloc
(
höô
->
max_size
 * (
u_sh‹t
), höô->
poﬁ
->
log
);

272 i‡(
ã°
 =
NULL
) {

273  
NGX_ERROR
;

276 
buckë_size
 = 
höô
->bucket_size - (*);

278 
°¨t
 = 
√…s
 / (
buckë_size
 / (2 * (*)));

279 
°¨t
 = start ? start : 1;

281 i‡(
höô
->
max_size
 > 10000 && 
√…s
 && hinit->max_size /Çelts < 100) {

282 
°¨t
 = 
höô
->
max_size
 - 1000;

285 
size
 = 
°¨t
; sizê< 
höô
->
max_size
; size++) {

287 
	`ngx_memzîo
(
ã°
, 
size
 * (
u_sh‹t
));

289 
n
 = 0;Ç < 
√…s
;Ç++) {

290 i‡(
«mes
[
n
].
key
.
d©a
 =
NULL
) {

294 
key
 = 
«mes
[
n
].
key_hash
 % 
size
;

295 
ã°
[
key
] = (
u_sh‹t
Ë—e°[key] + 
	`NGX_HASH_ELT_SIZE
(&
«mes
[
n
]));

298 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

300 
size
, 
key
, 
ã°
[key], &
«mes
[
n
].key);

303 i‡(
ã°
[
key
] > (
u_sh‹t
Ë
buckë_size
) {

304 
√xt
;

308 
found
;

310 
√xt
:

315 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
höô
->
poﬁ
->
log
, 0,

318 
höô
->
«me
, höô->«me, höô->
max_size
,

319 
höô
->
«me
, höô->
buckë_size
);

321 
	`ngx_‰ì
(
ã°
);

323  
NGX_ERROR
;

325 
found
:

327 
i
 = 0; i < 
size
; i++) {

328 
ã°
[
i
] = (*);

331 
n
 = 0;Ç < 
√…s
;Ç++) {

332 i‡(
«mes
[
n
].
key
.
d©a
 =
NULL
) {

336 
key
 = 
«mes
[
n
].
key_hash
 % 
size
;

337 
ã°
[
key
] = (
u_sh‹t
Ë—e°[key] + 
	`NGX_HASH_ELT_SIZE
(&
«mes
[
n
]));

340 
Àn
 = 0;

342 
i
 = 0; i < 
size
; i++) {

343 i‡(
ã°
[
i
] == (*)) {

347 
ã°
[
i
] = (
u_sh‹t
Ë(
	`ngx_Æign
—e°[i], 
ngx_ˇchñöe_size
));

349 
Àn
 +
ã°
[
i
];

352 i‡(
höô
->
hash
 =
NULL
) {

353 
höô
->
hash
 = 
	`ngx_pˇŒoc
(höô->
poﬁ
, (
ngx_hash_wûdˇrd_t
)

354 + 
size
 * (
ngx_hash_ñt_t
 *));

355 i‡(
höô
->
hash
 =
NULL
) {

356 
	`ngx_‰ì
(
ã°
);

357  
NGX_ERROR
;

360 
buckës
 = (
ngx_hash_ñt_t
 **)

361 ((
u_ch¨
 *Ë
höô
->
hash
 + (
ngx_hash_wûdˇrd_t
));

364 
buckës
 = 
	`ngx_pˇŒoc
(
höô
->
poﬁ
, 
size
 * (
ngx_hash_ñt_t
 *));

365 i‡(
buckës
 =
NULL
) {

366 
	`ngx_‰ì
(
ã°
);

367  
NGX_ERROR
;

371 
ñts
 = 
	`ngx_∑Œoc
(
höô
->
poﬁ
, 
Àn
 + 
ngx_ˇchñöe_size
);

372 i‡(
ñts
 =
NULL
) {

373 
	`ngx_‰ì
(
ã°
);

374  
NGX_ERROR
;

377 
ñts
 = 
	`ngx_Æign_±r
”…s, 
ngx_ˇchñöe_size
);

379 
i
 = 0; i < 
size
; i++) {

380 i‡(
ã°
[
i
] == (*)) {

384 
buckës
[
i
] = (
ngx_hash_ñt_t
 *Ë
ñts
;

385 
ñts
 +
ã°
[
i
];

389 
i
 = 0; i < 
size
; i++) {

390 
ã°
[
i
] = 0;

393 
n
 = 0;Ç < 
√…s
;Ç++) {

394 i‡(
«mes
[
n
].
key
.
d©a
 =
NULL
) {

398 
key
 = 
«mes
[
n
].
key_hash
 % 
size
;

399 
ñt
 = (
ngx_hash_ñt_t
 *Ë((
u_ch¨
 *Ë
buckës
[
key
] + 
ã°
[key]);

401 
ñt
->
vÆue
 = 
«mes
[
n
].value;

402 
ñt
->
Àn
 = (
u_sh‹t
Ë
«mes
[
n
].
key
.len;

404 
	`ngx_°æow
(
ñt
->
«me
, 
«mes
[
n
].
key
.
d©a
,Çames[n].key.
Àn
);

406 
ã°
[
key
] = (
u_sh‹t
Ë—e°[key] + 
	`NGX_HASH_ELT_SIZE
(&
«mes
[
n
]));

409 
i
 = 0; i < 
size
; i++) {

410 i‡(
buckës
[
i
] =
NULL
) {

414 
ñt
 = (
ngx_hash_ñt_t
 *Ë((
u_ch¨
 *Ë
buckës
[
i
] + 
ã°
[i]);

416 
ñt
->
vÆue
 = 
NULL
;

419 
	`ngx_‰ì
(
ã°
);

421 
höô
->
hash
->
buckës
 = buckets;

422 
höô
->
hash
->
size
 = size;

426 
i
 = 0; i < 
size
; i++) {

427 
ngx_°r_t
 
vÆ
;

428 
ngx_uöt_t
 
key
;

430 
ñt
 = 
buckës
[
i
];

432 i‡(
ñt
 =
NULL
) {

433 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

434 "%ui: NULL", 
i
);

438 
ñt
->
vÆue
) {

439 
vÆ
.
Àn
 = 
ñt
->len;

440 
vÆ
.
d©a
 = &
ñt
->
«me
[0];

442 
key
 = 
höô
->
	`key
(
vÆ
.
d©a
, vÆ.
Àn
);

444 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

445 "%ui: %∞\"%V\" %ui", 
i
, 
ñt
, &
vÆ
, 
key
);

447 
ñt
 = (
ngx_hash_ñt_t
 *Ë
	`ngx_Æign_±r
(&ñt->
«me
[0] +É…->
Àn
,

454  
NGX_OK
;

455 
	}
}

458 
ngx_öt_t


459 
	$ngx_hash_wûdˇrd_öô
(
ngx_hash_öô_t
 *
höô
, 
ngx_hash_key_t
 *
«mes
,

460 
ngx_uöt_t
 
√…s
)

462 
size_t
 
Àn
, 
dŸ_Àn
;

463 
ngx_uöt_t
 
i
, 
n
, 
dŸ
;

464 
ngx_¨øy_t
 
cuº_«mes
, 
√xt_«mes
;

465 
ngx_hash_key_t
 *
«me
, *
√xt_«me
;

466 
ngx_hash_öô_t
 
h
;

467 
ngx_hash_wûdˇrd_t
 *
wdc
;

469 i‡(
	`ngx_¨øy_öô
(&
cuº_«mes
, 
höô
->
ãmp_poﬁ
, 
√…s
,

470 (
ngx_hash_key_t
))

471 !
NGX_OK
)

473  
NGX_ERROR
;

476 i‡(
	`ngx_¨øy_öô
(&
√xt_«mes
, 
höô
->
ãmp_poﬁ
, 
√…s
,

477 (
ngx_hash_key_t
))

478 !
NGX_OK
)

480  
NGX_ERROR
;

483 
n
 = 0;Ç < 
√…s
;Ç = 
i
) {

486 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

487 "wc0: \"%V\"", &
«mes
[
n
].
key
);

490 
dŸ
 = 0;

492 
Àn
 = 0;Üí < 
«mes
[
n
].
key
.len;Üen++) {

493 i‡(
«mes
[
n
].
key
.
d©a
[
Àn
] == '.') {

494 
dŸ
 = 1;

499 
«me
 = 
	`ngx_¨øy_push
(&
cuº_«mes
);

500 i‡(
«me
 =
NULL
) {

501  
NGX_ERROR
;

504 
«me
->
key
.
Àn
 =Üen;

505 
«me
->
key
.
d©a
 = 
«mes
[
n
].key.data;

506 
«me
->
key_hash
 = 
höô
->
	`key
“ame->
key
.
d©a
,Çame->key.
Àn
);

507 
«me
->
vÆue
 = 
«mes
[
n
].value;

510 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

511 "wc1: \"%V\" %ui", &
«me
->
key
, 
dŸ
);

514 
dŸ_Àn
 = 
Àn
 + 1;

516 i‡(
dŸ
) {

517 
Àn
++;

520 
√xt_«mes
.
√…s
 = 0;

522 i‡(
«mes
[
n
].
key
.
Àn
 !=Üen) {

523 
√xt_«me
 = 
	`ngx_¨øy_push
(&
√xt_«mes
);

524 i‡(
√xt_«me
 =
NULL
) {

525  
NGX_ERROR
;

528 
√xt_«me
->
key
.
Àn
 = 
«mes
[
n
].key.len -Üen;

529 
√xt_«me
->
key
.
d©a
 = 
«mes
[
n
].key.d©®+ 
Àn
;

530 
√xt_«me
->
key_hash
 = 0;

531 
√xt_«me
->
vÆue
 = 
«mes
[
n
].value;

534 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

535 "wc2: \"%V\"", &
√xt_«me
->
key
);

539 
i
 = 
n
 + 1; i < 
√…s
; i++) {

540 i‡(
	`ngx_°∫cmp
(
«mes
[
n
].
key
.
d©a
,Çames[
i
].key.d©a, 
Àn
) != 0) {

544 i‡(!
dŸ


545 && 
«mes
[
i
].
key
.
Àn
 >Üen

546 && 
«mes
[
i
].
key
.
d©a
[
Àn
] != '.')

551 
√xt_«me
 = 
	`ngx_¨øy_push
(&
√xt_«mes
);

552 i‡(
√xt_«me
 =
NULL
) {

553  
NGX_ERROR
;

556 
√xt_«me
->
key
.
Àn
 = 
«mes
[
i
].key.À¿- 
dŸ_Àn
;

557 
√xt_«me
->
key
.
d©a
 = 
«mes
[
i
].key.d©®+ 
dŸ_Àn
;

558 
√xt_«me
->
key_hash
 = 0;

559 
√xt_«me
->
vÆue
 = 
«mes
[
i
].value;

562 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
höô
->
poﬁ
->
log
, 0,

563 "wc3: \"%V\"", &
√xt_«me
->
key
);

567 i‡(
√xt_«mes
.
√…s
) {

569 
h
 = *
höô
;

570 
h
.
hash
 = 
NULL
;

572 i‡(
	`ngx_hash_wûdˇrd_öô
(&
h
, (
ngx_hash_key_t
 *Ë
√xt_«mes
.
ñts
,

573 
√xt_«mes
.
√…s
)

574 !
NGX_OK
)

576  
NGX_ERROR
;

579 
wdc
 = (
ngx_hash_wûdˇrd_t
 *Ë
h
.
hash
;

581 i‡(
«mes
[
n
].
key
.
Àn
 ==Üen) {

582 
wdc
->
vÆue
 = 
«mes
[
n
].value;

585 
«me
->
vÆue
 = (*Ë((
uöçå_t
Ë
wdc
 | (
dŸ
 ? 3 : 2));

587 } i‡(
dŸ
) {

588 
«me
->
vÆue
 = (*Ë((
uöçå_t
)Çame->value | 1);

592 i‡(
	`ngx_hash_öô
(
höô
, (
ngx_hash_key_t
 *Ë
cuº_«mes
.
ñts
,

593 
cuº_«mes
.
√…s
)

594 !
NGX_OK
)

596  
NGX_ERROR
;

599  
NGX_OK
;

600 
	}
}

603 
ngx_uöt_t


604 
	$ngx_hash_key
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
)

606 
ngx_uöt_t
 
i
, 
key
;

608 
key
 = 0;

610 
i
 = 0; i < 
Àn
; i++) {

611 
key
 = 
	`ngx_hash
(key, 
d©a
[
i
]);

614  
key
;

615 
	}
}

618 
ngx_uöt_t


619 
	$ngx_hash_key_lc
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
)

621 
ngx_uöt_t
 
i
, 
key
;

623 
key
 = 0;

625 
i
 = 0; i < 
Àn
; i++) {

626 
key
 = 
	`ngx_hash
(key, 
	`ngx_tﬁowî
(
d©a
[
i
]));

629  
key
;

630 
	}
}

633 
ngx_uöt_t


634 
	$ngx_hash_°æow
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
n
)

636 
ngx_uöt_t
 
key
;

638 
key
 = 0;

640 
n
--) {

641 *
d°
 = 
	`ngx_tﬁowî
(*
§c
);

642 
key
 = 
	`ngx_hash
(key, *
d°
);

643 
d°
++;

644 
§c
++;

647  
key
;

648 
	}
}

651 
ngx_öt_t


652 
	$ngx_hash_keys_¨øy_öô
(
ngx_hash_keys_¨øys_t
 *
ha
, 
ngx_uöt_t
 
ty≥
)

654 
ngx_uöt_t
 
asize
;

656 i‡(
ty≥
 =
NGX_HASH_SMALL
) {

657 
asize
 = 4;

658 
ha
->
hsize
 = 107;

661 
asize
 = 
NGX_HASH_LARGE_ASIZE
;

662 
ha
->
hsize
 = 
NGX_HASH_LARGE_HSIZE
;

665 i‡(
	`ngx_¨øy_öô
(&
ha
->
keys
, ha->
ãmp_poﬁ
, 
asize
, (
ngx_hash_key_t
))

666 !
NGX_OK
)

668  
NGX_ERROR
;

671 i‡(
	`ngx_¨øy_öô
(&
ha
->
dns_wc_hód
, ha->
ãmp_poﬁ
, 
asize
,

672 (
ngx_hash_key_t
))

673 !
NGX_OK
)

675  
NGX_ERROR
;

678 i‡(
	`ngx_¨øy_öô
(&
ha
->
dns_wc_èû
, ha->
ãmp_poﬁ
, 
asize
,

679 (
ngx_hash_key_t
))

680 !
NGX_OK
)

682  
NGX_ERROR
;

685 
ha
->
keys_hash
 = 
	`ngx_pˇŒoc
(ha->
ãmp_poﬁ
, (
ngx_¨øy_t
Ë* ha->
hsize
);

686 i‡(
ha
->
keys_hash
 =
NULL
) {

687  
NGX_ERROR
;

690 
ha
->
dns_wc_hód_hash
 = 
	`ngx_pˇŒoc
(ha->
ãmp_poﬁ
,

691 (
ngx_¨øy_t
Ë* 
ha
->
hsize
);

692 i‡(
ha
->
dns_wc_hód_hash
 =
NULL
) {

693  
NGX_ERROR
;

696 
ha
->
dns_wc_èû_hash
 = 
	`ngx_pˇŒoc
(ha->
ãmp_poﬁ
,

697 (
ngx_¨øy_t
Ë* 
ha
->
hsize
);

698 i‡(
ha
->
dns_wc_èû_hash
 =
NULL
) {

699  
NGX_ERROR
;

702  
NGX_OK
;

703 
	}
}

706 
ngx_öt_t


707 
	$ngx_hash_add_key
(
ngx_hash_keys_¨øys_t
 *
ha
, 
ngx_°r_t
 *
key
, *
vÆue
,

708 
ngx_uöt_t
 
Êags
)

710 
size_t
 
Àn
;

711 
u_ch¨
 *
p
;

712 
ngx_°r_t
 *
«me
;

713 
ngx_uöt_t
 
i
, 
k
, 
n
, 
skù
, 
œ°
;

714 
ngx_¨øy_t
 *
keys
, *
hwc
;

715 
ngx_hash_key_t
 *
hk
;

717 
œ°
 = 
key
->
Àn
;

719 i‡(
Êags
 & 
NGX_HASH_WILDCARD_KEY
) {

726 
n
 = 0;

728 
i
 = 0; i < 
key
->
Àn
; i++) {

730 i‡(
key
->
d©a
[
i
] == '*') {

731 i‡(++
n
 > 1) {

732  
NGX_DECLINED
;

736 i‡(
key
->
d©a
[
i
] == '.' && key->data[i + 1] == '.') {

737  
NGX_DECLINED
;

741 i‡(
key
->
Àn
 > 1 && key->
d©a
[0] == '.') {

742 
skù
 = 1;

743 
wûdˇrd
;

746 i‡(
key
->
Àn
 > 2) {

748 i‡(
key
->
d©a
[0] == '*' && key->data[1] == '.') {

749 
skù
 = 2;

750 
wûdˇrd
;

753 i‡(
key
->
d©a
[
i
 - 2] == '.' && key->data[i - 1] == '*') {

754 
skù
 = 0;

755 
œ°
 -= 2;

756 
wûdˇrd
;

760 i‡(
n
) {

761  
NGX_DECLINED
;

767 
k
 = 0;

769 
i
 = 0; i < 
œ°
; i++) {

770 i‡(!(
Êags
 & 
NGX_HASH_READONLY_KEY
)) {

771 
key
->
d©a
[
i
] = 
	`ngx_tﬁowî
(key->data[i]);

773 
k
 = 
	`ngx_hash
(k, 
key
->
d©a
[
i
]);

776 
k
 %
ha
->
hsize
;

780 
«me
 = 
ha
->
keys_hash
[
k
].
ñts
;

782 i‡(
«me
) {

783 
i
 = 0; i < 
ha
->
keys_hash
[
k
].
√…s
; i++) {

784 i‡(
œ°
 !
«me
[
i
].
Àn
) {

788 i‡(
	`ngx_°∫cmp
(
key
->
d©a
, 
«me
[
i
].d©a, 
œ°
) == 0) {

789  
NGX_BUSY
;

794 i‡(
	`ngx_¨øy_öô
(&
ha
->
keys_hash
[
k
], ha->
ãmp_poﬁ
, 4,

795 (
ngx_°r_t
))

796 !
NGX_OK
)

798  
NGX_ERROR
;

802 
«me
 = 
	`ngx_¨øy_push
(&
ha
->
keys_hash
[
k
]);

803 i‡(
«me
 =
NULL
) {

804  
NGX_ERROR
;

807 *
«me
 = *
key
;

809 
hk
 = 
	`ngx_¨øy_push
(&
ha
->
keys
);

810 i‡(
hk
 =
NULL
) {

811  
NGX_ERROR
;

814 
hk
->
key
 = *key;

815 
hk
->
key_hash
 = 
	`ngx_hash_key
(
key
->
d©a
, 
œ°
);

816 
hk
->
vÆue
 = value;

818  
NGX_OK
;

821 
wûdˇrd
:

825 
k
 = 
	`ngx_hash_°æow
(&
key
->
d©a
[
skù
], &key->d©a[skù], 
œ°
 - skip);

827 
k
 %
ha
->
hsize
;

829 i‡(
skù
 == 1) {

833 
«me
 = 
ha
->
keys_hash
[
k
].
ñts
;

835 i‡(
«me
) {

836 
Àn
 = 
œ°
 - 
skù
;

838 
i
 = 0; i < 
ha
->
keys_hash
[
k
].
√…s
; i++) {

839 i‡(
Àn
 !
«me
[
i
].len) {

843 i‡(
	`ngx_°∫cmp
(&
key
->
d©a
[1], 
«me
[
i
].d©a, 
Àn
) == 0) {

844  
NGX_BUSY
;

849 i‡(
	`ngx_¨øy_öô
(&
ha
->
keys_hash
[
k
], ha->
ãmp_poﬁ
, 4,

850 (
ngx_°r_t
))

851 !
NGX_OK
)

853  
NGX_ERROR
;

857 
«me
 = 
	`ngx_¨øy_push
(&
ha
->
keys_hash
[
k
]);

858 i‡(
«me
 =
NULL
) {

859  
NGX_ERROR
;

862 
«me
->
Àn
 = 
œ°
 - 1;

863 
«me
->
d©a
 = 
	`ngx_≤Æloc
(
ha
->
ãmp_poﬁ
,Çame->
Àn
);

864 i‡(
«me
->
d©a
 =
NULL
) {

865  
NGX_ERROR
;

868 
	`ngx_mem˝y
(
«me
->
d©a
, &
key
->d©a[1],Çame->
Àn
);

872 i‡(
skù
) {

879 
p
 = 
	`ngx_≤Æloc
(
ha
->
ãmp_poﬁ
, 
œ°
);

880 i‡(
p
 =
NULL
) {

881  
NGX_ERROR
;

884 
Àn
 = 0;

885 
n
 = 0;

887 
i
 = 
œ°
 - 1; i; i--) {

888 i‡(
key
->
d©a
[
i
] == '.') {

889 
	`ngx_mem˝y
(&
p
[
n
], &
key
->
d©a
[
i
 + 1], 
Àn
);

890 
n
 +
Àn
;

891 
p
[
n
++] = '.';

892 
Àn
 = 0;

896 
Àn
++;

899 i‡(
Àn
) {

900 
	`ngx_mem˝y
(&
p
[
n
], &
key
->
d©a
[1], 
Àn
);

901 
n
 +
Àn
;

904 
p
[
n
] = '\0';

906 
hwc
 = &
ha
->
dns_wc_hód
;

907 
keys
 = &
ha
->
dns_wc_hód_hash
[
k
];

913 
œ°
++;

915 
p
 = 
	`ngx_≤Æloc
(
ha
->
ãmp_poﬁ
, 
œ°
);

916 i‡(
p
 =
NULL
) {

917  
NGX_ERROR
;

920 
	`ngx_˝y°∫
(
p
, 
key
->
d©a
, 
œ°
);

922 
hwc
 = &
ha
->
dns_wc_èû
;

923 
keys
 = &
ha
->
dns_wc_èû_hash
[
k
];

929 
«me
 = 
keys
->
ñts
;

931 i‡(
«me
) {

932 
Àn
 = 
œ°
 - 
skù
;

934 
i
 = 0; i < 
keys
->
√…s
; i++) {

935 i‡(
Àn
 !
«me
[
i
].len) {

939 i‡(
	`ngx_°∫cmp
(
key
->
d©a
 + 
skù
, 
«me
[
i
].d©a, 
Àn
) == 0) {

940  
NGX_BUSY
;

945 i‡(
	`ngx_¨øy_öô
(
keys
, 
ha
->
ãmp_poﬁ
, 4, (
ngx_°r_t
)Ë!
NGX_OK
)

947  
NGX_ERROR
;

951 
«me
 = 
	`ngx_¨øy_push
(
keys
);

952 i‡(
«me
 =
NULL
) {

953  
NGX_ERROR
;

956 
«me
->
Àn
 = 
œ°
 - 
skù
;

957 
«me
->
d©a
 = 
	`ngx_≤Æloc
(
ha
->
ãmp_poﬁ
,Çame->
Àn
);

958 i‡(
«me
->
d©a
 =
NULL
) {

959  
NGX_ERROR
;

962 
	`ngx_mem˝y
(
«me
->
d©a
, 
key
->d©®+ 
skù
,Çame->
Àn
);

967 
hk
 = 
	`ngx_¨øy_push
(
hwc
);

968 i‡(
hk
 =
NULL
) {

969  
NGX_ERROR
;

972 
hk
->
key
.
Àn
 = 
œ°
 - 1;

973 
hk
->
key
.
d©a
 = 
p
;

974 
hk
->
key_hash
 = 0;

975 
hk
->
vÆue
 = value;

977  
NGX_OK
;

978 
	}
}

	@ngx_hash.h

8 #i‚de‡
_NGX_HASH_H_INCLUDED_


9 
	#_NGX_HASH_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

17 *
	mvÆue
;

18 
u_sh‹t
 
	mÀn
;

19 
u_ch¨
 
	m«me
[1];

20 } 
	tngx_hash_ñt_t
;

24 
ngx_hash_ñt_t
 **
	mbuckës
;

25 
ngx_uöt_t
 
	msize
;

26 } 
	tngx_hash_t
;

30 
ngx_hash_t
 
	mhash
;

31 *
	mvÆue
;

32 } 
	tngx_hash_wûdˇrd_t
;

36 
ngx_°r_t
 
	mkey
;

37 
ngx_uöt_t
 
	mkey_hash
;

38 *
	mvÆue
;

39 } 
	tngx_hash_key_t
;

42 
	$ngx_uöt_t
 (*
	tngx_hash_key_±
Ë(
	tu_ch¨
 *
	td©a
, 
	tsize_t
 
	tÀn
);

46 
ngx_hash_t
 
hash
;

47 
ngx_hash_wûdˇrd_t
 *
wc_hód
;

48 
ngx_hash_wûdˇrd_t
 *
wc_èû
;

49 } 
	tngx_hash_comböed_t
;

53 
ngx_hash_t
 *
hash
;

54 
ngx_hash_key_±
 
key
;

56 
ngx_uöt_t
 
max_size
;

57 
ngx_uöt_t
 
buckë_size
;

59 *
«me
;

60 
ngx_poﬁ_t
 *
poﬁ
;

61 
ngx_poﬁ_t
 *
ãmp_poﬁ
;

62 } 
	tngx_hash_öô_t
;

65 
	#NGX_HASH_SMALL
 1

	)

66 
	#NGX_HASH_LARGE
 2

	)

68 
	#NGX_HASH_LARGE_ASIZE
 16384

	)

69 
	#NGX_HASH_LARGE_HSIZE
 10007

	)

71 
	#NGX_HASH_WILDCARD_KEY
 1

	)

72 
	#NGX_HASH_READONLY_KEY
 2

	)

76 
ngx_uöt_t
 
hsize
;

78 
ngx_poﬁ_t
 *
poﬁ
;

79 
ngx_poﬁ_t
 *
ãmp_poﬁ
;

81 
ngx_¨øy_t
 
keys
;

82 
ngx_¨øy_t
 *
keys_hash
;

84 
ngx_¨øy_t
 
dns_wc_hód
;

85 
ngx_¨øy_t
 *
dns_wc_hód_hash
;

87 
ngx_¨øy_t
 
dns_wc_èû
;

88 
ngx_¨øy_t
 *
dns_wc_èû_hash
;

89 } 
	tngx_hash_keys_¨øys_t
;

93 
ngx_uöt_t
 
hash
;

94 
ngx_°r_t
 
key
;

95 
ngx_°r_t
 
vÆue
;

96 
u_ch¨
 *
lowˇ£_key
;

97 } 
	tngx_èbÀ_ñt_t
;

100 *
	`ngx_hash_föd
(
ngx_hash_t
 *
hash
, 
ngx_uöt_t
 
key
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
);

101 *
	`ngx_hash_föd_wc_hód
(
ngx_hash_wûdˇrd_t
 *
hwc
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
);

102 *
	`ngx_hash_föd_wc_èû
(
ngx_hash_wûdˇrd_t
 *
hwc
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
);

103 *
	`ngx_hash_föd_comböed
(
ngx_hash_comböed_t
 *
hash
, 
ngx_uöt_t
 
key
,

104 
u_ch¨
 *
«me
, 
size_t
 
Àn
);

106 
ngx_öt_t
 
	`ngx_hash_öô
(
ngx_hash_öô_t
 *
höô
, 
ngx_hash_key_t
 *
«mes
,

107 
ngx_uöt_t
 
√…s
);

108 
ngx_öt_t
 
	`ngx_hash_wûdˇrd_öô
(
ngx_hash_öô_t
 *
höô
, 
ngx_hash_key_t
 *
«mes
,

109 
ngx_uöt_t
 
√…s
);

111 
	#ngx_hash
(
key
, 
c
Ë((
ngx_uöt_t
Ëkey * 31 + c)

	)

112 
ngx_uöt_t
 
	`ngx_hash_key
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
);

113 
ngx_uöt_t
 
	`ngx_hash_key_lc
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
);

114 
ngx_uöt_t
 
	`ngx_hash_°æow
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
n
);

117 
ngx_öt_t
 
	`ngx_hash_keys_¨øy_öô
(
ngx_hash_keys_¨øys_t
 *
ha
, 
ngx_uöt_t
 
ty≥
);

118 
ngx_öt_t
 
	`ngx_hash_add_key
(
ngx_hash_keys_¨øys_t
 *
ha
, 
ngx_°r_t
 *
key
,

119 *
vÆue
, 
ngx_uöt_t
 
Êags
);

	@ngx_inet.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
ngx_öt_t
 
ngx_∑r£_unix_domaö_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
);

13 
ngx_öt_t
 
ngx_∑r£_öë_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
);

14 
ngx_öt_t
 
ngx_∑r£_öë6_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
);

17 
ö_addr_t


18 
	$ngx_öë_addr
(
u_ch¨
 *
ãxt
, 
size_t
 
Àn
)

20 
u_ch¨
 *
p
, 
c
;

21 
ö_addr_t
 
addr
;

22 
ngx_uöt_t
 
o˘ë
, 
n
;

24 
addr
 = 0;

25 
o˘ë
 = 0;

26 
n
 = 0;

28 
p
 = 
ãxt
;Ö <Åexà+ 
Àn
;Ö++) {

30 
c
 = *
p
;

32 i‡(
c
 >= '0' && c <= '9') {

33 
o˘ë
 = o˘ë * 10 + (
c
 - '0');

37 i‡(
c
 ='.' && 
o˘ë
 < 256) {

38 
addr
 = (add∏<< 8Ë+ 
o˘ë
;

39 
o˘ë
 = 0;

40 
n
++;

44  
INADDR_NONE
;

47 i‡(
n
 =3 && 
o˘ë
 < 256) {

48 
addr
 = (add∏<< 8Ë+ 
o˘ë
;

49  
	`ht⁄l
(
addr
);

52  
INADDR_NONE
;

53 
	}
}

56 #i‡(
NGX_HAVE_INET6
)

58 
ngx_öt_t


59 
	$ngx_öë6_addr
(
u_ch¨
 *
p
, 
size_t
 
Àn
, u_ch¨ *
addr
)

61 
u_ch¨
 
c
, *
zîo
, *
digô
, *
s
, *
d
;

62 
size_t
 
Àn4
;

63 
ngx_uöt_t
 
n
, 
nibbÀs
, 
w‹d
;

65 i‡(
Àn
 == 0) {

66  
NGX_ERROR
;

69 
zîo
 = 
NULL
;

70 
digô
 = 
NULL
;

71 
Àn4
 = 0;

72 
nibbÀs
 = 0;

73 
w‹d
 = 0;

74 
n
 = 8;

76 i‡(
p
[0] == ':') {

77 
p
++;

78 
Àn
--;

81  ; 
Àn
;Üen--) {

82 
c
 = *
p
++;

84 i‡(
c
 == ':') {

85 i‡(
nibbÀs
) {

86 
digô
 = 
p
;

87 
Àn4
 = 
Àn
;

88 *
addr
++ = (
u_ch¨
Ë(
w‹d
 >> 8);

89 *
addr
++ = (
u_ch¨
Ë(
w‹d
 & 0xff);

91 i‡(--
n
) {

92 
nibbÀs
 = 0;

93 
w‹d
 = 0;

98 i‡(
zîo
 =
NULL
) {

99 
digô
 = 
p
;

100 
Àn4
 = 
Àn
;

101 
zîo
 = 
addr
;

106  
NGX_ERROR
;

109 i‡(
c
 ='.' && 
nibbÀs
) {

110 i‡(
n
 < 2 || 
digô
 =
NULL
) {

111  
NGX_ERROR
;

114 
w‹d
 = 
	`ngx_öë_addr
(
digô
, 
Àn4
 - 1);

115 i‡(
w‹d
 =
INADDR_NONE
) {

116  
NGX_ERROR
;

119 
w‹d
 = 
	`¡ohl
(word);

120 *
addr
++ = (
u_ch¨
Ë((
w‹d
 >> 24) & 0xff);

121 *
addr
++ = (
u_ch¨
Ë((
w‹d
 >> 16) & 0xff);

122 
n
--;

126 i‡(++
nibbÀs
 > 4) {

127  
NGX_ERROR
;

130 i‡(
c
 >= '0' && c <= '9') {

131 
w‹d
 = w‹d * 16 + (
c
 - '0');

135 
c
 |= 0x20;

137 i‡(
c
 >= 'a' && c <= 'f') {

138 
w‹d
 = w‹d * 16 + (
c
 - 'a') + 10;

142  
NGX_ERROR
;

145 i‡(
nibbÀs
 =0 && 
zîo
 =
NULL
) {

146  
NGX_ERROR
;

149 *
addr
++ = (
u_ch¨
Ë(
w‹d
 >> 8);

150 *
addr
++ = (
u_ch¨
Ë(
w‹d
 & 0xff);

152 i‡(--
n
) {

153 i‡(
zîo
) {

154 
n
 *= 2;

155 
s
 = 
addr
 - 1;

156 
d
 = 
s
 + 
n
;

157 
s
 >
zîo
) {

158 *
d
-- = *
s
--;

160 
	`ngx_memzîo
(
zîo
, 
n
);

161  
NGX_OK
;

165 i‡(
zîo
 =
NULL
) {

166  
NGX_OK
;

170  
NGX_ERROR
;

171 
	}
}

176 
size_t


177 
	$ngx_sock_¡›
(
sockaddr
 *
ß
, 
u_ch¨
 *
ãxt
, 
size_t
 
Àn
, 
ngx_uöt_t
 
p‹t
)

179 
u_ch¨
 *
p
;

180 
sockaddr_ö
 *
sö
;

181 #i‡(
NGX_HAVE_INET6
)

182 
size_t
 
n
;

183 
sockaddr_ö6
 *
sö6
;

185 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

186 
sockaddr_un
 *
ßun
;

189 
ß
->
ß_Ámûy
) {

191 
AF_INET
:

193 
sö
 = (
sockaddr_ö
 *Ë
ß
;

194 
p
 = (
u_ch¨
 *Ë&
sö
->
sö_addr
;

196 i‡(
p‹t
) {

197 
p
 = 
	`ngx_¢¥ötf
(
ãxt
, 
Àn
, "%ud.%ud.%ud.%ud:%d",

198 
p
[0],Ö[1],Ö[2],Ö[3], 
	`¡ohs
(
sö
->
sö_p‹t
));

200 
p
 = 
	`ngx_¢¥ötf
(
ãxt
, 
Àn
, "%ud.%ud.%ud.%ud",

201 
p
[0],Ö[1],Ö[2],Ö[3]);

204  (
p
 - 
ãxt
);

206 #i‡(
NGX_HAVE_INET6
)

208 
AF_INET6
:

210 
sö6
 = (
sockaddr_ö6
 *Ë
ß
;

212 
n
 = 0;

214 i‡(
p‹t
) {

215 
ãxt
[
n
++] = '[';

218 
n
 = 
	`ngx_öë6_¡›
(
sö6
->
sö6_addr
.
s6_addr
, &
ãxt
[n], 
Àn
);

220 i‡(
p‹t
) {

221 
n
 = 
	`ngx_•rötf
(&
ãxt
[1 +Ç], "]:%d",

222 
	`¡ohs
(
sö6
->
sö6_p‹t
)Ë- 
ãxt
;

225  
n
;

228 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

230 
AF_UNIX
:

231 
ßun
 = (
sockaddr_un
 *Ë
ß
;

235  
	`ngx_¢¥ötf
(
ãxt
, 
Àn
, "unix:%s%Z", 
ßun
->
sun_∑th
) -Åext - 1;

242 
	}
}

245 
size_t


246 
	$ngx_öë_¡›
(
Ámûy
, *
addr
, 
u_ch¨
 *
ãxt
, 
size_t
 
Àn
)

248 
u_ch¨
 *
p
;

250 
Ámûy
) {

252 
AF_INET
:

254 
p
 = 
addr
;

256  
	`ngx_¢¥ötf
(
ãxt
, 
Àn
, "%ud.%ud.%ud.%ud",

257 
p
[0],Ö[1],Ö[2],Ö[3])

258 - 
ãxt
;

260 #i‡(
NGX_HAVE_INET6
)

262 
AF_INET6
:

263  
	`ngx_öë6_¡›
(
addr
, 
ãxt
, 
Àn
);

270 
	}
}

273 #i‡(
NGX_HAVE_INET6
)

275 
size_t


276 
	$ngx_öë6_¡›
(
u_ch¨
 *
p
, u_ch¨ *
ãxt
, 
size_t
 
Àn
)

278 
u_ch¨
 *
d°
;

279 
size_t
 
max
, 
n
;

280 
ngx_uöt_t
 
i
, 
zîo
, 
œ°
;

282 i‡(
Àn
 < 
NGX_INET6_ADDRSTRLEN
) {

286 
zîo
 = (
ngx_uöt_t
) -1;

287 
œ°
 = (
ngx_uöt_t
) -1;

288 
max
 = 1;

289 
n
 = 0;

291 
i
 = 0; i < 16; i += 2) {

293 i‡(
p
[
i
] ||Ö[i + 1]) {

295 i‡(
max
 < 
n
) {

296 
zîo
 = 
œ°
;

297 
max
 = 
n
;

300 
n
 = 0;

304 i‡(
n
++ == 0) {

305 
œ°
 = 
i
;

309 i‡(
max
 < 
n
) {

310 
zîo
 = 
œ°
;

311 
max
 = 
n
;

314 
d°
 = 
ãxt
;

315 
n
 = 16;

317 i‡(
zîo
 == 0) {

319 i‡((
max
 =5 && 
p
[10] == 0xff &&Ö[11] == 0xff)

320 || (
max
 == 6)

321 || (
max
 =7 && 
p
[14] != 0 &&Ö[15] != 1))

323 
n
 = 12;

326 *
d°
++ = ':';

329 
i
 = 0; i < 
n
; i += 2) {

331 i‡(
i
 =
zîo
) {

332 *
d°
++ = ':';

333 
i
 +(
max
 - 1) * 2;

337 
d°
 = 
	`ngx_•rötf
(d°, "%uxi", 
p
[
i
] * 256 +Ö[i + 1]);

339 i‡(
i
 < 14) {

340 *
d°
++ = ':';

344 i‡(
n
 == 12) {

345 
d°
 = 
	`ngx_•rötf
(d°, "%ud.%ud.%ud.%ud", 
p
[12],Ö[13],Ö[14],Ö[15]);

348  
d°
 - 
ãxt
;

349 
	}
}

354 
ngx_öt_t


355 
	$ngx_±ocidr
(
ngx_°r_t
 *
ãxt
, 
ngx_cidr_t
 *
cidr
)

357 
u_ch¨
 *
addr
, *
mask
, *
œ°
;

358 
size_t
 
Àn
;

359 
ngx_öt_t
 
shi·
;

360 #i‡(
NGX_HAVE_INET6
)

361 
ngx_öt_t
 
rc
;

362 
ngx_uöt_t
 
s
, 
i
;

365 
addr
 = 
ãxt
->
d©a
;

366 
œ°
 = 
addr
 + 
ãxt
->
Àn
;

368 
mask
 = 
	`ngx_°æchr
(
addr
, 
œ°
, '/');

369 
Àn
 = (
mask
 ? mask : 
œ°
Ë- 
addr
;

371 
cidr
->
u
.
ö
.
addr
 = 
	`ngx_öë_addr
◊ddr, 
Àn
);

373 i‡(
cidr
->
u
.
ö
.
addr
 !
INADDR_NONE
) {

374 
cidr
->
Ámûy
 = 
AF_INET
;

376 i‡(
mask
 =
NULL
) {

377 
cidr
->
u
.
ö
.
mask
 = 0xffffffff;

378  
NGX_OK
;

381 #i‡(
NGX_HAVE_INET6
)

382 } i‡(
	`ngx_öë6_addr
(
addr
, 
Àn
, 
cidr
->
u
.
ö6
.addr.
s6_addr
Ë=
NGX_OK
) {

383 
cidr
->
Ámûy
 = 
AF_INET6
;

385 i‡(
mask
 =
NULL
) {

386 
	`ngx_mem£t
(
cidr
->
u
.
ö6
.
mask
.
s6_addr
, 0xff, 16);

387  
NGX_OK
;

392  
NGX_ERROR
;

395 
mask
++;

397 
shi·
 = 
	`ngx_©oi
(
mask
, 
œ°
 - mask);

398 i‡(
shi·
 =
NGX_ERROR
) {

399  
NGX_ERROR
;

402 
cidr
->
Ámûy
) {

404 #i‡(
NGX_HAVE_INET6
)

405 
AF_INET6
:

406 i‡(
shi·
 > 128) {

407  
NGX_ERROR
;

410 
addr
 = 
cidr
->
u
.
ö6
.addr.
s6_addr
;

411 
mask
 = 
cidr
->
u
.
ö6
.mask.
s6_addr
;

412 
rc
 = 
NGX_OK
;

414 
i
 = 0; i < 16; i++) {

416 
s
 = (
shi·
 > 8) ? 8 : shift;

417 
shi·
 -
s
;

419 
mask
[
i
] = (
u_ch¨
Ë(0xffu << (8 - 
s
));

421 i‡(
addr
[
i
] !◊ddr[i] & 
mask
[i])) {

422 
rc
 = 
NGX_DONE
;

423 
addr
[
i
] &
mask
[i];

427  
rc
;

431 i‡(
shi·
 > 32) {

432  
NGX_ERROR
;

435 i‡(
shi·
) {

436 
cidr
->
u
.
ö
.
mask
 = 
	`ht⁄l
((
uöt32_t
Ë(0xffffffffu << (32 - 
shi·
)));

440 
cidr
->
u
.
ö
.
mask
 = 0;

443 i‡(
cidr
->
u
.
ö
.
addr
 =(cidr->u.ö.add∏& cidr->u.ö.
mask
)) {

444  
NGX_OK
;

447 
cidr
->
u
.
ö
.
addr
 &cidr->u.ö.
mask
;

449  
NGX_DONE
;

451 
	}
}

454 
ngx_öt_t


455 
	$ngx_∑r£_addr
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_addr_t
 *
addr
, 
u_ch¨
 *
ãxt
, 
size_t
 
Àn
)

457 
ö_addr_t
 
öaddr
;

458 
ngx_uöt_t
 
Ámûy
;

459 
sockaddr_ö
 *
sö
;

460 #i‡(
NGX_HAVE_INET6
)

461 
ö6_addr
 
öaddr6
;

462 
sockaddr_ö6
 *
sö6
;

468 
	`ngx_memzîo
(
öaddr6
.
s6_addr
, (
ö6_addr
));

471 
öaddr
 = 
	`ngx_öë_addr
(
ãxt
, 
Àn
);

473 i‡(
öaddr
 !
INADDR_NONE
) {

474 
Ámûy
 = 
AF_INET
;

475 
Àn
 = (
sockaddr_ö
);

477 #i‡(
NGX_HAVE_INET6
)

478 } i‡(
	`ngx_öë6_addr
(
ãxt
, 
Àn
, 
öaddr6
.
s6_addr
Ë=
NGX_OK
) {

479 
Ámûy
 = 
AF_INET6
;

480 
Àn
 = (
sockaddr_ö6
);

484  
NGX_DECLINED
;

487 
addr
->
sockaddr
 = 
	`ngx_pˇŒoc
(
poﬁ
, 
Àn
);

488 i‡(
addr
->
sockaddr
 =
NULL
) {

489  
NGX_ERROR
;

492 
addr
->
sockaddr
->
ß_Ámûy
 = (
u_ch¨
Ë
Ámûy
;

493 
addr
->
sockÀn
 = 
Àn
;

495 
Ámûy
) {

497 #i‡(
NGX_HAVE_INET6
)

498 
AF_INET6
:

499 
sö6
 = (
sockaddr_ö6
 *Ë
addr
->
sockaddr
;

500 
	`ngx_mem˝y
(
sö6
->
sö6_addr
.
s6_addr
, 
öaddr6
.s6_addr, 16);

505 
sö
 = (
sockaddr_ö
 *Ë
addr
->
sockaddr
;

506 
sö
->
sö_addr
.
s_addr
 = 
öaddr
;

510  
NGX_OK
;

511 
	}
}

514 
ngx_öt_t


515 
	$ngx_∑r£_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
)

517 
u_ch¨
 *
p
;

519 
p
 = 
u
->
uæ
.
d©a
;

521 i‡(
	`ngx_°∫ˇ£cmp
(
p
, (
u_ch¨
 *) "unix:", 5) == 0) {

522  
	`ngx_∑r£_unix_domaö_uæ
(
poﬁ
, 
u
);

525 i‡(
p
[0] == '[') {

526  
	`ngx_∑r£_öë6_uæ
(
poﬁ
, 
u
);

529  
	`ngx_∑r£_öë_uæ
(
poﬁ
, 
u
);

530 
	}
}

533 
ngx_öt_t


534 
	$ngx_∑r£_unix_domaö_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
)

536 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

537 
u_ch¨
 *
∑th
, *
uri
, *
œ°
;

538 
size_t
 
Àn
;

539 
sockaddr_un
 *
ßun
;

541 
Àn
 = 
u
->
uæ
.len;

542 
∑th
 = 
u
->
uæ
.
d©a
;

544 
∑th
 += 5;

545 
Àn
 -= 5;

547 i‡(
u
->
uri_∑π
) {

549 
œ°
 = 
∑th
 + 
Àn
;

550 
uri
 = 
	`ngx_°æchr
(
∑th
, 
œ°
, ':');

552 i‡(
uri
) {

553 
Àn
 = 
uri
 - 
∑th
;

554 
uri
++;

555 
u
->
uri
.
Àn
 = 
œ°
 - uri;

556 
u
->
uri
.
d©a
 = uri;

560 i‡(
Àn
 == 0) {

561 
u
->
îr
 = "noÖath inÅhe unix domain socket";

562  
NGX_ERROR
;

565 
u
->
ho°
.
Àn
 =Üen++;

566 
u
->
ho°
.
d©a
 = 
∑th
;

568 i‡(
Àn
 > (
ßun
->
sun_∑th
)) {

569 
u
->
îr
 = "tooÜongÖath inÅhe unix domain socket";

570  
NGX_ERROR
;

573 
u
->
sockÀn
 = (
sockaddr_un
);

574 
ßun
 = (
sockaddr_un
 *Ë&
u
->
sockaddr
;

575 
ßun
->
sun_Ámûy
 = 
AF_UNIX
;

576 (Ë
	`ngx_˝y°∫
((
u_ch¨
 *Ë
ßun
->
sun_∑th
, 
∑th
, 
Àn
);

578 
u
->
addrs
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_addr_t
));

579 i‡(
u
->
addrs
 =
NULL
) {

580  
NGX_ERROR
;

583 
ßun
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
sockaddr_un
));

584 i‡(
ßun
 =
NULL
) {

585  
NGX_ERROR
;

588 
u
->
Ámûy
 = 
AF_UNIX
;

589 
u
->
«ddrs
 = 1;

591 
ßun
->
sun_Ámûy
 = 
AF_UNIX
;

592 (Ë
	`ngx_˝y°∫
((
u_ch¨
 *Ë
ßun
->
sun_∑th
, 
∑th
, 
Àn
);

594 
u
->
addrs
[0].
sockaddr
 = (sockadd∏*Ë
ßun
;

595 
u
->
addrs
[0].
sockÀn
 = (
sockaddr_un
);

596 
u
->
addrs
[0].
«me
.
Àn
 =Üen + 4;

597 
u
->
addrs
[0].
«me
.
d©a
 = u->
uæ
.data;

599  
NGX_OK
;

603 
u
->
îr
 = "the unix domain socketsáreÇot supported onÅhisÖlatform";

605  
NGX_ERROR
;

608 
	}
}

611 
ngx_öt_t


612 
	$ngx_∑r£_öë_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
)

614 
u_ch¨
 *
p
, *
ho°
, *
p‹t
, *
œ°
, *
uri
, *
¨gs
;

615 
size_t
 
Àn
;

616 
ngx_öt_t
 
n
;

617 
ho°ít
 *
h
;

618 
sockaddr_ö
 *
sö
;

620 
u
->
sockÀn
 = (
sockaddr_ö
);

621 
sö
 = (
sockaddr_ö
 *Ë&
u
->
sockaddr
;

622 
sö
->
sö_Ámûy
 = 
AF_INET
;

624 
u
->
Ámûy
 = 
AF_INET
;

626 
ho°
 = 
u
->
uæ
.
d©a
;

628 
œ°
 = 
ho°
 + 
u
->
uæ
.
Àn
;

630 
p‹t
 = 
	`ngx_°æchr
(
ho°
, 
œ°
, ':');

632 
uri
 = 
	`ngx_°æchr
(
ho°
, 
œ°
, '/');

634 
¨gs
 = 
	`ngx_°æchr
(
ho°
, 
œ°
, '?');

636 i‡(
¨gs
) {

637 i‡(
uri
 =
NULL
 || 
¨gs
 < uri) {

638 
uri
 = 
¨gs
;

642 i‡(
uri
) {

643 i‡(
u
->
li°í
 || !u->
uri_∑π
) {

644 
u
->
îr
 = "invalid host";

645  
NGX_ERROR
;

648 
u
->
uri
.
Àn
 = 
œ°
 - uri;

649 
u
->
uri
.
d©a
 = uri;

651 
œ°
 = 
uri
;

653 i‡(
uri
 < 
p‹t
) {

654 
p‹t
 = 
NULL
;

658 i‡(
p‹t
) {

659 
p‹t
++;

661 
Àn
 = 
œ°
 - 
p‹t
;

663 
n
 = 
	`ngx_©oi
(
p‹t
, 
Àn
);

665 i‡(
n
 < 1 ||Ç > 65535) {

666 
u
->
îr
 = "invalidÖort";

667  
NGX_ERROR
;

670 
u
->
p‹t
 = (
ö_p‹t_t
Ë
n
;

671 
sö
->
sö_p‹t
 = 
	`ht⁄s
((
ö_p‹t_t
Ë
n
);

673 
u
->
p‹t_ãxt
.
Àn
 =Üen;

674 
u
->
p‹t_ãxt
.
d©a
 = 
p‹t
;

676 
œ°
 = 
p‹t
 - 1;

679 i‡(
uri
 =
NULL
) {

681 i‡(
u
->
li°í
) {

685 
n
 = 
	`ngx_©oi
(
ho°
, 
œ°
 - host);

687 i‡(
n
 !
NGX_ERROR
) {

689 i‡(
n
 < 1 ||Ç > 65535) {

690 
u
->
îr
 = "invalidÖort";

691  
NGX_ERROR
;

694 
u
->
p‹t
 = (
ö_p‹t_t
Ë
n
;

695 
sö
->
sö_p‹t
 = 
	`ht⁄s
((
ö_p‹t_t
Ë
n
);

697 
u
->
p‹t_ãxt
.
Àn
 = 
œ°
 - 
ho°
;

698 
u
->
p‹t_ãxt
.
d©a
 = 
ho°
;

700 
u
->
wûdˇrd
 = 1;

702  
NGX_OK
;

707 
u
->
no_p‹t
 = 1;

710 
Àn
 = 
œ°
 - 
ho°
;

712 i‡(
Àn
 == 0) {

713 
u
->
îr
 = "no host";

714  
NGX_ERROR
;

717 i‡(
Àn
 =1 && *
ho°
 == '*') {

718 
Àn
 = 0;

721 
u
->
ho°
.
Àn
 =Üen;

722 
u
->
ho°
.
d©a
 = host;

724 i‡(
u
->
no_ªsﬁve
) {

725  
NGX_OK
;

728 i‡(
Àn
) {

729 
sö
->
sö_addr
.
s_addr
 = 
	`ngx_öë_addr
(
ho°
, 
Àn
);

731 i‡(
sö
->
sö_addr
.
s_addr
 =
INADDR_NONE
) {

732 
p
 = 
	`ngx_Æloc
(++
Àn
, 
poﬁ
->
log
);

733 i‡(
p
 =
NULL
) {

734  
NGX_ERROR
;

737 (Ë
	`ngx_˝y°∫
(
p
, 
ho°
, 
Àn
);

739 
h
 = 
	`gëho°by«me
((c⁄° *Ë
p
);

741 
	`ngx_‰ì
(
p
);

743 i‡(
h
 =
NULL
 || h->
h_addr_li°
[0] == NULL) {

744 
u
->
îr
 = "hostÇot found";

745  
NGX_ERROR
;

748 
sö
->
sö_addr
.
s_addr
 = *(
ö_addr_t
 *Ë(
h
->
h_addr_li°
[0]);

751 i‡(
sö
->
sö_addr
.
s_addr
 =
INADDR_ANY
) {

752 
u
->
wûdˇrd
 = 1;

756 
sö
->
sö_addr
.
s_addr
 = 
INADDR_ANY
;

757 
u
->
wûdˇrd
 = 1;

760 i‡(
u
->
no_p‹t
) {

761 
u
->
p‹t
 = u->
deÁu…_p‹t
;

762 
sö
->
sö_p‹t
 = 
	`ht⁄s
(
u
->
deÁu…_p‹t
);

765 i‡(
u
->
li°í
) {

766  
NGX_OK
;

769  
	`ngx_öë_ªsﬁve_ho°
(
poﬁ
, 
u
);

770 
	}
}

773 
ngx_öt_t


774 
	$ngx_∑r£_öë6_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
)

776 #i‡(
NGX_HAVE_INET6
)

777 
u_ch¨
 *
p
, *
ho°
, *
p‹t
, *
œ°
, *
uri
;

778 
size_t
 
Àn
;

779 
ngx_öt_t
 
n
;

780 
sockaddr_ö6
 *
sö6
;

782 
u
->
sockÀn
 = (
sockaddr_ö6
);

783 
sö6
 = (
sockaddr_ö6
 *Ë&
u
->
sockaddr
;

784 
sö6
->
sö6_Ámûy
 = 
AF_INET6
;

786 
ho°
 = 
u
->
uæ
.
d©a
 + 1;

788 
œ°
 = 
u
->
uæ
.
d©a
 + u->uæ.
Àn
;

790 
p
 = 
	`ngx_°æchr
(
ho°
, 
œ°
, ']');

792 i‡(
p
 =
NULL
) {

793 
u
->
îr
 = "invalid host";

794  
NGX_ERROR
;

797 i‡(
œ°
 - 
p
) {

799 
p‹t
 = 
p
 + 1;

801 
uri
 = 
	`ngx_°æchr
(
p‹t
, 
œ°
, '/');

803 i‡(
uri
) {

804 i‡(
u
->
li°í
 || !u->
uri_∑π
) {

805 
u
->
îr
 = "invalid host";

806  
NGX_ERROR
;

809 
u
->
uri
.
Àn
 = 
œ°
 - uri;

810 
u
->
uri
.
d©a
 = uri;

812 
œ°
 = 
uri
;

815 i‡(*
p‹t
 == ':') {

816 
p‹t
++;

818 
Àn
 = 
œ°
 - 
p‹t
;

820 
n
 = 
	`ngx_©oi
(
p‹t
, 
Àn
);

822 i‡(
n
 < 1 ||Ç > 65535) {

823 
u
->
îr
 = "invalidÖort";

824  
NGX_ERROR
;

827 
u
->
p‹t
 = (
ö_p‹t_t
Ë
n
;

828 
sö6
->
sö6_p‹t
 = 
	`ht⁄s
((
ö_p‹t_t
Ë
n
);

830 
u
->
p‹t_ãxt
.
Àn
 =Üen;

831 
u
->
p‹t_ãxt
.
d©a
 = 
p‹t
;

834 
u
->
no_p‹t
 = 1;

838 
Àn
 = 
p
 - 
ho°
;

840 i‡(
Àn
 == 0) {

841 
u
->
îr
 = "no host";

842  
NGX_ERROR
;

845 
u
->
ho°
.
Àn
 =Üen + 2;

846 
u
->
ho°
.
d©a
 = host - 1;

848 i‡(
	`ngx_öë6_addr
(
ho°
, 
Àn
, 
sö6
->
sö6_addr
.
s6_addr
Ë!
NGX_OK
) {

849 
u
->
îr
 = "invalid IPv6áddress";

850  
NGX_ERROR
;

853 i‡(
	`IN6_IS_ADDR_UNSPECIFIED
(&
sö6
->
sö6_addr
)) {

854 
u
->
wûdˇrd
 = 1;

857 i‡(
u
->
no_p‹t
) {

858 
u
->
p‹t
 = u->
deÁu…_p‹t
;

859 
sö6
->
sö6_p‹t
 = 
	`ht⁄s
(
u
->
deÁu…_p‹t
);

862 
u
->
Ámûy
 = 
AF_INET6
;

863 
u
->
«ddrs
 = 1;

865 
u
->
addrs
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_addr_t
));

866 i‡(
u
->
addrs
 =
NULL
) {

867  
NGX_ERROR
;

870 
sö6
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
sockaddr_ö6
));

871 i‡(
sö6
 =
NULL
) {

872  
NGX_ERROR
;

875 
	`ngx_mem˝y
(
sö6
, 
u
->
sockaddr
, (
sockaddr_ö6
));

877 
u
->
addrs
[0].
sockaddr
 = (sockadd∏*Ë
sö6
;

878 
u
->
addrs
[0].
sockÀn
 = (
sockaddr_ö6
);

880 
p
 = 
	`ngx_≤Æloc
(
poﬁ
, 
u
->
ho°
.
Àn
 + (":65535") - 1);

881 i‡(
p
 =
NULL
) {

882  
NGX_ERROR
;

885 
u
->
addrs
[0].
«me
.
Àn
 = 
	`ngx_•rötf
(
p
, "%V:%d",

886 &
u
->
ho°
, u->
p‹t
Ë- 
p
;

887 
u
->
addrs
[0].
«me
.
d©a
 = 
p
;

889  
NGX_OK
;

893 
u
->
îr
 = "the INET6 socketsáreÇot supported onÅhisÖlatform";

895  
NGX_ERROR
;

898 
	}
}

901 
ngx_öt_t


902 
	$ngx_öë_ªsﬁve_ho°
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
)

904 
u_ch¨
 *
p
, *
ho°
;

905 
size_t
 
Àn
;

906 
ö_p‹t_t
 
p‹t
;

907 
ö_addr_t
 
ö_addr
;

908 
ngx_uöt_t
 
i
;

909 
ho°ít
 *
h
;

910 
sockaddr_ö
 *
sö
;

914 
p‹t
 = 
	`ht⁄s
(
u
->port);

916 
ö_addr
 = 
	`ngx_öë_addr
(
u
->
ho°
.
d©a
, u->ho°.
Àn
);

918 i‡(
ö_addr
 =
INADDR_NONE
) {

919 
ho°
 = 
	`ngx_Æloc
(
u
->ho°.
Àn
 + 1, 
poﬁ
->
log
);

920 i‡(
ho°
 =
NULL
) {

921  
NGX_ERROR
;

924 (Ë
	`ngx_˝y°∫
(
ho°
, 
u
->ho°.
d©a
, u->ho°.
Àn
 + 1);

926 
h
 = 
	`gëho°by«me
((*Ë
ho°
);

928 
	`ngx_‰ì
(
ho°
);

930 i‡(
h
 =
NULL
 || h->
h_addr_li°
[0] == NULL) {

931 
u
->
îr
 = "hostÇot found";

932  
NGX_ERROR
;

935 i‡(
u
->
⁄e_addr
 == 0) {

936 
i
 = 0; 
h
->
h_addr_li°
[i] !
NULL
; i++) { }

939 
i
 = 1;

944 
u
->
addrs
 = 
	`ngx_pˇŒoc
(
poﬁ
, 
i
 * (
ngx_addr_t
));

945 i‡(
u
->
addrs
 =
NULL
) {

946  
NGX_ERROR
;

949 
u
->
«ddrs
 = 
i
;

951 
i
 = 0; i < 
u
->
«ddrs
; i++) {

953 
sö
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
sockaddr_ö
));

954 i‡(
sö
 =
NULL
) {

955  
NGX_ERROR
;

958 
sö
->
sö_Ámûy
 = 
AF_INET
;

959 
sö
->
sö_p‹t
 = 
p‹t
;

960 
sö
->
sö_addr
.
s_addr
 = *(
ö_addr_t
 *Ë(
h
->
h_addr_li°
[
i
]);

962 
u
->
addrs
[
i
].
sockaddr
 = (sockadd∏*Ë
sö
;

963 
u
->
addrs
[
i
].
sockÀn
 = (
sockaddr_ö
);

965 
Àn
 = 
NGX_INET_ADDRSTRLEN
 + (":65535") - 1;

967 
p
 = 
	`ngx_≤Æloc
(
poﬁ
, 
Àn
);

968 i‡(
p
 =
NULL
) {

969  
NGX_ERROR
;

972 
Àn
 = 
	`ngx_sock_¡›
((
sockaddr
 *Ë
sö
, 
p
,Üen, 1);

974 
u
->
addrs
[
i
].
«me
.
Àn
 =Üen;

975 
u
->
addrs
[
i
].
«me
.
d©a
 = 
p
;

982 
u
->
addrs
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_addr_t
));

983 i‡(
u
->
addrs
 =
NULL
) {

984  
NGX_ERROR
;

987 
sö
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
sockaddr_ö
));

988 i‡(
sö
 =
NULL
) {

989  
NGX_ERROR
;

992 
u
->
«ddrs
 = 1;

994 
sö
->
sö_Ámûy
 = 
AF_INET
;

995 
sö
->
sö_p‹t
 = 
p‹t
;

996 
sö
->
sö_addr
.
s_addr
 = 
ö_addr
;

998 
u
->
addrs
[0].
sockaddr
 = (sockadd∏*Ë
sö
;

999 
u
->
addrs
[0].
sockÀn
 = (
sockaddr_ö
);

1001 
p
 = 
	`ngx_≤Æloc
(
poﬁ
, 
u
->
ho°
.
Àn
 + (":65535") - 1);

1002 i‡(
p
 =
NULL
) {

1003  
NGX_ERROR
;

1006 
u
->
addrs
[0].
«me
.
Àn
 = 
	`ngx_•rötf
(
p
, "%V:%d",

1007 &
u
->
ho°
, 
	`¡ohs
(
p‹t
)Ë- 
p
;

1008 
u
->
addrs
[0].
«me
.
d©a
 = 
p
;

1011  
NGX_OK
;

1012 
	}
}

	@ngx_inet.h

8 #i‚de‡
_NGX_INET_H_INCLUDED_


9 
	#_NGX_INET_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

24 
	#NGX_INET_ADDRSTRLEN
 (("255.255.255.255"Ë- 1)

	)

25 
	#NGX_INET6_ADDRSTRLEN
 \

26 (("ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"Ë- 1)

	)

27 
	#NGX_UNIX_ADDRSTRLEN
 \

28 ((
sockaddr_un
Ë- 
	`off£tof
(sockaddr_un, 
sun_∑th
))

	)

30 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

31 
	#NGX_SOCKADDR_STRLEN
 (("unix:"Ë- 1 + 
NGX_UNIX_ADDRSTRLEN
)

	)

33 
	#NGX_SOCKADDR_STRLEN
 (
NGX_INET6_ADDRSTRLEN
 + (":65535"Ë- 1)

	)

36 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

37 
	#NGX_SOCKADDRLEN
 (
sockaddr_un
)

	)

39 
	#NGX_SOCKADDRLEN
 512

	)

44 
ö_addr_t
 
	maddr
;

45 
ö_addr_t
 
	mmask
;

46 } 
	tngx_ö_cidr_t
;

49 #i‡(
NGX_HAVE_INET6
)

52 
ö6_addr
 
	maddr
;

53 
ö6_addr
 
	mmask
;

54 } 
	tngx_ö6_cidr_t
;

60 
ngx_uöt_t
 
	mÁmûy
;

62 
ngx_ö_cidr_t
 
	mö
;

63 #i‡(
NGX_HAVE_INET6
)

64 
ngx_ö6_cidr_t
 
	mö6
;

66 } 
	mu
;

67 } 
	tngx_cidr_t
;

71 
sockaddr
 *
	msockaddr
;

72 
sockÀn_t
 
	msockÀn
;

73 
ngx_°r_t
 
	m«me
;

74 } 
	tngx_addr_t
;

78 
ngx_°r_t
 
	muæ
;

79 
ngx_°r_t
 
	mho°
;

80 
ngx_°r_t
 
	mp‹t_ãxt
;

81 
ngx_°r_t
 
	muri
;

83 
ö_p‹t_t
 
	mp‹t
;

84 
ö_p‹t_t
 
	mdeÁu…_p‹t
;

85 
	mÁmûy
;

87 
	mli°í
:1;

88 
	muri_∑π
:1;

89 
	mno_ªsﬁve
:1;

90 
	m⁄e_addr
:1;

92 
	mno_p‹t
:1;

93 
	mwûdˇrd
:1;

95 
sockÀn_t
 
	msockÀn
;

96 
u_ch¨
 
	msockaddr
[
NGX_SOCKADDRLEN
];

98 
ngx_addr_t
 *
	maddrs
;

99 
ngx_uöt_t
 
	m«ddrs
;

101 *
	mîr
;

102 } 
	tngx_uæ_t
;

105 
ö_addr_t
 
ngx_öë_addr
(
u_ch¨
 *
ãxt
, 
size_t
 
Àn
);

106 #i‡(
NGX_HAVE_INET6
)

107 
ngx_öt_t
 
ngx_öë6_addr
(
u_ch¨
 *
p
, 
size_t
 
Àn
, u_ch¨ *
addr
);

108 
size_t
 
ngx_öë6_¡›
(
u_ch¨
 *
p
, u_ch¨ *
ãxt
, size_à
Àn
);

110 
size_t
 
ngx_sock_¡›
(
sockaddr
 *
ß
, 
u_ch¨
 *
ãxt
, size_à
Àn
,

111 
ngx_uöt_t
 
p‹t
);

112 
size_t
 
ngx_öë_¡›
(
Ámûy
, *
addr
, 
u_ch¨
 *
ãxt
, size_à
Àn
);

113 
ngx_öt_t
 
ngx_±ocidr
(
ngx_°r_t
 *
ãxt
, 
ngx_cidr_t
 *
cidr
);

114 
ngx_öt_t
 
ngx_∑r£_addr
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_addr_t
 *
addr
, 
u_ch¨
 *
ãxt
,

115 
size_t
 
Àn
);

116 
ngx_öt_t
 
ngx_∑r£_uæ
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
);

117 
ngx_öt_t
 
ngx_öë_ªsﬁve_ho°
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uæ_t
 *
u
);

	@ngx_list.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
ngx_li°_t
 *

13 
	$ngx_li°_¸óã
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
n
, 
size_t
 
size
)

15 
ngx_li°_t
 *
li°
;

17 
li°
 = 
	`ngx_∑Œoc
(
poﬁ
, (
ngx_li°_t
));

18 i‡(
li°
 =
NULL
) {

19  
NULL
;

22 
li°
->
∑π
.
ñts
 = 
	`ngx_∑Œoc
(
poﬁ
, 
n
 * 
size
);

23 i‡(
li°
->
∑π
.
ñts
 =
NULL
) {

24  
NULL
;

27 
li°
->
∑π
.
√…s
 = 0;

28 
li°
->
∑π
.
√xt
 = 
NULL
;

29 
li°
->
œ°
 = &li°->
∑π
;

30 
li°
->
size
 = size;

31 
li°
->
«Œoc
 = 
n
;

32 
li°
->
poﬁ
 =Öool;

34  
li°
;

35 
	}
}

39 
	$ngx_li°_push
(
ngx_li°_t
 *
l
)

41 *
ñt
;

42 
ngx_li°_∑π_t
 *
œ°
;

44 
œ°
 = 
l
->last;

46 i‡(
œ°
->
√…s
 =
l
->
«Œoc
) {

50 
œ°
 = 
	`ngx_∑Œoc
(
l
->
poﬁ
, (
ngx_li°_∑π_t
));

51 i‡(
œ°
 =
NULL
) {

52  
NULL
;

55 
œ°
->
ñts
 = 
	`ngx_∑Œoc
(
l
->
poﬁ
,Ü->
«Œoc
 *Ü->
size
);

56 i‡(
œ°
->
ñts
 =
NULL
) {

57  
NULL
;

60 
œ°
->
√…s
 = 0;

61 
œ°
->
√xt
 = 
NULL
;

63 
l
->
œ°
->
√xt
 =Üast;

64 
l
->
œ°
 =Üast;

67 
ñt
 = (*Ë
œ°
->
ñts
 + 
l
->
size
 *Üa°->
√…s
;

68 
œ°
->
√…s
++;

70  
ñt
;

71 
	}
}

	@ngx_list.h

8 #i‚de‡
_NGX_LIST_H_INCLUDED_


9 
	#_NGX_LIST_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
ngx_li°_∑π_s
 
	tngx_li°_∑π_t
;

18 
	sngx_li°_∑π_s
 {

19 *
	mñts
;

20 
ngx_uöt_t
 
	m√…s
;

21 
ngx_li°_∑π_t
 *
	m√xt
;

26 
ngx_li°_∑π_t
 *
	mœ°
;

27 
ngx_li°_∑π_t
 
	m∑π
;

28 
size_t
 
	msize
;

29 
ngx_uöt_t
 
	m«Œoc
;

30 
ngx_poﬁ_t
 *
	mpoﬁ
;

31 } 
	tngx_li°_t
;

34 
ngx_li°_t
 *
ngx_li°_¸óã
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
n
, 
size_t
 
size
);

36 
ngx_ölöe
 
ngx_öt_t


37 
	$ngx_li°_öô
(
ngx_li°_t
 *
li°
, 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
n
, 
size_t
 
size
)

39 
li°
->
∑π
.
ñts
 = 
	`ngx_∑Œoc
(
poﬁ
, 
n
 * 
size
);

40 i‡(
li°
->
∑π
.
ñts
 =
NULL
) {

41  
NGX_ERROR
;

44 
li°
->
∑π
.
√…s
 = 0;

45 
li°
->
∑π
.
√xt
 = 
NULL
;

46 
li°
->
œ°
 = &li°->
∑π
;

47 
li°
->
size
 = size;

48 
li°
->
«Œoc
 = 
n
;

49 
li°
->
poﬁ
 =Öool;

51  
NGX_OK
;

52 
	}
}

80 *
ngx_li°_push
(
ngx_li°_t
 *
li°
);

	@ngx_log.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 *
ngx_îr‹_log
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

15 
ngx_comm™d_t
 
	gngx_îæog_comm™ds
[] = {

17 {
ngx_°rög
("error_log"),

18 
NGX_MAIN_CONF
|
NGX_CONF_1MORE
,

19 
ngx_îr‹_log
,

22 
NULL
},

24 
ngx_nuŒ_comm™d


28 
ngx_c‹e_moduÀ_t
 
	gngx_îæog_moduÀ_˘x
 = {

29 
ngx_°rög
("errlog"),

30 
NULL
,

31 
NULL


35 
ngx_moduÀ_t
 
	gngx_îæog_moduÀ
 = {

36 
NGX_MODULE_V1
,

37 &
ngx_îæog_moduÀ_˘x
,

38 
ngx_îæog_comm™ds
,

39 
NGX_CORE_MODULE
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NGX_MODULE_V1_PADDING


51 
ngx_log_t
 
	gngx_log
;

52 
ngx_›í_fûe_t
 
	gngx_log_fûe
;

53 
ngx_uöt_t
 
	gngx_u£_°dîr
 = 1;

56 
ngx_°r_t
 
	gîr_Àvñs
[] = {

57 
ngx_nuŒ_°rög
,

58 
ngx_°rög
("emerg"),

59 
ngx_°rög
("alert"),

60 
ngx_°rög
("crit"),

61 
ngx_°rög
("error"),

62 
ngx_°rög
("warn"),

63 
ngx_°rög
("notice"),

64 
ngx_°rög
("info"),

65 
ngx_°rög
("debug")

68 c⁄° *
	gdebug_Àvñs
[] = {

74 #i‡(
NGX_HAVE_VARIADIC_MACROS
)

77 
	$ngx_log_îr‹_c‹e
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

78 c⁄° *
fmt
, ...)

83 
	$ngx_log_îr‹_c‹e
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

84 c⁄° *
fmt
, 
va_li°
 
¨gs
)

88 #i‡(
NGX_HAVE_VARIADIC_MACROS
)

89 
va_li°
 
¨gs
;

91 
u_ch¨
 *
p
, *
œ°
, *
msg
;

92 
u_ch¨
 
îr°r
[
NGX_MAX_ERROR_STR
];

94 i‡(
log
->
fûe
->
fd
 =
NGX_INVALID_FILE
) {

98 
œ°
 = 
îr°r
 + 
NGX_MAX_ERROR_STR
;

100 
	`ngx_mem˝y
(
îr°r
, 
ngx_ˇched_îr_log_time
.
d©a
,

101 
ngx_ˇched_îr_log_time
.
Àn
);

103 
p
 = 
îr°r
 + 
ngx_ˇched_îr_log_time
.
Àn
;

105 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, " [%V] ", &
îr_Àvñs
[
Àvñ
]);

108 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, "%P#" 
NGX_TID_T_FMT
 ": ",

109 
ngx_log_pid
, 
ngx_log_tid
);

111 i‡(
log
->
c⁄√˘i⁄
) {

112 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, "*%uA ", 
log
->
c⁄√˘i⁄
);

115 
msg
 = 
p
;

117 #i‡(
NGX_HAVE_VARIADIC_MACROS
)

119 
	`va_°¨t
(
¨gs
, 
fmt
);

120 
p
 = 
	`ngx_v¶¥ötf
’, 
œ°
, 
fmt
, 
¨gs
);

121 
	`va_íd
(
¨gs
);

125 
p
 = 
	`ngx_v¶¥ötf
’, 
œ°
, 
fmt
, 
¨gs
);

129 i‡(
îr
) {

130 
p
 = 
	`ngx_log_î∫o
’, 
œ°
, 
îr
);

133 i‡(
Àvñ
 !
NGX_LOG_DEBUG
 && 
log
->
h™dÀr
) {

134 
p
 = 
log
->
	`h™dÀr
÷og,Ö, 
œ°
 -Ö);

137 i‡(
p
 > 
œ°
 - 
NGX_LINEFEED_SIZE
) {

138 
p
 = 
œ°
 - 
NGX_LINEFEED_SIZE
;

141 
	`ngx_löe„ed
(
p
);

143 (Ë
	`ngx_wrôe_fd
(
log
->
fûe
->
fd
, 
îr°r
, 
p
 -Érrstr);

145 i‡(!
ngx_u£_°dîr


146 || 
Àvñ
 > 
NGX_LOG_WARN


147 || 
log
->
fûe
->
fd
 =
ngx_°dîr
)

152 
msg
 -(7 + 
îr_Àvñs
[
Àvñ
].
Àn
 + 3);

154 (Ë
	`ngx_•rötf
(
msg
, "ngöx: [%V] ", &
îr_Àvñs
[
Àvñ
]);

156 (Ë
	`ngx_wrôe_c⁄sﬁe
(
ngx_°dîr
, 
msg
, 
p
 - msg);

157 
	}
}

160 #i‡!(
NGX_HAVE_VARIADIC_MACROS
)

162 
ngx_cde˛


163 
	$ngx_log_îr‹
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

164 c⁄° *
fmt
, ...)

166 
va_li°
 
¨gs
;

168 i‡(
log
->
log_Àvñ
 >
Àvñ
) {

169 
	`va_°¨t
(
¨gs
, 
fmt
);

170 
	`ngx_log_îr‹_c‹e
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨gs
);

171 
	`va_íd
(
¨gs
);

173 
	}
}

176 
ngx_cde˛


177 
	$ngx_log_debug_c‹e
(
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
, c⁄° *
fmt
, ...)

179 
va_li°
 
¨gs
;

181 
	`va_°¨t
(
¨gs
, 
fmt
);

182 
	`ngx_log_îr‹_c‹e
(
NGX_LOG_DEBUG
, 
log
, 
îr
, 
fmt
, 
¨gs
);

183 
	`va_íd
(
¨gs
);

184 
	}
}

189 
ngx_cde˛


190 
	$ngx_log_ab‹t
(
ngx_îr_t
 
îr
, c⁄° *
fmt
, ...)

192 
u_ch¨
 *
p
;

193 
va_li°
 
¨gs
;

194 
u_ch¨
 
îr°r
[
NGX_MAX_CONF_ERRSTR
];

196 
	`va_°¨t
(
¨gs
, 
fmt
);

197 
p
 = 
	`ngx_v¢¥ötf
(
îr°r
, ”º°rË- 1, 
fmt
, 
¨gs
);

198 
	`va_íd
(
¨gs
);

200 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
îr
,

201 "%*s", 
p
 - 
îr°r
,Érrstr);

202 
	}
}

205 
ngx_cde˛


206 
	$ngx_log_°dîr
(
ngx_îr_t
 
îr
, c⁄° *
fmt
, ...)

208 
u_ch¨
 *
p
, *
œ°
;

209 
va_li°
 
¨gs
;

210 
u_ch¨
 
îr°r
[
NGX_MAX_ERROR_STR
];

212 
œ°
 = 
îr°r
 + 
NGX_MAX_ERROR_STR
;

213 
p
 = 
îr°r
 + 7;

215 
	`ngx_mem˝y
(
îr°r
, "nginx: ", 7);

217 
	`va_°¨t
(
¨gs
, 
fmt
);

218 
p
 = 
	`ngx_v¶¥ötf
’, 
œ°
, 
fmt
, 
¨gs
);

219 
	`va_íd
(
¨gs
);

221 i‡(
îr
) {

222 
p
 = 
	`ngx_log_î∫o
’, 
œ°
, 
îr
);

225 i‡(
p
 > 
œ°
 - 
NGX_LINEFEED_SIZE
) {

226 
p
 = 
œ°
 - 
NGX_LINEFEED_SIZE
;

229 
	`ngx_löe„ed
(
p
);

231 (Ë
	`ngx_wrôe_c⁄sﬁe
(
ngx_°dîr
, 
îr°r
, 
p
 -Érrstr);

232 
	}
}

235 
u_ch¨
 *

236 
	$ngx_log_î∫o
(
u_ch¨
 *
buf
, u_ch¨ *
œ°
, 
ngx_îr_t
 
îr
)

238 i‡(
buf
 > 
œ°
 - 50) {

242 
buf
 = 
œ°
 - 50;

243 *
buf
++ = '.';

244 *
buf
++ = '.';

245 *
buf
++ = '.';

248 #i‡(
NGX_WIN32
)

249 
buf
 = 
	`ngx_¶¥ötf
(buf, 
œ°
, ((Ë
îr
 < 0x80000000)

250 ? " (%d: " : " (%Xd: ", 
îr
);

252 
buf
 = 
	`ngx_¶¥ötf
(buf, 
œ°
, " (%d: ", 
îr
);

255 
buf
 = 
	`ngx_°ªº‹
(
îr
, buf, 
œ°
 - buf);

257 i‡(
buf
 < 
œ°
) {

258 *
buf
++ = ')';

261  
buf
;

262 
	}
}

265 
ngx_log_t
 *

266 
	$ngx_log_öô
(
u_ch¨
 *
¥efix
)

268 
u_ch¨
 *
p
, *
«me
;

269 
size_t
 
∆í
, 
∂í
;

271 
ngx_log
.
fûe
 = &
ngx_log_fûe
;

272 
ngx_log
.
log_Àvñ
 = 
NGX_LOG_NOTICE
;

274 
«me
 = (
u_ch¨
 *Ë
NGX_ERROR_LOG_PATH
;

281 
∆í
 = 
	`ngx_°æí
(
«me
);

283 i‡(
∆í
 == 0) {

284 
ngx_log_fûe
.
fd
 = 
ngx_°dîr
;

285  &
ngx_log
;

288 
p
 = 
NULL
;

290 #i‡(
NGX_WIN32
)

291 i‡(
«me
[1] != ':') {

293 i‡(
«me
[0] != '/') {

296 i‡(
¥efix
) {

297 
∂í
 = 
	`ngx_°æí
(
¥efix
);

300 #ifde‡
NGX_PREFIX


301 
¥efix
 = (
u_ch¨
 *Ë
NGX_PREFIX
;

302 
∂í
 = 
	`ngx_°æí
(
¥efix
);

304 
∂í
 = 0;

308 i‡(
∂í
) {

309 
«me
 = 
	`mÆloc
(
∂í
 + 
∆í
 + 2);

310 i‡(
«me
 =
NULL
) {

311  
NULL
;

314 
p
 = 
	`ngx_˝ymem
(
«me
, 
¥efix
, 
∂í
);

316 i‡(!
	`ngx_∑th_£∑øt‹
(*(
p
 - 1))) {

317 *
p
++ = '/';

320 
	`ngx_˝y°∫
(
p
, (
u_ch¨
 *Ë
NGX_ERROR_LOG_PATH
, 
∆í
 + 1);

322 
p
 = 
«me
;

326 
ngx_log_fûe
.
fd
 = 
	`ngx_›í_fûe
(
«me
, 
NGX_FILE_APPEND
,

327 
NGX_FILE_CREATE_OR_OPEN
,

328 
NGX_FILE_DEFAULT_ACCESS
);

330 i‡(
ngx_log_fûe
.
fd
 =
NGX_INVALID_FILE
) {

331 
	`ngx_log_°dîr
(
ngx_î∫o
,

333 
ngx_›í_fûe_n
 " \"%s\" faûed", 
«me
);

334 #i‡(
NGX_WIN32
)

335 
	`ngx_evít_log
(
ngx_î∫o
,

337 
ngx_›í_fûe_n
 " \"%s\" faûed", 
«me
);

340 
ngx_log_fûe
.
fd
 = 
ngx_°dîr
;

343 i‡(
p
) {

344 
	`ngx_‰ì
(
p
);

347  &
ngx_log
;

348 
	}
}

351 
ngx_log_t
 *

352 
	$ngx_log_¸óã
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_°r_t
 *
«me
)

354 
ngx_log_t
 *
log
;

356 
log
 = 
	`ngx_pˇŒoc
(
cy˛e
->
poﬁ
, (
ngx_log_t
));

357 i‡(
log
 =
NULL
) {

358  
NULL
;

361 
log
->
fûe
 = 
	`ngx_c⁄f_›í_fûe
(
cy˛e
, 
«me
);

362 i‡(
log
->
fûe
 =
NULL
) {

363  
NULL
;

366  
log
;

367 
	}
}

371 
	$ngx_log_£t_Àvñs
(
ngx_c⁄f_t
 *
cf
, 
ngx_log_t
 *
log
)

373 
ngx_uöt_t
 
i
, 
n
, 
d
, 
found
;

374 
ngx_°r_t
 *
vÆue
;

376 
vÆue
 = 
cf
->
¨gs
->
ñts
;

378 
i
 = 2; i < 
cf
->
¨gs
->
√…s
; i++) {

379 
found
 = 0;

381 
n
 = 1;Ç <
NGX_LOG_DEBUG
;Ç++) {

382 i‡(
	`ngx_°rcmp
(
vÆue
[
i
].
d©a
, 
îr_Àvñs
[
n
].data) == 0) {

384 i‡(
log
->
log_Àvñ
 != 0) {

385 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

387 &
vÆue
[
i
]);

388  
NGX_CONF_ERROR
;

391 
log
->
log_Àvñ
 = 
n
;

392 
found
 = 1;

397 
n
 = 0, 
d
 = 
NGX_LOG_DEBUG_FIRST
; d <
NGX_LOG_DEBUG_LAST
; d <<= 1) {

398 i‡(
	`ngx_°rcmp
(
vÆue
[
i
].
d©a
, 
debug_Àvñs
[
n
++]) == 0) {

399 i‡(
log
->
log_Àvñ
 & ~
NGX_LOG_DEBUG_ALL
) {

400 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

402 &
vÆue
[
i
]);

403  
NGX_CONF_ERROR
;

406 
log
->
log_Àvñ
 |
d
;

407 
found
 = 1;

413 i‡(!
found
) {

414 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

415 "övÆidÜogÜevñ \"%V\"", &
vÆue
[
i
]);

416  
NGX_CONF_ERROR
;

420 i‡(
log
->
log_Àvñ
 =
NGX_LOG_DEBUG
) {

421 
log
->
log_Àvñ
 = 
NGX_LOG_DEBUG_ALL
;

424  
NGX_CONF_OK
;

425 
	}
}

429 
	$ngx_îr‹_log
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

431 
ngx_°r_t
 *
vÆue
, 
«me
;

433 i‡(
cf
->
cy˛e
->
√w_log
.
fûe
) {

437 
vÆue
 = 
cf
->
¨gs
->
ñts
;

439 i‡(
	`ngx_°rcmp
(
vÆue
[1].
d©a
, "stderr") == 0) {

440 
	`ngx_°r_nuŒ
(&
«me
);

443 
«me
 = 
vÆue
[1];

446 
cf
->
cy˛e
->
√w_log
.
fûe
 = 
	`ngx_c⁄f_›í_fûe
(cf->cy˛e, &
«me
);

447 i‡(
cf
->
cy˛e
->
√w_log
.
fûe
 =
NULL
) {

448  
NULL
;

451 i‡(
cf
->
¨gs
->
√…s
 == 2) {

452 
cf
->
cy˛e
->
√w_log
.
log_Àvñ
 = 
NGX_LOG_ERR
;

453  
NGX_CONF_OK
;

456 
cf
->
cy˛e
->
√w_log
.
log_Àvñ
 = 0;

458  
	`ngx_log_£t_Àvñs
(
cf
, &cf->
cy˛e
->
√w_log
);

459 
	}
}

	@ngx_log.h

8 #i‚de‡
_NGX_LOG_H_INCLUDED_


9 
	#_NGX_LOG_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
	#NGX_LOG_STDERR
 0

	)

17 
	#NGX_LOG_EMERG
 1

	)

18 
	#NGX_LOG_ALERT
 2

	)

19 
	#NGX_LOG_CRIT
 3

	)

20 
	#NGX_LOG_ERR
 4

	)

21 
	#NGX_LOG_WARN
 5

	)

22 
	#NGX_LOG_NOTICE
 6

	)

23 
	#NGX_LOG_INFO
 7

	)

24 
	#NGX_LOG_DEBUG
 8

	)

26 
	#NGX_LOG_DEBUG_CORE
 0x010

	)

27 
	#NGX_LOG_DEBUG_ALLOC
 0x020

	)

28 
	#NGX_LOG_DEBUG_MUTEX
 0x040

	)

29 
	#NGX_LOG_DEBUG_EVENT
 0x080

	)

30 
	#NGX_LOG_DEBUG_HTTP
 0x100

	)

31 
	#NGX_LOG_DEBUG_MAIL
 0x200

	)

32 
	#NGX_LOG_DEBUG_MYSQL
 0x400

	)

39 
	#NGX_LOG_DEBUG_FIRST
 
NGX_LOG_DEBUG_CORE


	)

40 
	#NGX_LOG_DEBUG_LAST
 
NGX_LOG_DEBUG_MYSQL


	)

41 
	#NGX_LOG_DEBUG_CONNECTION
 0x80000000

	)

42 
	#NGX_LOG_DEBUG_ALL
 0x7ffffff0

	)

45 
	gu_ch¨
 *(*
	tngx_log_h™dÀr_±
Ë(
	tngx_log_t
 *
	tlog
, 
	tu_ch¨
 *
	tbuf
, 
	tsize_t
 
	tÀn
);

48 
	sngx_log_s
 {

49 
ngx_uöt_t
 
	mlog_Àvñ
;

50 
ngx_›í_fûe_t
 *
	mfûe
;

52 
ngx_©omic_uöt_t
 
	mc⁄√˘i⁄
;

54 
ngx_log_h™dÀr_±
 
	mh™dÀr
;

55 *
	md©a
;

63 *
	ma˘i⁄
;

67 
	#NGX_MAX_ERROR_STR
 2048

	)

72 #i‡(
NGX_HAVE_C99_VARIADIC_MACROS
)

74 
	#NGX_HAVE_VARIADIC_MACROS
 1

	)

76 
	#ngx_log_îr‹
(
Àvñ
, 
log
, ...) \

77 i‡((
log
)->
log_Àvñ
 >
Àvñ
Ë
	`ngx_log_îr‹_c‹e
÷evñ,Üog, 
__VA_ARGS__
)

	)

79 
ngx_log_îr‹_c‹e
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

80 c⁄° *
fmt
, ...);

82 
	#ngx_log_debug
(
Àvñ
, 
log
, ...) \

83 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

84 
	`ngx_log_îr‹_c‹e
(
NGX_LOG_DEBUG
, 
log
, 
__VA_ARGS__
)

	)

88 #ñi‡(
NGX_HAVE_GCC_VARIADIC_MACROS
)

90 
	#NGX_HAVE_VARIADIC_MACROS
 1

	)

92 
	#ngx_log_îr‹
(
Àvñ
, 
log
, 
¨gs
...) \

93 i‡((
log
)->
log_Àvñ
 >
Àvñ
Ë
	`ngx_log_îr‹_c‹e
÷evñ,Üog, 
¨gs
)

	)

95 
ngx_log_îr‹_c‹e
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

96 c⁄° *
fmt
, ...);

98 
	#ngx_log_debug
(
Àvñ
, 
log
, 
¨gs
...) \

99 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

100 
	`ngx_log_îr‹_c‹e
(
NGX_LOG_DEBUG
, 
log
, 
¨gs
)

	)

106 
	#NGX_HAVE_VARIADIC_MACROS
 0

	)

108 
ngx_cde˛
 
ngx_log_îr‹
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

109 c⁄° *
fmt
, ...);

110 
ngx_log_îr‹_c‹e
(
ngx_uöt_t
 
Àvñ
, 
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

111 c⁄° *
fmt
, 
va_li°
 
¨gs
);

112 
ngx_cde˛
 
ngx_log_debug_c‹e
(
ngx_log_t
 *
log
, 
ngx_îr_t
 
îr
,

113 c⁄° *
fmt
, ...);

121 #i‡(
NGX_DEBUG
)

123 #i‡(
NGX_HAVE_VARIADIC_MACROS
)

125 
	#ngx_log_debug0
(
Àvñ
, 
log
, 
îr
, 
fmt
) \

126 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
)

	)

128 
	#ngx_log_debug1
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
) \

129 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
)

	)

131 
	#ngx_log_debug2
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
) \

132 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
)

	)

134 
	#ngx_log_debug3
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
) \

135 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
)

	)

137 
	#ngx_log_debug4
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
) \

138 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
)

	)

140 
	#ngx_log_debug5
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
) \

141 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
)

	)

143 
	#ngx_log_debug6
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

144 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
) \

145 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

146 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
)

	)

148 
	#ngx_log_debug7
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

149 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
) \

150 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

151 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
)

	)

153 
	#ngx_log_debug8
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

154 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
, 
¨g8
) \

155 
	`ngx_log_debug
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

156 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
, 
¨g8
)

	)

161 
	#ngx_log_debug0
(
Àvñ
, 
log
, 
îr
, 
fmt
) \

162 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

163 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
)

	)

165 
	#ngx_log_debug1
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
) \

166 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

167 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, 
¨g1
)

	)

169 
	#ngx_log_debug2
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
) \

170 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

171 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
)

	)

173 
	#ngx_log_debug3
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
) \

174 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

175 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
)

	)

177 
	#ngx_log_debug4
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
) \

178 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

179 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
)

	)

181 
	#ngx_log_debug5
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
) \

182 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

183 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
)

	)

185 
	#ngx_log_debug6
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

186 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
) \

187 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

188 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
)

	)

190 
	#ngx_log_debug7
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

191 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
) \

192 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

193 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, \

194 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
)

	)

196 
	#ngx_log_debug8
(
Àvñ
, 
log
, 
îr
, 
fmt
, \

197 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
, 
¨g8
) \

198 i‡((
log
)->
log_Àvñ
 & 
Àvñ
) \

199 
	`ngx_log_debug_c‹e
(
log
, 
îr
, 
fmt
, \

200 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
, 
¨g7
, 
¨g8
)

	)

206 
	#ngx_log_debug0
(
Àvñ
, 
log
, 
îr
, 
fmt
)

	)

207 
	#ngx_log_debug1
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
)

	)

208 
	#ngx_log_debug2
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
)

	)

209 
	#ngx_log_debug3
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
)

	)

210 
	#ngx_log_debug4
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
)

	)

211 
	#ngx_log_debug5
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
)

	)

212 
	#ngx_log_debug6
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, 
¨g6
)

	)

213 
	#ngx_log_debug7
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, \

214 
¨g6
, 
¨g7
)

	)

215 
	#ngx_log_debug8
(
Àvñ
, 
log
, 
îr
, 
fmt
, 
¨g1
, 
¨g2
, 
¨g3
, 
¨g4
, 
¨g5
, \

216 
¨g6
, 
¨g7
, 
¨g8
)

	)

222 
ngx_log_t
 *
ngx_log_öô
(
u_ch¨
 *
¥efix
);

223 
ngx_log_t
 *
ngx_log_¸óã
(
ngx_cy˛e_t
 *
cy˛e
, 
ngx_°r_t
 *
«me
);

224 *
ngx_log_£t_Àvñs
(
ngx_c⁄f_t
 *
cf
, 
ngx_log_t
 *
log
);

225 
ngx_cde˛
 
ngx_log_ab‹t
(
ngx_îr_t
 
îr
, c⁄° *
fmt
, ...);

226 
ngx_cde˛
 
ngx_log_°dîr
(
ngx_îr_t
 
îr
, c⁄° *
fmt
, ...);

227 
u_ch¨
 *
ngx_log_î∫o
(u_ch¨ *
buf
, u_ch¨ *
œ°
, 
ngx_îr_t
 
îr
);

239 
ngx_ölöe
 

240 
	$ngx_wrôe_°dîr
(*
ãxt
)

242 (Ë
	`ngx_wrôe_fd
(
ngx_°dîr
, 
ãxt
, 
	`°æí
(text));

243 
	}
}

246 
ngx_moduÀ_t
 
ngx_îæog_moduÀ
;

247 
ngx_uöt_t
 
ngx_u£_°dîr
;

	@ngx_md5.c

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~<ngx_md5.h
>

16 #i‡!(
NGX_HAVE_MD5
)

18 c⁄° 
u_ch¨
 *
ngx_md5_body
(
ngx_md5_t
 *
˘x
, c⁄° u_ch¨ *
d©a
,

19 
size_t
 
size
);

23 
	$ngx_md5_öô
(
ngx_md5_t
 *
˘x
)

25 
˘x
->
a
 = 0x67452301;

26 
˘x
->
b
 = 0xefcdab89;

27 
˘x
->
c
 = 0x98badcfe;

28 
˘x
->
d
 = 0x10325476;

30 
˘x
->
byãs
 = 0;

31 
	}
}

35 
	$ngx_md5_upd©e
(
ngx_md5_t
 *
˘x
, c⁄° *
d©a
, 
size_t
 
size
)

37 
size_t
 
u£d
, 
‰ì
;

39 
u£d
 = (
size_t
Ë(
˘x
->
byãs
 & 0x3f);

40 
˘x
->
byãs
 +
size
;

42 i‡(
u£d
) {

43 
‰ì
 = 64 - 
u£d
;

45 i‡(
size
 < 
‰ì
) {

46 
	`ngx_mem˝y
(&
˘x
->
buf„r
[
u£d
], 
d©a
, 
size
);

50 
	`ngx_mem˝y
(&
˘x
->
buf„r
[
u£d
], 
d©a
, 
‰ì
);

51 
d©a
 = (
u_ch¨
 *Ëd©®+ 
‰ì
;

52 
size
 -
‰ì
;

53 (Ë
	`ngx_md5_body
(
˘x
, ctx->
buf„r
, 64);

56 i‡(
size
 >= 64) {

57 
d©a
 = 
	`ngx_md5_body
(
˘x
, d©a, 
size
 & ~(
size_t
) 0x3f);

58 
size
 &= 0x3f;

61 
	`ngx_mem˝y
(
˘x
->
buf„r
, 
d©a
, 
size
);

62 
	}
}

66 
	$ngx_md5_föÆ
(
u_ch¨
 
ªsu…
[16], 
ngx_md5_t
 *
˘x
)

68 
size_t
 
u£d
, 
‰ì
;

70 
u£d
 = (
size_t
Ë(
˘x
->
byãs
 & 0x3f);

72 
˘x
->
buf„r
[
u£d
++] = 0x80;

74 
‰ì
 = 64 - 
u£d
;

76 i‡(
‰ì
 < 8) {

77 
	`ngx_memzîo
(&
˘x
->
buf„r
[
u£d
], 
‰ì
);

78 (Ë
	`ngx_md5_body
(
˘x
, ctx->
buf„r
, 64);

79 
u£d
 = 0;

80 
‰ì
 = 64;

83 
	`ngx_memzîo
(&
˘x
->
buf„r
[
u£d
], 
‰ì
 - 8);

85 
˘x
->
byãs
 <<= 3;

86 
˘x
->
buf„r
[56] = (
u_ch¨
Ë˘x->
byãs
;

87 
˘x
->
buf„r
[57] = (
u_ch¨
Ë(˘x->
byãs
 >> 8);

88 
˘x
->
buf„r
[58] = (
u_ch¨
Ë(˘x->
byãs
 >> 16);

89 
˘x
->
buf„r
[59] = (
u_ch¨
Ë(˘x->
byãs
 >> 24);

90 
˘x
->
buf„r
[60] = (
u_ch¨
Ë(˘x->
byãs
 >> 32);

91 
˘x
->
buf„r
[61] = (
u_ch¨
Ë(˘x->
byãs
 >> 40);

92 
˘x
->
buf„r
[62] = (
u_ch¨
Ë(˘x->
byãs
 >> 48);

93 
˘x
->
buf„r
[63] = (
u_ch¨
Ë(˘x->
byãs
 >> 56);

95 (Ë
	`ngx_md5_body
(
˘x
, ctx->
buf„r
, 64);

97 
ªsu…
[0] = (
u_ch¨
Ë
˘x
->
a
;

98 
ªsu…
[1] = (
u_ch¨
Ë(
˘x
->
a
 >> 8);

99 
ªsu…
[2] = (
u_ch¨
Ë(
˘x
->
a
 >> 16);

100 
ªsu…
[3] = (
u_ch¨
Ë(
˘x
->
a
 >> 24);

101 
ªsu…
[4] = (
u_ch¨
Ë
˘x
->
b
;

102 
ªsu…
[5] = (
u_ch¨
Ë(
˘x
->
b
 >> 8);

103 
ªsu…
[6] = (
u_ch¨
Ë(
˘x
->
b
 >> 16);

104 
ªsu…
[7] = (
u_ch¨
Ë(
˘x
->
b
 >> 24);

105 
ªsu…
[8] = (
u_ch¨
Ë
˘x
->
c
;

106 
ªsu…
[9] = (
u_ch¨
Ë(
˘x
->
c
 >> 8);

107 
ªsu…
[10] = (
u_ch¨
Ë(
˘x
->
c
 >> 16);

108 
ªsu…
[11] = (
u_ch¨
Ë(
˘x
->
c
 >> 24);

109 
ªsu…
[12] = (
u_ch¨
Ë
˘x
->
d
;

110 
ªsu…
[13] = (
u_ch¨
Ë(
˘x
->
d
 >> 8);

111 
ªsu…
[14] = (
u_ch¨
Ë(
˘x
->
d
 >> 16);

112 
ªsu…
[15] = (
u_ch¨
Ë(
˘x
->
d
 >> 24);

114 
	`ngx_memzîo
(
˘x
, (*ctx));

115 
	}
}

126 
	#F
(
x
, 
y
, 
z
Ë((zË^ ((xË& ((yË^ (z))))

	)

127 
	#G
(
x
, 
y
, 
z
Ë((yË^ ((zË& ((xË^ (y))))

	)

128 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

129 
	#I
(
x
, 
y
, 
z
Ë((yË^ ((xË| ~(z)))

	)

135 
	#STEP
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
t
, 
s
) \

136 (
a
Ë+
	`f
((
b
), (
c
), (
d
)Ë+ (
x
Ë+ (
t
); \

137 (
a
Ë((◊Ë<< (
s
)) | (((a) & 0xffffffff) >> (32 - (s)))); \

138 (
a
Ë+(
b
)

	)

149 #i‡(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

151 
	#SET
(
n
Ë(*(
uöt32_t
 *Ë&
p
[¿* 4])

	)

152 
	#GET
(
n
Ë(*(
uöt32_t
 *Ë&
p
[¿* 4])

	)

156 
	#SET
(
n
) \

157 (
block
[
n
] = \

158 (
uöt32_t
Ë
p
[
n
 * 4] | \

159 ((
uöt32_t
Ë
p
[
n
 * 4 + 1] << 8) | \

160 ((
uöt32_t
Ë
p
[
n
 * 4 + 2] << 16) | \

161 ((
uöt32_t
Ë
p
[
n
 * 4 + 3] << 24))

	)

163 
	#GET
(
n
Ë
block
[n]

	)

173 c⁄° 
u_ch¨
 *

174 
	$ngx_md5_body
(
ngx_md5_t
 *
˘x
, c⁄° 
u_ch¨
 *
d©a
, 
size_t
 
size
)

176 
uöt32_t
 
a
, 
b
, 
c
, 
d
;

177 
uöt32_t
 
ßved_a
, 
ßved_b
, 
ßved_c
, 
ßved_d
;

178 c⁄° 
u_ch¨
 *
p
;

179 #i‡!(
NGX_HAVE_LITTLE_ENDIAN
 && 
NGX_HAVE_NONALIGNED
)

180 
uöt32_t
 
block
[16];

183 
p
 = 
d©a
;

185 
a
 = 
˘x
->a;

186 
b
 = 
˘x
->b;

187 
c
 = 
˘x
->c;

188 
d
 = 
˘x
->d;

191 
ßved_a
 = 
a
;

192 
ßved_b
 = 
b
;

193 
ßved_c
 = 
c
;

194 
ßved_d
 = 
d
;

198 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(0), 0xd76aa478, 7);

199 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(1), 0xe8c7b756, 12);

200 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(2), 0x242070db, 17);

201 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(3), 0xc1bdceee, 22);

202 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(4), 0xf57c0faf, 7);

203 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(5), 0x4787c62a, 12);

204 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(6), 0xa8304613, 17);

205 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(7), 0xfd469501, 22);

206 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(8), 0x698098d8, 7);

207 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(9), 0x8b44f7af, 12);

208 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(10), 0xffff5bb1, 17);

209 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(11), 0x895cd7be, 22);

210 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(12), 0x6b901122, 7);

211 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(13), 0xfd987193, 12);

212 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(14), 0xa679438e, 17);

213 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(15), 0x49b40821, 22);

217 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xf61e2562, 5);

218 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(6), 0xc040b340, 9);

219 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x265e5a51, 14);

220 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(0), 0xe9b6c7aa, 20);

221 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xd62f105d, 5);

222 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(10), 0x02441453, 9);

223 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0xd8a1e681, 14);

224 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(4), 0xe7d3fbc8, 20);

225 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0x21e1cde6, 5);

226 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(14), 0xc33707d6, 9);

227 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xf4d50d87, 14);

228 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(8), 0x455a14ed, 20);

229 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0xa9e3e905, 5);

230 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(2), 0xfcefa3f8, 9);

231 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0x676f02d9, 14);

232 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(12), 0x8d2a4c8a, 20);

236 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xfffa3942, 4);

237 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(8), 0x8771f681, 11);

238 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x6d9d6122, 16);

239 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(14), 0xfde5380c, 23);

240 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xa4beea44, 4);

241 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(4), 0x4bdecfa9, 11);

242 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0xf6bb4b60, 16);

243 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(10), 0xbebfbc70, 23);

244 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0x289b7ec6, 4);

245 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(0), 0xeaa127fa, 11);

246 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xd4ef3085, 16);

247 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(6), 0x04881d05, 23);

248 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0xd9d4d039, 4);

249 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(12), 0xe6db99e5, 11);

250 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0x1fa27cf8, 16);

251 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(2), 0xc4ac5665, 23);

255 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(0), 0xf4292244, 6);

256 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(7), 0x432aff97, 10);

257 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(14), 0xab9423a7, 15);

258 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(5), 0xfc93a039, 21);

259 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(12), 0x655b59c3, 6);

260 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(3), 0x8f0ccc92, 10);

261 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(10), 0xffeff47d, 15);

262 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(1), 0x85845dd1, 21);

263 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(8), 0x6fa87e4f, 6);

264 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(15), 0xfe2ce6e0, 10);

265 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(6), 0xa3014314, 15);

266 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(13), 0x4e0811a1, 21);

267 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(4), 0xf7537e82, 6);

268 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(11), 0xbd3af235, 10);

269 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(2), 0x2ad7d2bb, 15);

270 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(9), 0xeb86d391, 21);

272 
a
 +
ßved_a
;

273 
b
 +
ßved_b
;

274 
c
 +
ßved_c
;

275 
d
 +
ßved_d
;

277 
p
 += 64;

279 } 
size
 -= 64);

281 
˘x
->
a
 =á;

282 
˘x
->
b
 = b;

283 
˘x
->
c
 = c;

284 
˘x
->
d
 = d;

286  
p
;

287 
	}
}

	@ngx_md5.h

8 #i‚de‡
_NGX_MD5_H_INCLUDED_


9 
	#_NGX_MD5_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 #i‡(
NGX_HAVE_MD5
)

18 #i‡(
NGX_HAVE_OPENSSL_MD5_H
)

19 
	~<›ís¶/md5.h
>

21 
	~<md5.h
>

25 
MD5_CTX
 
	tngx_md5_t
;

28 #i‡(
NGX_OPENSSL_MD5
)

30 
	#ngx_md5_öô
 
MD5_Inô


	)

31 
	#ngx_md5_upd©e
 
MD5_Upd©e


	)

32 
	#ngx_md5_föÆ
 
MD5_FöÆ


	)

36 
	#ngx_md5_öô
 
MD5Inô


	)

37 
	#ngx_md5_upd©e
 
MD5Upd©e


	)

38 
	#ngx_md5_föÆ
 
MD5FöÆ


	)

47 
uöt64_t
 
	mbyãs
;

48 
uöt32_t
 
	ma
, 
	mb
, 
	mc
, 
	md
;

49 
u_ch¨
 
	mbuf„r
[64];

50 } 
	tngx_md5_t
;

53 
ngx_md5_öô
(
ngx_md5_t
 *
˘x
);

54 
ngx_md5_upd©e
(
ngx_md5_t
 *
˘x
, c⁄° *
d©a
, 
size_t
 
size
);

55 
ngx_md5_föÆ
(
u_ch¨
 
ªsu…
[16], 
ngx_md5_t
 *
˘x
);

	@ngx_murmurhash.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

11 
uöt32_t


12 
	$ngx_murmur_hash2
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
)

14 
uöt32_t
 
h
, 
k
;

16 
h
 = 0 ^ 
Àn
;

18 
Àn
 >= 4) {

19 
k
 = 
d©a
[0];

20 
k
 |
d©a
[1] << 8;

21 
k
 |
d©a
[2] << 16;

22 
k
 |
d©a
[3] << 24;

24 
k
 *= 0x5bd1e995;

25 
k
 ^= k >> 24;

26 
k
 *= 0x5bd1e995;

28 
h
 *= 0x5bd1e995;

29 
h
 ^
k
;

31 
d©a
 += 4;

32 
Àn
 -= 4;

35 
Àn
) {

37 
h
 ^
d©a
[2] << 16;

39 
h
 ^
d©a
[1] << 8;

41 
h
 ^
d©a
[0];

42 
h
 *= 0x5bd1e995;

45 
h
 ^= h >> 13;

46 
h
 *= 0x5bd1e995;

47 
h
 ^= h >> 15;

49  
h
;

50 
	}
}

	@ngx_murmurhash.h

8 #i‚de‡
_NGX_MURMURHASH_H_INCLUDED_


9 
	#_NGX_MURMURHASH_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
uöt32_t
 
ngx_murmur_hash2
(
u_ch¨
 *
d©a
, 
size_t
 
Àn
);

	@ngx_open_file_cache.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

10 
	~<ngx_evít.h
>

21 
	#NGX_MIN_READ_AHEAD
 (128 * 1024)

	)

24 
ngx_›í_fûe_ˇche_˛ónup
(*
d©a
);

25 #i‡(
NGX_HAVE_OPENAT
)

26 
ngx_fd_t
 
ngx_›í©_fûe_ow√r
“gx_fd_à
©_fd
, c⁄° 
u_ch¨
 *
«me
,

27 
ngx_öt_t
 
mode
,Çgx_öt_à
¸óã
,Çgx_öt_à
ac˚ss
, 
ngx_log_t
 *
log
);

29 
ngx_fd_t
 
ngx_›í_fûe_wøµî
(
ngx_°r_t
 *
«me
,

30 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_öt_t
 
mode
,Çgx_öt_à
¸óã
,

31 
ngx_öt_t
 
ac˚ss
, 
ngx_log_t
 *
log
);

32 
ngx_öt_t
 
ngx_fûe_öfo_wøµî
(
ngx_°r_t
 *
«me
,

33 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_fûe_öfo_t
 *
fi
, 
ngx_log_t
 *
log
);

34 
ngx_öt_t
 
ngx_›í_™d_°©_fûe
(
ngx_°r_t
 *
«me
,

35 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_log_t
 *
log
);

36 
ngx_›í_fûe_add_evít
(
ngx_›í_fûe_ˇche_t
 *
ˇche
,

37 
ngx_ˇched_›í_fûe_t
 *
fûe
, 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_log_t
 *
log
);

38 
ngx_›í_fûe_˛ónup
(*
d©a
);

39 
ngx_˛o£_ˇched_fûe
(
ngx_›í_fûe_ˇche_t
 *
ˇche
,

40 
ngx_ˇched_›í_fûe_t
 *
fûe
, 
ngx_uöt_t
 
mö_u£s
, 
ngx_log_t
 *
log
);

41 
ngx_›í_fûe_dñ_evít
(
ngx_ˇched_›í_fûe_t
 *
fûe
);

42 
ngx_expúe_ﬁd_ˇched_fûes
(
ngx_›í_fûe_ˇche_t
 *
ˇche
,

43 
ngx_uöt_t
 
n
, 
ngx_log_t
 *
log
);

44 
ngx_›í_fûe_ˇche_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,

45 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
);

46 
ngx_ˇched_›í_fûe_t
 *

47 
ngx_›í_fûe_lookup
(
ngx_›í_fûe_ˇche_t
 *
ˇche
, 
ngx_°r_t
 *
«me
,

48 
uöt32_t
 
hash
);

49 
ngx_›í_fûe_ˇche_ªmove
(
ngx_evít_t
 *
ev
);

52 
ngx_›í_fûe_ˇche_t
 *

53 
	$ngx_›í_fûe_ˇche_öô
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
max
, 
time_t
 
öa˘ive
)

55 
ngx_poﬁ_˛ónup_t
 *
˛n
;

56 
ngx_›í_fûe_ˇche_t
 *
ˇche
;

58 
ˇche
 = 
	`ngx_∑Œoc
(
poﬁ
, (
ngx_›í_fûe_ˇche_t
));

59 i‡(
ˇche
 =
NULL
) {

60  
NULL
;

63 
	`ngx_rbåì_öô
(&
ˇche
->
rbåì
, &ˇche->
£¡öñ
,

64 
ngx_›í_fûe_ˇche_rbåì_ö£π_vÆue
);

66 
	`ngx_queue_öô
(&
ˇche
->
expúe_queue
);

68 
ˇche
->
cuºít
 = 0;

69 
ˇche
->
max
 = max;

70 
ˇche
->
öa˘ive
 = inactive;

72 
˛n
 = 
	`ngx_poﬁ_˛ónup_add
(
poﬁ
, 0);

73 i‡(
˛n
 =
NULL
) {

74  
NULL
;

77 
˛n
->
h™dÀr
 = 
ngx_›í_fûe_ˇche_˛ónup
;

78 
˛n
->
d©a
 = 
ˇche
;

80  
ˇche
;

81 
	}
}

85 
	$ngx_›í_fûe_ˇche_˛ónup
(*
d©a
)

87 
ngx_›í_fûe_ˇche_t
 *
ˇche
 = 
d©a
;

89 
ngx_queue_t
 *
q
;

90 
ngx_ˇched_›í_fûe_t
 *
fûe
;

92 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

97 i‡(
	`ngx_queue_em±y
(&
ˇche
->
expúe_queue
)) {

101 
q
 = 
	`ngx_queue_œ°
(&
ˇche
->
expúe_queue
);

103 
fûe
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ˇched_›í_fûe_t
, 
queue
);

105 
	`ngx_queue_ªmove
(
q
);

107 
	`ngx_rbåì_dñëe
(&
ˇche
->
rbåì
, &
fûe
->
node
);

109 
ˇche
->
cuºít
--;

111 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

112 "dñëêˇched o≥¿fûe: %s", 
fûe
->
«me
);

114 i‡(!
fûe
->
îr
 && !fûe->
is_dú
) {

115 
fûe
->
˛o£
 = 1;

116 
fûe
->
cou¡
 = 0;

117 
	`ngx_˛o£_ˇched_fûe
(
ˇche
, 
fûe
, 0, 
ngx_cy˛e
->
log
);

120 
	`ngx_‰ì
(
fûe
->
«me
);

121 
	`ngx_‰ì
(
fûe
);

125 i‡(
ˇche
->
cuºít
) {

126 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0,

128 
ˇche
->
cuºít
);

131 i‡(
ˇche
->
rbåì
.
roŸ
 !ˇche->rbåì.
£¡öñ
) {

132 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0,

136 
	}
}

139 
ngx_öt_t


140 
	$ngx_›í_ˇched_fûe
(
ngx_›í_fûe_ˇche_t
 *
ˇche
, 
ngx_°r_t
 *
«me
,

141 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_poﬁ_t
 *
poﬁ
)

143 
time_t
 
now
;

144 
uöt32_t
 
hash
;

145 
ngx_öt_t
 
rc
;

146 
ngx_fûe_öfo_t
 
fi
;

147 
ngx_poﬁ_˛ónup_t
 *
˛n
;

148 
ngx_ˇched_›í_fûe_t
 *
fûe
;

149 
ngx_poﬁ_˛ónup_fûe_t
 *
˛nf
;

150 
ngx_›í_fûe_ˇche_˛ónup_t
 *
of˛n
;

152 
of
->
fd
 = 
NGX_INVALID_FILE
;

153 
of
->
îr
 = 0;

155 i‡(
ˇche
 =
NULL
) {

157 i‡(
of
->
ã°_⁄ly
) {

159 i‡(
	`ngx_fûe_öfo_wøµî
(
«me
, 
of
, &
fi
, 
poﬁ
->
log
)

160 =
NGX_FILE_ERROR
)

162  
NGX_ERROR
;

165 
of
->
uniq
 = 
	`ngx_fûe_uniq
(&
fi
);

166 
of
->
mtime
 = 
	`ngx_fûe_mtime
(&
fi
);

167 
of
->
size
 = 
	`ngx_fûe_size
(&
fi
);

168 
of
->
fs_size
 = 
	`ngx_fûe_fs_size
(&
fi
);

169 
of
->
is_dú
 = 
	`ngx_is_dú
(&
fi
);

170 
of
->
is_fûe
 = 
	`ngx_is_fûe
(&
fi
);

171 
of
->
is_lök
 = 
	`ngx_is_lök
(&
fi
);

172 
of
->
is_exec
 = 
	`ngx_is_exec
(&
fi
);

174  
NGX_OK
;

177 
˛n
 = 
	`ngx_poﬁ_˛ónup_add
(
poﬁ
, (
ngx_poﬁ_˛ónup_fûe_t
));

178 i‡(
˛n
 =
NULL
) {

179  
NGX_ERROR
;

182 
rc
 = 
	`ngx_›í_™d_°©_fûe
(
«me
, 
of
, 
poﬁ
->
log
);

184 i‡(
rc
 =
NGX_OK
 && !
of
->
is_dú
) {

185 
˛n
->
h™dÀr
 = 
ngx_poﬁ_˛ónup_fûe
;

186 
˛nf
 = 
˛n
->
d©a
;

188 
˛nf
->
fd
 = 
of
->fd;

189 
˛nf
->
«me
 =Çame->
d©a
;

190 
˛nf
->
log
 = 
poﬁ
->log;

193  
rc
;

196 
˛n
 = 
	`ngx_poﬁ_˛ónup_add
(
poﬁ
, (
ngx_›í_fûe_ˇche_˛ónup_t
));

197 i‡(
˛n
 =
NULL
) {

198  
NGX_ERROR
;

201 
now
 = 
	`ngx_time
();

203 
hash
 = 
	`ngx_¸c32_l⁄g
(
«me
->
d©a
,Çame->
Àn
);

205 
fûe
 = 
	`ngx_›í_fûe_lookup
(
ˇche
, 
«me
, 
hash
);

207 i‡(
fûe
) {

209 
fûe
->
u£s
++;

211 
	`ngx_queue_ªmove
(&
fûe
->
queue
);

213 i‡(
fûe
->
fd
 =
NGX_INVALID_FILE
 && fûe->
îr
 =0 && !fûe->
is_dú
) {

217 
rc
 = 
	`ngx_›í_™d_°©_fûe
(
«me
, 
of
, 
poﬁ
->
log
);

219 i‡(
rc
 !
NGX_OK
 && (
of
->
îr
 =0 || !of->
îr‹s
)) {

220 
Áûed
;

223 
add_evít
;

226 i‡(
fûe
->
u£_evít


227 || (
fûe
->
evít
 =
NULL


228 && (
of
->
uniq
 =0 || of->uniq =
fûe
->uniq)

229 && 
now
 - 
fûe
->
¸óãd
 < 
of
->
vÆid


230 #i‡(
NGX_HAVE_OPENAT
)

231 && 
of
->
dißbÀ_symlöks
 =
fûe
->disable_symlinks

232 && 
of
->
dißbÀ_symlöks_‰om
 =
fûe
->disable_symlinks_from

236 i‡(
fûe
->
îr
 == 0) {

238 
of
->
fd
 = 
fûe
->fd;

239 
of
->
uniq
 = 
fûe
->uniq;

240 
of
->
mtime
 = 
fûe
->mtime;

241 
of
->
size
 = 
fûe
->size;

243 
of
->
is_dú
 = 
fûe
->is_dir;

244 
of
->
is_fûe
 = 
fûe
->is_file;

245 
of
->
is_lök
 = 
fûe
->is_link;

246 
of
->
is_exec
 = 
fûe
->is_exec;

247 
of
->
is_dúe˘io
 = 
fûe
->is_directio;

249 i‡(!
fûe
->
is_dú
) {

250 
fûe
->
cou¡
++;

251 
	`ngx_›í_fûe_add_evít
(
ˇche
, 
fûe
, 
of
, 
poﬁ
->
log
);

255 
of
->
îr
 = 
fûe
->err;

256 #i‡(
NGX_HAVE_OPENAT
)

257 
of
->
Áûed
 = 
fûe
->
dißbÀ_symlöks
 ? 
ngx_›í©_fûe_n


258 : 
ngx_›í_fûe_n
;

260 
of
->
Áûed
 = 
ngx_›í_fûe_n
;

264 
found
;

267 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_CORE
, 
poﬁ
->
log
, 0,

269 
fûe
->
«me
, fûe->
fd
, fûe->
cou¡
, fûe->
îr
);

271 i‡(
fûe
->
is_dú
) {

279 
of
->
ã°_dú
 = 1;

282 
of
->
fd
 = 
fûe
->fd;

283 
of
->
uniq
 = 
fûe
->uniq;

285 
rc
 = 
	`ngx_›í_™d_°©_fûe
(
«me
, 
of
, 
poﬁ
->
log
);

287 i‡(
rc
 !
NGX_OK
 && (
of
->
îr
 =0 || !of->
îr‹s
)) {

288 
Áûed
;

291 i‡(
of
->
is_dú
) {

293 i‡(
fûe
->
is_dú
 || fûe->
îr
) {

294 
upd©e
;

299 } i‡(
of
->
îr
 == 0) {

301 i‡(
fûe
->
is_dú
 || fûe->
îr
) {

302 
add_evít
;

305 i‡(
of
->
uniq
 =
fûe
->uniq) {

307 i‡(
fûe
->
evít
) {

308 
fûe
->
u£_evít
 = 1;

311 
of
->
is_dúe˘io
 = 
fûe
->is_directio;

313 
upd©e
;

320 i‡(
fûe
->
îr
 || fûe->
is_dú
) {

321 
upd©e
;

327 i‡(
fûe
->
cou¡
 == 0) {

329 
	`ngx_›í_fûe_dñ_evít
(
fûe
);

331 i‡(
	`ngx_˛o£_fûe
(
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

332 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
poﬁ
->
log
, 
ngx_î∫o
,

333 
ngx_˛o£_fûe_n
 " \"%V\" faûed", 
«me
);

336 
add_evít
;

339 
	`ngx_rbåì_dñëe
(&
ˇche
->
rbåì
, &
fûe
->
node
);

341 
ˇche
->
cuºít
--;

343 
fûe
->
˛o£
 = 1;

345 
¸óã
;

350 
rc
 = 
	`ngx_›í_™d_°©_fûe
(
«me
, 
of
, 
poﬁ
->
log
);

352 i‡(
rc
 !
NGX_OK
 && (
of
->
îr
 =0 || !of->
îr‹s
)) {

353 
Áûed
;

356 
¸óã
:

358 i‡(
ˇche
->
cuºít
 >ˇche->
max
) {

359 
	`ngx_expúe_ﬁd_ˇched_fûes
(
ˇche
, 0, 
poﬁ
->
log
);

362 
fûe
 = 
	`ngx_Æloc
((
ngx_ˇched_›í_fûe_t
), 
poﬁ
->
log
);

364 i‡(
fûe
 =
NULL
) {

365 
Áûed
;

368 
fûe
->
«me
 = 
	`ngx_Æloc
“ame->
Àn
 + 1, 
poﬁ
->
log
);

370 i‡(
fûe
->
«me
 =
NULL
) {

371 
	`ngx_‰ì
(
fûe
);

372 
fûe
 = 
NULL
;

373 
Áûed
;

376 
	`ngx_˝y°∫
(
fûe
->
«me
,Çame->
d©a
,Çame->
Àn
 + 1);

378 
fûe
->
node
.
key
 = 
hash
;

380 
	`ngx_rbåì_ö£π
(&
ˇche
->
rbåì
, &
fûe
->
node
);

382 
ˇche
->
cuºít
++;

384 
fûe
->
u£s
 = 1;

385 
fûe
->
cou¡
 = 0;

386 
fûe
->
u£_evít
 = 0;

387 
fûe
->
evít
 = 
NULL
;

389 
add_evít
:

391 
	`ngx_›í_fûe_add_evít
(
ˇche
, 
fûe
, 
of
, 
poﬁ
->
log
);

393 
upd©e
:

395 
fûe
->
fd
 = 
of
->fd;

396 
fûe
->
îr
 = 
of
->err;

397 #i‡(
NGX_HAVE_OPENAT
)

398 
fûe
->
dißbÀ_symlöks
 = 
of
->disable_symlinks;

399 
fûe
->
dißbÀ_symlöks_‰om
 = 
of
->disable_symlinks_from;

402 i‡(
of
->
îr
 == 0) {

403 
fûe
->
uniq
 = 
of
->uniq;

404 
fûe
->
mtime
 = 
of
->mtime;

405 
fûe
->
size
 = 
of
->size;

407 
fûe
->
˛o£
 = 0;

409 
fûe
->
is_dú
 = 
of
->is_dir;

410 
fûe
->
is_fûe
 = 
of
->is_file;

411 
fûe
->
is_lök
 = 
of
->is_link;

412 
fûe
->
is_exec
 = 
of
->is_exec;

413 
fûe
->
is_dúe˘io
 = 
of
->is_directio;

415 i‡(!
of
->
is_dú
) {

416 
fûe
->
cou¡
++;

420 
fûe
->
¸óãd
 = 
now
;

422 
found
:

424 
fûe
->
ac˚s£d
 = 
now
;

426 
	`ngx_queue_ö£π_hód
(&
ˇche
->
expúe_queue
, &
fûe
->
queue
);

428 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_CORE
, 
poﬁ
->
log
, 0,

430 
fûe
->
«me
, fûe->
fd
, fûe->
cou¡
, fûe->
îr
, fûe->
u£s
);

432 i‡(
of
->
îr
 == 0) {

434 i‡(!
of
->
is_dú
) {

435 
˛n
->
h™dÀr
 = 
ngx_›í_fûe_˛ónup
;

436 
of˛n
 = 
˛n
->
d©a
;

438 
of˛n
->
ˇche
 = cache;

439 
of˛n
->
fûe
 = file;

440 
of˛n
->
mö_u£s
 = 
of
->min_uses;

441 
of˛n
->
log
 = 
poﬁ
->log;

444  
NGX_OK
;

447  
NGX_ERROR
;

449 
Áûed
:

451 i‡(
fûe
) {

452 
	`ngx_rbåì_dñëe
(&
ˇche
->
rbåì
, &
fûe
->
node
);

454 
ˇche
->
cuºít
--;

456 i‡(
fûe
->
cou¡
 == 0) {

458 i‡(
fûe
->
fd
 !
NGX_INVALID_FILE
) {

459 i‡(
	`ngx_˛o£_fûe
(
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

460 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
poﬁ
->
log
, 
ngx_î∫o
,

461 
ngx_˛o£_fûe_n
 " \"%s\" failed",

462 
fûe
->
«me
);

466 
	`ngx_‰ì
(
fûe
->
«me
);

467 
	`ngx_‰ì
(
fûe
);

470 
fûe
->
˛o£
 = 1;

474 i‡(
of
->
fd
 !
NGX_INVALID_FILE
) {

475 i‡(
	`ngx_˛o£_fûe
(
of
->
fd
Ë=
NGX_FILE_ERROR
) {

476 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
poﬁ
->
log
, 
ngx_î∫o
,

477 
ngx_˛o£_fûe_n
 " \"%V\" faûed", 
«me
);

481  
NGX_ERROR
;

482 
	}
}

485 #i‡(
NGX_HAVE_OPENAT
)

487 
ngx_fd_t


488 
	$ngx_›í©_fûe_ow√r
(
ngx_fd_t
 
©_fd
, c⁄° 
u_ch¨
 *
«me
,

489 
ngx_öt_t
 
mode
,Çgx_öt_à
¸óã
,Çgx_öt_à
ac˚ss
, 
ngx_log_t
 *
log
)

491 
ngx_fd_t
 
fd
;

492 
ngx_îr_t
 
îr
;

493 
ngx_fûe_öfo_t
 
fi
, 
©fi
;

507 
fd
 = 
	`ngx_›í©_fûe
(
©_fd
, 
«me
, 
mode
, 
¸óã
, 
ac˚ss
);

509 i‡(
fd
 =
NGX_INVALID_FILE
) {

510  
NGX_INVALID_FILE
;

513 i‡(
	`ngx_fûe_©_öfo
(
©_fd
, 
«me
, &
©fi
, 
AT_SYMLINK_NOFOLLOW
)

514 =
NGX_FILE_ERROR
)

516 
îr
 = 
ngx_î∫o
;

517 
Áûed
;

520 i‡(
	`ngx_fd_öfo
(
fd
, &
fi
Ë=
NGX_FILE_ERROR
) {

521 
îr
 = 
ngx_î∫o
;

522 
Áûed
;

525 i‡(
fi
.
°_uid
 !
©fi
.st_uid) {

526 
îr
 = 
NGX_ELOOP
;

527 
Áûed
;

530  
fd
;

532 
Áûed
:

534 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

535 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

536 
ngx_˛o£_fûe_n
 " \"%V\" faûed", 
«me
);

539 
	`ngx_£t_î∫o
(
îr
);

541  
NGX_INVALID_FILE
;

542 
	}
}

547 
ngx_fd_t


548 
	$ngx_›í_fûe_wøµî
(
ngx_°r_t
 *
«me
, 
ngx_›í_fûe_öfo_t
 *
of
,

549 
ngx_öt_t
 
mode
,Çgx_öt_à
¸óã
,Çgx_öt_à
ac˚ss
, 
ngx_log_t
 *
log
)

551 
ngx_fd_t
 
fd
;

553 #i‡!(
NGX_HAVE_OPENAT
)

555 
fd
 = 
	`ngx_›í_fûe
(
«me
->
d©a
, 
mode
, 
¸óã
, 
ac˚ss
);

557 i‡(
fd
 =
NGX_INVALID_FILE
) {

558 
of
->
îr
 = 
ngx_î∫o
;

559 
of
->
Áûed
 = 
ngx_›í_fûe_n
;

560  
NGX_INVALID_FILE
;

563  
fd
;

567 
u_ch¨
 *
p
, *
˝
, *
íd
;

568 
ngx_fd_t
 
©_fd
;

569 
ngx_°r_t
 
©_«me
;

571 i‡(
of
->
dißbÀ_symlöks
 =
NGX_DISABLE_SYMLINKS_OFF
) {

572 
fd
 = 
	`ngx_›í_fûe
(
«me
->
d©a
, 
mode
, 
¸óã
, 
ac˚ss
);

574 i‡(
fd
 =
NGX_INVALID_FILE
) {

575 
of
->
îr
 = 
ngx_î∫o
;

576 
of
->
Áûed
 = 
ngx_›í_fûe_n
;

577  
NGX_INVALID_FILE
;

580  
fd
;

583 
p
 = 
«me
->
d©a
;

584 
íd
 = 
p
 + 
«me
->
Àn
;

586 
©_«me
 = *
«me
;

588 i‡(
of
->
dißbÀ_symlöks_‰om
) {

590 
˝
 = 
p
 + 
of
->
dißbÀ_symlöks_‰om
;

592 *
˝
 = '\0';

594 
©_fd
 = 
	`ngx_›í_fûe
(
p
, 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
,

595 
NGX_FILE_OPEN
, 0);

597 *
˝
 = '/';

599 i‡(
©_fd
 =
NGX_INVALID_FILE
) {

600 
of
->
îr
 = 
ngx_î∫o
;

601 
of
->
Áûed
 = 
ngx_›í_fûe_n
;

602  
NGX_INVALID_FILE
;

605 
©_«me
.
Àn
 = 
of
->
dißbÀ_symlöks_‰om
;

606 
p
 = 
˝
 + 1;

608 } i‡(*
p
 == '/') {

610 
©_fd
 = 
	`ngx_›í_fûe
("/",

611 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
,

612 
NGX_FILE_OPEN
, 0);

614 i‡(
©_fd
 =
NGX_INVALID_FILE
) {

615 
of
->
îr
 = 
ngx_î∫o
;

616 
of
->
Áûed
 = 
ngx_›í©_fûe_n
;

617  
NGX_INVALID_FILE
;

620 
©_«me
.
Àn
 = 1;

621 
p
++;

624 
©_fd
 = 
NGX_AT_FDCWD
;

628 
˝
 = 
	`ngx_°æchr
(
p
, 
íd
, '/');

629 i‡(
˝
 =
NULL
) {

633 i‡(
˝
 =
p
) {

634 
p
++;

638 *
˝
 = '\0';

640 i‡(
of
->
dißbÀ_symlöks
 =
NGX_DISABLE_SYMLINKS_NOTOWNER
) {

641 
fd
 = 
	`ngx_›í©_fûe_ow√r
(
©_fd
, 
p
,

642 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
,

643 
NGX_FILE_OPEN
, 0, 
log
);

646 
fd
 = 
	`ngx_›í©_fûe
(
©_fd
, 
p
,

647 
NGX_FILE_SEARCH
|
NGX_FILE_NONBLOCK
|
NGX_FILE_NOFOLLOW
,

648 
NGX_FILE_OPEN
, 0);

651 *
˝
 = '/';

653 i‡(
fd
 =
NGX_INVALID_FILE
) {

654 
of
->
îr
 = 
ngx_î∫o
;

655 
of
->
Áûed
 = 
ngx_›í©_fûe_n
;

656 
Áûed
;

659 i‡(
©_fd
 !
NGX_AT_FDCWD
 && 
	`ngx_˛o£_fûe
◊t_fdË=
NGX_FILE_ERROR
) {

660 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

661 
ngx_˛o£_fûe_n
 " \"%V\" faûed", &
©_«me
);

664 
p
 = 
˝
 + 1;

665 
©_fd
 = 
fd
;

666 
©_«me
.
Àn
 = 
˝
 -át_«me.
d©a
;

669 i‡(
p
 =
íd
) {

682 
fd
 = 
	`ngx_›í©_fûe
(
©_fd
, ".", 
mode
, 
¸óã
, 
ac˚ss
);

683 
d⁄e
;

686 i‡(
of
->
dißbÀ_symlöks
 =
NGX_DISABLE_SYMLINKS_NOTOWNER


687 && !(
¸óã
 & (
NGX_FILE_CREATE_OR_OPEN
|
NGX_FILE_TRUNCATE
)))

689 
fd
 = 
	`ngx_›í©_fûe_ow√r
(
©_fd
, 
p
, 
mode
, 
¸óã
, 
ac˚ss
, 
log
);

692 
fd
 = 
	`ngx_›í©_fûe
(
©_fd
, 
p
, 
mode
|
NGX_FILE_NOFOLLOW
, 
¸óã
, 
ac˚ss
);

695 
d⁄e
:

697 i‡(
fd
 =
NGX_INVALID_FILE
) {

698 
of
->
îr
 = 
ngx_î∫o
;

699 
of
->
Áûed
 = 
ngx_›í©_fûe_n
;

702 
Áûed
:

704 i‡(
©_fd
 !
NGX_AT_FDCWD
 && 
	`ngx_˛o£_fûe
◊t_fdË=
NGX_FILE_ERROR
) {

705 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

706 
ngx_˛o£_fûe_n
 " \"%V\" faûed", &
©_«me
);

709  
fd
;

711 
	}
}

714 
ngx_öt_t


715 
	$ngx_fûe_öfo_wøµî
(
ngx_°r_t
 *
«me
, 
ngx_›í_fûe_öfo_t
 *
of
,

716 
ngx_fûe_öfo_t
 *
fi
, 
ngx_log_t
 *
log
)

718 
ngx_öt_t
 
rc
;

720 #i‡!(
NGX_HAVE_OPENAT
)

722 
rc
 = 
	`ngx_fûe_öfo
(
«me
->
d©a
, 
fi
);

724 i‡(
rc
 =
NGX_FILE_ERROR
) {

725 
of
->
îr
 = 
ngx_î∫o
;

726 
of
->
Áûed
 = 
ngx_fûe_öfo_n
;

727  
NGX_FILE_ERROR
;

730  
rc
;

734 
ngx_fd_t
 
fd
;

736 i‡(
of
->
dißbÀ_symlöks
 =
NGX_DISABLE_SYMLINKS_OFF
) {

738 
rc
 = 
	`ngx_fûe_öfo
(
«me
->
d©a
, 
fi
);

740 i‡(
rc
 =
NGX_FILE_ERROR
) {

741 
of
->
îr
 = 
ngx_î∫o
;

742 
of
->
Áûed
 = 
ngx_fûe_öfo_n
;

743  
NGX_FILE_ERROR
;

746  
rc
;

749 
fd
 = 
	`ngx_›í_fûe_wøµî
(
«me
, 
of
, 
NGX_FILE_RDONLY
|
NGX_FILE_NONBLOCK
,

750 
NGX_FILE_OPEN
, 0, 
log
);

752 i‡(
fd
 =
NGX_INVALID_FILE
) {

753  
NGX_FILE_ERROR
;

756 
rc
 = 
	`ngx_fd_öfo
(
fd
, 
fi
);

758 i‡(
rc
 =
NGX_FILE_ERROR
) {

759 
of
->
îr
 = 
ngx_î∫o
;

760 
of
->
Áûed
 = 
ngx_fd_öfo_n
;

763 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

764 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

765 
ngx_˛o£_fûe_n
 " \"%V\" faûed", 
«me
);

768  
rc
;

770 
	}
}

773 
ngx_öt_t


774 
	$ngx_›í_™d_°©_fûe
(
ngx_°r_t
 *
«me
, 
ngx_›í_fûe_öfo_t
 *
of
,

775 
ngx_log_t
 *
log
)

777 
ngx_fd_t
 
fd
;

778 
ngx_fûe_öfo_t
 
fi
;

780 i‡(
of
->
fd
 !
NGX_INVALID_FILE
) {

782 i‡(
	`ngx_fûe_öfo_wøµî
(
«me
, 
of
, &
fi
, 
log
Ë=
NGX_FILE_ERROR
) {

783 
of
->
fd
 = 
NGX_INVALID_FILE
;

784  
NGX_ERROR
;

787 i‡(
of
->
uniq
 =
	`ngx_fûe_uniq
(&
fi
)) {

788 
d⁄e
;

791 } i‡(
of
->
ã°_dú
) {

793 i‡(
	`ngx_fûe_öfo_wøµî
(
«me
, 
of
, &
fi
, 
log
Ë=
NGX_FILE_ERROR
) {

794 
of
->
fd
 = 
NGX_INVALID_FILE
;

795  
NGX_ERROR
;

798 i‡(
	`ngx_is_dú
(&
fi
)) {

799 
d⁄e
;

803 i‡(!
of
->
log
) {

810 
fd
 = 
	`ngx_›í_fûe_wøµî
(
«me
, 
of
, 
NGX_FILE_RDONLY
|
NGX_FILE_NONBLOCK
,

811 
NGX_FILE_OPEN
, 0, 
log
);

814 
fd
 = 
	`ngx_›í_fûe_wøµî
(
«me
, 
of
, 
NGX_FILE_APPEND
,

815 
NGX_FILE_CREATE_OR_OPEN
,

816 
NGX_FILE_DEFAULT_ACCESS
, 
log
);

819 i‡(
fd
 =
NGX_INVALID_FILE
) {

820 
of
->
fd
 = 
NGX_INVALID_FILE
;

821  
NGX_ERROR
;

824 i‡(
	`ngx_fd_öfo
(
fd
, &
fi
Ë=
NGX_FILE_ERROR
) {

825 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
log
, 
ngx_î∫o
,

826 
ngx_fd_öfo_n
 " \"%V\" faûed", 
«me
);

828 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

829 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

830 
ngx_˛o£_fûe_n
 " \"%V\" faûed", 
«me
);

833 
of
->
fd
 = 
NGX_INVALID_FILE
;

835  
NGX_ERROR
;

838 i‡(
	`ngx_is_dú
(&
fi
)) {

839 i‡(
	`ngx_˛o£_fûe
(
fd
Ë=
NGX_FILE_ERROR
) {

840 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

841 
ngx_˛o£_fûe_n
 " \"%V\" faûed", 
«me
);

844 
of
->
fd
 = 
NGX_INVALID_FILE
;

847 
of
->
fd
 = fd;

849 i‡(
of
->
ªad_ahód
 && 
	`ngx_fûe_size
(&
fi
Ë> 
NGX_MIN_READ_AHEAD
) {

850 i‡(
	`ngx_ªad_ahód
(
fd
, 
of
->
ªad_ahód
Ë=
NGX_ERROR
) {

851 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

852 
ngx_ªad_ahód_n
 " \"%V\" faûed", 
«me
);

856 i‡(
of
->
dúe˘io
 <
	`ngx_fûe_size
(&
fi
)) {

857 i‡(
	`ngx_dúe˘io_⁄
(
fd
Ë=
NGX_FILE_ERROR
) {

858 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

859 
ngx_dúe˘io_⁄_n
 " \"%V\" faûed", 
«me
);

862 
of
->
is_dúe˘io
 = 1;

867 
d⁄e
:

869 
of
->
uniq
 = 
	`ngx_fûe_uniq
(&
fi
);

870 
of
->
mtime
 = 
	`ngx_fûe_mtime
(&
fi
);

871 
of
->
size
 = 
	`ngx_fûe_size
(&
fi
);

872 
of
->
fs_size
 = 
	`ngx_fûe_fs_size
(&
fi
);

873 
of
->
is_dú
 = 
	`ngx_is_dú
(&
fi
);

874 
of
->
is_fûe
 = 
	`ngx_is_fûe
(&
fi
);

875 
of
->
is_lök
 = 
	`ngx_is_lök
(&
fi
);

876 
of
->
is_exec
 = 
	`ngx_is_exec
(&
fi
);

878  
NGX_OK
;

879 
	}
}

888 
	$ngx_›í_fûe_add_evít
(
ngx_›í_fûe_ˇche_t
 *
ˇche
,

889 
ngx_ˇched_›í_fûe_t
 *
fûe
, 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_log_t
 *
log
)

891 
ngx_›í_fûe_ˇche_evít_t
 *
„v
;

893 i‡(!(
ngx_evít_Êags
 & 
NGX_USE_VNODE_EVENT
)

894 || !
of
->
evíts


895 || 
fûe
->
evít


896 || 
of
->
fd
 =
NGX_INVALID_FILE


897 || 
fûe
->
u£s
 < 
of
->
mö_u£s
)

902 
fûe
->
u£_evít
 = 0;

904 
fûe
->
evít
 = 
	`ngx_ˇŒoc
((
ngx_evít_t
), 
log
);

905 i‡(
fûe
->
evít
=
NULL
) {

909 
„v
 = 
	`ngx_Æloc
((
ngx_›í_fûe_ˇche_evít_t
), 
log
);

910 i‡(
„v
 =
NULL
) {

911 
	`ngx_‰ì
(
fûe
->
evít
);

912 
fûe
->
evít
 = 
NULL
;

916 
„v
->
fd
 = 
of
->fd;

917 
„v
->
fûe
 = file;

918 
„v
->
ˇche
 = cache;

920 
fûe
->
evít
->
h™dÀr
 = 
ngx_›í_fûe_ˇche_ªmove
;

921 
fûe
->
evít
->
d©a
 = 
„v
;

929 
fûe
->
evít
->
log
 = 
ngx_cy˛e
->log;

931 i‡(
	`ngx_add_evít
(
fûe
->
evít
, 
NGX_VNODE_EVENT
, 
NGX_ONESHOT_EVENT
)

932 !
NGX_OK
)

934 
	`ngx_‰ì
(
fûe
->
evít
->
d©a
);

935 
	`ngx_‰ì
(
fûe
->
evít
);

936 
fûe
->
evít
 = 
NULL
;

948 
	}
}

952 
	$ngx_›í_fûe_˛ónup
(*
d©a
)

954 
ngx_›í_fûe_ˇche_˛ónup_t
 *
c
 = 
d©a
;

956 
c
->
fûe
->
cou¡
--;

958 
	`ngx_˛o£_ˇched_fûe
(
c
->
ˇche
, c->
fûe
, c->
mö_u£s
, c->
log
);

961 
	`ngx_expúe_ﬁd_ˇched_fûes
(
c
->
ˇche
, 1, c->
log
);

962 
	}
}

966 
	$ngx_˛o£_ˇched_fûe
(
ngx_›í_fûe_ˇche_t
 *
ˇche
,

967 
ngx_ˇched_›í_fûe_t
 *
fûe
, 
ngx_uöt_t
 
mö_u£s
, 
ngx_log_t
 *
log
)

969 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

971 
fûe
->
«me
, fûe->
fd
, fûe->
cou¡
, fûe->
u£s
, fûe->
˛o£
);

973 i‡(!
fûe
->
˛o£
) {

975 
fûe
->
ac˚s£d
 = 
	`ngx_time
();

977 
	`ngx_queue_ªmove
(&
fûe
->
queue
);

979 
	`ngx_queue_ö£π_hód
(&
ˇche
->
expúe_queue
, &
fûe
->
queue
);

981 i‡(
fûe
->
u£s
 >
mö_u£s
 || fûe->
cou¡
) {

986 
	`ngx_›í_fûe_dñ_evít
(
fûe
);

988 i‡(
fûe
->
cou¡
) {

992 i‡(
fûe
->
fd
 !
NGX_INVALID_FILE
) {

994 i‡(
	`ngx_˛o£_fûe
(
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

995 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 
ngx_î∫o
,

996 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
fûe
->
«me
);

999 
fûe
->
fd
 = 
NGX_INVALID_FILE
;

1002 i‡(!
fûe
->
˛o£
) {

1006 
	`ngx_‰ì
(
fûe
->
«me
);

1007 
	`ngx_‰ì
(
fûe
);

1008 
	}
}

1012 
	$ngx_›í_fûe_dñ_evít
(
ngx_ˇched_›í_fûe_t
 *
fûe
)

1014 i‡(
fûe
->
evít
 =
NULL
) {

1018 (Ë
	`ngx_dñ_evít
(
fûe
->
evít
, 
NGX_VNODE_EVENT
,

1019 
fûe
->
cou¡
 ? 
NGX_FLUSH_EVENT
 : 
NGX_CLOSE_EVENT
);

1021 
	`ngx_‰ì
(
fûe
->
evít
->
d©a
);

1022 
	`ngx_‰ì
(
fûe
->
evít
);

1023 
fûe
->
evít
 = 
NULL
;

1024 
fûe
->
u£_evít
 = 0;

1025 
	}
}

1029 
	$ngx_expúe_ﬁd_ˇched_fûes
(
ngx_›í_fûe_ˇche_t
 *
ˇche
, 
ngx_uöt_t
 
n
,

1030 
ngx_log_t
 *
log
)

1032 
time_t
 
now
;

1033 
ngx_queue_t
 *
q
;

1034 
ngx_ˇched_›í_fûe_t
 *
fûe
;

1036 
now
 = 
	`ngx_time
();

1044 
n
 < 3) {

1046 i‡(
	`ngx_queue_em±y
(&
ˇche
->
expúe_queue
)) {

1050 
q
 = 
	`ngx_queue_œ°
(&
ˇche
->
expúe_queue
);

1052 
fûe
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ˇched_›í_fûe_t
, 
queue
);

1054 i‡(
n
++ !0 && 
now
 - 
fûe
->
ac˚s£d
 <
ˇche
->
öa˘ive
) {

1058 
	`ngx_queue_ªmove
(
q
);

1060 
	`ngx_rbåì_dñëe
(&
ˇche
->
rbåì
, &
fûe
->
node
);

1062 
ˇche
->
cuºít
--;

1064 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
log
, 0,

1065 "expúêˇched o≥¿fûe: %s", 
fûe
->
«me
);

1067 i‡(!
fûe
->
îr
 && !fûe->
is_dú
) {

1068 
fûe
->
˛o£
 = 1;

1069 
	`ngx_˛o£_ˇched_fûe
(
ˇche
, 
fûe
, 0, 
log
);

1072 
	`ngx_‰ì
(
fûe
->
«me
);

1073 
	`ngx_‰ì
(
fûe
);

1076 
	}
}

1080 
	$ngx_›í_fûe_ˇche_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,

1081 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
)

1083 
ngx_rbåì_node_t
 **
p
;

1084 
ngx_ˇched_›í_fûe_t
 *
fûe
, *
fûe_ãmp
;

1088 i‡(
node
->
key
 < 
ãmp
->key) {

1090 
p
 = &
ãmp
->
À·
;

1092 } i‡(
node
->
key
 > 
ãmp
->key) {

1094 
p
 = &
ãmp
->
right
;

1098 
fûe
 = (
ngx_ˇched_›í_fûe_t
 *Ë
node
;

1099 
fûe_ãmp
 = (
ngx_ˇched_›í_fûe_t
 *Ë
ãmp
;

1101 
p
 = (
	`ngx_°rcmp
(
fûe
->
«me
, 
fûe_ãmp
->name) < 0)

1102 ? &
ãmp
->
À·
 : &ãmp->
right
;

1105 i‡(*
p
 =
£¡öñ
) {

1109 
ãmp
 = *
p
;

1112 *
p
 = 
node
;

1113 
node
->
∑ª¡
 = 
ãmp
;

1114 
node
->
À·
 = 
£¡öñ
;

1115 
node
->
right
 = 
£¡öñ
;

1116 
	`ngx_rbt_ªd
(
node
);

1117 
	}
}

1120 
ngx_ˇched_›í_fûe_t
 *

1121 
	$ngx_›í_fûe_lookup
(
ngx_›í_fûe_ˇche_t
 *
ˇche
, 
ngx_°r_t
 *
«me
,

1122 
uöt32_t
 
hash
)

1124 
ngx_öt_t
 
rc
;

1125 
ngx_rbåì_node_t
 *
node
, *
£¡öñ
;

1126 
ngx_ˇched_›í_fûe_t
 *
fûe
;

1128 
node
 = 
ˇche
->
rbåì
.
roŸ
;

1129 
£¡öñ
 = 
ˇche
->
rbåì
.sentinel;

1131 
node
 !
£¡öñ
) {

1133 i‡(
hash
 < 
node
->
key
) {

1134 
node
 =Çode->
À·
;

1138 i‡(
hash
 > 
node
->
key
) {

1139 
node
 =Çode->
right
;

1145 
fûe
 = (
ngx_ˇched_›í_fûe_t
 *Ë
node
;

1147 
rc
 = 
	`ngx_°rcmp
(
«me
->
d©a
, 
fûe
->name);

1149 i‡(
rc
 == 0) {

1150  
fûe
;

1153 
node
 = (
rc
 < 0Ë?Çode->
À·
 :Çode->
right
;

1156  
NULL
;

1157 
	}
}

1161 
	$ngx_›í_fûe_ˇche_ªmove
(
ngx_evít_t
 *
ev
)

1163 
ngx_ˇched_›í_fûe_t
 *
fûe
;

1164 
ngx_›í_fûe_ˇche_evít_t
 *
„v
;

1166 
„v
 = 
ev
->
d©a
;

1167 
fûe
 = 
„v
->file;

1169 
	`ngx_queue_ªmove
(&
fûe
->
queue
);

1171 
	`ngx_rbåì_dñëe
(&
„v
->
ˇche
->
rbåì
, &
fûe
->
node
);

1173 
„v
->
ˇche
->
cuºít
--;

1176 
fûe
->
evít
 = 
NULL
;

1177 
fûe
->
u£_evít
 = 0;

1179 
fûe
->
˛o£
 = 1;

1181 
	`ngx_˛o£_ˇched_fûe
(
„v
->
ˇche
, 
fûe
, 0, 
ev
->
log
);

1185 
	`ngx_‰ì
(
ev
->
d©a
);

1186 
	`ngx_‰ì
(
ev
);

1187 
	}
}

	@ngx_open_file_cache.h

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 #i‚de‡
_NGX_OPEN_FILE_CACHE_H_INCLUDED_


13 
	#_NGX_OPEN_FILE_CACHE_H_INCLUDED_


	)

16 
	#NGX_OPEN_FILE_DIRECTIO_OFF
 
NGX_MAX_OFF_T_VALUE


	)

20 
ngx_fd_t
 
	mfd
;

21 
ngx_fûe_uniq_t
 
	muniq
;

22 
time_t
 
	mmtime
;

23 
off_t
 
	msize
;

24 
off_t
 
	mfs_size
;

25 
off_t
 
	mdúe˘io
;

26 
size_t
 
	mªad_ahód
;

28 
ngx_îr_t
 
	mîr
;

29 *
	mÁûed
;

31 
time_t
 
	mvÆid
;

33 
ngx_uöt_t
 
	mmö_u£s
;

35 #i‡(
NGX_HAVE_OPENAT
)

36 
size_t
 
	mdißbÀ_symlöks_‰om
;

37 
	mdißbÀ_symlöks
:2;

40 
	mã°_dú
:1;

41 
	mã°_⁄ly
:1;

42 
	mlog
:1;

43 
	mîr‹s
:1;

44 
	mevíts
:1;

46 
	mis_dú
:1;

47 
	mis_fûe
:1;

48 
	mis_lök
:1;

49 
	mis_exec
:1;

50 
	mis_dúe˘io
:1;

51 } 
	tngx_›í_fûe_öfo_t
;

54 
ngx_ˇched_›í_fûe_s
 
	tngx_ˇched_›í_fûe_t
;

56 
	sngx_ˇched_›í_fûe_s
 {

57 
ngx_rbåì_node_t
 
	mnode
;

58 
ngx_queue_t
 
	mqueue
;

60 
u_ch¨
 *
	m«me
;

61 
time_t
 
	m¸óãd
;

62 
time_t
 
	mac˚s£d
;

64 
ngx_fd_t
 
	mfd
;

65 
ngx_fûe_uniq_t
 
	muniq
;

66 
time_t
 
	mmtime
;

67 
off_t
 
	msize
;

68 
ngx_îr_t
 
	mîr
;

70 
uöt32_t
 
	mu£s
;

72 #i‡(
NGX_HAVE_OPENAT
)

73 
size_t
 
	mdißbÀ_symlöks_‰om
;

74 
	mdißbÀ_symlöks
:2;

77 
	mcou¡
:24;

78 
	m˛o£
:1;

79 
	mu£_evít
:1;

81 
	mis_dú
:1;

82 
	mis_fûe
:1;

83 
	mis_lök
:1;

84 
	mis_exec
:1;

85 
	mis_dúe˘io
:1;

87 
ngx_evít_t
 *
	mevít
;

92 
ngx_rbåì_t
 
	mrbåì
;

93 
ngx_rbåì_node_t
 
	m£¡öñ
;

94 
ngx_queue_t
 
	mexpúe_queue
;

96 
ngx_uöt_t
 
	mcuºít
;

97 
ngx_uöt_t
 
	mmax
;

98 
time_t
 
	möa˘ive
;

99 } 
	tngx_›í_fûe_ˇche_t
;

103 
ngx_›í_fûe_ˇche_t
 *
	mˇche
;

104 
ngx_ˇched_›í_fûe_t
 *
	mfûe
;

105 
ngx_uöt_t
 
	mmö_u£s
;

106 
ngx_log_t
 *
	mlog
;

107 } 
	tngx_›í_fûe_ˇche_˛ónup_t
;

113 *
	md©a
;

114 
ngx_evít_t
 *
	mªad
;

115 
ngx_evít_t
 *
	mwrôe
;

116 
ngx_fd_t
 
	mfd
;

118 
ngx_ˇched_›í_fûe_t
 *
	mfûe
;

119 
ngx_›í_fûe_ˇche_t
 *
	mˇche
;

120 } 
	tngx_›í_fûe_ˇche_evít_t
;

123 
ngx_›í_fûe_ˇche_t
 *
ngx_›í_fûe_ˇche_öô
(
ngx_poﬁ_t
 *
poﬁ
,

124 
ngx_uöt_t
 
max
, 
time_t
 
öa˘ive
);

125 
ngx_öt_t
 
ngx_›í_ˇched_fûe
(
ngx_›í_fûe_ˇche_t
 *
ˇche
, 
ngx_°r_t
 *
«me
,

126 
ngx_›í_fûe_öfo_t
 *
of
, 
ngx_poﬁ_t
 *
poﬁ
);

	@ngx_output_chain.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

10 
	~<ngx_evít.h
>

14 
	#NGX_SENDFILE_LIMIT
 4096

	)

27 
	#NGX_NONE
 1

	)

30 
ngx_ölöe
 
ngx_öt_t


31 
ngx_ouçut_chaö_as_is
(
ngx_ouçut_chaö_˘x_t
 *
˘x
, 
ngx_buf_t
 *
buf
);

32 
ngx_öt_t
 
ngx_ouçut_chaö_add_c›y
(
ngx_poﬁ_t
 *
poﬁ
,

33 
ngx_chaö_t
 **
chaö
,Çgx_chaö_à*
ö
);

34 
ngx_öt_t
 
ngx_ouçut_chaö_Æign_fûe_buf
(
ngx_ouçut_chaö_˘x_t
 *
˘x
,

35 
off_t
 
bsize
);

36 
ngx_öt_t
 
ngx_ouçut_chaö_gë_buf
(
ngx_ouçut_chaö_˘x_t
 *
˘x
,

37 
off_t
 
bsize
);

38 
ngx_öt_t
 
ngx_ouçut_chaö_c›y_buf
(
ngx_ouçut_chaö_˘x_t
 *
˘x
);

41 
ngx_öt_t


42 
	$ngx_ouçut_chaö
(
ngx_ouçut_chaö_˘x_t
 *
˘x
, 
ngx_chaö_t
 *
ö
)

44 
off_t
 
bsize
;

45 
ngx_öt_t
 
rc
, 
œ°
;

46 
ngx_chaö_t
 *
˛
, *
out
, **
œ°_out
;

48 i‡(
˘x
->
ö
 =
NULL
 && ctx->
busy
 == NULL) {

56 i‡(
ö
 =
NULL
) {

57  
˘x
->
	`ouçut_fûãr
(˘x->
fûãr_˘x
, 
ö
);

60 i‡(
ö
->
√xt
 =
NULL


61 #i‡(
NGX_SENDFILE_LIMIT
)

62 && !(
ö
->
buf
->
ö_fûe
 && in->buf->
fûe_œ°
 > 
NGX_SENDFILE_LIMIT
)

64 && 
	`ngx_ouçut_chaö_as_is
(
˘x
, 
ö
->
buf
))

66  
˘x
->
	`ouçut_fûãr
(˘x->
fûãr_˘x
, 
ö
);

72 i‡(
ö
) {

73 i‡(
	`ngx_ouçut_chaö_add_c›y
(
˘x
->
poﬁ
, &˘x->
ö
, inË=
NGX_ERROR
) {

74  
NGX_ERROR
;

78 
out
 = 
NULL
;

79 
œ°_out
 = &
out
;

80 
œ°
 = 
NGX_NONE
;

84 #i‡(
NGX_HAVE_FILE_AIO
)

85 i‡(
˘x
->
aio
) {

86  
NGX_AGAIN
;

90 
˘x
->
ö
) {

97 
bsize
 = 
	`ngx_buf_size
(
˘x
->
ö
->
buf
);

99 i‡(
bsize
 =0 && !
	`ngx_buf_•ecül
(
˘x
->
ö
->
buf
)) {

101 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
˘x
->
poﬁ
->
log
, 0,

104 
˘x
->
ö
->
buf
->
ãmp‹¨y
,

105 
˘x
->
ö
->
buf
->
ªcy˛ed
,

106 
˘x
->
ö
->
buf
->
ö_fûe
,

107 
˘x
->
ö
->
buf
->
°¨t
,

108 
˘x
->
ö
->
buf
->
pos
,

109 
˘x
->
ö
->
buf
->
œ°
,

110 
˘x
->
ö
->
buf
->
fûe
,

111 
˘x
->
ö
->
buf
->
fûe_pos
,

112 
˘x
->
ö
->
buf
->
fûe_œ°
);

114 
	`ngx_debug_poöt
();

116 
˘x
->
ö
 = ctx->ö->
√xt
;

121 i‡(
	`ngx_ouçut_chaö_as_is
(
˘x
, ctx->
ö
->
buf
)) {

125 
˛
 = 
˘x
->
ö
;

126 
˘x
->
ö
 = 
˛
->
√xt
;

128 *
œ°_out
 = 
˛
;

129 
œ°_out
 = &
˛
->
√xt
;

130 
˛
->
√xt
 = 
NULL
;

135 i‡(
˘x
->
buf
 =
NULL
) {

137 
rc
 = 
	`ngx_ouçut_chaö_Æign_fûe_buf
(
˘x
, 
bsize
);

139 i‡(
rc
 =
NGX_ERROR
) {

140  
NGX_ERROR
;

143 i‡(
rc
 !
NGX_OK
) {

145 i‡(
˘x
->
‰ì
) {

149 
˛
 = 
˘x
->
‰ì
;

150 
˘x
->
buf
 = 
˛
->buf;

151 
˘x
->
‰ì
 = 
˛
->
√xt
;

153 
	`ngx_‰ì_chaö
(
˘x
->
poﬁ
, 
˛
);

155 } i‡(
out
 || 
˘x
->
Æloˇãd
 =˘x->
bufs
.
num
) {

159 } i‡(
	`ngx_ouçut_chaö_gë_buf
(
˘x
, 
bsize
Ë!
NGX_OK
) {

160  
NGX_ERROR
;

165 
rc
 = 
	`ngx_ouçut_chaö_c›y_buf
(
˘x
);

167 i‡(
rc
 =
NGX_ERROR
) {

168  
rc
;

171 i‡(
rc
 =
NGX_AGAIN
) {

172 i‡(
out
) {

176  
rc
;

181 i‡(
	`ngx_buf_size
(
˘x
->
ö
->
buf
) == 0) {

182 
˘x
->
ö
 = ctx->ö->
√xt
;

185 
˛
 = 
	`ngx_Æloc_chaö_lök
(
˘x
->
poﬁ
);

186 i‡(
˛
 =
NULL
) {

187  
NGX_ERROR
;

190 
˛
->
buf
 = 
˘x
->buf;

191 
˛
->
√xt
 = 
NULL
;

192 *
œ°_out
 = 
˛
;

193 
œ°_out
 = &
˛
->
√xt
;

194 
˘x
->
buf
 = 
NULL
;

197 i‡(
out
 =
NULL
 && 
œ°
 !
NGX_NONE
) {

199 i‡(
˘x
->
ö
) {

200  
NGX_AGAIN
;

203  
œ°
;

206 
œ°
 = 
˘x
->
	`ouçut_fûãr
(˘x->
fûãr_˘x
, 
out
);

208 i‡(
œ°
 =
NGX_ERROR
 ||Üa° =
NGX_DONE
) {

209  
œ°
;

212 
	`ngx_chaö_upd©e_chaös
(
˘x
->
poﬁ
, &˘x->
‰ì
, &˘x->
busy
, &
out
,

213 
˘x
->
èg
);

214 
œ°_out
 = &
out
;

216 
	}
}

219 
ngx_ölöe
 
ngx_öt_t


220 
	$ngx_ouçut_chaö_as_is
(
ngx_ouçut_chaö_˘x_t
 *
˘x
, 
ngx_buf_t
 *
buf
)

222 
ngx_uöt_t
 
£ndfûe
;

224 i‡(
	`ngx_buf_•ecül
(
buf
)) {

228 i‡(
buf
->
ö_fûe
 && buf->
fûe
->
dúe˘io
) {

232 
£ndfûe
 = 
˘x
->sendfile;

234 #i‡(
NGX_SENDFILE_LIMIT
)

236 i‡(
buf
->
ö_fûe
 && buf->
fûe_pos
 >
NGX_SENDFILE_LIMIT
) {

237 
£ndfûe
 = 0;

242 i‡(!
£ndfûe
) {

244 i‡(!
	`ngx_buf_ö_mem‹y
(
buf
)) {

248 
buf
->
ö_fûe
 = 0;

251 i‡(
˘x
->
√ed_ö_mem‹y
 && !
	`ngx_buf_ö_mem‹y
(
buf
)) {

255 i‡(
˘x
->
√ed_ö_ãmp
 && (
buf
->
mem‹y
 || buf->
mm≠
)) {

260 
	}
}

263 
ngx_öt_t


264 
	$ngx_ouçut_chaö_add_c›y
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_chaö_t
 **
chaö
,

265 
ngx_chaö_t
 *
ö
)

267 
ngx_chaö_t
 *
˛
, **
Œ
;

268 #i‡(
NGX_SENDFILE_LIMIT
)

269 
ngx_buf_t
 *
b
, *
buf
;

272 
Œ
 = 
chaö
;

274 
˛
 = *
chaö
; cl; c»˛->
√xt
) {

275 
Œ
 = &
˛
->
√xt
;

278 
ö
) {

280 
˛
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

281 i‡(
˛
 =
NULL
) {

282  
NGX_ERROR
;

285 #i‡(
NGX_SENDFILE_LIMIT
)

287 
buf
 = 
ö
->buf;

289 i‡(
buf
->
ö_fûe


290 && 
buf
->
fûe_pos
 < 
NGX_SENDFILE_LIMIT


291 && 
buf
->
fûe_œ°
 > 
NGX_SENDFILE_LIMIT
)

295 
b
 = 
	`ngx_ˇŒoc_buf
(
poﬁ
);

296 i‡(
b
 =
NULL
) {

297  
NGX_ERROR
;

300 
	`ngx_mem˝y
(
b
, 
buf
, (
ngx_buf_t
));

302 i‡(
	`ngx_buf_ö_mem‹y
(
buf
)) {

303 
buf
->
pos
 +(
ssize_t
Ë(
NGX_SENDFILE_LIMIT
 - buf->
fûe_pos
);

304 
b
->
œ°
 = 
buf
->
pos
;

307 
buf
->
fûe_pos
 = 
NGX_SENDFILE_LIMIT
;

308 
b
->
fûe_œ°
 = 
NGX_SENDFILE_LIMIT
;

310 
˛
->
buf
 = 
b
;

313 
˛
->
buf
 = buf;

314 
ö
 = in->
√xt
;

318 
˛
->
buf
 = 
ö
->buf;

319 
ö
 = in->
√xt
;

323 
˛
->
√xt
 = 
NULL
;

324 *
Œ
 = 
˛
;

325 
Œ
 = &
˛
->
√xt
;

328  
NGX_OK
;

329 
	}
}

332 
ngx_öt_t


333 
	$ngx_ouçut_chaö_Æign_fûe_buf
(
ngx_ouçut_chaö_˘x_t
 *
˘x
, 
off_t
 
bsize
)

335 
size_t
 
size
;

336 
ngx_buf_t
 *
ö
;

338 
ö
 = 
˘x
->ö->
buf
;

340 i‡(
ö
->
fûe
 =
NULL
 || !ö->fûe->
dúe˘io
) {

341  
NGX_DECLINED
;

344 
˘x
->
dúe˘io
 = 1;

346 
size
 = (
size_t
Ë(
ö
->
fûe_pos
 - (ö->fûe_po†& ~(
˘x
->
Æignmít
 - 1)));

348 i‡(
size
 == 0) {

350 i‡(
bsize
 >(
off_t
Ë
˘x
->
bufs
.
size
) {

351  
NGX_DECLINED
;

354 
size
 = (
size_t
Ë
bsize
;

357 
size
 = (
size_t
Ë
˘x
->
Æignmít
 - size;

359 i‡((
off_t
Ë
size
 > 
bsize
) {

360 
size
 = (
size_t
Ë
bsize
;

364 
˘x
->
buf
 = 
	`ngx_¸óã_ãmp_buf
(˘x->
poﬁ
, 
size
);

365 i‡(
˘x
->
buf
 =
NULL
) {

366  
NGX_ERROR
;

374 #i‡(
NGX_HAVE_ALIGNED_DIRECTIO
)

375 
˘x
->
u«lig√d
 = 1;

378  
NGX_OK
;

379 
	}
}

382 
ngx_öt_t


383 
	$ngx_ouçut_chaö_gë_buf
(
ngx_ouçut_chaö_˘x_t
 *
˘x
, 
off_t
 
bsize
)

385 
size_t
 
size
;

386 
ngx_buf_t
 *
b
, *
ö
;

387 
ngx_uöt_t
 
ªcy˛ed
;

389 
ö
 = 
˘x
->ö->
buf
;

390 
size
 = 
˘x
->
bufs
.size;

391 
ªcy˛ed
 = 1;

393 i‡(
ö
->
œ°_ö_chaö
) {

395 i‡(
bsize
 < (
off_t
Ë
size
) {

402 
size
 = (
size_t
Ë
bsize
;

403 
ªcy˛ed
 = 0;

405 } i‡(!
˘x
->
dúe˘io


406 && 
˘x
->
bufs
.
num
 == 1

407 && (
bsize
 < (
off_t
Ë(
size
 + size / 4)))

415 
size
 = (
size_t
Ë
bsize
;

416 
ªcy˛ed
 = 0;

420 
b
 = 
	`ngx_ˇŒoc_buf
(
˘x
->
poﬁ
);

421 i‡(
b
 =
NULL
) {

422  
NGX_ERROR
;

425 i‡(
˘x
->
dúe˘io
) {

432 
b
->
°¨t
 = 
	`ngx_pmemÆign
(
˘x
->
poﬁ
, 
size
, (
size_t
Ë˘x->
Æignmít
);

433 i‡(
b
->
°¨t
 =
NULL
) {

434  
NGX_ERROR
;

438 
b
->
°¨t
 = 
	`ngx_∑Œoc
(
˘x
->
poﬁ
, 
size
);

439 i‡(
b
->
°¨t
 =
NULL
) {

440  
NGX_ERROR
;

444 
b
->
pos
 = b->
°¨t
;

445 
b
->
œ°
 = b->
°¨t
;

446 
b
->
íd
 = b->
œ°
 + 
size
;

447 
b
->
ãmp‹¨y
 = 1;

448 
b
->
èg
 = 
˘x
->tag;

449 
b
->
ªcy˛ed
 =Ñecycled;

451 
˘x
->
buf
 = 
b
;

452 
˘x
->
Æloˇãd
++;

454  
NGX_OK
;

455 
	}
}

458 
ngx_öt_t


459 
	$ngx_ouçut_chaö_c›y_buf
(
ngx_ouçut_chaö_˘x_t
 *
˘x
)

461 
off_t
 
size
;

462 
ssize_t
 
n
;

463 
ngx_buf_t
 *
§c
, *
d°
;

464 
ngx_uöt_t
 
£ndfûe
;

466 
§c
 = 
˘x
->
ö
->
buf
;

467 
d°
 = 
˘x
->
buf
;

469 
size
 = 
	`ngx_buf_size
(
§c
);

470 
size
 = 
	`ngx_mö
(size, 
d°
->
íd
 - d°->
pos
);

472 
£ndfûe
 = 
˘x
->£ndfûê& !˘x->
dúe˘io
;

474 #i‡(
NGX_SENDFILE_LIMIT
)

476 i‡(
§c
->
ö_fûe
 && src->
fûe_pos
 >
NGX_SENDFILE_LIMIT
) {

477 
£ndfûe
 = 0;

482 i‡(
	`ngx_buf_ö_mem‹y
(
§c
)) {

483 
	`ngx_mem˝y
(
d°
->
pos
, 
§c
->pos, (
size_t
Ë
size
);

484 
§c
->
pos
 +(
size_t
Ë
size
;

485 
d°
->
œ°
 +(
size_t
Ë
size
;

487 i‡(
§c
->
ö_fûe
) {

489 i‡(
£ndfûe
) {

490 
d°
->
ö_fûe
 = 1;

491 
d°
->
fûe
 = 
§c
->file;

492 
d°
->
fûe_pos
 = 
§c
->file_pos;

493 
d°
->
fûe_œ°
 = 
§c
->
fûe_pos
 + 
size
;

496 
d°
->
ö_fûe
 = 0;

499 
§c
->
fûe_pos
 +
size
;

502 
d°
->
ö_fûe
 = 0;

505 i‡(
§c
->
pos
 =§c->
œ°
) {

506 
d°
->
Êush
 = 
§c
->flush;

507 
d°
->
œ°_buf
 = 
§c
->last_buf;

508 
d°
->
œ°_ö_chaö
 = 
§c
->last_in_chain;

513 #i‡(
NGX_HAVE_ALIGNED_DIRECTIO
)

515 i‡(
˘x
->
u«lig√d
) {

516 i‡(
	`ngx_dúe˘io_off
(
§c
->
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

517 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
˘x
->
poﬁ
->
log
, 
ngx_î∫o
,

518 
ngx_dúe˘io_off_n
 " \"%s\" failed",

519 
§c
->
fûe
->
«me
.
d©a
);

525 #i‡(
NGX_HAVE_FILE_AIO
)

527 i‡(
˘x
->
aio_h™dÀr
) {

528 
n
 = 
	`ngx_fûe_aio_ªad
(
§c
->
fûe
, 
d°
->
pos
, (
size_t
Ë
size
,

529 
§c
->
fûe_pos
, 
˘x
->
poﬁ
);

530 i‡(
n
 =
NGX_AGAIN
) {

531 
˘x
->
	`aio_h™dÀr
(˘x, 
§c
->
fûe
);

532  
NGX_AGAIN
;

536 
n
 = 
	`ngx_ªad_fûe
(
§c
->
fûe
, 
d°
->
pos
, (
size_t
Ë
size
,

537 
§c
->
fûe_pos
);

541 
n
 = 
	`ngx_ªad_fûe
(
§c
->
fûe
, 
d°
->
pos
, (
size_t
Ë
size
, src->
fûe_pos
);

545 #i‡(
NGX_HAVE_ALIGNED_DIRECTIO
)

547 i‡(
˘x
->
u«lig√d
) {

548 
ngx_îr_t
 
îr
;

550 
îr
 = 
ngx_î∫o
;

552 i‡(
	`ngx_dúe˘io_⁄
(
§c
->
fûe
->
fd
Ë=
NGX_FILE_ERROR
) {

553 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
˘x
->
poﬁ
->
log
, 
ngx_î∫o
,

554 
ngx_dúe˘io_⁄_n
 " \"%s\" failed",

555 
§c
->
fûe
->
«me
.
d©a
);

558 
	`ngx_£t_î∫o
(
îr
);

560 
˘x
->
u«lig√d
 = 0;

565 i‡(
n
 =
NGX_ERROR
) {

566  (
ngx_öt_t
Ë
n
;

569 i‡(
n
 !
size
) {

570 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
˘x
->
poﬁ
->
log
, 0,

571 
ngx_ªad_fûe_n
 "Ñead only %z of %O from \"%s\"",

572 
n
, 
size
, 
§c
->
fûe
->
«me
.
d©a
);

573  
NGX_ERROR
;

576 
d°
->
œ°
 +
n
;

578 i‡(
£ndfûe
) {

579 
d°
->
ö_fûe
 = 1;

580 
d°
->
fûe
 = 
§c
->file;

581 
d°
->
fûe_pos
 = 
§c
->file_pos;

582 
d°
->
fûe_œ°
 = 
§c
->
fûe_pos
 + 
n
;

585 
d°
->
ö_fûe
 = 0;

588 
§c
->
fûe_pos
 +
n
;

590 i‡(
§c
->
fûe_pos
 =§c->
fûe_œ°
) {

591 
d°
->
Êush
 = 
§c
->flush;

592 
d°
->
œ°_buf
 = 
§c
->last_buf;

593 
d°
->
œ°_ö_chaö
 = 
§c
->last_in_chain;

597  
NGX_OK
;

598 
	}
}

601 
ngx_öt_t


602 
	$ngx_chaö_wrôî
(*
d©a
, 
ngx_chaö_t
 *
ö
)

604 
ngx_chaö_wrôî_˘x_t
 *
˘x
 = 
d©a
;

606 
off_t
 
size
;

607 
ngx_chaö_t
 *
˛
;

608 
ngx_c⁄√˘i⁄_t
 *
c
;

610 
c
 = 
˘x
->
c⁄√˘i⁄
;

612 
size
 = 0; 
ö
; i¿ö->
√xt
) {

615 i‡(
	`ngx_buf_size
(
ö
->
buf
Ë=0 && !
	`ngx_buf_•ecül
(in->buf)) {

616 
	`ngx_debug_poöt
();

620 
size
 +
	`ngx_buf_size
(
ö
->
buf
);

622 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

624 
ö
->
buf
->
Êush
, 
	`ngx_buf_size
(in->buf));

626 
˛
 = 
	`ngx_Æloc_chaö_lök
(
˘x
->
poﬁ
);

627 i‡(
˛
 =
NULL
) {

628  
NGX_ERROR
;

631 
˛
->
buf
 = 
ö
->buf;

632 
˛
->
√xt
 = 
NULL
;

633 *
˘x
->
œ°
 = 
˛
;

634 
˘x
->
œ°
 = &
˛
->
√xt
;

637 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

638 "chaö wrôî in: %p", 
˘x
->
out
);

640 
˛
 = 
˘x
->
out
; cl; c»˛->
√xt
) {

643 i‡(
	`ngx_buf_size
(
˛
->
buf
Ë=0 && !
	`ngx_buf_•ecül
(cl->buf)) {

644 
	`ngx_debug_poöt
();

649 
size
 +
	`ngx_buf_size
(
˛
->
buf
);

652 i‡(
size
 =0 && !
c
->
buf„ªd
) {

653  
NGX_OK
;

656 
˘x
->
out
 = 
c
->
	`£nd_chaö
(c, ctx->out, ctx->
limô
);

658 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
c
->
log
, 0,

659 "chaö wrôî out: %p", 
˘x
->
out
);

661 i‡(
˘x
->
out
 =
NGX_CHAIN_ERROR
) {

662  
NGX_ERROR
;

665 i‡(
˘x
->
out
 =
NULL
) {

666 
˘x
->
œ°
 = &˘x->
out
;

668 i‡(!
c
->
buf„ªd
) {

669  
NGX_OK
;

673  
NGX_AGAIN
;

674 
	}
}

	@ngx_palloc.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 *
ngx_∑Œoc_block
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

13 *
ngx_∑Œoc_œrge
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

16 
ngx_poﬁ_t
 *

17 
	$ngx_¸óã_poﬁ
(
size_t
 
size
, 
ngx_log_t
 *
log
)

19 
ngx_poﬁ_t
 *
p
;

21 
p
 = 
	`ngx_memÆign
(
NGX_POOL_ALIGNMENT
, 
size
, 
log
);

22 i‡(
p
 =
NULL
) {

23  
NULL
;

26 
p
->
d
.
œ°
 = (
u_ch¨
 *Ë∞+ (
ngx_poﬁ_t
);

27 
p
->
d
.
íd
 = (
u_ch¨
 *Ë∞+ 
size
;

28 
p
->
d
.
√xt
 = 
NULL
;

29 
p
->
d
.
Áûed
 = 0;

31 
size
 = sizê- (
ngx_poﬁ_t
);

32 
p
->
max
 = (
size
 < 
NGX_MAX_ALLOC_FROM_POOL
) ? size : NGX_MAX_ALLOC_FROM_POOL;

34 
p
->
cuºít
 =Ö;

35 
p
->
chaö
 = 
NULL
;

36 
p
->
œrge
 = 
NULL
;

37 
p
->
˛ónup
 = 
NULL
;

38 
p
->
log
 =Üog;

40  
p
;

41 
	}
}

45 
	$ngx_de°roy_poﬁ
(
ngx_poﬁ_t
 *
poﬁ
)

47 
ngx_poﬁ_t
 *
p
, *
n
;

48 
ngx_poﬁ_œrge_t
 *
l
;

49 
ngx_poﬁ_˛ónup_t
 *
c
;

51 
c
 = 
poﬁ
->
˛ónup
; c; c = c->
√xt
) {

52 i‡(
c
->
h™dÀr
) {

53 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
poﬁ
->
log
, 0,

54 "ru¿˛ónup: %p", 
c
);

55 
c
->
	`h™dÀr
(c->
d©a
);

59 
l
 = 
poﬁ
->
œrge
;Ü;Ü =Ü->
√xt
) {

61 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
poﬁ
->
log
, 0, "‰ì: %p", 
l
->
Æloc
);

63 i‡(
l
->
Æloc
) {

64 
	`ngx_‰ì
(
l
->
Æloc
);

68 #i‡(
NGX_DEBUG
)

75 
p
 = 
poﬁ
, 
n
 =Öoﬁ->
d
.
√xt
; ;Ö =Ç,Ç =Ç->d.next) {

76 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
poﬁ
->
log
, 0,

77 "‰ì: %p, unu£d: %uz", 
p
,Ö->
d
.
íd
 -Ö->d.
œ°
);

79 i‡(
n
 =
NULL
) {

86 
p
 = 
poﬁ
, 
n
 =Öoﬁ->
d
.
√xt
; ;Ö =Ç,Ç =Ç->d.next) {

87 
	`ngx_‰ì
(
p
);

89 i‡(
n
 =
NULL
) {

93 
	}
}

97 
	$ngx_ª£t_poﬁ
(
ngx_poﬁ_t
 *
poﬁ
)

99 
ngx_poﬁ_t
 *
p
;

100 
ngx_poﬁ_œrge_t
 *
l
;

102 
l
 = 
poﬁ
->
œrge
;Ü;Ü =Ü->
√xt
) {

103 i‡(
l
->
Æloc
) {

104 
	`ngx_‰ì
(
l
->
Æloc
);

108 
poﬁ
->
œrge
 = 
NULL
;

110 
p
 = 
poﬁ
;Ö;Ö =Ö->
d
.
√xt
) {

111 
p
->
d
.
œ°
 = (
u_ch¨
 *Ë∞+ (
ngx_poﬁ_t
);

113 
	}
}

117 
	$ngx_∑Œoc
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

119 
u_ch¨
 *
m
;

120 
ngx_poﬁ_t
 *
p
;

122 i‡(
size
 <
poﬁ
->
max
) {

124 
p
 = 
poﬁ
->
cuºít
;

127 
m
 = 
	`ngx_Æign_±r
(
p
->
d
.
œ°
, 
NGX_ALIGNMENT
);

129 i‡((
size_t
Ë(
p
->
d
.
íd
 - 
m
Ë>
size
) {

130 
p
->
d
.
œ°
 = 
m
 + 
size
;

132  
m
;

135 
p
 =Ö->
d
.
√xt
;

137 } 
p
);

139  
	`ngx_∑Œoc_block
(
poﬁ
, 
size
);

142  
	`ngx_∑Œoc_œrge
(
poﬁ
, 
size
);

143 
	}
}

147 
	$ngx_≤Æloc
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

149 
u_ch¨
 *
m
;

150 
ngx_poﬁ_t
 *
p
;

152 i‡(
size
 <
poﬁ
->
max
) {

154 
p
 = 
poﬁ
->
cuºít
;

157 
m
 = 
p
->
d
.
œ°
;

159 i‡((
size_t
Ë(
p
->
d
.
íd
 - 
m
Ë>
size
) {

160 
p
->
d
.
œ°
 = 
m
 + 
size
;

162  
m
;

165 
p
 =Ö->
d
.
√xt
;

167 } 
p
);

169  
	`ngx_∑Œoc_block
(
poﬁ
, 
size
);

172  
	`ngx_∑Œoc_œrge
(
poﬁ
, 
size
);

173 
	}
}

177 
	$ngx_∑Œoc_block
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

179 
u_ch¨
 *
m
;

180 
size_t
 
psize
;

181 
ngx_poﬁ_t
 *
p
, *
√w
, *
cuºít
;

183 
psize
 = (
size_t
Ë(
poﬁ
->
d
.
íd
 - (
u_ch¨
 *)Öool);

185 
m
 = 
	`ngx_memÆign
(
NGX_POOL_ALIGNMENT
, 
psize
, 
poﬁ
->
log
);

186 i‡(
m
 =
NULL
) {

187  
NULL
;

190 
√w
 = (
ngx_poﬁ_t
 *Ë
m
;

192 
√w
->
d
.
íd
 = 
m
 + 
psize
;

193 
√w
->
d
.
√xt
 = 
NULL
;

194 
√w
->
d
.
Áûed
 = 0;

196 
m
 +(
ngx_poﬁ_d©a_t
);

197 
m
 = 
	`ngx_Æign_±r
(m, 
NGX_ALIGNMENT
);

198 
√w
->
d
.
œ°
 = 
m
 + 
size
;

200 
cuºít
 = 
poﬁ
->current;

202 
p
 = 
cuºít
;Ö->
d
.
√xt
;Ö =Ö->d.next) {

203 i‡(
p
->
d
.
Áûed
++ > 4) {

204 
cuºít
 = 
p
->
d
.
√xt
;

208 
p
->
d
.
√xt
 = 
√w
;

210 
poﬁ
->
cuºít
 = cuºíà? cuºíà: 
√w
;

212  
m
;

213 
	}
}

217 
	$ngx_∑Œoc_œrge
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

219 *
p
;

220 
ngx_uöt_t
 
n
;

221 
ngx_poﬁ_œrge_t
 *
œrge
;

223 
p
 = 
	`ngx_Æloc
(
size
, 
poﬁ
->
log
);

224 i‡(
p
 =
NULL
) {

225  
NULL
;

228 
n
 = 0;

230 
œrge
 = 
poﬁ
->œrge;Ü¨ge;Ü¨gêœrge->
√xt
) {

231 i‡(
œrge
->
Æloc
 =
NULL
) {

232 
œrge
->
Æloc
 = 
p
;

233  
p
;

236 i‡(
n
++ > 3) {

241 
œrge
 = 
	`ngx_∑Œoc
(
poﬁ
, (
ngx_poﬁ_œrge_t
));

242 i‡(
œrge
 =
NULL
) {

243 
	`ngx_‰ì
(
p
);

244  
NULL
;

247 
œrge
->
Æloc
 = 
p
;

248 
œrge
->
√xt
 = 
poﬁ
->large;

249 
poﬁ
->
œrge
 =Üarge;

251  
p
;

252 
	}
}

256 
	$ngx_pmemÆign
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
, size_à
Æignmít
)

258 *
p
;

259 
ngx_poﬁ_œrge_t
 *
œrge
;

261 
p
 = 
	`ngx_memÆign
(
Æignmít
, 
size
, 
poﬁ
->
log
);

262 i‡(
p
 =
NULL
) {

263  
NULL
;

266 
œrge
 = 
	`ngx_∑Œoc
(
poﬁ
, (
ngx_poﬁ_œrge_t
));

267 i‡(
œrge
 =
NULL
) {

268 
	`ngx_‰ì
(
p
);

269  
NULL
;

272 
œrge
->
Æloc
 = 
p
;

273 
œrge
->
√xt
 = 
poﬁ
->large;

274 
poﬁ
->
œrge
 =Üarge;

276  
p
;

277 
	}
}

280 
ngx_öt_t


281 
	$ngx_p‰ì
(
ngx_poﬁ_t
 *
poﬁ
, *
p
)

283 
ngx_poﬁ_œrge_t
 *
l
;

285 
l
 = 
poﬁ
->
œrge
;Ü;Ü =Ü->
√xt
) {

286 i‡(
p
 =
l
->
Æloc
) {

287 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
poﬁ
->
log
, 0,

288 "‰ì: %p", 
l
->
Æloc
);

289 
	`ngx_‰ì
(
l
->
Æloc
);

290 
l
->
Æloc
 = 
NULL
;

292  
NGX_OK
;

296  
NGX_DECLINED
;

297 
	}
}

301 
	$ngx_pˇŒoc
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

303 *
p
;

305 
p
 = 
	`ngx_∑Œoc
(
poﬁ
, 
size
);

306 i‡(
p
) {

307 
	`ngx_memzîo
(
p
, 
size
);

310  
p
;

311 
	}
}

314 
ngx_poﬁ_˛ónup_t
 *

315 
	$ngx_poﬁ_˛ónup_add
(
ngx_poﬁ_t
 *
p
, 
size_t
 
size
)

317 
ngx_poﬁ_˛ónup_t
 *
c
;

319 
c
 = 
	`ngx_∑Œoc
(
p
, (
ngx_poﬁ_˛ónup_t
));

320 i‡(
c
 =
NULL
) {

321  
NULL
;

324 i‡(
size
) {

325 
c
->
d©a
 = 
	`ngx_∑Œoc
(
p
, 
size
);

326 i‡(
c
->
d©a
 =
NULL
) {

327  
NULL
;

331 
c
->
d©a
 = 
NULL
;

334 
c
->
h™dÀr
 = 
NULL
;

335 
c
->
√xt
 = 
p
->
˛ónup
;

337 
p
->
˛ónup
 = 
c
;

339 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
p
->
log
, 0, "add cÀ™up: %p", 
c
);

341  
c
;

342 
	}
}

346 
	$ngx_poﬁ_run_˛ónup_fûe
(
ngx_poﬁ_t
 *
p
, 
ngx_fd_t
 
fd
)

348 
ngx_poﬁ_˛ónup_t
 *
c
;

349 
ngx_poﬁ_˛ónup_fûe_t
 *
cf
;

351 
c
 = 
p
->
˛ónup
; c; c = c->
√xt
) {

352 i‡(
c
->
h™dÀr
 =
ngx_poﬁ_˛ónup_fûe
) {

354 
cf
 = 
c
->
d©a
;

356 i‡(
cf
->
fd
 == fd) {

357 
c
->
	`h™dÀr
(
cf
);

358 
c
->
h™dÀr
 = 
NULL
;

363 
	}
}

367 
	$ngx_poﬁ_˛ónup_fûe
(*
d©a
)

369 
ngx_poﬁ_˛ónup_fûe_t
 *
c
 = 
d©a
;

371 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
c
->
log
, 0, "file cleanup: fd:%d",

372 
c
->
fd
);

374 i‡(
	`ngx_˛o£_fûe
(
c
->
fd
Ë=
NGX_FILE_ERROR
) {

375 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_î∫o
,

376 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
c
->
«me
);

378 
	}
}

382 
	$ngx_poﬁ_dñëe_fûe
(*
d©a
)

384 
ngx_poﬁ_˛ónup_fûe_t
 *
c
 = 
d©a
;

386 
ngx_îr_t
 
îr
;

388 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
c
->
log
, 0, "file cleanup: fd:%d %s",

389 
c
->
fd
, c->
«me
);

391 i‡(
	`ngx_dñëe_fûe
(
c
->
«me
Ë=
NGX_FILE_ERROR
) {

392 
îr
 = 
ngx_î∫o
;

394 i‡(
îr
 !
NGX_ENOENT
) {

395 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
c
->
log
, 
îr
,

396 
ngx_dñëe_fûe_n
 " \"%s\" faûed", 
c
->
«me
);

400 i‡(
	`ngx_˛o£_fûe
(
c
->
fd
Ë=
NGX_FILE_ERROR
) {

401 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
c
->
log
, 
ngx_î∫o
,

402 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
c
->
«me
);

404 
	}
}

410 
	$ngx_gë_ˇched_block
(
size_t
 
size
)

412 *
p
;

413 
ngx_ˇched_block_¶Ÿ_t
 *
¶Ÿ
;

415 i‡(
ngx_cy˛e
->
ˇche
 =
NULL
) {

416  
NULL
;

419 
¶Ÿ
 = &
ngx_cy˛e
->
ˇche
[(
size
 + 
ngx_∑gesize
 - 1) /Çgx_pagesize];

421 
¶Ÿ
->
åõs
++;

423 i‡(
¶Ÿ
->
numbî
) {

424 
p
 = 
¶Ÿ
->
block
;

425 
¶Ÿ
->
block
 = slŸ->block->
√xt
;

426 
¶Ÿ
->
numbî
--;

427  
p
;

430  
NULL
;

431 
	}
}

	@ngx_palloc.h

8 #i‚de‡
_NGX_PALLOC_H_INCLUDED_


9 
	#_NGX_PALLOC_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

20 
	#NGX_MAX_ALLOC_FROM_POOL
 (
ngx_∑gesize
 - 1)

	)

22 
	#NGX_DEFAULT_POOL_SIZE
 (16 * 1024)

	)

24 
	#NGX_POOL_ALIGNMENT
 16

	)

25 
	#NGX_MIN_POOL_SIZE
 \

26 
	`ngx_Æign
(((
ngx_poﬁ_t
Ë+ 2 * (
ngx_poﬁ_œrge_t
)), \

27 
NGX_POOL_ALIGNMENT
)

	)

30 (*
	tngx_poﬁ_˛ónup_±
)(*
	td©a
);

32 
ngx_poﬁ_˛ónup_s
 
	tngx_poﬁ_˛ónup_t
;

34 
	sngx_poﬁ_˛ónup_s
 {

35 
ngx_poﬁ_˛ónup_±
 
h™dÀr
;

36 *
d©a
;

37 
ngx_poﬁ_˛ónup_t
 *
√xt
;

41 
ngx_poﬁ_œrge_s
 
	tngx_poﬁ_œrge_t
;

43 
	sngx_poﬁ_œrge_s
 {

44 
ngx_poﬁ_œrge_t
 *
√xt
;

45 *
Æloc
;

50 
u_ch¨
 *
œ°
;

51 
u_ch¨
 *
íd
;

52 
ngx_poﬁ_t
 *
√xt
;

53 
ngx_uöt_t
 
Áûed
;

54 } 
	tngx_poﬁ_d©a_t
;

57 
	sngx_poﬁ_s
 {

58 
ngx_poﬁ_d©a_t
 
d
;

59 
size_t
 
max
;

60 
ngx_poﬁ_t
 *
cuºít
;

61 
ngx_chaö_t
 *
chaö
;

62 
ngx_poﬁ_œrge_t
 *
œrge
;

63 
ngx_poﬁ_˛ónup_t
 *
˛ónup
;

64 
ngx_log_t
 *
log
;

69 
ngx_fd_t
 
fd
;

70 
u_ch¨
 *
«me
;

71 
ngx_log_t
 *
log
;

72 } 
	tngx_poﬁ_˛ónup_fûe_t
;

75 *
	`ngx_Æloc
(
size_t
 
size
, 
ngx_log_t
 *
log
);

76 *
	`ngx_ˇŒoc
(
size_t
 
size
, 
ngx_log_t
 *
log
);

78 
ngx_poﬁ_t
 *
	`ngx_¸óã_poﬁ
(
size_t
 
size
, 
ngx_log_t
 *
log
);

79 
	`ngx_de°roy_poﬁ
(
ngx_poﬁ_t
 *
poﬁ
);

80 
	`ngx_ª£t_poﬁ
(
ngx_poﬁ_t
 *
poﬁ
);

82 *
	`ngx_∑Œoc
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

83 *
	`ngx_≤Æloc
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

84 *
	`ngx_pˇŒoc
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

85 *
	`ngx_pmemÆign
(
ngx_poﬁ_t
 *
poﬁ
, 
size_t
 
size
, size_à
Æignmít
);

86 
ngx_öt_t
 
	`ngx_p‰ì
(
ngx_poﬁ_t
 *
poﬁ
, *
p
);

89 
ngx_poﬁ_˛ónup_t
 *
	`ngx_poﬁ_˛ónup_add
(
ngx_poﬁ_t
 *
p
, 
size_t
 
size
);

90 
	`ngx_poﬁ_run_˛ónup_fûe
(
ngx_poﬁ_t
 *
p
, 
ngx_fd_t
 
fd
);

91 
	`ngx_poﬁ_˛ónup_fûe
(*
d©a
);

92 
	`ngx_poﬁ_dñëe_fûe
(*
d©a
);

	@ngx_parse.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
ssize_t


13 
	$ngx_∑r£_size
(
ngx_°r_t
 *
löe
)

15 
u_ch¨
 
unô
;

16 
size_t
 
Àn
;

17 
ssize_t
 
size
;

18 
ngx_öt_t
 
sˇÀ
;

20 
Àn
 = 
löe
->len;

21 
unô
 = 
löe
->
d©a
[
Àn
 - 1];

23 
unô
) {

26 
Àn
--;

27 
sˇÀ
 = 1024;

32 
Àn
--;

33 
sˇÀ
 = 1024 * 1024;

37 
sˇÀ
 = 1;

40 
size
 = 
	`ngx_©osz
(
löe
->
d©a
, 
Àn
);

41 i‡(
size
 =
NGX_ERROR
) {

42  
NGX_ERROR
;

45 
size
 *
sˇÀ
;

47  
size
;

48 
	}
}

51 
off_t


52 
	$ngx_∑r£_off£t
(
ngx_°r_t
 *
löe
)

54 
u_ch¨
 
unô
;

55 
off_t
 
off£t
;

56 
size_t
 
Àn
;

57 
ngx_öt_t
 
sˇÀ
;

59 
Àn
 = 
löe
->len;

60 
unô
 = 
löe
->
d©a
[
Àn
 - 1];

62 
unô
) {

65 
Àn
--;

66 
sˇÀ
 = 1024;

71 
Àn
--;

72 
sˇÀ
 = 1024 * 1024;

77 
Àn
--;

78 
sˇÀ
 = 1024 * 1024 * 1024;

82 
sˇÀ
 = 1;

85 
off£t
 = 
	`ngx_©oof
(
löe
->
d©a
, 
Àn
);

86 i‡(
off£t
 =
NGX_ERROR
) {

87  
NGX_ERROR
;

90 
off£t
 *
sˇÀ
;

92  
off£t
;

93 
	}
}

96 
ngx_öt_t


97 
	$ngx_∑r£_time
(
ngx_°r_t
 *
löe
, 
ngx_uöt_t
 
is_£c
)

99 
u_ch¨
 *
p
, *
œ°
;

100 
ngx_öt_t
 
vÆue
, 
tŸÆ
, 
sˇÀ
;

101 
ngx_uöt_t
 
max
, 
vÆid
;

103 
°_°¨t
 = 0,

104 
°_yór
,

105 
°_m⁄th
,

106 
°_wìk
,

107 
°_day
,

108 
°_hour
,

109 
°_mö
,

110 
°_£c
,

111 
°_m£c
,

112 
°_œ°


113 } 
°ï
;

115 
vÆid
 = 0;

116 
vÆue
 = 0;

117 
tŸÆ
 = 0;

118 
°ï
 = 
is_£c
 ? 
°_°¨t
 : 
°_m⁄th
;

119 
sˇÀ
 = 
is_£c
 ? 1 : 1000;

121 
p
 = 
löe
->
d©a
;

122 
œ°
 = 
p
 + 
löe
->
Àn
;

124 
p
 < 
œ°
) {

126 i‡(*
p
 >= '0' && *p <= '9') {

127 
vÆue
 = vÆuê* 10 + (*
p
++ - '0');

128 
vÆid
 = 1;

132 *
p
++) {

135 i‡(
°ï
 > 
°_°¨t
) {

136  
NGX_ERROR
;

138 
°ï
 = 
°_yór
;

139 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24 * 365);

140 
sˇÀ
 = 60 * 60 * 24 * 365;

144 i‡(
°ï
 >
°_m⁄th
) {

145  
NGX_ERROR
;

147 
°ï
 = 
°_m⁄th
;

148 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24 * 30);

149 
sˇÀ
 = 60 * 60 * 24 * 30;

153 i‡(
°ï
 >
°_wìk
) {

154  
NGX_ERROR
;

156 
°ï
 = 
°_wìk
;

157 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24 * 7);

158 
sˇÀ
 = 60 * 60 * 24 * 7;

162 i‡(
°ï
 >
°_day
) {

163  
NGX_ERROR
;

165 
°ï
 = 
°_day
;

166 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60 * 24);

167 
sˇÀ
 = 60 * 60 * 24;

171 i‡(
°ï
 >
°_hour
) {

172  
NGX_ERROR
;

174 
°ï
 = 
°_hour
;

175 
max
 = 
NGX_MAX_INT32_VALUE
 / (60 * 60);

176 
sˇÀ
 = 60 * 60;

180 i‡(*
p
 == 's') {

181 i‡(
is_£c
 || 
°ï
 >
°_m£c
) {

182  
NGX_ERROR
;

184 
p
++;

185 
°ï
 = 
°_m£c
;

186 
max
 = 
NGX_MAX_INT32_VALUE
;

187 
sˇÀ
 = 1;

191 i‡(
°ï
 >
°_mö
) {

192  
NGX_ERROR
;

194 
°ï
 = 
°_mö
;

195 
max
 = 
NGX_MAX_INT32_VALUE
 / 60;

196 
sˇÀ
 = 60;

200 i‡(
°ï
 >
°_£c
) {

201  
NGX_ERROR
;

203 
°ï
 = 
°_£c
;

204 
max
 = 
NGX_MAX_INT32_VALUE
;

205 
sˇÀ
 = 1;

209 i‡(
°ï
 >
°_£c
) {

210  
NGX_ERROR
;

212 
°ï
 = 
°_œ°
;

213 
max
 = 
NGX_MAX_INT32_VALUE
;

214 
sˇÀ
 = 1;

218  
NGX_ERROR
;

221 i‡(
°ï
 !
°_m£c
 && !
is_£c
) {

222 
sˇÀ
 *= 1000;

223 
max
 /= 1000;

226 i‡((
ngx_uöt_t
Ë
vÆue
 > 
max
) {

227  
NGX_ERROR
;

230 
tŸÆ
 +
vÆue
 * 
sˇÀ
;

232 i‡((
ngx_uöt_t
Ë
tŸÆ
 > 
NGX_MAX_INT32_VALUE
) {

233  
NGX_ERROR
;

236 
vÆue
 = 0;

237 
sˇÀ
 = 
is_£c
 ? 1 : 1000;

239 
p
 < 
œ°
 && *p == ' ') {

240 
p
++;

244 i‡(
vÆid
) {

245  
tŸÆ
 + 
vÆue
 * 
sˇÀ
;

248  
NGX_ERROR
;

249 
	}
}

	@ngx_parse.h

8 #i‚de‡
_NGX_PARSE_H_INCLUDED_


9 
	#_NGX_PARSE_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
ssize_t
 
ngx_∑r£_size
(
ngx_°r_t
 *
löe
);

17 
off_t
 
ngx_∑r£_off£t
(
ngx_°r_t
 *
löe
);

18 
ngx_öt_t
 
ngx_∑r£_time
(
ngx_°r_t
 *
löe
, 
ngx_uöt_t
 
is_£c
);

	@ngx_queue.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

17 
ngx_queue_t
 *

18 
	$ngx_queue_middÀ
(
ngx_queue_t
 *
queue
)

20 
ngx_queue_t
 *
middÀ
, *
√xt
;

22 
middÀ
 = 
	`ngx_queue_hód
(
queue
);

24 i‡(
middÀ
 =
	`ngx_queue_œ°
(
queue
)) {

25  
middÀ
;

28 
√xt
 = 
	`ngx_queue_hód
(
queue
);

31 
middÀ
 = 
	`ngx_queue_√xt
(middle);

33 
√xt
 = 
	`ngx_queue_√xt
(next);

35 i‡(
√xt
 =
	`ngx_queue_œ°
(
queue
)) {

36  
middÀ
;

39 
√xt
 = 
	`ngx_queue_√xt
(next);

41 i‡(
√xt
 =
	`ngx_queue_œ°
(
queue
)) {

42  
middÀ
;

45 
	}
}

51 
ngx_queue_s‹t
(
ngx_queue_t
 *
queue
,

52 
	$ngx_öt_t
 (*
cmp
)(c⁄° 
ngx_queue_t
 *, constÇgx_queue_t *))

54 
ngx_queue_t
 *
q
, *
¥ev
, *
√xt
;

56 
q
 = 
	`ngx_queue_hód
(
queue
);

58 i‡(
q
 =
	`ngx_queue_œ°
(
queue
)) {

62 
q
 = 
	`ngx_queue_√xt
(q); q !
	`ngx_queue_£¡öñ
(
queue
); q = 
√xt
) {

64 
¥ev
 = 
	`ngx_queue_¥ev
(
q
);

65 
√xt
 = 
	`ngx_queue_√xt
(
q
);

67 
	`ngx_queue_ªmove
(
q
);

70 i‡(
	`cmp
(
¥ev
, 
q
) <= 0) {

74 
¥ev
 = 
	`ngx_queue_¥ev
(prev);

76 } 
¥ev
 !
	`ngx_queue_£¡öñ
(
queue
));

78 
	`ngx_queue_ö£π_a·î
(
¥ev
, 
q
);

80 
	}
}

	@ngx_queue.h

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 #i‚de‡
_NGX_QUEUE_H_INCLUDED_


13 
	#_NGX_QUEUE_H_INCLUDED_


	)

16 
ngx_queue_s
 
	tngx_queue_t
;

18 
	sngx_queue_s
 {

19 
ngx_queue_t
 *
	m¥ev
;

20 
ngx_queue_t
 *
	m√xt
;

24 
	#ngx_queue_öô
(
q
) \

25 (
q
)->
¥ev
 = q; \

26 (
q
)->
√xt
 = 
	)
q

29 
	#ngx_queue_em±y
(
h
) \

30 (
h
 =(h)->
¥ev
)

	)

33 
	#ngx_queue_ö£π_hód
(
h
, 
x
) \

34 (
x
)->
√xt
 = (
h
)->next; \

35 (
x
)->
√xt
->
¥ev
 = x; \

36 (
x
)->
¥ev
 = 
h
; \

37 (
h
)->
√xt
 = 
x


	)

40 
	#ngx_queue_ö£π_a·î
 
ngx_queue_ö£π_hód


	)

43 
	#ngx_queue_ö£π_èû
(
h
, 
x
) \

44 (
x
)->
¥ev
 = (
h
)->prev; \

45 (
x
)->
¥ev
->
√xt
 = x; \

46 (
x
)->
√xt
 = 
h
; \

47 (
h
)->
¥ev
 = 
x


	)

50 
	#ngx_queue_hód
(
h
) \

51 (
h
)->
√xt


	)

54 
	#ngx_queue_œ°
(
h
) \

55 (
h
)->
¥ev


	)

58 
	#ngx_queue_£¡öñ
(
h
) \

59 (
h
)

	)

62 
	#ngx_queue_√xt
(
q
) \

63 (
q
)->
√xt


	)

66 
	#ngx_queue_¥ev
(
q
) \

67 (
q
)->
¥ev


	)

70 #i‡(
NGX_DEBUG
)

72 
	#ngx_queue_ªmove
(
x
) \

73 (
x
)->
√xt
->
¥ev
 = (x)->prev; \

74 (
x
)->
¥ev
->
√xt
 = (x)->next; \

75 (
x
)->
¥ev
 = 
NULL
; \

76 (
x
)->
√xt
 = 
NULL


	)

80 
	#ngx_queue_ªmove
(
x
) \

81 (
x
)->
√xt
->
¥ev
 = (x)->prev; \

82 (
x
)->
¥ev
->
√xt
 = (x)->
	)
next

87 
	#ngx_queue_•lô
(
h
, 
q
, 
n
) \

88 (
n
)->
¥ev
 = (
h
)->prev; \

89 (
n
)->
¥ev
->
√xt
 =Ç; \

90 (
n
)->
√xt
 = 
q
; \

91 (
h
)->
¥ev
 = (
q
)->prev; \

92 (
h
)->
¥ev
->
√xt
 = h; \

93 (
q
)->
¥ev
 = 
n
;

	)

96 
	#ngx_queue_add
(
h
, 
n
) \

97 (
h
)->
¥ev
->
√xt
 = (
n
)->next; \

98 (
n
)->
√xt
->
¥ev
 = (
h
)->prev; \

99 (
h
)->
¥ev
 = (
n
)->prev; \

100 (
h
)->
¥ev
->
√xt
 = h;

	)

103 
	#ngx_queue_d©a
(
q
, 
ty≥
, 
lök
) \

104 (
ty≥
 *Ë((
u_ch¨
 *Ë
q
 - 
	`off£tof
—y≥, 
lök
))

	)

107 
ngx_queue_t
 *
ngx_queue_middÀ
“gx_queue_à*
queue
);

108 
ngx_queue_s‹t
(
ngx_queue_t
 *
queue
,

109 
	$ngx_öt_t
 (*
cmp
)(c⁄° 
ngx_queue_t
 *, constÇgx_queue_t *));

	@ngx_radix_tree.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 *
ngx_ødix_Æloc
(
ngx_ødix_åì_t
 *
åì
);

15 
ngx_ødix_åì_t
 *

16 
	$ngx_ødix_åì_¸óã
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_öt_t
 
¥óŒoˇã
)

18 
uöt32_t
 
key
, 
mask
, 
öc
;

19 
ngx_ødix_åì_t
 *
åì
;

21 
åì
 = 
	`ngx_∑Œoc
(
poﬁ
, (
ngx_ødix_åì_t
));

22 i‡(
åì
 =
NULL
) {

23  
NULL
;

26 
åì
->
poﬁ
 =Öool;

27 
åì
->
‰ì
 = 
NULL
;

28 
åì
->
°¨t
 = 
NULL
;

29 
åì
->
size
 = 0;

31 
åì
->
roŸ
 = 
	`ngx_ødix_Æloc
(tree);

32 i‡(
åì
->
roŸ
 =
NULL
) {

33  
NULL
;

36 
åì
->
roŸ
->
right
 = 
NULL
;

37 
åì
->
roŸ
->
À·
 = 
NULL
;

38 
åì
->
roŸ
->
∑ª¡
 = 
NULL
;

39 
åì
->
roŸ
->
vÆue
 = 
NGX_RADIX_NO_VALUE
;

41 i‡(
¥óŒoˇã
 == 0) {

42  
åì
;

62 i‡(
¥óŒoˇã
 == -1) {

63 
ngx_∑gesize
 / (
ngx_ødix_åì_t
)) {

67 
¥óŒoˇã
 = 6;

72 
¥óŒoˇã
 = 7;

77 
¥óŒoˇã
 = 8;

81 
mask
 = 0;

82 
öc
 = 0x80000000;

84 
¥óŒoˇã
--) {

86 
key
 = 0;

87 
mask
 >>= 1;

88 
mask
 |= 0x80000000;

91 i‡(
	`ngx_ødix32åì_ö£π
(
åì
, 
key
, 
mask
, 
NGX_RADIX_NO_VALUE
)

92 !
NGX_OK
)

94  
NULL
;

97 
key
 +
öc
;

99 } 
key
);

101 
öc
 >>= 1;

104  
åì
;

105 
	}
}

108 
ngx_öt_t


109 
	$ngx_ødix32åì_ö£π
(
ngx_ødix_åì_t
 *
åì
, 
uöt32_t
 
key
, uöt32_à
mask
,

110 
uöçå_t
 
vÆue
)

112 
uöt32_t
 
bô
;

113 
ngx_ødix_node_t
 *
node
, *
√xt
;

115 
bô
 = 0x80000000;

117 
node
 = 
åì
->
roŸ
;

118 
√xt
 = 
åì
->
roŸ
;

120 
bô
 & 
mask
) {

121 i‡(
key
 & 
bô
) {

122 
√xt
 = 
node
->
right
;

125 
√xt
 = 
node
->
À·
;

128 i‡(
√xt
 =
NULL
) {

132 
bô
 >>= 1;

133 
node
 = 
√xt
;

136 i‡(
√xt
) {

137 i‡(
node
->
vÆue
 !
NGX_RADIX_NO_VALUE
) {

138  
NGX_BUSY
;

141 
node
->
vÆue
 = value;

142  
NGX_OK
;

145 
bô
 & 
mask
) {

146 
√xt
 = 
	`ngx_ødix_Æloc
(
åì
);

147 i‡(
√xt
 =
NULL
) {

148  
NGX_ERROR
;

151 
√xt
->
right
 = 
NULL
;

152 
√xt
->
À·
 = 
NULL
;

153 
√xt
->
∑ª¡
 = 
node
;

154 
√xt
->
vÆue
 = 
NGX_RADIX_NO_VALUE
;

156 i‡(
key
 & 
bô
) {

157 
node
->
right
 = 
√xt
;

160 
node
->
À·
 = 
√xt
;

163 
bô
 >>= 1;

164 
node
 = 
√xt
;

167 
node
->
vÆue
 = value;

169  
NGX_OK
;

170 
	}
}

173 
ngx_öt_t


174 
	$ngx_ødix32åì_dñëe
(
ngx_ødix_åì_t
 *
åì
, 
uöt32_t
 
key
, uöt32_à
mask
)

176 
uöt32_t
 
bô
;

177 
ngx_ødix_node_t
 *
node
;

179 
bô
 = 0x80000000;

180 
node
 = 
åì
->
roŸ
;

182 
node
 && (
bô
 & 
mask
)) {

183 i‡(
key
 & 
bô
) {

184 
node
 =Çode->
right
;

187 
node
 =Çode->
À·
;

190 
bô
 >>= 1;

193 i‡(
node
 =
NULL
) {

194  
NGX_ERROR
;

197 i‡(
node
->
right
 ||Çode->
À·
) {

198 i‡(
node
->
vÆue
 !
NGX_RADIX_NO_VALUE
) {

199 
node
->
vÆue
 = 
NGX_RADIX_NO_VALUE
;

200  
NGX_OK
;

203  
NGX_ERROR
;

207 i‡(
node
->
∑ª¡
->
right
 ==Çode) {

208 
node
->
∑ª¡
->
right
 = 
NULL
;

211 
node
->
∑ª¡
->
À·
 = 
NULL
;

214 
node
->
right
 = 
åì
->
‰ì
;

215 
åì
->
‰ì
 = 
node
;

217 
node
 =Çode->
∑ª¡
;

219 i‡(
node
->
right
 ||Çode->
À·
) {

223 i‡(
node
->
vÆue
 !
NGX_RADIX_NO_VALUE
) {

227 i‡(
node
->
∑ª¡
 =
NULL
) {

232  
NGX_OK
;

233 
	}
}

236 
uöçå_t


237 
	$ngx_ødix32åì_föd
(
ngx_ødix_åì_t
 *
åì
, 
uöt32_t
 
key
)

239 
uöt32_t
 
bô
;

240 
uöçå_t
 
vÆue
;

241 
ngx_ødix_node_t
 *
node
;

243 
bô
 = 0x80000000;

244 
vÆue
 = 
NGX_RADIX_NO_VALUE
;

245 
node
 = 
åì
->
roŸ
;

247 
node
) {

248 i‡(
node
->
vÆue
 !
NGX_RADIX_NO_VALUE
) {

249 
vÆue
 = 
node
->value;

252 i‡(
key
 & 
bô
) {

253 
node
 =Çode->
right
;

256 
node
 =Çode->
À·
;

259 
bô
 >>= 1;

262  
vÆue
;

263 
	}
}

267 
	$ngx_ødix_Æloc
(
ngx_ødix_åì_t
 *
åì
)

269 *
p
;

271 i‡(
åì
->
‰ì
) {

272 
p
 = (*Ë
åì
->
‰ì
;

273 
åì
->
‰ì
 =Åªe->‰ì->
right
;

274  
p
;

277 i‡(
åì
->
size
 < (
ngx_ødix_node_t
)) {

278 
åì
->
°¨t
 = 
	`ngx_pmemÆign
—ªe->
poﬁ
, 
ngx_∑gesize
,Çgx_pagesize);

279 i‡(
åì
->
°¨t
 =
NULL
) {

280  
NULL
;

283 
åì
->
size
 = 
ngx_∑gesize
;

286 
p
 = 
åì
->
°¨t
;

287 
åì
->
°¨t
 +(
ngx_ødix_node_t
);

288 
åì
->
size
 -(
ngx_ødix_node_t
);

290  
p
;

291 
	}
}

	@ngx_radix_tree.h

8 #i‚de‡
_NGX_RADIX_TREE_H_INCLUDED_


9 
	#_NGX_RADIX_TREE_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
	#NGX_RADIX_NO_VALUE
 (
uöçå_t
Ë-1

	)

18 
ngx_ødix_node_s
 
	tngx_ødix_node_t
;

20 
	sngx_ødix_node_s
 {

21 
ngx_ødix_node_t
 *
	mright
;

22 
ngx_ødix_node_t
 *
	mÀ·
;

23 
ngx_ødix_node_t
 *
	m∑ª¡
;

24 
uöçå_t
 
	mvÆue
;

29 
ngx_ødix_node_t
 *
	mroŸ
;

30 
ngx_poﬁ_t
 *
	mpoﬁ
;

31 
ngx_ødix_node_t
 *
	m‰ì
;

32 *
	m°¨t
;

33 
size_t
 
	msize
;

34 } 
	tngx_ødix_åì_t
;

37 
ngx_ødix_åì_t
 *
ngx_ødix_åì_¸óã
(
ngx_poﬁ_t
 *
poﬁ
,

38 
ngx_öt_t
 
¥óŒoˇã
);

39 
ngx_öt_t
 
ngx_ødix32åì_ö£π
(
ngx_ødix_åì_t
 *
åì
,

40 
uöt32_t
 
key
, uöt32_à
mask
, 
uöçå_t
 
vÆue
);

41 
ngx_öt_t
 
ngx_ødix32åì_dñëe
(
ngx_ødix_åì_t
 *
åì
,

42 
uöt32_t
 
key
, uöt32_à
mask
);

43 
uöçå_t
 
ngx_ødix32åì_föd
(
ngx_ødix_åì_t
 *
åì
, 
uöt32_t
 
key
);

	@ngx_rbtree.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

18 
ngx_ölöe
 
ngx_rbåì_À·_rŸ©e
(
ngx_rbåì_node_t
 **
roŸ
,

19 
ngx_rbåì_node_t
 *
£¡öñ
,Çgx_rbåì_node_à*
node
);

20 
ngx_ölöe
 
ngx_rbåì_right_rŸ©e
(
ngx_rbåì_node_t
 **
roŸ
,

21 
ngx_rbåì_node_t
 *
£¡öñ
,Çgx_rbåì_node_à*
node
);

25 
	$ngx_rbåì_ö£π
(
ngx_thªad_vﬁ©ûe
 
ngx_rbåì_t
 *
åì
,

26 
ngx_rbåì_node_t
 *
node
)

28 
ngx_rbåì_node_t
 **
roŸ
, *
ãmp
, *
£¡öñ
;

32 
roŸ
 = (
ngx_rbåì_node_t
 **Ë&
åì
->root;

33 
£¡öñ
 = 
åì
->sentinel;

35 i‡(*
roŸ
 =
£¡öñ
) {

36 
node
->
∑ª¡
 = 
NULL
;

37 
node
->
À·
 = 
£¡öñ
;

38 
node
->
right
 = 
£¡öñ
;

39 
	`ngx_rbt_bœck
(
node
);

40 *
roŸ
 = 
node
;

45 
åì
->
	`ö£π
(*
roŸ
, 
node
, 
£¡öñ
);

49 
node
 !*
roŸ
 && 
	`ngx_rbt_is_ªd
“ode->
∑ª¡
)) {

51 i‡(
node
->
∑ª¡
 =node->∑ª¡->∑ª¡->
À·
) {

52 
ãmp
 = 
node
->
∑ª¡
->∑ª¡->
right
;

54 i‡(
	`ngx_rbt_is_ªd
(
ãmp
)) {

55 
	`ngx_rbt_bœck
(
node
->
∑ª¡
);

56 
	`ngx_rbt_bœck
(
ãmp
);

57 
	`ngx_rbt_ªd
(
node
->
∑ª¡
->parent);

58 
node
 =Çode->
∑ª¡
->parent;

61 i‡(
node
 =node->
∑ª¡
->
right
) {

62 
node
 =Çode->
∑ª¡
;

63 
	`ngx_rbåì_À·_rŸ©e
(
roŸ
, 
£¡öñ
, 
node
);

66 
	`ngx_rbt_bœck
(
node
->
∑ª¡
);

67 
	`ngx_rbt_ªd
(
node
->
∑ª¡
->parent);

68 
	`ngx_rbåì_right_rŸ©e
(
roŸ
, 
£¡öñ
, 
node
->
∑ª¡
->parent);

72 
ãmp
 = 
node
->
∑ª¡
->∑ª¡->
À·
;

74 i‡(
	`ngx_rbt_is_ªd
(
ãmp
)) {

75 
	`ngx_rbt_bœck
(
node
->
∑ª¡
);

76 
	`ngx_rbt_bœck
(
ãmp
);

77 
	`ngx_rbt_ªd
(
node
->
∑ª¡
->parent);

78 
node
 =Çode->
∑ª¡
->parent;

81 i‡(
node
 =node->
∑ª¡
->
À·
) {

82 
node
 =Çode->
∑ª¡
;

83 
	`ngx_rbåì_right_rŸ©e
(
roŸ
, 
£¡öñ
, 
node
);

86 
	`ngx_rbt_bœck
(
node
->
∑ª¡
);

87 
	`ngx_rbt_ªd
(
node
->
∑ª¡
->parent);

88 
	`ngx_rbåì_À·_rŸ©e
(
roŸ
, 
£¡öñ
, 
node
->
∑ª¡
->parent);

93 
	`ngx_rbt_bœck
(*
roŸ
);

94 
	}
}

98 
	$ngx_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,Çgx_rbåì_node_à*
node
,

99 
ngx_rbåì_node_t
 *
£¡öñ
)

101 
ngx_rbåì_node_t
 **
p
;

105 
p
 = (
node
->
key
 < 
ãmp
->keyË? &ãmp->
À·
 : &ãmp->
right
;

107 i‡(*
p
 =
£¡öñ
) {

111 
ãmp
 = *
p
;

114 *
p
 = 
node
;

115 
node
->
∑ª¡
 = 
ãmp
;

116 
node
->
À·
 = 
£¡öñ
;

117 
node
->
right
 = 
£¡öñ
;

118 
	`ngx_rbt_ªd
(
node
);

119 
	}
}

123 
	$ngx_rbåì_ö£π_timî_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,Çgx_rbåì_node_à*
node
,

124 
ngx_rbåì_node_t
 *
£¡öñ
)

126 
ngx_rbåì_node_t
 **
p
;

139 
p
 = ((
ngx_rbåì_key_öt_t
Ë(
node
->
key
 - 
ãmp
->key) < 0)

140 ? &
ãmp
->
À·
 : &ãmp->
right
;

142 i‡(*
p
 =
£¡öñ
) {

146 
ãmp
 = *
p
;

149 *
p
 = 
node
;

150 
node
->
∑ª¡
 = 
ãmp
;

151 
node
->
À·
 = 
£¡öñ
;

152 
node
->
right
 = 
£¡öñ
;

153 
	`ngx_rbt_ªd
(
node
);

154 
	}
}

158 
	$ngx_rbåì_dñëe
(
ngx_thªad_vﬁ©ûe
 
ngx_rbåì_t
 *
åì
,

159 
ngx_rbåì_node_t
 *
node
)

161 
ngx_uöt_t
 
ªd
;

162 
ngx_rbåì_node_t
 **
roŸ
, *
£¡öñ
, *
sub°
, *
ãmp
, *
w
;

166 
roŸ
 = (
ngx_rbåì_node_t
 **Ë&
åì
->root;

167 
£¡öñ
 = 
åì
->sentinel;

169 i‡(
node
->
À·
 =
£¡öñ
) {

170 
ãmp
 = 
node
->
right
;

171 
sub°
 = 
node
;

173 } i‡(
node
->
right
 =
£¡öñ
) {

174 
ãmp
 = 
node
->
À·
;

175 
sub°
 = 
node
;

178 
sub°
 = 
	`ngx_rbåì_mö
(
node
->
right
, 
£¡öñ
);

180 i‡(
sub°
->
À·
 !
£¡öñ
) {

181 
ãmp
 = 
sub°
->
À·
;

183 
ãmp
 = 
sub°
->
right
;

187 i‡(
sub°
 =*
roŸ
) {

188 *
roŸ
 = 
ãmp
;

189 
	`ngx_rbt_bœck
(
ãmp
);

192 
node
->
À·
 = 
NULL
;

193 
node
->
right
 = 
NULL
;

194 
node
->
∑ª¡
 = 
NULL
;

195 
node
->
key
 = 0;

200 
ªd
 = 
	`ngx_rbt_is_ªd
(
sub°
);

202 i‡(
sub°
 =sub°->
∑ª¡
->
À·
) {

203 
sub°
->
∑ª¡
->
À·
 = 
ãmp
;

206 
sub°
->
∑ª¡
->
right
 = 
ãmp
;

209 i‡(
sub°
 =
node
) {

211 
ãmp
->
∑ª¡
 = 
sub°
->parent;

215 i‡(
sub°
->
∑ª¡
 =
node
) {

216 
ãmp
->
∑ª¡
 = 
sub°
;

219 
ãmp
->
∑ª¡
 = 
sub°
->parent;

222 
sub°
->
À·
 = 
node
->left;

223 
sub°
->
right
 = 
node
->right;

224 
sub°
->
∑ª¡
 = 
node
->parent;

225 
	`ngx_rbt_c›y_cﬁ‹
(
sub°
, 
node
);

227 i‡(
node
 =*
roŸ
) {

228 *
roŸ
 = 
sub°
;

231 i‡(
node
 =node->
∑ª¡
->
À·
) {

232 
node
->
∑ª¡
->
À·
 = 
sub°
;

234 
node
->
∑ª¡
->
right
 = 
sub°
;

238 i‡(
sub°
->
À·
 !
£¡öñ
) {

239 
sub°
->
À·
->
∑ª¡
 = subst;

242 i‡(
sub°
->
right
 !
£¡öñ
) {

243 
sub°
->
right
->
∑ª¡
 = subst;

248 
node
->
À·
 = 
NULL
;

249 
node
->
right
 = 
NULL
;

250 
node
->
∑ª¡
 = 
NULL
;

251 
node
->
key
 = 0;

253 i‡(
ªd
) {

259 
ãmp
 !*
roŸ
 && 
	`ngx_rbt_is_bœck
(temp)) {

261 i‡(
ãmp
 =ãmp->
∑ª¡
->
À·
) {

262 
w
 = 
ãmp
->
∑ª¡
->
right
;

264 i‡(
	`ngx_rbt_is_ªd
(
w
)) {

265 
	`ngx_rbt_bœck
(
w
);

266 
	`ngx_rbt_ªd
(
ãmp
->
∑ª¡
);

267 
	`ngx_rbåì_À·_rŸ©e
(
roŸ
, 
£¡öñ
, 
ãmp
->
∑ª¡
);

268 
w
 = 
ãmp
->
∑ª¡
->
right
;

271 i‡(
	`ngx_rbt_is_bœck
(
w
->
À·
Ë&&Çgx_rbt_is_bœck(w->
right
)) {

272 
	`ngx_rbt_ªd
(
w
);

273 
ãmp
 =Åemp->
∑ª¡
;

276 i‡(
	`ngx_rbt_is_bœck
(
w
->
right
)) {

277 
	`ngx_rbt_bœck
(
w
->
À·
);

278 
	`ngx_rbt_ªd
(
w
);

279 
	`ngx_rbåì_right_rŸ©e
(
roŸ
, 
£¡öñ
, 
w
);

280 
w
 = 
ãmp
->
∑ª¡
->
right
;

283 
	`ngx_rbt_c›y_cﬁ‹
(
w
, 
ãmp
->
∑ª¡
);

284 
	`ngx_rbt_bœck
(
ãmp
->
∑ª¡
);

285 
	`ngx_rbt_bœck
(
w
->
right
);

286 
	`ngx_rbåì_À·_rŸ©e
(
roŸ
, 
£¡öñ
, 
ãmp
->
∑ª¡
);

287 
ãmp
 = *
roŸ
;

291 
w
 = 
ãmp
->
∑ª¡
->
À·
;

293 i‡(
	`ngx_rbt_is_ªd
(
w
)) {

294 
	`ngx_rbt_bœck
(
w
);

295 
	`ngx_rbt_ªd
(
ãmp
->
∑ª¡
);

296 
	`ngx_rbåì_right_rŸ©e
(
roŸ
, 
£¡öñ
, 
ãmp
->
∑ª¡
);

297 
w
 = 
ãmp
->
∑ª¡
->
À·
;

300 i‡(
	`ngx_rbt_is_bœck
(
w
->
À·
Ë&&Çgx_rbt_is_bœck(w->
right
)) {

301 
	`ngx_rbt_ªd
(
w
);

302 
ãmp
 =Åemp->
∑ª¡
;

305 i‡(
	`ngx_rbt_is_bœck
(
w
->
À·
)) {

306 
	`ngx_rbt_bœck
(
w
->
right
);

307 
	`ngx_rbt_ªd
(
w
);

308 
	`ngx_rbåì_À·_rŸ©e
(
roŸ
, 
£¡öñ
, 
w
);

309 
w
 = 
ãmp
->
∑ª¡
->
À·
;

312 
	`ngx_rbt_c›y_cﬁ‹
(
w
, 
ãmp
->
∑ª¡
);

313 
	`ngx_rbt_bœck
(
ãmp
->
∑ª¡
);

314 
	`ngx_rbt_bœck
(
w
->
À·
);

315 
	`ngx_rbåì_right_rŸ©e
(
roŸ
, 
£¡öñ
, 
ãmp
->
∑ª¡
);

316 
ãmp
 = *
roŸ
;

321 
	`ngx_rbt_bœck
(
ãmp
);

322 
	}
}

325 
ngx_ölöe
 

326 
	$ngx_rbåì_À·_rŸ©e
(
ngx_rbåì_node_t
 **
roŸ
,Çgx_rbåì_node_à*
£¡öñ
,

327 
ngx_rbåì_node_t
 *
node
)

329 
ngx_rbåì_node_t
 *
ãmp
;

331 
ãmp
 = 
node
->
right
;

332 
node
->
right
 = 
ãmp
->
À·
;

334 i‡(
ãmp
->
À·
 !
£¡öñ
) {

335 
ãmp
->
À·
->
∑ª¡
 = 
node
;

338 
ãmp
->
∑ª¡
 = 
node
->parent;

340 i‡(
node
 =*
roŸ
) {

341 *
roŸ
 = 
ãmp
;

343 } i‡(
node
 =node->
∑ª¡
->
À·
) {

344 
node
->
∑ª¡
->
À·
 = 
ãmp
;

347 
node
->
∑ª¡
->
right
 = 
ãmp
;

350 
ãmp
->
À·
 = 
node
;

351 
node
->
∑ª¡
 = 
ãmp
;

352 
	}
}

355 
ngx_ölöe
 

356 
	$ngx_rbåì_right_rŸ©e
(
ngx_rbåì_node_t
 **
roŸ
,Çgx_rbåì_node_à*
£¡öñ
,

357 
ngx_rbåì_node_t
 *
node
)

359 
ngx_rbåì_node_t
 *
ãmp
;

361 
ãmp
 = 
node
->
À·
;

362 
node
->
À·
 = 
ãmp
->
right
;

364 i‡(
ãmp
->
right
 !
£¡öñ
) {

365 
ãmp
->
right
->
∑ª¡
 = 
node
;

368 
ãmp
->
∑ª¡
 = 
node
->parent;

370 i‡(
node
 =*
roŸ
) {

371 *
roŸ
 = 
ãmp
;

373 } i‡(
node
 =node->
∑ª¡
->
right
) {

374 
node
->
∑ª¡
->
right
 = 
ãmp
;

377 
node
->
∑ª¡
->
À·
 = 
ãmp
;

380 
ãmp
->
right
 = 
node
;

381 
node
->
∑ª¡
 = 
ãmp
;

382 
	}
}

	@ngx_rbtree.h

8 #i‚de‡
_NGX_RBTREE_H_INCLUDED_


9 
	#_NGX_RBTREE_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
ngx_uöt_t
 
	tngx_rbåì_key_t
;

17 
ngx_öt_t
 
	tngx_rbåì_key_öt_t
;

20 
ngx_rbåì_node_s
 
	tngx_rbåì_node_t
;

22 
	sngx_rbåì_node_s
 {

23 
ngx_rbåì_key_t
 
	mkey
;

24 
ngx_rbåì_node_t
 *
	mÀ·
;

25 
ngx_rbåì_node_t
 *
	mright
;

26 
ngx_rbåì_node_t
 *
	m∑ª¡
;

27 
u_ch¨
 
	mcﬁ‹
;

28 
u_ch¨
 
	md©a
;

32 
ngx_rbåì_s
 
	tngx_rbåì_t
;

34 (*
	tngx_rbåì_ö£π_±
Ë(
	tngx_rbåì_node_t
 *
	troŸ
,

35 
	tngx_rbåì_node_t
 *
	tnode
,Çgx_rbåì_node_à*
	t£¡öñ
);

37 
	sngx_rbåì_s
 {

38 
ngx_rbåì_node_t
 *
roŸ
;

39 
ngx_rbåì_node_t
 *
£¡öñ
;

40 
ngx_rbåì_ö£π_±
 
ö£π
;

44 
	#ngx_rbåì_öô
(
åì
, 
s
, 
i
) \

45 
	`ngx_rbåì_£¡öñ_öô
(
s
); \

46 (
åì
)->
roŸ
 = 
s
; \

47 (
åì
)->
£¡öñ
 = 
s
; \

48 (
åì
)->
ö£π
 = 
i


	)

51 
	`ngx_rbåì_ö£π
(
ngx_thªad_vﬁ©ûe
 
ngx_rbåì_t
 *
åì
,

52 
ngx_rbåì_node_t
 *
node
);

53 
	`ngx_rbåì_dñëe
(
ngx_thªad_vﬁ©ûe
 
ngx_rbåì_t
 *
åì
,

54 
ngx_rbåì_node_t
 *
node
);

55 
	`ngx_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
roŸ
,Çgx_rbåì_node_à*
node
,

56 
ngx_rbåì_node_t
 *
£¡öñ
);

57 
	`ngx_rbåì_ö£π_timî_vÆue
(
ngx_rbåì_node_t
 *
roŸ
,

58 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
);

61 
	#ngx_rbt_ªd
(
node
Ë(“ode)->
cﬁ‹
 = 1)

	)

62 
	#ngx_rbt_bœck
(
node
Ë(“ode)->
cﬁ‹
 = 0)

	)

63 
	#ngx_rbt_is_ªd
(
node
Ë(“ode)->
cﬁ‹
)

	)

64 
	#ngx_rbt_is_bœck
(
node
Ë(!
	`ngx_rbt_is_ªd
“ode))

	)

65 
	#ngx_rbt_c›y_cﬁ‹
(
n1
, 
n2
Ë“1->
cﬁ‹
 =Ç2->cﬁ‹)

	)

70 
	#ngx_rbåì_£¡öñ_öô
(
node
Ë
	`ngx_rbt_bœck
“ode)

	)

73 
ngx_ölöe
 
ngx_rbåì_node_t
 *

74 
	$ngx_rbåì_mö
(
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
)

76 
node
->
À·
 !
£¡öñ
) {

77 
node
 =Çode->
À·
;

80  
node
;

81 
	}
}

	@ngx_regex.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

13 
ngx_Êag_t
 
	mp¸e_jô
;

14 } 
	tngx_ªgex_c⁄f_t
;

17 * 
ngx_libc_cde˛
 
ngx_ªgex_mÆloc
(
size_t
 
size
);

18 
ngx_libc_cde˛
 
ngx_ªgex_‰ì
(*
p
);

19 #i‡(
NGX_HAVE_PCRE_JIT
)

20 
ngx_p¸e_‰ì_°udõs
(*
d©a
);

23 
ngx_öt_t
 
ngx_ªgex_moduÀ_öô
(
ngx_cy˛e_t
 *
cy˛e
);

25 *
ngx_ªgex_¸óã_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
);

26 *
ngx_ªgex_öô_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
, *
c⁄f
);

28 *
ngx_ªgex_p¸e_jô
(
ngx_c⁄f_t
 *
cf
, *
po°
, *
d©a
);

29 
ngx_c⁄f_po°_t
 
	gngx_ªgex_p¸e_jô_po°
 = { 
ngx_ªgex_p¸e_jô
 };

32 
ngx_comm™d_t
 
	gngx_ªgex_comm™ds
[] = {

34 { 
ngx_°rög
("pcre_jit"),

35 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

36 
ngx_c⁄f_£t_Êag_¶Ÿ
,

38 
off£tof
(
ngx_ªgex_c⁄f_t
, 
p¸e_jô
),

39 &
ngx_ªgex_p¸e_jô_po°
 },

41 
ngx_nuŒ_comm™d


45 
ngx_c‹e_moduÀ_t
 
	gngx_ªgex_moduÀ_˘x
 = {

46 
ngx_°rög
("regex"),

47 
ngx_ªgex_¸óã_c⁄f
,

48 
ngx_ªgex_öô_c⁄f


52 
ngx_moduÀ_t
 
	gngx_ªgex_moduÀ
 = {

53 
NGX_MODULE_V1
,

54 &
ngx_ªgex_moduÀ_˘x
,

55 
ngx_ªgex_comm™ds
,

56 
NGX_CORE_MODULE
,

57 
NULL
,

58 
ngx_ªgex_moduÀ_öô
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
NULL
,

64 
NGX_MODULE_V1_PADDING


68 
ngx_poﬁ_t
 *
	gngx_p¸e_poﬁ
;

69 
ngx_li°_t
 *
	gngx_p¸e_°udõs
;

73 
	$ngx_ªgex_öô
()

75 
p¸e_mÆloc
 = 
ngx_ªgex_mÆloc
;

76 
p¸e_‰ì
 = 
ngx_ªgex_‰ì
;

77 
	}
}

80 
ngx_ölöe
 

81 
	$ngx_ªgex_mÆloc_öô
(
ngx_poﬁ_t
 *
poﬁ
)

83 #i‡(
NGX_THREADS
)

84 
ngx_c‹e_és_t
 *
és
;

86 i‡(
ngx_thªaded
) {

87 
és
 = 
	`ngx_thªad_gë_és
(
ngx_c‹e_és_key
);

88 
és
->
poﬁ
 =Öool;

94 
ngx_p¸e_poﬁ
 = 
poﬁ
;

95 
	}
}

98 
ngx_ölöe
 

99 
	$ngx_ªgex_mÆloc_d⁄e
()

101 #i‡(
NGX_THREADS
)

102 
ngx_c‹e_és_t
 *
és
;

104 i‡(
ngx_thªaded
) {

105 
és
 = 
	`ngx_thªad_gë_és
(
ngx_c‹e_és_key
);

106 
és
->
poﬁ
 = 
NULL
;

112 
ngx_p¸e_poﬁ
 = 
NULL
;

113 
	}
}

116 
ngx_öt_t


117 
	$ngx_ªgex_compûe
(
ngx_ªgex_compûe_t
 *
rc
)

119 
n
, 
îroff
;

120 *
p
;

121 
p¸e
 *
ª
;

122 c⁄° *
îr°r
;

123 
ngx_ªgex_ñt_t
 *
ñt
;

125 
	`ngx_ªgex_mÆloc_öô
(
rc
->
poﬁ
);

127 
ª
 = 
	`p¸e_compûe
((c⁄° *Ë
rc
->
∑âîn
.
d©a
, (Ërc->
›ti⁄s
,

128 &
îr°r
, &
îroff
, 
NULL
);

131 
	`ngx_ªgex_mÆloc_d⁄e
();

133 i‡(
ª
 =
NULL
) {

134 i‡((
size_t
Ë
îroff
 =
rc
->
∑âîn
.
Àn
) {

135 
rc
->
îr
.
Àn
 = 
	`ngx_¢¥ötf
‘c->îr.
d©a
,Ñc->err.len,

137 
îr°r
, &
rc
->
∑âîn
)

138 - 
rc
->
îr
.
d©a
;

141 
rc
->
îr
.
Àn
 = 
	`ngx_¢¥ötf
‘c->îr.
d©a
,Ñc->err.len,

143 
îr°r
, &
rc
->
∑âîn
,Ñc->∑âîn.
d©a
 + 
îroff
)

144 - 
rc
->
îr
.
d©a
;

147  
NGX_ERROR
;

150 
rc
->
ªgex
 = 
	`ngx_pˇŒoc
‘c->
poﬁ
, (
ngx_ªgex_t
));

151 i‡(
rc
->
ªgex
 =
NULL
) {

152  
NGX_ERROR
;

155 
rc
->
ªgex
->
code
 = 
ª
;

159 i‡(
ngx_p¸e_°udõs
 !
NULL
) {

160 
ñt
 = 
	`ngx_li°_push
(
ngx_p¸e_°udõs
);

161 i‡(
ñt
 =
NULL
) {

162  
NGX_ERROR
;

165 
ñt
->
ªgex
 = 
rc
->regex;

166 
ñt
->
«me
 = 
rc
->
∑âîn
.
d©a
;

169 
n
 = 
	`p¸e_fuŒöfo
(
ª
, 
NULL
, 
PCRE_INFO_CAPTURECOUNT
, &
rc
->
ˇ±uªs
);

170 i‡(
n
 < 0) {

171 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_CAPTURECOUNT) failed: %d";

172 
Áûed
;

175 i‡(
rc
->
ˇ±uªs
 == 0) {

176  
NGX_OK
;

179 
n
 = 
	`p¸e_fuŒöfo
(
ª
, 
NULL
, 
PCRE_INFO_NAMECOUNT
, &
rc
->
«med_ˇ±uªs
);

180 i‡(
n
 < 0) {

181 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_NAMECOUNT) failed: %d";

182 
Áûed
;

185 i‡(
rc
->
«med_ˇ±uªs
 == 0) {

186  
NGX_OK
;

189 
n
 = 
	`p¸e_fuŒöfo
(
ª
, 
NULL
, 
PCRE_INFO_NAMEENTRYSIZE
, &
rc
->
«me_size
);

190 i‡(
n
 < 0) {

191 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_NAMEENTRYSIZE) failed: %d";

192 
Áûed
;

195 
n
 = 
	`p¸e_fuŒöfo
(
ª
, 
NULL
, 
PCRE_INFO_NAMETABLE
, &
rc
->
«mes
);

196 i‡(
n
 < 0) {

197 
p
 = "pcre_fullinfo(\"%V\", PCRE_INFO_NAMETABLE) failed: %d";

198 
Áûed
;

201  
NGX_OK
;

203 
Áûed
:

205 
rc
->
îr
.
Àn
 = 
	`ngx_¢¥ötf
‘c->îr.
d©a
,Ñc->îr.Àn, 
p
, &rc->
∑âîn
, 
n
)

206 - 
rc
->
îr
.
d©a
;

207  
NGX_OK
;

208 
	}
}

211 
ngx_öt_t


212 
	$ngx_ªgex_exec_¨øy
(
ngx_¨øy_t
 *
a
, 
ngx_°r_t
 *
s
, 
ngx_log_t
 *
log
)

214 
ngx_öt_t
 
n
;

215 
ngx_uöt_t
 
i
;

216 
ngx_ªgex_ñt_t
 *
ª
;

218 
ª
 = 
a
->
ñts
;

220 
i
 = 0; i < 
a
->
√…s
; i++) {

222 
n
 = 
	`ngx_ªgex_exec
(
ª
[
i
].
ªgex
, 
s
, 
NULL
, 0);

224 i‡(
n
 =
NGX_REGEX_NO_MATCHED
) {

228 i‡(
n
 < 0) {

229 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
log
, 0,

230 
ngx_ªgex_exec_n
 " failed: %i on \"%V\" using \"%s\"",

231 
n
, 
s
, 
ª
[
i
].
«me
);

232  
NGX_ERROR
;

237  
NGX_OK
;

240  
NGX_DECLINED
;

241 
	}
}

244 * 
ngx_libc_cde˛


245 
	$ngx_ªgex_mÆloc
(
size_t
 
size
)

247 
ngx_poﬁ_t
 *
poﬁ
;

248 #i‡(
NGX_THREADS
)

249 
ngx_c‹e_és_t
 *
és
;

251 i‡(
ngx_thªaded
) {

252 
és
 = 
	`ngx_thªad_gë_és
(
ngx_c‹e_és_key
);

253 
poﬁ
 = 
és
->pool;

256 
poﬁ
 = 
ngx_p¸e_poﬁ
;

261 
poﬁ
 = 
ngx_p¸e_poﬁ
;

265 i‡(
poﬁ
) {

266  
	`ngx_∑Œoc
(
poﬁ
, 
size
);

269  
NULL
;

270 
	}
}

273 
ngx_libc_cde˛


274 
	$ngx_ªgex_‰ì
(*
p
)

277 
	}
}

280 #i‡(
NGX_HAVE_PCRE_JIT
)

283 
	$ngx_p¸e_‰ì_°udõs
(*
d©a
)

285 
ngx_li°_t
 *
°udõs
 = 
d©a
;

287 
ngx_uöt_t
 
i
;

288 
ngx_li°_∑π_t
 *
∑π
;

289 
ngx_ªgex_ñt_t
 *
ñts
;

291 
∑π
 = &
°udõs
->part;

292 
ñts
 = 
∑π
->elts;

294 
i
 = 0 ; ; i++) {

296 i‡(
i
 >
∑π
->
√…s
) {

297 i‡(
∑π
->
√xt
 =
NULL
) {

301 
∑π
 =Ö¨t->
√xt
;

302 
ñts
 = 
∑π
->elts;

303 
i
 = 0;

306 i‡(
ñts
[
i
].
ªgex
->
exåa
 !
NULL
) {

307 
	`p¸e_‰ì_°udy
(
ñts
[
i
].
ªgex
->
exåa
);

310 
	}
}

315 
ngx_öt_t


316 
	$ngx_ªgex_moduÀ_öô
(
ngx_cy˛e_t
 *
cy˛e
)

318 
›t
;

319 c⁄° *
îr°r
;

320 
ngx_uöt_t
 
i
;

321 
ngx_li°_∑π_t
 *
∑π
;

322 
ngx_ªgex_ñt_t
 *
ñts
;

324 
›t
 = 0;

326 #i‡(
NGX_HAVE_PCRE_JIT
)

328 
ngx_ªgex_c⁄f_t
 *
rcf
;

329 
ngx_poﬁ_˛ónup_t
 *
˛n
;

331 
rcf
 = (
ngx_ªgex_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
, 
ngx_ªgex_moduÀ
);

333 i‡(
rcf
->
p¸e_jô
) {

334 
›t
 = 
PCRE_STUDY_JIT_COMPILE
;

342 
˛n
 = 
	`ngx_poﬁ_˛ónup_add
(
cy˛e
->
poﬁ
, 0);

343 i‡(
˛n
 =
NULL
) {

344  
NGX_ERROR
;

347 
˛n
->
h™dÀr
 = 
ngx_p¸e_‰ì_°udõs
;

348 
˛n
->
d©a
 = 
ngx_p¸e_°udõs
;

353 
	`ngx_ªgex_mÆloc_öô
(
cy˛e
->
poﬁ
);

355 
∑π
 = &
ngx_p¸e_°udõs
->part;

356 
ñts
 = 
∑π
->elts;

358 
i
 = 0 ; ; i++) {

360 i‡(
i
 >
∑π
->
√…s
) {

361 i‡(
∑π
->
√xt
 =
NULL
) {

365 
∑π
 =Ö¨t->
√xt
;

366 
ñts
 = 
∑π
->elts;

367 
i
 = 0;

370 
ñts
[
i
].
ªgex
->
exåa
 = 
	`p¸e_°udy
”…s[i].ªgex->
code
, 
›t
, &
îr°r
);

372 i‡(
îr°r
 !
NULL
) {

373 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 0,

375 
îr°r
, 
ñts
[
i
].
«me
);

378 #i‡(
NGX_HAVE_PCRE_JIT
)

379 i‡(
›t
 & 
PCRE_STUDY_JIT_COMPILE
) {

380 
jô
, 
n
;

382 
jô
 = 0;

383 
n
 = 
	`p¸e_fuŒöfo
(
ñts
[
i
].
ªgex
->
code
,É…s[i].ªgex->
exåa
,

384 
PCRE_INFO_JIT
, &
jô
);

386 i‡(
n
 !0 || 
jô
 != 1) {

387 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
cy˛e
->
log
, 0,

389 
ñts
[
i
].
«me
);

395 
	`ngx_ªgex_mÆloc_d⁄e
();

397 
ngx_p¸e_°udõs
 = 
NULL
;

399  
NGX_OK
;

400 
	}
}

404 
	$ngx_ªgex_¸óã_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
)

406 
ngx_ªgex_c⁄f_t
 *
rcf
;

408 
rcf
 = 
	`ngx_pˇŒoc
(
cy˛e
->
poﬁ
, (
ngx_ªgex_c⁄f_t
));

409 i‡(
rcf
 =
NULL
) {

410  
NULL
;

413 
rcf
->
p¸e_jô
 = 
NGX_CONF_UNSET
;

415 
ngx_p¸e_°udõs
 = 
	`ngx_li°_¸óã
(
cy˛e
->
poﬁ
, 8, (
ngx_ªgex_ñt_t
));

416 i‡(
ngx_p¸e_°udõs
 =
NULL
) {

417  
NULL
;

420  
rcf
;

421 
	}
}

425 
	$ngx_ªgex_öô_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
, *
c⁄f
)

427 
ngx_ªgex_c⁄f_t
 *
rcf
 = 
c⁄f
;

429 
	`ngx_c⁄f_öô_vÆue
(
rcf
->
p¸e_jô
, 0);

431  
NGX_CONF_OK
;

432 
	}
}

436 
	$ngx_ªgex_p¸e_jô
(
ngx_c⁄f_t
 *
cf
, *
po°
, *
d©a
)

438 
ngx_Êag_t
 *
Â
 = 
d©a
;

440 i‡(*
Â
 == 0) {

441  
NGX_CONF_OK
;

444 #i‡(
NGX_HAVE_PCRE_JIT
)

446 
jô
, 
r
;

448 
jô
 = 0;

449 
r
 = 
	`p¸e_c⁄fig
(
PCRE_CONFIG_JIT
, &
jô
);

451 i‡(
r
 !0 || 
jô
 != 1) {

452 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

454 *
Â
 = 0;

458 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

460 *
Â
 = 0;

463  
NGX_CONF_OK
;

464 
	}
}

	@ngx_regex.h

8 #i‚de‡
_NGX_REGEX_H_INCLUDED_


9 
	#_NGX_REGEX_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

15 
	~<p¸e.h
>

18 
	#NGX_REGEX_NO_MATCHED
 
PCRE_ERROR_NOMATCH


	)

20 
	#NGX_REGEX_CASELESS
 
PCRE_CASELESS


	)

24 
p¸e
 *
	mcode
;

25 
p¸e_exåa
 *
	mexåa
;

26 } 
	tngx_ªgex_t
;

30 
ngx_°r_t
 
	m∑âîn
;

31 
ngx_poﬁ_t
 *
	mpoﬁ
;

32 
ngx_öt_t
 
	m›ti⁄s
;

34 
ngx_ªgex_t
 *
	mªgex
;

35 
	mˇ±uªs
;

36 
	m«med_ˇ±uªs
;

37 
	m«me_size
;

38 
u_ch¨
 *
	m«mes
;

39 
ngx_°r_t
 
	mîr
;

40 } 
	tngx_ªgex_compûe_t
;

44 
ngx_ªgex_t
 *
	mªgex
;

45 
u_ch¨
 *
	m«me
;

46 } 
	tngx_ªgex_ñt_t
;

49 
ngx_ªgex_öô
();

50 
ngx_öt_t
 
ngx_ªgex_compûe
(
ngx_ªgex_compûe_t
 *
rc
);

52 
	#ngx_ªgex_exec
(
ª
, 
s
, 
ˇ±uªs
, 
size
) \

53 
	`p¸e_exec
(
ª
->
code
,Ñe->
exåa
, (c⁄° *Ë(
s
)->
d©a
, (s)->
Àn
, 0, 0, \

54 
ˇ±uªs
, 
size
)

	)

55 
	#ngx_ªgex_exec_n
 "p¸e_exec()"

	)

57 
ngx_öt_t
 
ngx_ªgex_exec_¨øy
(
ngx_¨øy_t
 *
a
, 
ngx_°r_t
 *
s
, 
ngx_log_t
 *
log
);

	@ngx_resolver.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

10 
	~<ngx_evít.h
>

13 
	#NGX_RESOLVER_UDP_SIZE
 4096

	)

17 
u_ch¨
 
	midít_hi
;

18 
u_ch¨
 
	midít_lo
;

19 
u_ch¨
 
	mÊags_hi
;

20 
u_ch¨
 
	mÊags_lo
;

21 
u_ch¨
 
	mnqs_hi
;

22 
u_ch¨
 
	mnqs_lo
;

23 
u_ch¨
 
	m«n_hi
;

24 
u_ch¨
 
	m«n_lo
;

25 
u_ch¨
 
	m¬s_hi
;

26 
u_ch¨
 
	m¬s_lo
;

27 
u_ch¨
 
	m«r_hi
;

28 
u_ch¨
 
	m«r_lo
;

29 } 
	tngx_ªsﬁvî_quîy_t
;

33 
u_ch¨
 
	mty≥_hi
;

34 
u_ch¨
 
	mty≥_lo
;

35 
u_ch¨
 
	m˛ass_hi
;

36 
u_ch¨
 
	m˛ass_lo
;

37 } 
	tngx_ªsﬁvî_qs_t
;

41 
u_ch¨
 
	mty≥_hi
;

42 
u_ch¨
 
	mty≥_lo
;

43 
u_ch¨
 
	m˛ass_hi
;

44 
u_ch¨
 
	m˛ass_lo
;

45 
u_ch¨
 
	mâl
[4];

46 
u_ch¨
 
	mÀn_hi
;

47 
u_ch¨
 
	mÀn_lo
;

48 } 
	tngx_ªsﬁvî_™_t
;

51 
ngx_öt_t
 
ngx_udp_c⁄√˘
(
ngx_udp_c⁄√˘i⁄_t
 *
uc
);

54 
ngx_ªsﬁvî_˛ónup
(*
d©a
);

55 
ngx_ªsﬁvî_˛ónup_åì
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_rbåì_t
 *
åì
);

56 
ngx_öt_t
 
ngx_ªsﬁve_«me_locked
(
ngx_ªsﬁvî_t
 *
r
,

57 
ngx_ªsﬁvî_˘x_t
 *
˘x
);

58 
ngx_ªsﬁvî_expúe
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_rbåì_t
 *
åì
,

59 
ngx_queue_t
 *
queue
);

60 
ngx_öt_t
 
ngx_ªsﬁvî_£nd_quîy
(
ngx_ªsﬁvî_t
 *
r
,

61 
ngx_ªsﬁvî_node_t
 *
∫
);

62 
ngx_öt_t
 
ngx_ªsﬁvî_¸óã_«me_quîy
(
ngx_ªsﬁvî_node_t
 *
∫
,

63 
ngx_ªsﬁvî_˘x_t
 *
˘x
);

64 
ngx_öt_t
 
ngx_ªsﬁvî_¸óã_addr_quîy
(
ngx_ªsﬁvî_node_t
 *
∫
,

65 
ngx_ªsﬁvî_˘x_t
 *
˘x
);

66 
ngx_ªsﬁvî_ª£nd_h™dÀr
(
ngx_evít_t
 *
ev
);

67 
time_t
 
ngx_ªsﬁvî_ª£nd
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_rbåì_t
 *
åì
,

68 
ngx_queue_t
 *
queue
);

69 
ngx_ªsﬁvî_ªad_ª•⁄£
(
ngx_evít_t
 *
ªv
);

70 
ngx_ªsﬁvî_¥o˚ss_ª•⁄£
(
ngx_ªsﬁvî_t
 *
r
, 
u_ch¨
 *
buf
,

71 
size_t
 
n
);

72 
ngx_ªsﬁvî_¥o˚ss_a
(
ngx_ªsﬁvî_t
 *
r
, 
u_ch¨
 *
buf
, 
size_t
 
n
,

73 
ngx_uöt_t
 
idít
,Çgx_uöt_à
code
,Çgx_uöt_à
«n
,Çgx_uöt_à
™s
);

74 
ngx_ªsﬁvî_¥o˚ss_±r
(
ngx_ªsﬁvî_t
 *
r
, 
u_ch¨
 *
buf
, 
size_t
 
n
,

75 
ngx_uöt_t
 
idít
,Çgx_uöt_à
code
,Çgx_uöt_à
«n
);

76 
ngx_ªsﬁvî_node_t
 *
ngx_ªsﬁvî_lookup_«me
(
ngx_ªsﬁvî_t
 *
r
,

77 
ngx_°r_t
 *
«me
, 
uöt32_t
 
hash
);

78 
ngx_ªsﬁvî_node_t
 *
ngx_ªsﬁvî_lookup_addr
(
ngx_ªsﬁvî_t
 *
r
,

79 
ö_addr_t
 
addr
);

80 
ngx_ªsﬁvî_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,

81 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
);

82 
ngx_öt_t
 
ngx_ªsﬁvî_c›y
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_°r_t
 *
«me
,

83 
u_ch¨
 *
buf
, u_ch¨ *
§c
, u_ch¨ *
œ°
);

84 
ngx_ªsﬁvî_timeout_h™dÀr
(
ngx_evít_t
 *
ev
);

85 
ngx_ªsﬁvî_‰ì_node
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_ªsﬁvî_node_t
 *
∫
);

86 *
ngx_ªsﬁvî_Æloc
(
ngx_ªsﬁvî_t
 *
r
, 
size_t
 
size
);

87 *
ngx_ªsﬁvî_ˇŒoc
(
ngx_ªsﬁvî_t
 *
r
, 
size_t
 
size
);

88 
ngx_ªsﬁvî_‰ì
(
ngx_ªsﬁvî_t
 *
r
, *
p
);

89 
ngx_ªsﬁvî_‰ì_locked
(
ngx_ªsﬁvî_t
 *
r
, *
p
);

90 *
ngx_ªsﬁvî_dup
(
ngx_ªsﬁvî_t
 *
r
, *
§c
, 
size_t
 
size
);

91 
u_ch¨
 *
ngx_ªsﬁvî_log_îr‹
(
ngx_log_t
 *
log
, u_ch¨ *
buf
, 
size_t
 
Àn
);

94 
ngx_ªsﬁvî_t
 *

95 
	$ngx_ªsﬁvî_¸óã
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
«mes
, 
ngx_uöt_t
 
n
)

97 
ngx_°r_t
 
s
;

98 
ngx_uæ_t
 
u
;

99 
ngx_uöt_t
 
i
, 
j
;

100 
ngx_ªsﬁvî_t
 *
r
;

101 
ngx_poﬁ_˛ónup_t
 *
˛n
;

102 
ngx_udp_c⁄√˘i⁄_t
 *
uc
;

104 
˛n
 = 
	`ngx_poﬁ_˛ónup_add
(
cf
->
poﬁ
, 0);

105 i‡(
˛n
 =
NULL
) {

106  
NULL
;

109 
˛n
->
h™dÀr
 = 
ngx_ªsﬁvî_˛ónup
;

111 
r
 = 
	`ngx_ˇŒoc
((
ngx_ªsﬁvî_t
), 
cf
->
log
);

112 i‡(
r
 =
NULL
) {

113  
NULL
;

116 i‡(
n
) {

117 i‡(
	`ngx_¨øy_öô
(&
r
->
udp_c⁄√˘i⁄s
, 
cf
->
poﬁ
, 
n
,

118 (
ngx_udp_c⁄√˘i⁄_t
))

119 !
NGX_OK
)

121  
NULL
;

125 
˛n
->
d©a
 = 
r
;

127 
r
->
evít
 = 
	`ngx_ˇŒoc
((
ngx_evít_t
), 
cf
->
log
);

128 i‡(
r
->
evít
 =
NULL
) {

129  
NULL
;

132 
	`ngx_rbåì_öô
(&
r
->
«me_rbåì
, &r->
«me_£¡öñ
,

133 
ngx_ªsﬁvî_rbåì_ö£π_vÆue
);

135 
	`ngx_rbåì_öô
(&
r
->
addr_rbåì
, &r->
addr_£¡öñ
,

136 
ngx_rbåì_ö£π_vÆue
);

138 
	`ngx_queue_öô
(&
r
->
«me_ª£nd_queue
);

139 
	`ngx_queue_öô
(&
r
->
addr_ª£nd_queue
);

141 
	`ngx_queue_öô
(&
r
->
«me_expúe_queue
);

142 
	`ngx_queue_öô
(&
r
->
addr_expúe_queue
);

144 
r
->
evít
->
h™dÀr
 = 
ngx_ªsﬁvî_ª£nd_h™dÀr
;

145 
r
->
evít
->
d©a
 =Ñ;

146 
r
->
evít
->
log
 = &
cf
->
cy˛e
->
√w_log
;

147 
r
->
idít
 = -1;

149 
r
->
ª£nd_timeout
 = 5;

150 
r
->
expúe
 = 30;

151 
r
->
vÆid
 = 0;

153 
r
->
log
 = &
cf
->
cy˛e
->
√w_log
;

154 
r
->
log_Àvñ
 = 
NGX_LOG_ERR
;

156 
i
 = 0; i < 
n
; i++) {

157 i‡(
	`ngx_°∫cmp
(
«mes
[
i
].
d©a
, "valid=", 6) == 0) {

158 
s
.
Àn
 = 
«mes
[
i
].len - 6;

159 
s
.
d©a
 = 
«mes
[
i
].data + 6;

161 
r
->
vÆid
 = 
	`ngx_∑r£_time
(&
s
, 1);

163 i‡(
r
->
vÆid
 =(
time_t
Ë
NGX_ERROR
) {

164 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

165 "övÆidÖ¨amëî: %V", &
«mes
[
i
]);

166  
NULL
;

172 
	`ngx_memzîo
(&
u
, (
ngx_uæ_t
));

174 
u
.
uæ
 = 
«mes
[
i
];

175 
u
.
deÁu…_p‹t
 = 53;

177 i‡(
	`ngx_∑r£_uæ
(
cf
->
poﬁ
, &
u
Ë!
NGX_OK
) {

178 i‡(
u
.
îr
) {

179 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

181 
u
.
îr
, &u.
uæ
);

184  
NULL
;

187 
uc
 = 
	`ngx_¨øy_push_n
(&
r
->
udp_c⁄√˘i⁄s
, 
u
.
«ddrs
);

188 i‡(
uc
 =
NULL
) {

189  
NULL
;

192 
	`ngx_memzîo
(
uc
, 
u
.
«ddrs
 * (
ngx_udp_c⁄√˘i⁄_t
));

194 
j
 = 0; j < 
u
.
«ddrs
; j++) {

195 
uc
[
j
].
sockaddr
 = 
u
.
addrs
[j].sockaddr;

196 
uc
[
j
].
sockÀn
 = 
u
.
addrs
[j].socklen;

197 
uc
[
j
].
£rvî
 = 
u
.
addrs
[j].
«me
;

201  
r
;

202 
	}
}

206 
	$ngx_ªsﬁvî_˛ónup
(*
d©a
)

208 
ngx_ªsﬁvî_t
 *
r
 = 
d©a
;

210 
ngx_uöt_t
 
i
;

211 
ngx_udp_c⁄√˘i⁄_t
 *
uc
;

213 i‡(
r
) {

214 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

217 
	`ngx_ªsﬁvî_˛ónup_åì
(
r
, &r->
«me_rbåì
);

219 
	`ngx_ªsﬁvî_˛ónup_åì
(
r
, &r->
addr_rbåì
);

221 i‡(
r
->
evít
) {

222 
	`ngx_‰ì
(
r
->
evít
);

226 
uc
 = 
r
->
udp_c⁄√˘i⁄s
.
ñts
;

228 
i
 = 0; i < 
r
->
udp_c⁄√˘i⁄s
.
√…s
; i++) {

229 i‡(
uc
[
i
].
c⁄√˘i⁄
) {

230 
	`ngx_˛o£_c⁄√˘i⁄
(
uc
[
i
].
c⁄√˘i⁄
);

234 
	`ngx_‰ì
(
r
);

236 
	}
}

240 
	$ngx_ªsﬁvî_˛ónup_åì
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_rbåì_t
 *
åì
)

242 
ngx_ªsﬁvî_˘x_t
 *
˘x
, *
√xt
;

243 
ngx_ªsﬁvî_node_t
 *
∫
;

245 
åì
->
roŸ
 !åì->
£¡öñ
) {

247 
∫
 = (
ngx_ªsﬁvî_node_t
 *Ë
	`ngx_rbåì_mö
(
åì
->
roŸ
,Åªe->
£¡öñ
);

249 
	`ngx_queue_ªmove
(&
∫
->
queue
);

251 
˘x
 = 
∫
->
waôög
; ctx; ctx = 
√xt
) {

252 
√xt
 = 
˘x
->next;

254 i‡(
˘x
->
evít
) {

255 
	`ngx_ªsﬁvî_‰ì
(
r
, 
˘x
->
evít
);

258 
	`ngx_ªsﬁvî_‰ì
(
r
, 
˘x
);

261 
	`ngx_rbåì_dñëe
(
åì
, &
∫
->
node
);

263 
	`ngx_ªsﬁvî_‰ì_node
(
r
, 
∫
);

265 
	}
}

268 
ngx_ªsﬁvî_˘x_t
 *

269 
	$ngx_ªsﬁve_°¨t
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_ªsﬁvî_˘x_t
 *
ãmp
)

271 
ö_addr_t
 
addr
;

272 
ngx_ªsﬁvî_˘x_t
 *
˘x
;

274 i‡(
ãmp
) {

275 
addr
 = 
	`ngx_öë_addr
(
ãmp
->
«me
.
d©a
,Åemp->«me.
Àn
);

277 i‡(
addr
 !
INADDR_NONE
) {

278 
ãmp
->
ªsﬁvî
 = 
r
;

279 
ãmp
->
°©e
 = 
NGX_OK
;

280 
ãmp
->
«ddrs
 = 1;

281 
ãmp
->
addrs
 = &ãmp->
addr
;

282 
ãmp
->
addr
 =áddr;

283 
ãmp
->
quick
 = 1;

285  
ãmp
;

289 i‡(
r
->
udp_c⁄√˘i⁄s
.
√…s
 == 0) {

290  
NGX_NO_RESOLVER
;

293 
˘x
 = 
	`ngx_ªsﬁvî_ˇŒoc
(
r
, (
ngx_ªsﬁvî_˘x_t
));

295 i‡(
˘x
) {

296 
˘x
->
ªsﬁvî
 = 
r
;

299  
˘x
;

300 
	}
}

303 
ngx_öt_t


304 
	$ngx_ªsﬁve_«me
(
ngx_ªsﬁvî_˘x_t
 *
˘x
)

306 
ngx_öt_t
 
rc
;

307 
ngx_ªsﬁvî_t
 *
r
;

309 
r
 = 
˘x
->
ªsﬁvî
;

311 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

312 "ªsﬁve: \"%V\"", &
˘x
->
«me
);

314 i‡(
˘x
->
quick
) {

315 
˘x
->
	`h™dÀr
(ctx);

316  
NGX_OK
;

321 
rc
 = 
	`ngx_ªsﬁve_«me_locked
(
r
, 
˘x
);

323 i‡(
rc
 =
NGX_OK
) {

324  
NGX_OK
;

329 i‡(
rc
 =
NGX_AGAIN
) {

330  
NGX_OK
;

335 i‡(
˘x
->
evít
) {

336 
	`ngx_ªsﬁvî_‰ì
(
r
, 
˘x
->
evít
);

339 
	`ngx_ªsﬁvî_‰ì
(
r
, 
˘x
);

341  
NGX_ERROR
;

342 
	}
}

346 
	$ngx_ªsﬁve_«me_d⁄e
(
ngx_ªsﬁvî_˘x_t
 *
˘x
)

348 
uöt32_t
 
hash
;

349 
ngx_ªsﬁvî_t
 *
r
;

350 
ngx_ªsﬁvî_˘x_t
 *
w
, **
p
;

351 
ngx_ªsﬁvî_node_t
 *
∫
;

353 
r
 = 
˘x
->
ªsﬁvî
;

355 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

356 "ªsﬁvê«mêd⁄e: %i", 
˘x
->
°©e
);

358 i‡(
˘x
->
quick
) {

362 i‡(
˘x
->
evít
 && ctx->evít->
timî_£t
) {

363 
	`ngx_dñ_timî
(
˘x
->
evít
);

368 i‡(
˘x
->
°©e
 =
NGX_AGAIN
 || ctx->°©ê=
NGX_RESOLVE_TIMEDOUT
) {

370 
hash
 = 
	`ngx_¸c32_sh‹t
(
˘x
->
«me
.
d©a
, ctx->«me.
Àn
);

372 
∫
 = 
	`ngx_ªsﬁvî_lookup_«me
(
r
, &
˘x
->
«me
, 
hash
);

374 i‡(
∫
) {

375 
p
 = &
∫
->
waôög
;

376 
w
 = 
∫
->
waôög
;

378 
w
) {

379 i‡(
w
 =
˘x
) {

380 *
p
 = 
w
->
√xt
;

382 
d⁄e
;

385 
p
 = &
w
->
√xt
;

386 
w
 = w->
√xt
;

390 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
r
->
log
, 0,

391 "couldÇŸ c™˚»%VÑesﬁvög", &
˘x
->
«me
);

394 
d⁄e
:

396 
	`ngx_ªsﬁvî_expúe
(
r
, &r->
«me_rbåì
, &r->
«me_expúe_queue
);

402 i‡(
˘x
->
evít
) {

403 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
˘x
->
evít
);

406 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
˘x
);

409 
	}
}

414 
ngx_öt_t


415 
	$ngx_ªsﬁve_«me_locked
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_ªsﬁvî_˘x_t
 *
˘x
)

417 
uöt32_t
 
hash
;

418 
ö_addr_t
 
addr
, *
addrs
;

419 
ngx_öt_t
 
rc
;

420 
ngx_uöt_t
 
«ddrs
;

421 
ngx_ªsﬁvî_˘x_t
 *
√xt
;

422 
ngx_ªsﬁvî_node_t
 *
∫
;

424 
hash
 = 
	`ngx_¸c32_sh‹t
(
˘x
->
«me
.
d©a
, ctx->«me.
Àn
);

426 
∫
 = 
	`ngx_ªsﬁvî_lookup_«me
(
r
, &
˘x
->
«me
, 
hash
);

428 i‡(
∫
) {

430 i‡(
∫
->
vÆid
 >
	`ngx_time
()) {

432 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "resolve cached");

434 
	`ngx_queue_ªmove
(&
∫
->
queue
);

436 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->expire;

438 
	`ngx_queue_ö£π_hód
(&
r
->
«me_expúe_queue
, &
∫
->
queue
);

440 
«ddrs
 = 
∫
->naddrs;

442 i‡(
«ddrs
) {

446 i‡(
«ddrs
 != 1) {

447 
addr
 = 0;

448 
addrs
 = 
	`ngx_ªsﬁvî_dup
(
r
, 
∫
->
u
.addrs,

449 
«ddrs
 * (
ö_addr_t
));

450 i‡(
addrs
 =
NULL
) {

451  
NGX_ERROR
;

455 
addr
 = 
∫
->
u
.addr;

456 
addrs
 = 
NULL
;

459 
˘x
->
√xt
 = 
∫
->
waôög
;

460 
∫
->
waôög
 = 
NULL
;

465 
˘x
->
°©e
 = 
NGX_OK
;

466 
˘x
->
«ddrs
 =Çaddrs;

467 
˘x
->
addrs
 = (
«ddrs
 =1Ë? &˘x->
addr
 :áddrs;

468 
˘x
->
addr
 =áddr;

469 
√xt
 = 
˘x
->next;

471 
˘x
->
	`h™dÀr
(ctx);

473 
˘x
 = 
√xt
;

474 } 
˘x
);

476 i‡(
addrs
) {

477 
	`ngx_ªsﬁvî_‰ì
(
r
, 
addrs
);

480  
NGX_OK
;

485 i‡(
˘x
->
ªcursi⁄
++ < 
NGX_RESOLVER_MAX_RECURSION
) {

487 
˘x
->
«me
.
Àn
 = 
∫
->
˙Àn
;

488 
˘x
->
«me
.
d©a
 = 
∫
->
u
.
˙ame
;

490  
	`ngx_ªsﬁve_«me_locked
(
r
, 
˘x
);

493 
˘x
->
√xt
 = 
∫
->
waôög
;

494 
∫
->
waôög
 = 
NULL
;

499 
˘x
->
°©e
 = 
NGX_RESOLVE_NXDOMAIN
;

500 
√xt
 = 
˘x
->next;

502 
˘x
->
	`h™dÀr
(ctx);

504 
˘x
 = 
√xt
;

505 } 
˘x
);

507  
NGX_OK
;

510 i‡(
∫
->
waôög
) {

512 
˘x
->
√xt
 = 
∫
->
waôög
;

513 
∫
->
waôög
 = 
˘x
;

514 
˘x
->
°©e
 = 
NGX_AGAIN
;

516  
NGX_AGAIN
;

519 
	`ngx_queue_ªmove
(&
∫
->
queue
);

523 i‡(
∫
->
quîy
) {

524 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
quîy
);

525 
∫
->
quîy
 = 
NULL
;

528 i‡(
∫
->
˙Àn
) {

529 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
u
.
˙ame
);

532 i‡(
∫
->
«ddrs
 > 1) {

533 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
u
.
addrs
);

540 
∫
 = 
	`ngx_ªsﬁvî_Æloc
(
r
, (
ngx_ªsﬁvî_node_t
));

541 i‡(
∫
 =
NULL
) {

542  
NGX_ERROR
;

545 
∫
->
«me
 = 
	`ngx_ªsﬁvî_dup
(
r
, 
˘x
->«me.
d©a
, ctx->«me.
Àn
);

546 i‡(
∫
->
«me
 =
NULL
) {

547 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
);

548  
NGX_ERROR
;

551 
∫
->
node
.
key
 = 
hash
;

552 
∫
->
∆í
 = (
u_sh‹t
Ë
˘x
->
«me
.
Àn
;

553 
∫
->
quîy
 = 
NULL
;

555 
	`ngx_rbåì_ö£π
(&
r
->
«me_rbåì
, &
∫
->
node
);

558 
rc
 = 
	`ngx_ªsﬁvî_¸óã_«me_quîy
(
∫
, 
˘x
);

560 i‡(
rc
 =
NGX_ERROR
) {

561 
Áûed
;

564 i‡(
rc
 =
NGX_DECLINED
) {

565 
	`ngx_rbåì_dñëe
(&
r
->
«me_rbåì
, &
∫
->
node
);

567 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
quîy
);

568 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
«me
);

569 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
);

571 
˘x
->
°©e
 = 
NGX_RESOLVE_NXDOMAIN
;

572 
˘x
->
	`h™dÀr
(ctx);

574  
NGX_OK
;

577 i‡(
	`ngx_ªsﬁvî_£nd_quîy
(
r
, 
∫
Ë!
NGX_OK
) {

578 
Áûed
;

581 i‡(
˘x
->
evít
 =
NULL
) {

582 
˘x
->
evít
 = 
	`ngx_ªsﬁvî_ˇŒoc
(
r
, (
ngx_evít_t
));

583 i‡(
˘x
->
evít
 =
NULL
) {

584 
Áûed
;

587 
˘x
->
evít
->
h™dÀr
 = 
ngx_ªsﬁvî_timeout_h™dÀr
;

588 
˘x
->
evít
->
d©a
 = ctx;

589 
˘x
->
evít
->
log
 = 
r
->log;

590 
˘x
->
idít
 = -1;

592 
	`ngx_add_timî
(
˘x
->
evít
, ctx->
timeout
);

595 i‡(
	`ngx_queue_em±y
(&
r
->
«me_ª£nd_queue
)) {

596 
	`ngx_add_timî
(
r
->
evít
, (
ngx_m£c_t
Ë‘->
ª£nd_timeout
 * 1000));

599 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->
ª£nd_timeout
;

601 
	`ngx_queue_ö£π_hód
(&
r
->
«me_ª£nd_queue
, &
∫
->
queue
);

603 
∫
->
˙Àn
 = 0;

604 
∫
->
«ddrs
 = 0;

605 
∫
->
vÆid
 = 0;

606 
∫
->
waôög
 = 
˘x
;

608 
˘x
->
°©e
 = 
NGX_AGAIN
;

610  
NGX_AGAIN
;

612 
Áûed
:

614 
	`ngx_rbåì_dñëe
(&
r
->
«me_rbåì
, &
∫
->
node
);

616 i‡(
∫
->
quîy
) {

617 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
quîy
);

620 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
«me
);

622 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
);

624  
NGX_ERROR
;

625 
	}
}

628 
ngx_öt_t


629 
	$ngx_ªsﬁve_addr
(
ngx_ªsﬁvî_˘x_t
 *
˘x
)

631 
u_ch¨
 *
«me
;

632 
ngx_ªsﬁvî_t
 *
r
;

633 
ngx_ªsﬁvî_node_t
 *
∫
;

635 
r
 = 
˘x
->
ªsﬁvî
;

637 
˘x
->
addr
 = 
	`¡ohl
(ctx->addr);

641 
∫
 = 
	`ngx_ªsﬁvî_lookup_addr
(
r
, 
˘x
->
addr
);

643 i‡(
∫
) {

645 i‡(
∫
->
vÆid
 >
	`ngx_time
()) {

647 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "resolve cached");

649 
	`ngx_queue_ªmove
(&
∫
->
queue
);

651 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->expire;

653 
	`ngx_queue_ö£π_hód
(&
r
->
addr_expúe_queue
, &
∫
->
queue
);

655 
«me
 = 
	`ngx_ªsﬁvî_dup
(
r
, 
∫
->«me,Ñn->
∆í
);

656 i‡(
«me
 =
NULL
) {

657 
Áûed
;

660 
˘x
->
«me
.
Àn
 = 
∫
->
∆í
;

661 
˘x
->
«me
.
d©a
 =Çame;

665 
˘x
->
°©e
 = 
NGX_OK
;

667 
˘x
->
	`h™dÀr
(ctx);

669 
	`ngx_ªsﬁvî_‰ì
(
r
, 
«me
);

671  
NGX_OK
;

674 i‡(
∫
->
waôög
) {

676 
˘x
->
√xt
 = 
∫
->
waôög
;

677 
∫
->
waôög
 = 
˘x
;

678 
˘x
->
°©e
 = 
NGX_AGAIN
;

682  
NGX_OK
;

685 
	`ngx_queue_ªmove
(&
∫
->
queue
);

687 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
quîy
);

688 
∫
->
quîy
 = 
NULL
;

691 
∫
 = 
	`ngx_ªsﬁvî_Æloc
(
r
, (
ngx_ªsﬁvî_node_t
));

692 i‡(
∫
 =
NULL
) {

693 
Áûed
;

696 
∫
->
node
.
key
 = 
˘x
->
addr
;

697 
∫
->
quîy
 = 
NULL
;

699 
	`ngx_rbåì_ö£π
(&
r
->
addr_rbåì
, &
∫
->
node
);

702 i‡(
	`ngx_ªsﬁvî_¸óã_addr_quîy
(
∫
, 
˘x
Ë!
NGX_OK
) {

703 
Áûed
;

706 i‡(
	`ngx_ªsﬁvî_£nd_quîy
(
r
, 
∫
Ë!
NGX_OK
) {

707 
Áûed
;

710 
˘x
->
evít
 = 
	`ngx_ªsﬁvî_ˇŒoc
(
r
, (
ngx_evít_t
));

711 i‡(
˘x
->
evít
 =
NULL
) {

712 
Áûed
;

715 
˘x
->
evít
->
h™dÀr
 = 
ngx_ªsﬁvî_timeout_h™dÀr
;

716 
˘x
->
evít
->
d©a
 = ctx;

717 
˘x
->
evít
->
log
 = 
r
->log;

718 
˘x
->
idít
 = -1;

720 
	`ngx_add_timî
(
˘x
->
evít
, ctx->
timeout
);

722 i‡(
	`ngx_queue_em±y
(&
r
->
addr_ª£nd_queue
)) {

723 
	`ngx_add_timî
(
r
->
evít
, (
ngx_m£c_t
Ë‘->
ª£nd_timeout
 * 1000));

726 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->
ª£nd_timeout
;

728 
	`ngx_queue_ö£π_hód
(&
r
->
addr_ª£nd_queue
, &
∫
->
queue
);

730 
∫
->
˙Àn
 = 0;

731 
∫
->
«ddrs
 = 0;

732 
∫
->
«me
 = 
NULL
;

733 
∫
->
∆í
 = 0;

734 
∫
->
vÆid
 = 0;

735 
∫
->
waôög
 = 
˘x
;

739 
˘x
->
°©e
 = 
NGX_AGAIN
;

741  
NGX_OK
;

743 
Áûed
:

745 i‡(
∫
) {

746 
	`ngx_rbåì_dñëe
(&
r
->
addr_rbåì
, &
∫
->
node
);

748 i‡(
∫
->
quîy
) {

749 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
quîy
);

752 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
);

757 i‡(
˘x
->
evít
) {

758 
	`ngx_ªsﬁvî_‰ì
(
r
, 
˘x
->
evít
);

761 
	`ngx_ªsﬁvî_‰ì
(
r
, 
˘x
);

763  
NGX_ERROR
;

764 
	}
}

768 
	$ngx_ªsﬁve_addr_d⁄e
(
ngx_ªsﬁvî_˘x_t
 *
˘x
)

770 
ö_addr_t
 
addr
;

771 
ngx_ªsﬁvî_t
 *
r
;

772 
ngx_ªsﬁvî_˘x_t
 *
w
, **
p
;

773 
ngx_ªsﬁvî_node_t
 *
∫
;

775 
r
 = 
˘x
->
ªsﬁvî
;

777 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

778 "ªsﬁvêadd∏d⁄e: %i", 
˘x
->
°©e
);

780 i‡(
˘x
->
evít
 && ctx->evít->
timî_£t
) {

781 
	`ngx_dñ_timî
(
˘x
->
evít
);

786 i‡(
˘x
->
°©e
 =
NGX_AGAIN
 || ctx->°©ê=
NGX_RESOLVE_TIMEDOUT
) {

788 
∫
 = 
	`ngx_ªsﬁvî_lookup_addr
(
r
, 
˘x
->
addr
);

790 i‡(
∫
) {

791 
p
 = &
∫
->
waôög
;

792 
w
 = 
∫
->
waôög
;

794 
w
) {

795 i‡(
w
 =
˘x
) {

796 *
p
 = 
w
->
√xt
;

798 
d⁄e
;

801 
p
 = &
w
->
√xt
;

802 
w
 = w->
√xt
;

806 
addr
 = 
	`¡ohl
(
˘x
->addr);

808 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
r
->
log
, 0,

810 (
addr
 >> 24) & 0xff, (addr >> 16) & 0xff,

811 (
addr
 >> 8) & 0xff,áddr & 0xff);

814 
d⁄e
:

816 
	`ngx_ªsﬁvî_expúe
(
r
, &r->
addr_rbåì
, &r->
addr_expúe_queue
);

822 i‡(
˘x
->
evít
) {

823 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
˘x
->
evít
);

826 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
˘x
);

829 
	}
}

833 
	$ngx_ªsﬁvî_expúe
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_rbåì_t
 *
åì
, 
ngx_queue_t
 *
queue
)

835 
time_t
 
now
;

836 
ngx_uöt_t
 
i
;

837 
ngx_queue_t
 *
q
;

838 
ngx_ªsﬁvî_node_t
 *
∫
;

840 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "resolverÉxpire");

842 
now
 = 
	`ngx_time
();

844 
i
 = 0; i < 2; i++) {

845 i‡(
	`ngx_queue_em±y
(
queue
)) {

849 
q
 = 
	`ngx_queue_œ°
(
queue
);

851 
∫
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ªsﬁvî_node_t
, 
queue
);

853 i‡(
now
 <
∫
->
expúe
) {

857 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

858 "ªsﬁvîÉxpúê\"%*s\"", (
size_t
Ë
∫
->
∆í
,Ñn->
«me
);

860 
	`ngx_queue_ªmove
(
q
);

862 
	`ngx_rbåì_dñëe
(
åì
, &
∫
->
node
);

864 
	`ngx_ªsﬁvî_‰ì_node
(
r
, 
∫
);

866 
	}
}

869 
ngx_öt_t


870 
	$ngx_ªsﬁvî_£nd_quîy
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_ªsﬁvî_node_t
 *
∫
)

872 
ssize_t
 
n
;

873 
ngx_udp_c⁄√˘i⁄_t
 *
uc
;

875 
uc
 = 
r
->
udp_c⁄√˘i⁄s
.
ñts
;

877 
uc
 = &uc[
r
->
œ°_c⁄√˘i⁄
++];

878 i‡(
r
->
œ°_c⁄√˘i⁄
 =r->
udp_c⁄√˘i⁄s
.
√…s
) {

879 
r
->
œ°_c⁄√˘i⁄
 = 0;

882 i‡(
uc
->
c⁄√˘i⁄
 =
NULL
) {

884 
uc
->
log
 = *
r
->log;

885 
uc
->
log
.
h™dÀr
 = 
ngx_ªsﬁvî_log_îr‹
;

886 
uc
->
log
.
d©a
 = uc;

887 
uc
->
log
.
a˘i⁄
 = "resolving";

889 i‡(
	`ngx_udp_c⁄√˘
(
uc
Ë!
NGX_OK
) {

890  
NGX_ERROR
;

893 
uc
->
c⁄√˘i⁄
->
d©a
 = 
r
;

894 
uc
->
c⁄√˘i⁄
->
ªad
->
h™dÀr
 = 
ngx_ªsﬁvî_ªad_ª•⁄£
;

895 
uc
->
c⁄√˘i⁄
->
ªad
->
ªsﬁvî
 = 1;

898 
n
 = 
	`ngx_£nd
(
uc
->
c⁄√˘i⁄
, 
∫
->
quîy
,Ñn->
qÀn
);

900 i‡(
n
 == -1) {

901  
NGX_ERROR
;

904 i‡((
size_t
Ë
n
 !(size_tË
∫
->
qÀn
) {

905 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, &
uc
->
log
, 0, "send() incomplete");

906  
NGX_ERROR
;

909  
NGX_OK
;

910 
	}
}

914 
	$ngx_ªsﬁvî_ª£nd_h™dÀr
(
ngx_evít_t
 *
ev
)

916 
time_t
 
timî
, 
©imî
, 
¡imî
;

917 
ngx_ªsﬁvî_t
 *
r
;

919 
r
 = 
ev
->
d©a
;

921 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

926 
¡imî
 = 
	`ngx_ªsﬁvî_ª£nd
(
r
, &r->
«me_rbåì
, &r->
«me_ª£nd_queue
);

932 
©imî
 = 
	`ngx_ªsﬁvî_ª£nd
(
r
, &r->
addr_rbåì
, &r->
addr_ª£nd_queue
);

936 i‡(
¡imî
 == 0) {

937 
timî
 = 
©imî
;

939 } i‡(
©imî
 == 0) {

940 
timî
 = 
¡imî
;

943 
timî
 = (
©imî
 < 
¡imî
) ?átimer :Çtimer;

946 i‡(
timî
) {

947 
	`ngx_add_timî
(
r
->
evít
, (
ngx_m£c_t
Ë(
timî
 * 1000));

949 
	}
}

952 
time_t


953 
	$ngx_ªsﬁvî_ª£nd
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_rbåì_t
 *
åì
, 
ngx_queue_t
 *
queue
)

955 
time_t
 
now
;

956 
ngx_queue_t
 *
q
;

957 
ngx_ªsﬁvî_node_t
 *
∫
;

959 
now
 = 
	`ngx_time
();

962 i‡(
	`ngx_queue_em±y
(
queue
)) {

966 
q
 = 
	`ngx_queue_œ°
(
queue
);

968 
∫
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ªsﬁvî_node_t
, 
queue
);

970 i‡(
now
 < 
∫
->
expúe
) {

971  
∫
->
expúe
 - 
now
;

974 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

976 (
size_t
Ë
∫
->
∆í
,Ñn->
«me
,Ñn->
waôög
);

978 
	`ngx_queue_ªmove
(
q
);

980 i‡(
∫
->
waôög
) {

982 (Ë
	`ngx_ªsﬁvî_£nd_quîy
(
r
, 
∫
);

984 
∫
->
expúe
 = 
now
 + 
r
->
ª£nd_timeout
;

986 
	`ngx_queue_ö£π_hód
(
queue
, 
q
);

991 
	`ngx_rbåì_dñëe
(
åì
, &
∫
->
node
);

993 
	`ngx_ªsﬁvî_‰ì_node
(
r
, 
∫
);

995 
	}
}

999 
	$ngx_ªsﬁvî_ªad_ª•⁄£
(
ngx_evít_t
 *
ªv
)

1001 
ssize_t
 
n
;

1002 
ngx_c⁄√˘i⁄_t
 *
c
;

1003 
u_ch¨
 
buf
[
NGX_RESOLVER_UDP_SIZE
];

1005 
c
 = 
ªv
->
d©a
;

1008 
n
 = 
	`ngx_udp_ªcv
(
c
, 
buf
, 
NGX_RESOLVER_UDP_SIZE
);

1010 i‡(
n
 < 0) {

1014 
	`ngx_ªsﬁvî_¥o˚ss_ª•⁄£
(
c
->
d©a
, 
buf
, 
n
);

1016 } 
ªv
->
ªady
);

1017 
	}
}

1021 
	$ngx_ªsﬁvî_¥o˚ss_ª•⁄£
(
ngx_ªsﬁvî_t
 *
r
, 
u_ch¨
 *
buf
, 
size_t
 
n
)

1023 *
îr
;

1024 
size_t
 
Àn
;

1025 
ngx_uöt_t
 
i
, 
times
, 
idít
, 
qidít
, 
Êags
, 
code
, 
nqs
, 
«n
,

1026 
qty≥
, 
q˛ass
;

1027 
ngx_queue_t
 *
q
;

1028 
ngx_ªsﬁvî_qs_t
 *
qs
;

1029 
ngx_ªsﬁvî_node_t
 *
∫
;

1030 
ngx_ªsﬁvî_quîy_t
 *
quîy
;

1032 i‡((
size_t
Ë
n
 < (
ngx_ªsﬁvî_quîy_t
)) {

1033 
sh‹t_ª•⁄£
;

1036 
quîy
 = (
ngx_ªsﬁvî_quîy_t
 *Ë
buf
;

1038 
idít
 = (
quîy
->
idít_hi
 << 8Ë+ quîy->
idít_lo
;

1039 
Êags
 = (
quîy
->
Êags_hi
 << 8Ë+ quîy->
Êags_lo
;

1040 
nqs
 = (
quîy
->
nqs_hi
 << 8Ë+ quîy->
nqs_lo
;

1041 
«n
 = (
quîy
->
«n_hi
 << 8Ë+ quîy->
«n_lo
;

1043 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1045 
idít
, 
Êags
, 
nqs
, 
«n
,

1046 (
quîy
->
¬s_hi
 << 8Ë+ quîy->
¬s_lo
,

1047 (
quîy
->
«r_hi
 << 8Ë+ quîy->
«r_lo
);

1049 i‡(!(
Êags
 & 0x8000)) {

1050 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1051 "övÆid DNSÑe•⁄£ %uòÊ:%04Xui", 
idít
, 
Êags
);

1055 
code
 = 
Êags
 & 0x7f;

1057 i‡(
code
 =
NGX_RESOLVE_FORMERR
) {

1059 
times
 = 0;

1061 
q
 = 
	`ngx_queue_hód
(&
r
->
«me_ª£nd_queue
);

1062 
q
 !
	`ngx_queue_£¡öñ
(&
r
->
«me_ª£nd_queue
Ë|| 
times
++ < 100;

1063 
q
 = 
	`ngx_queue_√xt
(q))

1065 
∫
 = 
	`ngx_queue_d©a
(
q
, 
ngx_ªsﬁvî_node_t
, 
queue
);

1066 
qidít
 = (
∫
->
quîy
[0] << 8) +Ñn->query[1];

1068 i‡(
qidít
 =
idít
) {

1069 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1071 
code
, 
	`ngx_ªsﬁvî_°ªº‹
(code), 
idít
,

1072 
∫
->
∆í
,Ñn->
«me
);

1077 
dns_îr‹
;

1080 i‡(
code
 > 
NGX_RESOLVE_REFUSED
) {

1081 
dns_îr‹
;

1084 i‡(
nqs
 != 1) {

1085 
îr
 = "invalidÇumber of questions in DNSÑesponse";

1086 
d⁄e
;

1089 
i
 = (
ngx_ªsﬁvî_quîy_t
);

1091 
i
 < (
ngx_uöt_t
Ë
n
) {

1092 i‡(
buf
[
i
] == '\0') {

1093 
found
;

1096 
Àn
 = 
buf
[
i
];

1097 
i
 +1 + 
Àn
;

1100 
sh‹t_ª•⁄£
;

1102 
found
:

1104 i‡(
i
++ == 0) {

1105 
îr
 = "zero-length domainÇame in DNSÑesponse";

1106 
d⁄e
;

1109 i‡(
i
 + (
ngx_ªsﬁvî_qs_t
Ë+ 
«n
 * (2 + (
ngx_ªsﬁvî_™_t
))

1110 > (
ngx_uöt_t
Ë
n
)

1112 
sh‹t_ª•⁄£
;

1115 
qs
 = (
ngx_ªsﬁvî_qs_t
 *Ë&
buf
[
i
];

1117 
qty≥
 = (
qs
->
ty≥_hi
 << 8Ë+ qs->
ty≥_lo
;

1118 
q˛ass
 = (
qs
->
˛ass_hi
 << 8Ë+ qs->
˛ass_lo
;

1120 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1121 "ªsﬁvî DNSÑe•⁄£ qt:%uò˛:%ui", 
qty≥
, 
q˛ass
);

1123 i‡(
q˛ass
 != 1) {

1124 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1125 "unknow¿quîy cœs†%uòö DNSÑe•⁄£", 
q˛ass
);

1129 
qty≥
) {

1131 
NGX_RESOLVE_A
:

1133 
	`ngx_ªsﬁvî_¥o˚ss_a
(
r
, 
buf
, 
n
, 
idít
, 
code
, 
«n
,

1134 
i
 + (
ngx_ªsﬁvî_qs_t
));

1138 
NGX_RESOLVE_PTR
:

1140 
	`ngx_ªsﬁvî_¥o˚ss_±r
(
r
, 
buf
, 
n
, 
idít
, 
code
, 
«n
);

1145 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1146 "unknow¿quîyÅy≥ %uòö DNSÑe•⁄£", 
qty≥
);

1152 
sh‹t_ª•⁄£
:

1154 
îr
 = "short dnsÑesponse";

1156 
d⁄e
:

1158 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0, 
îr
);

1162 
dns_îr‹
:

1164 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1166 
code
, 
	`ngx_ªsﬁvî_°ªº‹
(code), 
idít
);

1168 
	}
}

1172 
	$ngx_ªsﬁvî_¥o˚ss_a
(
ngx_ªsﬁvî_t
 *
r
, 
u_ch¨
 *
buf
, 
size_t
 
œ°
,

1173 
ngx_uöt_t
 
idít
,Çgx_uöt_à
code
,Çgx_uöt_à
«n
,Çgx_uöt_à
™s
)

1175 *
îr
;

1176 
u_ch¨
 *
˙ame
;

1177 
size_t
 
Àn
;

1178 
öt32_t
 
âl
;

1179 
uöt32_t
 
hash
;

1180 
ö_addr_t
 
addr
, *
addrs
;

1181 
ngx_°r_t
 
«me
;

1182 
ngx_uöt_t
 
qty≥
, 
qidít
, 
«ddrs
, 
a
, 
i
, 
n
, 
°¨t
;

1183 
ngx_ªsﬁvî_™_t
 *
™
;

1184 
ngx_ªsﬁvî_˘x_t
 *
˘x
, *
√xt
;

1185 
ngx_ªsﬁvî_node_t
 *
∫
;

1187 i‡(
	`ngx_ªsﬁvî_c›y
(
r
, &
«me
, 
buf
, &buf[12], &buf[
œ°
]Ë!
NGX_OK
) {

1191 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "ªsﬁvî qs:%V", &
«me
);

1193 
hash
 = 
	`ngx_¸c32_sh‹t
(
«me
.
d©a
,Çame.
Àn
);

1197 
∫
 = 
	`ngx_ªsﬁvî_lookup_«me
(
r
, &
«me
, 
hash
);

1199 i‡(
∫
 =
NULL
 ||Ñn->
quîy
 == NULL) {

1200 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1201 "u√x≥˘edÑe•⁄£ f‹ %V", &
«me
);

1202 
Áûed
;

1205 
qidít
 = (
∫
->
quîy
[0] << 8) +Ñn->query[1];

1207 i‡(
idít
 !
qidít
) {

1208 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1210 
idít
, &
«me
, 
qidít
);

1211 
Áûed
;

1214 
	`ngx_ªsﬁvî_‰ì
(
r
, 
«me
.
d©a
);

1216 i‡(
code
 =0 && 
«n
 == 0) {

1217 
code
 = 3;

1220 i‡(
code
) {

1221 
√xt
 = 
∫
->
waôög
;

1222 
∫
->
waôög
 = 
NULL
;

1224 
	`ngx_queue_ªmove
(&
∫
->
queue
);

1226 
	`ngx_rbåì_dñëe
(&
r
->
«me_rbåì
, &
∫
->
node
);

1228 
	`ngx_ªsﬁvî_‰ì_node
(
r
, 
∫
);

1232 
√xt
) {

1233 
˘x
 = 
√xt
;

1234 
˘x
->
°©e
 = 
code
;

1235 
√xt
 = 
˘x
->next;

1237 
˘x
->
	`h™dÀr
(ctx);

1243 
i
 = 
™s
;

1244 
«ddrs
 = 0;

1245 
addr
 = 0;

1246 
addrs
 = 
NULL
;

1247 
˙ame
 = 
NULL
;

1248 
qty≥
 = 0;

1249 
âl
 = 0;

1251 
a
 = 0;á < 
«n
;á++) {

1253 
°¨t
 = 
i
;

1255 
i
 < 
œ°
) {

1257 i‡(
buf
[
i
] & 0xc0) {

1258 
i
 += 2;

1259 
found
;

1262 i‡(
buf
[
i
] == 0) {

1263 
i
++;

1264 
ã°_Àngth
;

1267 
i
 +1 + 
buf
[i];

1270 
sh‹t_ª•⁄£
;

1272 
ã°_Àngth
:

1274 i‡(
i
 - 
°¨t
 < 2) {

1275 
îr
 = "invalidÇame in dnsÑesponse";

1276 
övÆid
;

1279 
found
:

1281 i‡(
i
 + (
ngx_ªsﬁvî_™_t
Ë>
œ°
) {

1282 
sh‹t_ª•⁄£
;

1285 
™
 = (
ngx_ªsﬁvî_™_t
 *Ë&
buf
[
i
];

1287 
qty≥
 = (
™
->
ty≥_hi
 << 8Ë+án->
ty≥_lo
;

1288 
Àn
 = (
™
->
Àn_hi
 << 8Ë+án->
Àn_lo
;

1289 
âl
 = (
™
->ttl[0] << 24) + (an->ttl[1] << 16)

1290 + (
™
->
âl
[2] << 8) + (an->ttl[3]);

1292 i‡(
âl
 < 0) {

1293 
âl
 = 0;

1296 i‡(
qty≥
 =
NGX_RESOLVE_A
) {

1298 
i
 +(
ngx_ªsﬁvî_™_t
);

1300 i‡(
i
 + 
Àn
 > 
œ°
) {

1301 
sh‹t_ª•⁄£
;

1304 
addr
 = 
	`ht⁄l
((
buf
[
i
] << 24) + (buf[i + 1] << 16)

1305 + (
buf
[
i
 + 2] << 8) + (buf[i + 3]));

1307 
«ddrs
++;

1309 
i
 +
Àn
;

1311 } i‡(
qty≥
 =
NGX_RESOLVE_CNAME
) {

1312 
˙ame
 = &
buf
[
i
] + (
ngx_ªsﬁvî_™_t
);

1313 
i
 +(
ngx_ªsﬁvî_™_t
Ë+ 
Àn
;

1315 } i‡(
qty≥
 =
NGX_RESOLVE_DNAME
) {

1316 
i
 +(
ngx_ªsﬁvî_™_t
Ë+ 
Àn
;

1319 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1320 "u√x≥˘ed qty≥ %ui", 
qty≥
);

1324 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1326 
«ddrs
, 
˙ame
, 
âl
);

1328 i‡(
«ddrs
) {

1330 i‡(
«ddrs
 == 1) {

1331 
∫
->
u
.
addr
 =áddr;

1335 
addrs
 = 
	`ngx_ªsﬁvî_Æloc
(
r
, 
«ddrs
 * (
ö_addr_t
));

1336 i‡(
addrs
 =
NULL
) {

1340 
n
 = 0;

1341 
i
 = 
™s
;

1343 
a
 = 0;á < 
«n
;á++) {

1347 i‡(
buf
[
i
] & 0xc0) {

1348 
i
 += 2;

1349 
ok
;

1352 i‡(
buf
[
i
] == 0) {

1353 
i
++;

1354 
ok
;

1357 
i
 +1 + 
buf
[i];

1360 
ok
:

1362 
™
 = (
ngx_ªsﬁvî_™_t
 *Ë&
buf
[
i
];

1364 
qty≥
 = (
™
->
ty≥_hi
 << 8Ë+án->
ty≥_lo
;

1365 
Àn
 = (
™
->
Àn_hi
 << 8Ë+án->
Àn_lo
;

1367 
i
 +(
ngx_ªsﬁvî_™_t
);

1369 i‡(
qty≥
 =
NGX_RESOLVE_A
) {

1371 
addrs
[
n
++] = 
	`ht⁄l
((
buf
[
i
] << 24) + (buf[i + 1] << 16)

1372 + (
buf
[
i
 + 2] << 8) + (buf[i + 3]));

1374 i‡(
n
 =
«ddrs
) {

1379 
i
 +
Àn
;

1382 
∫
->
u
.
addrs
 =áddrs;

1384 
addrs
 = 
	`ngx_ªsﬁvî_dup
(
r
, 
∫
->
u
.addrs,

1385 
«ddrs
 * (
ö_addr_t
));

1386 i‡(
addrs
 =
NULL
) {

1391 
∫
->
«ddrs
 = (
u_sh‹t
)Çaddrs;

1393 
	`ngx_queue_ªmove
(&
∫
->
queue
);

1395 
∫
->
vÆid
 = 
	`ngx_time
(Ë+ (
r
->vÆid ?Ñ->vÆid : 
âl
);

1396 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->expire;

1398 
	`ngx_queue_ö£π_hód
(&
r
->
«me_expúe_queue
, &
∫
->
queue
);

1400 
√xt
 = 
∫
->
waôög
;

1401 
∫
->
waôög
 = 
NULL
;

1405 
√xt
) {

1406 
˘x
 = 
√xt
;

1407 
˘x
->
°©e
 = 
NGX_OK
;

1408 
˘x
->
«ddrs
 =Çaddrs;

1409 
˘x
->
addrs
 = (
«ddrs
 =1Ë? &˘x->
addr
 :áddrs;

1410 
˘x
->
addr
 =áddr;

1411 
√xt
 = 
˘x
->next;

1413 
˘x
->
	`h™dÀr
(ctx);

1416 i‡(
«ddrs
 > 1) {

1417 
	`ngx_ªsﬁvî_‰ì
(
r
, 
addrs
);

1420 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
quîy
);

1421 
∫
->
quîy
 = 
NULL
;

1425 } i‡(
˙ame
) {

1429 i‡(
	`ngx_ªsﬁvî_c›y
(
r
, &
«me
, 
buf
, 
˙ame
, &buf[
œ°
]Ë!
NGX_OK
) {

1433 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1434 "ªsﬁvî c«me:\"%V\"", &
«me
);

1436 
	`ngx_queue_ªmove
(&
∫
->
queue
);

1438 
∫
->
˙Àn
 = (
u_sh‹t
Ë
«me
.
Àn
;

1439 
∫
->
u
.
˙ame
 = 
«me
.
d©a
;

1441 
∫
->
vÆid
 = 
	`ngx_time
(Ë+ (
r
->vÆid ?Ñ->vÆid : 
âl
);

1442 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->expire;

1444 
	`ngx_queue_ö£π_hód
(&
r
->
«me_expúe_queue
, &
∫
->
queue
);

1446 
˘x
 = 
∫
->
waôög
;

1447 
∫
->
waôög
 = 
NULL
;

1449 i‡(
˘x
) {

1450 
˘x
->
«me
 =Çame;

1452 (Ë
	`ngx_ªsﬁve_«me_locked
(
r
, 
˘x
);

1455 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
quîy
);

1456 
∫
->
quîy
 = 
NULL
;

1461 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1463 
qty≥
);

1466 
sh‹t_ª•⁄£
:

1468 
îr
 = "short dnsÑesponse";

1470 
övÆid
:

1474 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0, 
îr
);

1478 
Áûed
:

1482 
	`ngx_ªsﬁvî_‰ì
(
r
, 
«me
.
d©a
);

1485 
	}
}

1489 
	$ngx_ªsﬁvî_¥o˚ss_±r
(
ngx_ªsﬁvî_t
 *
r
, 
u_ch¨
 *
buf
, 
size_t
 
n
,

1490 
ngx_uöt_t
 
idít
,Çgx_uöt_à
code
,Çgx_uöt_à
«n
)

1492 *
îr
;

1493 
size_t
 
Àn
;

1494 
ö_addr_t
 
addr
;

1495 
öt32_t
 
âl
;

1496 
ngx_öt_t
 
digô
;

1497 
ngx_°r_t
 
«me
;

1498 
ngx_uöt_t
 
i
, 
mask
, 
qidít
;

1499 
ngx_ªsﬁvî_™_t
 *
™
;

1500 
ngx_ªsﬁvî_˘x_t
 *
˘x
, *
√xt
;

1501 
ngx_ªsﬁvî_node_t
 *
∫
;

1503 i‡(
	`ngx_ªsﬁvî_c›y
(
r
, 
NULL
, 
buf
, &buf[12], &buf[
n
]Ë!
NGX_OK
) {

1504 
övÆid_ö_addr_¨∑
;

1507 
addr
 = 0;

1508 
i
 = 12;

1510 
mask
 = 0; mask < 32; mask += 8) {

1511 
Àn
 = 
buf
[
i
++];

1513 
digô
 = 
	`ngx_©oi
(&
buf
[
i
], 
Àn
);

1514 i‡(
digô
 =
NGX_ERROR
 || digit > 255) {

1515 
övÆid_ö_addr_¨∑
;

1518 
addr
 +
digô
 << 
mask
;

1519 
i
 +
Àn
;

1522 i‡(
	`ngx_°rcmp
(&
buf
[
i
], "\7in-addr\4arpa") != 0) {

1523 
övÆid_ö_addr_¨∑
;

1528 
∫
 = 
	`ngx_ªsﬁvî_lookup_addr
(
r
, 
addr
);

1530 i‡(
∫
 =
NULL
 ||Ñn->
quîy
 == NULL) {

1531 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1533 (
addr
 >> 24) & 0xff, (addr >> 16) & 0xff,

1534 (
addr
 >> 8) & 0xff,áddr & 0xff);

1535 
Áûed
;

1538 
qidít
 = (
∫
->
quîy
[0] << 8) +Ñn->query[1];

1540 i‡(
idít
 !
qidít
) {

1541 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1543 
idít
, (
addr
 >> 24) & 0xff, (addr >> 16) & 0xff,

1544 (
addr
 >> 8Ë& 0xff,ádd∏& 0xff, 
qidít
);

1545 
Áûed
;

1548 i‡(
code
 =0 && 
«n
 == 0) {

1549 
code
 = 3;

1552 i‡(
code
) {

1553 
√xt
 = 
∫
->
waôög
;

1554 
∫
->
waôög
 = 
NULL
;

1556 
	`ngx_queue_ªmove
(&
∫
->
queue
);

1558 
	`ngx_rbåì_dñëe
(&
r
->
addr_rbåì
, &
∫
->
node
);

1560 
	`ngx_ªsﬁvî_‰ì_node
(
r
, 
∫
);

1564 
√xt
) {

1565 
˘x
 = 
√xt
;

1566 
˘x
->
°©e
 = 
code
;

1567 
√xt
 = 
˘x
->next;

1569 
˘x
->
	`h™dÀr
(ctx);

1575 
i
 +("\7ö-addr\4¨∑"Ë+ (
ngx_ªsﬁvî_qs_t
);

1577 i‡(
i
 + 2 + (
ngx_ªsﬁvî_™_t
Ë> (
ngx_uöt_t
Ë
n
) {

1578 
sh‹t_ª•⁄£
;

1583 i‡(
buf
[
i
] != 0xc0 || buf[i + 1] != 0x0c) {

1584 
îr
 = "invalid in-addr.arpaÇame in DNSÑesponse";

1585 
övÆid
;

1588 
™
 = (
ngx_ªsﬁvî_™_t
 *Ë&
buf
[
i
 + 2];

1590 
Àn
 = (
™
->
Àn_hi
 << 8Ë+án->
Àn_lo
;

1591 
âl
 = (
™
->ttl[0] << 24) + (an->ttl[1] << 16)

1592 + (
™
->
âl
[2] << 8) + (an->ttl[3]);

1594 i‡(
âl
 < 0) {

1595 
âl
 = 0;

1598 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0,

1600 (
™
->
ty≥_hi
 << 8Ë+án->
ty≥_lo
,

1601 (
™
->
˛ass_hi
 << 8Ë+án->
˛ass_lo
, 
Àn
);

1603 
i
 +2 + (
ngx_ªsﬁvî_™_t
);

1605 i‡(
i
 + 
Àn
 > (
ngx_uöt_t
Ë
n
) {

1606 
sh‹t_ª•⁄£
;

1609 i‡(
	`ngx_ªsﬁvî_c›y
(
r
, &
«me
, 
buf
, &buf[
i
], &buf[
n
]Ë!
NGX_OK
) {

1613 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
r
->
log
, 0, "ªsﬁvîán:%V", &
«me
);

1615 i‡(
«me
.
Àn
 !(
size_t
Ë
∫
->
∆í


1616 || 
	`ngx_°∫cmp
(
«me
.
d©a
, 
∫
->«me,Çame.
Àn
) != 0)

1618 i‡(
∫
->
∆í
) {

1619 
	`ngx_ªsﬁvî_‰ì
(
r
, 
∫
->
«me
);

1622 
∫
->
∆í
 = (
u_sh‹t
Ë
«me
.
Àn
;

1623 
∫
->
«me
 =Çame.
d©a
;

1625 
«me
.
d©a
 = 
	`ngx_ªsﬁvî_dup
(
r
, 
∫
->«me,Çame.
Àn
);

1626 i‡(
«me
.
d©a
 =
NULL
) {

1627 
Áûed
;

1631 
	`ngx_queue_ªmove
(&
∫
->
queue
);

1633 
∫
->
vÆid
 = 
	`ngx_time
(Ë+ (
r
->vÆid ?Ñ->vÆid : 
âl
);

1634 
∫
->
expúe
 = 
	`ngx_time
(Ë+ 
r
->expire;

1636 
	`ngx_queue_ö£π_hód
(&
r
->
addr_expúe_queue
, &
∫
->
queue
);

1638 
√xt
 = 
∫
->
waôög
;

1639 
∫
->
waôög
 = 
NULL
;

1643 
√xt
) {

1644 
˘x
 = 
√xt
;

1645 
˘x
->
°©e
 = 
NGX_OK
;

1646 
˘x
->
«me
 =Çame;

1647 
√xt
 = 
˘x
->next;

1649 
˘x
->
	`h™dÀr
(ctx);

1652 
	`ngx_ªsﬁvî_‰ì
(
r
, 
«me
.
d©a
);

1656 
övÆid_ö_addr_¨∑
:

1658 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0,

1662 
sh‹t_ª•⁄£
:

1664 
îr
 = "short DNSÑesponse";

1666 
övÆid
:

1670 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0, 
îr
);

1674 
Áûed
:

1679 
	}
}

1682 
ngx_ªsﬁvî_node_t
 *

1683 
	$ngx_ªsﬁvî_lookup_«me
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_°r_t
 *
«me
, 
uöt32_t
 
hash
)

1685 
ngx_öt_t
 
rc
;

1686 
ngx_rbåì_node_t
 *
node
, *
£¡öñ
;

1687 
ngx_ªsﬁvî_node_t
 *
∫
;

1689 
node
 = 
r
->
«me_rbåì
.
roŸ
;

1690 
£¡öñ
 = 
r
->
«me_rbåì
.sentinel;

1692 
node
 !
£¡öñ
) {

1694 i‡(
hash
 < 
node
->
key
) {

1695 
node
 =Çode->
À·
;

1699 i‡(
hash
 > 
node
->
key
) {

1700 
node
 =Çode->
right
;

1706 
∫
 = (
ngx_ªsﬁvî_node_t
 *Ë
node
;

1708 
rc
 = 
	`ngx_memn2cmp
(
«me
->
d©a
, 
∫
->«me,Çame->
Àn
,Ñn->
∆í
);

1710 i‡(
rc
 == 0) {

1711  
∫
;

1714 
node
 = (
rc
 < 0Ë?Çode->
À·
 :Çode->
right
;

1719  
NULL
;

1720 
	}
}

1723 
ngx_ªsﬁvî_node_t
 *

1724 
	$ngx_ªsﬁvî_lookup_addr
(
ngx_ªsﬁvî_t
 *
r
, 
ö_addr_t
 
addr
)

1726 
ngx_rbåì_node_t
 *
node
, *
£¡öñ
;

1728 
node
 = 
r
->
addr_rbåì
.
roŸ
;

1729 
£¡öñ
 = 
r
->
addr_rbåì
.sentinel;

1731 
node
 !
£¡öñ
) {

1733 i‡(
addr
 < 
node
->
key
) {

1734 
node
 =Çode->
À·
;

1738 i‡(
addr
 > 
node
->
key
) {

1739 
node
 =Çode->
right
;

1745  (
ngx_ªsﬁvî_node_t
 *Ë
node
;

1750  
NULL
;

1751 
	}
}

1755 
	$ngx_ªsﬁvî_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,

1756 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
)

1758 
ngx_rbåì_node_t
 **
p
;

1759 
ngx_ªsﬁvî_node_t
 *
∫
, *
∫_ãmp
;

1763 i‡(
node
->
key
 < 
ãmp
->key) {

1765 
p
 = &
ãmp
->
À·
;

1767 } i‡(
node
->
key
 > 
ãmp
->key) {

1769 
p
 = &
ãmp
->
right
;

1773 
∫
 = (
ngx_ªsﬁvî_node_t
 *Ë
node
;

1774 
∫_ãmp
 = (
ngx_ªsﬁvî_node_t
 *Ë
ãmp
;

1776 
p
 = (
	`ngx_memn2cmp
(
∫
->
«me
, 
∫_ãmp
->«me,Ñn->
∆í
,Ñn_temp->nlen)

1777 < 0Ë? &
ãmp
->
À·
 : &ãmp->
right
;

1780 i‡(*
p
 =
£¡öñ
) {

1784 
ãmp
 = *
p
;

1787 *
p
 = 
node
;

1788 
node
->
∑ª¡
 = 
ãmp
;

1789 
node
->
À·
 = 
£¡öñ
;

1790 
node
->
right
 = 
£¡öñ
;

1791 
	`ngx_rbt_ªd
(
node
);

1792 
	}
}

1795 
ngx_öt_t


1796 
	$ngx_ªsﬁvî_¸óã_«me_quîy
(
ngx_ªsﬁvî_node_t
 *
∫
, 
ngx_ªsﬁvî_˘x_t
 *
˘x
)

1798 
u_ch¨
 *
p
, *
s
;

1799 
size_t
 
Àn
, 
∆í
;

1800 
ngx_uöt_t
 
idít
;

1801 
ngx_ªsﬁvî_qs_t
 *
qs
;

1802 
ngx_ªsﬁvî_quîy_t
 *
quîy
;

1804 
∆í
 = 
˘x
->
«me
.
Àn
 ? (1 + ctx->name.len + 1) : 1;

1806 
Àn
 = (
ngx_ªsﬁvî_quîy_t
Ë+ 
∆í
 + (
ngx_ªsﬁvî_qs_t
);

1808 
p
 = 
	`ngx_ªsﬁvî_Æloc
(
˘x
->
ªsﬁvî
, 
Àn
);

1809 i‡(
p
 =
NULL
) {

1810  
NGX_ERROR
;

1813 
∫
->
qÀn
 = (
u_sh‹t
Ë
Àn
;

1814 
∫
->
quîy
 = 
p
;

1816 
quîy
 = (
ngx_ªsﬁvî_quîy_t
 *Ë
p
;

1818 
idít
 = 
	`ngx_øndom
();

1820 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_CORE
, 
˘x
->
ªsﬁvî
->
log
, 0,

1821 "ªsﬁve: \"%V\" %i", &
˘x
->
«me
, 
idít
 & 0xffff);

1823 
quîy
->
idít_hi
 = (
u_ch¨
Ë((
idít
 >> 8) & 0xff);

1824 
quîy
->
idít_lo
 = (
u_ch¨
Ë(
idít
 & 0xff);

1827 
quîy
->
Êags_hi
 = 1; quîy->
Êags_lo
 = 0;

1830 
quîy
->
nqs_hi
 = 0; quîy->
nqs_lo
 = 1;

1831 
quîy
->
«n_hi
 = 0; quîy->
«n_lo
 = 0;

1832 
quîy
->
¬s_hi
 = 0; quîy->
¬s_lo
 = 0;

1833 
quîy
->
«r_hi
 = 0; quîy->
«r_lo
 = 0;

1835 
p
 +(
ngx_ªsﬁvî_quîy_t
Ë+ 
∆í
;

1837 
qs
 = (
ngx_ªsﬁvî_qs_t
 *Ë
p
;

1840 
qs
->
ty≥_hi
 = 0; qs->
ty≥_lo
 = (
u_ch¨
Ë
˘x
->
ty≥
;

1843 
qs
->
˛ass_hi
 = 0; qs->
˛ass_lo
 = 1;

1847 
Àn
 = 0;

1848 
p
--;

1849 *
p
-- = '\0';

1851 i‡(
˘x
->
«me
.
Àn
 == 0) {

1852  
NGX_DECLINED
;

1855 
s
 = 
˘x
->
«me
.
d©a
 + ctx->«me.
Àn
 - 1; s >= ctx->name.data; s--) {

1856 i‡(*
s
 != '.') {

1857 *
p
 = *
s
;

1858 
Àn
++;

1861 i‡(
Àn
 == 0 ||Üen > 255) {

1862  
NGX_DECLINED
;

1865 *
p
 = (
u_ch¨
Ë
Àn
;

1866 
Àn
 = 0;

1869 
p
--;

1872 i‡(
Àn
 == 0 ||Üen > 255) {

1873  
NGX_DECLINED
;

1876 *
p
 = (
u_ch¨
Ë
Àn
;

1878  
NGX_OK
;

1879 
	}
}

1884 
ngx_öt_t


1885 
	$ngx_ªsﬁvî_¸óã_addr_quîy
(
ngx_ªsﬁvî_node_t
 *
∫
, 
ngx_ªsﬁvî_˘x_t
 *
˘x
)

1887 
u_ch¨
 *
p
, *
d
;

1888 
size_t
 
Àn
;

1889 
ngx_öt_t
 
n
;

1890 
ngx_uöt_t
 
idít
;

1891 
ngx_ªsﬁvî_quîy_t
 *
quîy
;

1893 
Àn
 = (
ngx_ªsﬁvî_quîy_t
)

1895 + (
ngx_ªsﬁvî_qs_t
);

1897 
p
 = 
	`ngx_ªsﬁvî_Æloc
(
˘x
->
ªsﬁvî
, 
Àn
);

1898 i‡(
p
 =
NULL
) {

1899  
NGX_ERROR
;

1902 
∫
->
quîy
 = 
p
;

1903 
quîy
 = (
ngx_ªsﬁvî_quîy_t
 *Ë
p
;

1905 
idít
 = 
	`ngx_øndom
();

1907 
quîy
->
idít_hi
 = (
u_ch¨
Ë((
idít
 >> 8) & 0xff);

1908 
quîy
->
idít_lo
 = (
u_ch¨
Ë(
idít
 & 0xff);

1911 
quîy
->
Êags_hi
 = 1; quîy->
Êags_lo
 = 0;

1914 
quîy
->
nqs_hi
 = 0; quîy->
nqs_lo
 = 1;

1915 
quîy
->
«n_hi
 = 0; quîy->
«n_lo
 = 0;

1916 
quîy
->
¬s_hi
 = 0; quîy->
¬s_lo
 = 0;

1917 
quîy
->
«r_hi
 = 0; quîy->
«r_lo
 = 0;

1919 
p
 +(
ngx_ªsﬁvî_quîy_t
);

1921 
n
 = 0;Ç < 32;Ç += 8) {

1922 
d
 = 
	`ngx_•rötf
(&
p
[1], "%ud", (
˘x
->
addr
 >> 
n
) & 0xff);

1923 *
p
 = (
u_ch¨
Ë(
d
 - &p[1]);

1924 
p
 = 
d
;

1928 
	`ngx_mem˝y
(
p
, "\7in-addr\4arpa\0\0\14\0\1", 18);

1930 
∫
->
qÀn
 = (
u_sh‹t
)

1931 (
p
 + ("\7ö-addr\4¨∑"Ë+ (
ngx_ªsﬁvî_qs_t
)

1932 - 
∫
->
quîy
);

1934  
NGX_OK
;

1935 
	}
}

1938 
ngx_öt_t


1939 
	$ngx_ªsﬁvî_c›y
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_°r_t
 *
«me
, 
u_ch¨
 *
buf
, u_ch¨ *
§c
,

1940 
u_ch¨
 *
œ°
)

1942 *
îr
;

1943 
u_ch¨
 *
p
, *
d°
;

1944 
ssize_t
 
Àn
;

1945 
ngx_uöt_t
 
i
, 
n
;

1947 
p
 = 
§c
;

1948 
Àn
 = -1;

1955 
i
 = 0; i < 128; i++) {

1956 
n
 = *
p
++;

1958 i‡(
n
 == 0) {

1959 
d⁄e
;

1962 i‡(
n
 & 0xc0) {

1963 
n
 = (“ & 0x3fË<< 8Ë+ *
p
;

1964 
p
 = &
buf
[
n
];

1967 
Àn
 +1 + 
n
;

1968 
p
 = &p[
n
];

1971 i‡(
p
 >
œ°
) {

1972 
îr
 = "name is out ofÑesponse";

1973 
övÆid
;

1977 
îr
 = "compressionÖointersÜoop";

1979 
övÆid
:

1981 
	`ngx_log_îr‹
(
r
->
log_Àvñ
,Ñ->
log
, 0, 
îr
);

1983  
NGX_ERROR
;

1985 
d⁄e
:

1987 i‡(
«me
 =
NULL
) {

1988  
NGX_OK
;

1991 i‡(
Àn
 == -1) {

1992 
«me
->
Àn
 = 0;

1993 
«me
->
d©a
 = 
NULL
;

1994  
NGX_OK
;

1997 
d°
 = 
	`ngx_ªsﬁvî_Æloc
(
r
, 
Àn
);

1998 i‡(
d°
 =
NULL
) {

1999  
NGX_ERROR
;

2002 
«me
->
d©a
 = 
d°
;

2004 
n
 = *
§c
++;

2007 i‡(
n
 & 0xc0) {

2008 
n
 = (“ & 0x3fË<< 8Ë+ *
§c
;

2009 
§c
 = &
buf
[
n
];

2011 
n
 = *
§c
++;

2014 
	`ngx_mem˝y
(
d°
, 
§c
, 
n
);

2015 
d°
 +
n
;

2016 
§c
 +
n
;

2018 
n
 = *
§c
++;

2020 i‡(
n
 != 0) {

2021 *
d°
++ = '.';

2025 i‡(
n
 == 0) {

2026 
«me
->
Àn
 = 
d°
 -Çame->
d©a
;

2027  
NGX_OK
;

2030 
	}
}

2034 
	$ngx_ªsﬁvî_timeout_h™dÀr
(
ngx_evít_t
 *
ev
)

2036 
ngx_ªsﬁvî_˘x_t
 *
˘x
;

2038 
˘x
 = 
ev
->
d©a
;

2040 
˘x
->
°©e
 = 
NGX_RESOLVE_TIMEDOUT
;

2042 
˘x
->
	`h™dÀr
(ctx);

2043 
	}
}

2047 
	$ngx_ªsﬁvî_‰ì_node
(
ngx_ªsﬁvî_t
 *
r
, 
ngx_ªsﬁvî_node_t
 *
∫
)

2051 i‡(
∫
->
quîy
) {

2052 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
quîy
);

2055 i‡(
∫
->
«me
) {

2056 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
«me
);

2059 i‡(
∫
->
˙Àn
) {

2060 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
u
.
˙ame
);

2063 i‡(
∫
->
«ddrs
 > 1) {

2064 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
->
u
.
addrs
);

2067 
	`ngx_ªsﬁvî_‰ì_locked
(
r
, 
∫
);

2070 
	}
}

2074 
	$ngx_ªsﬁvî_Æloc
(
ngx_ªsﬁvî_t
 *
r
, 
size_t
 
size
)

2076 
u_ch¨
 *
p
;

2080 
p
 = 
	`ngx_Æloc
(
size
, 
r
->
log
);

2084  
p
;

2085 
	}
}

2089 
	$ngx_ªsﬁvî_ˇŒoc
(
ngx_ªsﬁvî_t
 *
r
, 
size_t
 
size
)

2091 
u_ch¨
 *
p
;

2093 
p
 = 
	`ngx_ªsﬁvî_Æloc
(
r
, 
size
);

2095 i‡(
p
) {

2096 
	`ngx_memzîo
(
p
, 
size
);

2099  
p
;

2100 
	}
}

2104 
	$ngx_ªsﬁvî_‰ì
(
ngx_ªsﬁvî_t
 *
r
, *
p
)

2108 
	`ngx_‰ì
(
p
);

2111 
	}
}

2115 
	$ngx_ªsﬁvî_‰ì_locked
(
ngx_ªsﬁvî_t
 *
r
, *
p
)

2117 
	`ngx_‰ì
(
p
);

2118 
	}
}

2122 
	$ngx_ªsﬁvî_dup
(
ngx_ªsﬁvî_t
 *
r
, *
§c
, 
size_t
 
size
)

2124 *
d°
;

2126 
d°
 = 
	`ngx_ªsﬁvî_Æloc
(
r
, 
size
);

2128 i‡(
d°
 =
NULL
) {

2129  
d°
;

2132 
	`ngx_mem˝y
(
d°
, 
§c
, 
size
);

2134  
d°
;

2135 
	}
}

2139 
	$ngx_ªsﬁvî_°ªº‹
(
ngx_öt_t
 
îr
)

2141 *
îr‹s
[] = {

2149 i‡(
îr
 > 0 &&Érr < 6) {

2150  
îr‹s
[
îr
 - 1];

2153 i‡(
îr
 =
NGX_RESOLVE_TIMEDOUT
) {

2158 
	}
}

2161 
u_ch¨
 *

2162 
	$ngx_ªsﬁvî_log_îr‹
(
ngx_log_t
 *
log
, 
u_ch¨
 *
buf
, 
size_t
 
Àn
)

2164 
u_ch¨
 *
p
;

2165 
ngx_udp_c⁄√˘i⁄_t
 *
uc
;

2167 
p
 = 
buf
;

2169 i‡(
log
->
a˘i⁄
) {

2170 
p
 = 
	`ngx_¢¥ötf
(
buf
, 
Àn
, " whûê%s", 
log
->
a˘i⁄
);

2171 
Àn
 -
p
 - 
buf
;

2174 
uc
 = 
log
->
d©a
;

2176 i‡(
uc
) {

2177 
p
 = 
	`ngx_¢¥ötf
’, 
Àn
, ",Ñesﬁvî: %V", &
uc
->
£rvî
);

2180  
p
;

2181 
	}
}

2184 
ngx_öt_t


2185 
	$ngx_udp_c⁄√˘
(
ngx_udp_c⁄√˘i⁄_t
 *
uc
)

2187 
rc
;

2188 
ngx_öt_t
 
evít
;

2189 
ngx_evít_t
 *
ªv
, *
wev
;

2190 
ngx_sockë_t
 
s
;

2191 
ngx_c⁄√˘i⁄_t
 *
c
;

2193 
s
 = 
	`ngx_sockë
(
uc
->
sockaddr
->
ß_Ámûy
, 
SOCK_DGRAM
, 0);

2195 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_EVENT
, &
uc
->
log
, 0, "UDP sockë %d", 
s
);

2197 i‡(
s
 == -1) {

2198 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sockë_î∫o
,

2199 
ngx_sockë_n
 " failed");

2200  
NGX_ERROR
;

2203 
c
 = 
	`ngx_gë_c⁄√˘i⁄
(
s
, &
uc
->
log
);

2205 i‡(
c
 =
NULL
) {

2206 i‡(
	`ngx_˛o£_sockë
(
s
) == -1) {

2207 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sockë_î∫o
,

2208 
ngx_˛o£_sockë_n
 "failed");

2211  
NGX_ERROR
;

2214 i‡(
	`ngx_n⁄blockög
(
s
) == -1) {

2215 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sockë_î∫o
,

2216 
ngx_n⁄blockög_n
 " failed");

2218 
	`ngx_‰ì_c⁄√˘i⁄
(
c
);

2220 i‡(
	`ngx_˛o£_sockë
(
s
) == -1) {

2221 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, &
uc
->
log
, 
ngx_sockë_î∫o
,

2222 
ngx_˛o£_sockë_n
 " failed");

2225  
NGX_ERROR
;

2228 
ªv
 = 
c
->
ªad
;

2229 
wev
 = 
c
->
wrôe
;

2231 
ªv
->
log
 = &
uc
->log;

2232 
wev
->
log
 = &
uc
->log;

2234 
uc
->
c⁄√˘i⁄
 = 
c
;

2236 
c
->
numbî
 = 
	`ngx_©omic_„tch_add
(
ngx_c⁄√˘i⁄_cou¡î
, 1);

2238 #i‡(
NGX_THREADS
)

2242 
ªv
->
lock
 = &
c
->lock;

2243 
wev
->
lock
 = &
c
->lock;

2244 
ªv
->
own_lock
 = &
c
->
lock
;

2245 
wev
->
own_lock
 = &
c
->
lock
;

2249 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_EVENT
, &
uc
->
log
, 0,

2250 "c⁄√˘Åÿ%V, fd:%d #%d", &
uc
->
£rvî
, 
s
, 
c
->
numbî
);

2252 
rc
 = 
	`c⁄√˘
(
s
, 
uc
->
sockaddr
, uc->
sockÀn
);

2256 i‡(
rc
 == -1) {

2257 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, &
uc
->
log
, 
ngx_sockë_î∫o
,

2260  
NGX_ERROR
;

2264 
wev
->
ªady
 = 1;

2266 i‡(
ngx_add_evít
) {

2268 
evít
 = (
ngx_evít_Êags
 & 
NGX_USE_CLEAR_EVENT
) ?

2269  
NGX_CLEAR_EVENT
:

2270  
NGX_LEVEL_EVENT
;

2273 i‡(
	`ngx_add_evít
(
ªv
, 
NGX_READ_EVENT
, 
evít
Ë!
NGX_OK
) {

2274  
NGX_ERROR
;

2280 i‡(
	`ngx_add_c⁄n
(
c
Ë=
NGX_ERROR
) {

2281  
NGX_ERROR
;

2285  
NGX_OK
;

2286 
	}
}

	@ngx_resolver.h

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 #i‚de‡
_NGX_RESOLVER_H_INCLUDED_


13 
	#_NGX_RESOLVER_H_INCLUDED_


	)

16 
	#NGX_RESOLVE_A
 1

	)

17 
	#NGX_RESOLVE_CNAME
 5

	)

18 
	#NGX_RESOLVE_PTR
 12

	)

19 
	#NGX_RESOLVE_MX
 15

	)

20 
	#NGX_RESOLVE_TXT
 16

	)

21 
	#NGX_RESOLVE_DNAME
 39

	)

23 
	#NGX_RESOLVE_FORMERR
 1

	)

24 
	#NGX_RESOLVE_SERVFAIL
 2

	)

25 
	#NGX_RESOLVE_NXDOMAIN
 3

	)

26 
	#NGX_RESOLVE_NOTIMP
 4

	)

27 
	#NGX_RESOLVE_REFUSED
 5

	)

28 
	#NGX_RESOLVE_TIMEDOUT
 
NGX_ETIMEDOUT


	)

31 
	#NGX_NO_RESOLVER
 (*Ë-1

	)

33 
	#NGX_RESOLVER_MAX_RECURSION
 50

	)

37 
ngx_c⁄√˘i⁄_t
 *
	mc⁄√˘i⁄
;

38 
sockaddr
 *
	msockaddr
;

39 
sockÀn_t
 
	msockÀn
;

40 
ngx_°r_t
 
	m£rvî
;

41 
ngx_log_t
 
	mlog
;

42 } 
	tngx_udp_c⁄√˘i⁄_t
;

45 
ngx_ªsﬁvî_˘x_s
 
	tngx_ªsﬁvî_˘x_t
;

47 (*
	tngx_ªsﬁvî_h™dÀr_±
)(
	tngx_ªsﬁvî_˘x_t
 *
	t˘x
);

51 
ngx_rbåì_node_t
 
node
;

52 
ngx_queue_t
 
queue
;

55 
u_ch¨
 *
«me
;

57 
u_sh‹t
 
∆í
;

58 
u_sh‹t
 
qÀn
;

60 
u_ch¨
 *
quîy
;

63 
ö_addr_t
 
addr
;

64 
ö_addr_t
 *
addrs
;

65 
u_ch¨
 *
˙ame
;

66 } 
u
;

68 
u_sh‹t
 
«ddrs
;

69 
u_sh‹t
 
˙Àn
;

71 
time_t
 
expúe
;

72 
time_t
 
vÆid
;

74 
ngx_ªsﬁvî_˘x_t
 *
waôög
;

75 } 
	tngx_ªsﬁvî_node_t
;

80 
ngx_evít_t
 *
evít
;

81 *
dummy
;

82 
ngx_log_t
 *
log
;

85 
ngx_öt_t
 
idít
;

88 
ngx_¨øy_t
 
udp_c⁄√˘i⁄s
;

89 
ngx_uöt_t
 
œ°_c⁄√˘i⁄
;

91 
ngx_rbåì_t
 
«me_rbåì
;

92 
ngx_rbåì_node_t
 
«me_£¡öñ
;

94 
ngx_rbåì_t
 
addr_rbåì
;

95 
ngx_rbåì_node_t
 
addr_£¡öñ
;

97 
ngx_queue_t
 
«me_ª£nd_queue
;

98 
ngx_queue_t
 
addr_ª£nd_queue
;

100 
ngx_queue_t
 
«me_expúe_queue
;

101 
ngx_queue_t
 
addr_expúe_queue
;

103 
time_t
 
ª£nd_timeout
;

104 
time_t
 
expúe
;

105 
time_t
 
vÆid
;

107 
ngx_uöt_t
 
log_Àvñ
;

108 } 
	tngx_ªsﬁvî_t
;

111 
	sngx_ªsﬁvî_˘x_s
 {

112 
ngx_ªsﬁvî_˘x_t
 *
√xt
;

113 
ngx_ªsﬁvî_t
 *
ªsﬁvî
;

114 
ngx_udp_c⁄√˘i⁄_t
 *
udp_c⁄√˘i⁄
;

117 
ngx_öt_t
 
idít
;

119 
ngx_öt_t
 
°©e
;

120 
ngx_öt_t
 
ty≥
;

121 
ngx_°r_t
 
«me
;

123 
ngx_uöt_t
 
«ddrs
;

124 
ö_addr_t
 *
addrs
;

125 
ö_addr_t
 
addr
;

127 
ngx_ªsﬁvî_h™dÀr_±
 
h™dÀr
;

128 *
d©a
;

129 
ngx_m£c_t
 
timeout
;

131 
ngx_uöt_t
 
quick
;

132 
ngx_uöt_t
 
ªcursi⁄
;

133 
ngx_evít_t
 *
evít
;

137 
ngx_ªsﬁvî_t
 *
	`ngx_ªsﬁvî_¸óã
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
«mes
,

138 
ngx_uöt_t
 
n
);

139 
ngx_ªsﬁvî_˘x_t
 *
	`ngx_ªsﬁve_°¨t
(
ngx_ªsﬁvî_t
 *
r
,

140 
ngx_ªsﬁvî_˘x_t
 *
ãmp
);

141 
ngx_öt_t
 
	`ngx_ªsﬁve_«me
(
ngx_ªsﬁvî_˘x_t
 *
˘x
);

142 
	`ngx_ªsﬁve_«me_d⁄e
(
ngx_ªsﬁvî_˘x_t
 *
˘x
);

143 
ngx_öt_t
 
	`ngx_ªsﬁve_addr
(
ngx_ªsﬁvî_˘x_t
 *
˘x
);

144 
	`ngx_ªsﬁve_addr_d⁄e
(
ngx_ªsﬁvî_˘x_t
 *
˘x
);

145 *
	`ngx_ªsﬁvî_°ªº‹
(
ngx_öt_t
 
îr
);

	@ngx_sha1.h

8 #i‚de‡
_NGX_SHA1_H_INCLUDED_


9 
	#_NGX_SHA1_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 #i‡(
NGX_HAVE_OPENSSL_SHA1_H
)

17 
	~<›ís¶/sha.h
>

19 
	~<sha.h
>

23 
SHA_CTX
 
	tngx_sha1_t
;

26 
	#ngx_sha1_öô
 
SHA1_Inô


	)

27 
	#ngx_sha1_upd©e
 
SHA1_Upd©e


	)

28 
	#ngx_sha1_föÆ
 
SHA1_FöÆ


	)

	@ngx_shmtx.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 #i‡(
NGX_HAVE_ATOMIC_OPS
)

15 
ngx_shmtx_wakeup
(
ngx_shmtx_t
 *
mtx
);

18 
ngx_öt_t


19 
	$ngx_shmtx_¸óã
(
ngx_shmtx_t
 *
mtx
, 
ngx_shmtx_sh_t
 *
addr
, 
u_ch¨
 *
«me
)

21 
mtx
->
lock
 = &
addr
->lock;

23 i‡(
mtx
->
•ö
 =(
ngx_uöt_t
) -1) {

24  
NGX_OK
;

27 
mtx
->
•ö
 = 2048;

29 #i‡(
NGX_HAVE_POSIX_SEM
)

31 
mtx
->
waô
 = &
addr
->wait;

33 i‡(
	`£m_öô
(&
mtx
->
£m
, 1, 0) == -1) {

34 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

37 
mtx
->
£m≠h‹e
 = 1;

42  
NGX_OK
;

43 
	}
}

47 
	$ngx_shmtx_de°‹y
(
ngx_shmtx_t
 *
mtx
)

49 #i‡(
NGX_HAVE_POSIX_SEM
)

51 i‡(
mtx
->
£m≠h‹e
) {

52 i‡(
	`£m_de°roy
(&
mtx
->
£m
) == -1) {

53 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

59 
	}
}

62 
ngx_uöt_t


63 
	$ngx_shmtx_åylock
(
ngx_shmtx_t
 *
mtx
)

65  (*
mtx
->
lock
 =0 && 
	`ngx_©omic_cmp_£t
(mtx->lock, 0, 
ngx_pid
));

66 
	}
}

70 
	$ngx_shmtx_lock
(
ngx_shmtx_t
 *
mtx
)

72 
ngx_uöt_t
 
i
, 
n
;

74 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0, "shmtxÜock");

78 i‡(*
mtx
->
lock
 =0 && 
	`ngx_©omic_cmp_£t
(mtx->lock, 0, 
ngx_pid
)) {

82 i‡(
ngx_n˝u
 > 1) {

84 
n
 = 1;Ç < 
mtx
->
•ö
;Ç <<= 1) {

86 
i
 = 0; i < 
n
; i++) {

87 
	`ngx_˝u_∑u£
();

90 i‡(*
mtx
->
lock
 == 0

91 && 
	`ngx_©omic_cmp_£t
(
mtx
->
lock
, 0, 
ngx_pid
))

98 #i‡(
NGX_HAVE_POSIX_SEM
)

100 i‡(
mtx
->
£m≠h‹e
) {

101 (Ë
	`ngx_©omic_„tch_add
(
mtx
->
waô
, 1);

103 i‡(*
mtx
->
lock
 =0 && 
	`ngx_©omic_cmp_£t
(mtx->lock, 0, 
ngx_pid
)) {

107 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

108 "shmtx waô %uA", *
mtx
->
waô
);

110 
	`£m_waô
(&
mtx
->
£m
) == -1) {

111 
ngx_îr_t
 
îr
;

113 
îr
 = 
ngx_î∫o
;

115 i‡(
îr
 !
NGX_EINTR
) {

116 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
îr
,

121 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

130 
	`ngx_sched_yõld
();

132 
	}
}

136 
	$ngx_shmtx_u∆ock
(
ngx_shmtx_t
 *
mtx
)

138 i‡(
mtx
->
•ö
 !(
ngx_uöt_t
) -1) {

139 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0, "shmtx unlock");

142 i‡(
	`ngx_©omic_cmp_£t
(
mtx
->
lock
, 
ngx_pid
, 0)) {

143 
	`ngx_shmtx_wakeup
(
mtx
);

145 
	}
}

148 
ngx_uöt_t


149 
	$ngx_shmtx_f‹˚_u∆ock
(
ngx_shmtx_t
 *
mtx
, 
ngx_pid_t
 
pid
)

151 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

154 i‡(
	`ngx_©omic_cmp_£t
(
mtx
->
lock
, 
pid
, 0)) {

155 
	`ngx_shmtx_wakeup
(
mtx
);

160 
	}
}

164 
	$ngx_shmtx_wakeup
(
ngx_shmtx_t
 *
mtx
)

166 #i‡(
NGX_HAVE_POSIX_SEM
)

167 
ngx_©omic_uöt_t
 
waô
;

169 i‡(!
mtx
->
£m≠h‹e
) {

175 
waô
 = *
mtx
->wait;

177 i‡(
waô
 == 0) {

181 i‡(
	`ngx_©omic_cmp_£t
(
mtx
->
waô
, wait, wait - 1)) {

186 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
ngx_cy˛e
->
log
, 0,

187 "shmtx wakê%uA", 
waô
);

189 i‡(
	`£m_po°
(&
mtx
->
£m
) == -1) {

190 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

195 
	}
}

201 
ngx_öt_t


202 
	$ngx_shmtx_¸óã
(
ngx_shmtx_t
 *
mtx
, 
ngx_shmtx_sh_t
 *
addr
, 
u_ch¨
 *
«me
)

204 i‡(
mtx
->
«me
) {

206 i‡(
	`ngx_°rcmp
(
«me
, 
mtx
->name) == 0) {

207 
mtx
->
«me
 =Çame;

208  
NGX_OK
;

211 
	`ngx_shmtx_de°‹y
(
mtx
);

214 
mtx
->
fd
 = 
	`ngx_›í_fûe
(
«me
, 
NGX_FILE_RDWR
, 
NGX_FILE_CREATE_OR_OPEN
,

215 
NGX_FILE_DEFAULT_ACCESS
);

217 i‡(
mtx
->
fd
 =
NGX_INVALID_FILE
) {

218 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

219 
ngx_›í_fûe_n
 " \"%s\" faûed", 
«me
);

220  
NGX_ERROR
;

223 i‡(
	`ngx_dñëe_fûe
(
«me
Ë=
NGX_FILE_ERROR
) {

224 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

225 
ngx_dñëe_fûe_n
 " \"%s\" faûed", 
«me
);

228 
mtx
->
«me
 =Çame;

230  
NGX_OK
;

231 
	}
}

235 
	$ngx_shmtx_de°‹y
(
ngx_shmtx_t
 *
mtx
)

237 i‡(
	`ngx_˛o£_fûe
(
mtx
->
fd
Ë=
NGX_FILE_ERROR
) {

238 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

239 
ngx_˛o£_fûe_n
 " \"%s\" faûed", 
mtx
->
«me
);

241 
	}
}

244 
ngx_uöt_t


245 
	$ngx_shmtx_åylock
(
ngx_shmtx_t
 *
mtx
)

247 
ngx_îr_t
 
îr
;

249 
îr
 = 
	`ngx_åylock_fd
(
mtx
->
fd
);

251 i‡(
îr
 == 0) {

255 i‡(
îr
 =
NGX_EAGAIN
) {

259 #i‡
__osf__


261 i‡(
îr
 =
NGX_EACCESS
) {

267 
	`ngx_log_ab‹t
(
îr
, 
ngx_åylock_fd_n
 " %†Áûed", 
mtx
->
«me
);

270 
	}
}

274 
	$ngx_shmtx_lock
(
ngx_shmtx_t
 *
mtx
)

276 
ngx_îr_t
 
îr
;

278 
îr
 = 
	`ngx_lock_fd
(
mtx
->
fd
);

280 i‡(
îr
 == 0) {

284 
	`ngx_log_ab‹t
(
îr
, 
ngx_lock_fd_n
 " %†Áûed", 
mtx
->
«me
);

285 
	}
}

289 
	$ngx_shmtx_u∆ock
(
ngx_shmtx_t
 *
mtx
)

291 
ngx_îr_t
 
îr
;

293 
îr
 = 
	`ngx_u∆ock_fd
(
mtx
->
fd
);

295 i‡(
îr
 == 0) {

299 
	`ngx_log_ab‹t
(
îr
, 
ngx_u∆ock_fd_n
 " %†Áûed", 
mtx
->
«me
);

300 
	}
}

303 
ngx_uöt_t


304 
	$ngx_shmtx_f‹˚_u∆ock
(
ngx_shmtx_t
 *
mtx
, 
ngx_pid_t
 
pid
)

307 
	}
}

	@ngx_shmtx.h

8 #i‚de‡
_NGX_SHMTX_H_INCLUDED_


9 
	#_NGX_SHMTX_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

17 
ngx_©omic_t
 
	mlock
;

18 #i‡(
NGX_HAVE_POSIX_SEM
)

19 
ngx_©omic_t
 
	mwaô
;

21 } 
	tngx_shmtx_sh_t
;

25 #i‡(
NGX_HAVE_ATOMIC_OPS
)

26 
ngx_©omic_t
 *
	mlock
;

27 #i‡(
NGX_HAVE_POSIX_SEM
)

28 
ngx_©omic_t
 *
	mwaô
;

29 
ngx_uöt_t
 
	m£m≠h‹e
;

30 
£m_t
 
	m£m
;

33 
ngx_fd_t
 
	mfd
;

34 
u_ch¨
 *
	m«me
;

36 
ngx_uöt_t
 
	m•ö
;

37 } 
	tngx_shmtx_t
;

40 
ngx_öt_t
 
ngx_shmtx_¸óã
(
ngx_shmtx_t
 *
mtx
, 
ngx_shmtx_sh_t
 *
addr
,

41 
u_ch¨
 *
«me
);

42 
ngx_shmtx_de°‹y
(
ngx_shmtx_t
 *
mtx
);

43 
ngx_uöt_t
 
ngx_shmtx_åylock
(
ngx_shmtx_t
 *
mtx
);

44 
ngx_shmtx_lock
(
ngx_shmtx_t
 *
mtx
);

45 
ngx_shmtx_u∆ock
(
ngx_shmtx_t
 *
mtx
);

46 
ngx_uöt_t
 
ngx_shmtx_f‹˚_u∆ock
(
ngx_shmtx_t
 *
mtx
, 
ngx_pid_t
 
pid
);

	@ngx_slab.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

11 
	#NGX_SLAB_PAGE_MASK
 3

	)

12 
	#NGX_SLAB_PAGE
 0

	)

13 
	#NGX_SLAB_BIG
 1

	)

14 
	#NGX_SLAB_EXACT
 2

	)

15 
	#NGX_SLAB_SMALL
 3

	)

17 #i‡(
NGX_PTR_SIZE
 == 4)

19 
	#NGX_SLAB_PAGE_FREE
 0

	)

20 
	#NGX_SLAB_PAGE_BUSY
 0xffffffff

	)

21 
	#NGX_SLAB_PAGE_START
 0x80000000

	)

23 
	#NGX_SLAB_SHIFT_MASK
 0x0000000f

	)

24 
	#NGX_SLAB_MAP_MASK
 0xffff0000

	)

25 
	#NGX_SLAB_MAP_SHIFT
 16

	)

27 
	#NGX_SLAB_BUSY
 0xffffffff

	)

31 
	#NGX_SLAB_PAGE_FREE
 0

	)

32 
	#NGX_SLAB_PAGE_BUSY
 0xffffffffffffffff

	)

33 
	#NGX_SLAB_PAGE_START
 0x8000000000000000

	)

35 
	#NGX_SLAB_SHIFT_MASK
 0x000000000000000f

	)

36 
	#NGX_SLAB_MAP_MASK
 0xffffffff00000000

	)

37 
	#NGX_SLAB_MAP_SHIFT
 32

	)

39 
	#NGX_SLAB_BUSY
 0xffffffffffffffff

	)

44 #i‡(
NGX_DEBUG_MALLOC
)

46 
	#ngx_¶ab_junk
(
p
, 
size
Ë
	`ngx_mem£t
’, 0xA5, size)

	)

50 #i‡(
NGX_HAVE_DEBUG_MALLOC
)

52 
	#ngx_¶ab_junk
(
p
, 
size
) \

53 i‡(
ngx_debug_mÆloc
Ë
	`ngx_mem£t
(
p
, 0xA5, 
size
)

	)

57 
	#ngx_¶ab_junk
(
p
, 
size
)

	)

63 
ngx_¶ab_∑ge_t
 *
ngx_¶ab_Æloc_∑ges
(
ngx_¶ab_poﬁ_t
 *
poﬁ
,

64 
ngx_uöt_t
 
∑ges
);

65 
ngx_¶ab_‰ì_∑ges
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
ngx_¶ab_∑ge_t
 *
∑ge
,

66 
ngx_uöt_t
 
∑ges
);

67 
ngx_¶ab_îr‹
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
Àvñ
,

68 *
ãxt
);

71 
ngx_uöt_t
 
	gngx_¶ab_max_size
;

72 
ngx_uöt_t
 
	gngx_¶ab_exa˘_size
;

73 
ngx_uöt_t
 
	gngx_¶ab_exa˘_shi·
;

77 
	$ngx_¶ab_öô
(
ngx_¶ab_poﬁ_t
 *
poﬁ
)

79 
u_ch¨
 *
p
;

80 
size_t
 
size
;

81 
ngx_öt_t
 
m
;

82 
ngx_uöt_t
 
i
, 
n
, 
∑ges
;

83 
ngx_¶ab_∑ge_t
 *
¶Ÿs
;

86 i‡(
ngx_¶ab_max_size
 == 0) {

87 
ngx_¶ab_max_size
 = 
ngx_∑gesize
 / 2;

88 
ngx_¶ab_exa˘_size
 = 
ngx_∑gesize
 / (8 * (
uöçå_t
));

89 
n
 = 
ngx_¶ab_exa˘_size
;Ç >>1; 
ngx_¶ab_exa˘_shi·
++) {

95 
poﬁ
->
mö_size
 = 1 <<Öoﬁ->
mö_shi·
;

97 
p
 = (
u_ch¨
 *Ë
poﬁ
 + (
ngx_¶ab_poﬁ_t
);

98 
size
 = 
poﬁ
->
íd
 - 
p
;

100 
	`ngx_¶ab_junk
(
p
, 
size
);

102 
¶Ÿs
 = (
ngx_¶ab_∑ge_t
 *Ë
p
;

103 
n
 = 
ngx_∑gesize_shi·
 - 
poﬁ
->
mö_shi·
;

105 
i
 = 0; i < 
n
; i++) {

106 
¶Ÿs
[
i
].
¶ab
 = 0;

107 
¶Ÿs
[
i
].
√xt
 = &slots[i];

108 
¶Ÿs
[
i
].
¥ev
 = 0;

111 
p
 +
n
 * (
ngx_¶ab_∑ge_t
);

113 
∑ges
 = (
ngx_uöt_t
Ë(
size
 / (
ngx_∑gesize
 + (
ngx_¶ab_∑ge_t
)));

115 
	`ngx_memzîo
(
p
, 
∑ges
 * (
ngx_¶ab_∑ge_t
));

117 
poﬁ
->
∑ges
 = (
ngx_¶ab_∑ge_t
 *Ë
p
;

119 
poﬁ
->
‰ì
.
¥ev
 = 0;

120 
poﬁ
->
‰ì
.
√xt
 = (
ngx_¶ab_∑ge_t
 *Ë
p
;

122 
poﬁ
->
∑ges
->
¶ab
 =Öages;

123 
poﬁ
->
∑ges
->
√xt
 = &poﬁ->
‰ì
;

124 
poﬁ
->
∑ges
->
¥ev
 = (
uöçå_t
Ë&poﬁ->
‰ì
;

126 
poﬁ
->
°¨t
 = (
u_ch¨
 *)

127 
	`ngx_Æign_±r
((
uöçå_t
Ë
p
 + 
∑ges
 * (
ngx_¶ab_∑ge_t
),

128 
ngx_∑gesize
);

130 
m
 = 
∑ges
 - (
poﬁ
->
íd
 -Öoﬁ->
°¨t
Ë/ 
ngx_∑gesize
;

131 i‡(
m
 > 0) {

132 
∑ges
 -
m
;

133 
poﬁ
->
∑ges
->
¶ab
 =Öages;

136 
poﬁ
->
log_˘x
 = &poﬁ->
zîo
;

137 
poﬁ
->
zîo
 = '\0';

138 
	}
}

142 
	$ngx_¶ab_Æloc
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

144 *
p
;

146 
	`ngx_shmtx_lock
(&
poﬁ
->
muãx
);

148 
p
 = 
	`ngx_¶ab_Æloc_locked
(
poﬁ
, 
size
);

150 
	`ngx_shmtx_u∆ock
(&
poﬁ
->
muãx
);

152  
p
;

153 
	}
}

157 
	$ngx_¶ab_Æloc_locked
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
size_t
 
size
)

159 
size_t
 
s
;

160 
uöçå_t
 
p
, 
n
, 
m
, 
mask
, *
bôm≠
;

161 
ngx_uöt_t
 
i
, 
¶Ÿ
, 
shi·
, 
m≠
;

162 
ngx_¶ab_∑ge_t
 *
∑ge
, *
¥ev
, *
¶Ÿs
;

164 i‡(
size
 >
ngx_¶ab_max_size
) {

166 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cy˛e
->
log
, 0,

167 "¶abáŒoc: %uz", 
size
);

169 
∑ge
 = 
	`ngx_¶ab_Æloc_∑ges
(
poﬁ
, (
size
 + 
ngx_∑gesize
 - 1)

170 >> 
ngx_∑gesize_shi·
);

171 i‡(
∑ge
) {

172 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

173 
p
 +(
uöçå_t
Ë
poﬁ
->
°¨t
;

176 
p
 = 0;

179 
d⁄e
;

182 i‡(
size
 > 
poﬁ
->
mö_size
) {

183 
shi·
 = 1;

184 
s
 = 
size
 - 1; s >>1; 
shi·
++) { }

185 
¶Ÿ
 = 
shi·
 - 
poﬁ
->
mö_shi·
;

188 
size
 = 
poﬁ
->
mö_size
;

189 
shi·
 = 
poﬁ
->
mö_shi·
;

190 
¶Ÿ
 = 0;

193 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cy˛e
->
log
, 0,

194 "¶abáŒoc: %uz slŸ: %ui", 
size
, 
¶Ÿ
);

196 
¶Ÿs
 = (
ngx_¶ab_∑ge_t
 *Ë((
u_ch¨
 *Ë
poﬁ
 + (
ngx_¶ab_poﬁ_t
));

197 
∑ge
 = 
¶Ÿs
[
¶Ÿ
].
√xt
;

199 i‡(
∑ge
->
√xt
 !=Öage) {

201 i‡(
shi·
 < 
ngx_¶ab_exa˘_shi·
) {

204 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

205 
bôm≠
 = (
uöçå_t
 *Ë(
poﬁ
->
°¨t
 + 
p
);

207 
m≠
 = (1 << (
ngx_∑gesize_shi·
 - 
shi·
))

208 / ((
uöçå_t
) * 8);

210 
n
 = 0;Ç < 
m≠
;Ç++) {

212 i‡(
bôm≠
[
n
] !
NGX_SLAB_BUSY
) {

214 
m
 = 1, 
i
 = 0; m; m <<= 1, i++) {

215 i‡((
bôm≠
[
n
] & 
m
)) {

219 
bôm≠
[
n
] |
m
;

221 
i
 = ((
n
 * (
uöçå_t
Ë* 8Ë<< 
shi·
)

222 + (
i
 << 
shi·
);

224 i‡(
bôm≠
[
n
] =
NGX_SLAB_BUSY
) {

225 
n
 =Ç + 1;Ç < 
m≠
;Ç++) {

226 i‡(
bôm≠
[
n
] !
NGX_SLAB_BUSY
) {

227 
p
 = (
uöçå_t
Ë
bôm≠
 + 
i
;

229 
d⁄e
;

233 
¥ev
 = (
ngx_¶ab_∑ge_t
 *)

234 (
∑ge
->
¥ev
 & ~
NGX_SLAB_PAGE_MASK
);

235 
¥ev
->
√xt
 = 
∑ge
->next;

236 
∑ge
->
√xt
->
¥ev
 =Öage->prev;

238 
∑ge
->
√xt
 = 
NULL
;

239 
∑ge
->
¥ev
 = 
NGX_SLAB_SMALL
;

242 
p
 = (
uöçå_t
Ë
bôm≠
 + 
i
;

244 
d⁄e
;

249 
∑ge
 =Öage->
√xt
;

251 } 
∑ge
);

253 } i‡(
shi·
 =
ngx_¶ab_exa˘_shi·
) {

256 i‡(
∑ge
->
¶ab
 !
NGX_SLAB_BUSY
) {

258 
m
 = 1, 
i
 = 0; m; m <<= 1, i++) {

259 i‡((
∑ge
->
¶ab
 & 
m
)) {

263 
∑ge
->
¶ab
 |
m
;

265 i‡(
∑ge
->
¶ab
 =
NGX_SLAB_BUSY
) {

266 
¥ev
 = (
ngx_¶ab_∑ge_t
 *)

267 (
∑ge
->
¥ev
 & ~
NGX_SLAB_PAGE_MASK
);

268 
¥ev
->
√xt
 = 
∑ge
->next;

269 
∑ge
->
√xt
->
¥ev
 =Öage->prev;

271 
∑ge
->
√xt
 = 
NULL
;

272 
∑ge
->
¥ev
 = 
NGX_SLAB_EXACT
;

275 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

276 
p
 +
i
 << 
shi·
;

277 
p
 +(
uöçå_t
Ë
poﬁ
->
°¨t
;

279 
d⁄e
;

283 
∑ge
 =Öage->
√xt
;

285 } 
∑ge
);

289 
n
 = 
ngx_∑gesize_shi·
 - (
∑ge
->
¶ab
 & 
NGX_SLAB_SHIFT_MASK
);

290 
n
 = 1 <<Ç;

291 
n
 = ((
uöçå_t
) 1 <<Ç) - 1;

292 
mask
 = 
n
 << 
NGX_SLAB_MAP_SHIFT
;

295 i‡((
∑ge
->
¶ab
 & 
NGX_SLAB_MAP_MASK
Ë!
mask
) {

297 
m
 = (
uöçå_t
Ë1 << 
NGX_SLAB_MAP_SHIFT
, 
i
 = 0;

298 
m
 & 
mask
;

299 
m
 <<1, 
i
++)

301 i‡((
∑ge
->
¶ab
 & 
m
)) {

305 
∑ge
->
¶ab
 |
m
;

307 i‡((
∑ge
->
¶ab
 & 
NGX_SLAB_MAP_MASK
Ë=
mask
) {

308 
¥ev
 = (
ngx_¶ab_∑ge_t
 *)

309 (
∑ge
->
¥ev
 & ~
NGX_SLAB_PAGE_MASK
);

310 
¥ev
->
√xt
 = 
∑ge
->next;

311 
∑ge
->
√xt
->
¥ev
 =Öage->prev;

313 
∑ge
->
√xt
 = 
NULL
;

314 
∑ge
->
¥ev
 = 
NGX_SLAB_BIG
;

317 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

318 
p
 +
i
 << 
shi·
;

319 
p
 +(
uöçå_t
Ë
poﬁ
->
°¨t
;

321 
d⁄e
;

325 
∑ge
 =Öage->
√xt
;

327 } 
∑ge
);

331 
∑ge
 = 
	`ngx_¶ab_Æloc_∑ges
(
poﬁ
, 1);

333 i‡(
∑ge
) {

334 i‡(
shi·
 < 
ngx_¶ab_exa˘_shi·
) {

335 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

336 
bôm≠
 = (
uöçå_t
 *Ë(
poﬁ
->
°¨t
 + 
p
);

338 
s
 = 1 << 
shi·
;

339 
n
 = (1 << (
ngx_∑gesize_shi·
 - 
shi·
)Ë/ 8 / 
s
;

341 i‡(
n
 == 0) {

342 
n
 = 1;

345 
bôm≠
[0] = (2 << 
n
) - 1;

347 
m≠
 = (1 << (
ngx_∑gesize_shi·
 - 
shi·
)Ë/ ((
uöçå_t
) * 8);

349 
i
 = 1; i < 
m≠
; i++) {

350 
bôm≠
[
i
] = 0;

353 
∑ge
->
¶ab
 = 
shi·
;

354 
∑ge
->
√xt
 = &
¶Ÿs
[
¶Ÿ
];

355 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
¶Ÿs
[
¶Ÿ
] | 
NGX_SLAB_SMALL
;

357 
¶Ÿs
[
¶Ÿ
].
√xt
 = 
∑ge
;

359 
p
 = ((
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
Ë+ 
s
 * 
n
;

360 
p
 +(
uöçå_t
Ë
poﬁ
->
°¨t
;

362 
d⁄e
;

364 } i‡(
shi·
 =
ngx_¶ab_exa˘_shi·
) {

366 
∑ge
->
¶ab
 = 1;

367 
∑ge
->
√xt
 = &
¶Ÿs
[
¶Ÿ
];

368 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
¶Ÿs
[
¶Ÿ
] | 
NGX_SLAB_EXACT
;

370 
¶Ÿs
[
¶Ÿ
].
√xt
 = 
∑ge
;

372 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

373 
p
 +(
uöçå_t
Ë
poﬁ
->
°¨t
;

375 
d⁄e
;

379 
∑ge
->
¶ab
 = ((
uöçå_t
Ë1 << 
NGX_SLAB_MAP_SHIFT
Ë| 
shi·
;

380 
∑ge
->
√xt
 = &
¶Ÿs
[
¶Ÿ
];

381 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
¶Ÿs
[
¶Ÿ
] | 
NGX_SLAB_BIG
;

383 
¶Ÿs
[
¶Ÿ
].
√xt
 = 
∑ge
;

385 
p
 = (
∑ge
 - 
poﬁ
->
∑ges
Ë<< 
ngx_∑gesize_shi·
;

386 
p
 +(
uöçå_t
Ë
poﬁ
->
°¨t
;

388 
d⁄e
;

392 
p
 = 0;

394 
d⁄e
:

396 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cy˛e
->
log
, 0, "¶abáŒoc: %p", 
p
);

398  (*Ë
p
;

399 
	}
}

403 
	$ngx_¶ab_‰ì
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, *
p
)

405 
	`ngx_shmtx_lock
(&
poﬁ
->
muãx
);

407 
	`ngx_¶ab_‰ì_locked
(
poﬁ
, 
p
);

409 
	`ngx_shmtx_u∆ock
(&
poﬁ
->
muãx
);

410 
	}
}

414 
	$ngx_¶ab_‰ì_locked
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, *
p
)

416 
size_t
 
size
;

417 
uöçå_t
 
¶ab
, 
m
, *
bôm≠
;

418 
ngx_uöt_t
 
n
, 
ty≥
, 
¶Ÿ
, 
shi·
, 
m≠
;

419 
ngx_¶ab_∑ge_t
 *
¶Ÿs
, *
∑ge
;

421 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_ALLOC
, 
ngx_cy˛e
->
log
, 0, "¶ab fªe: %p", 
p
);

423 i‡((
u_ch¨
 *Ë
p
 < 
poﬁ
->
°¨t
 || (u_ch¨ *Ë∞>Öoﬁ->
íd
) {

424 
	`ngx_¶ab_îr‹
(
poﬁ
, 
NGX_LOG_ALERT
, "ngx_slab_free(): outside ofÖool");

425 
Áû
;

428 
n
 = ((
u_ch¨
 *Ë
p
 - 
poﬁ
->
°¨t
Ë>> 
ngx_∑gesize_shi·
;

429 
∑ge
 = &
poﬁ
->
∑ges
[
n
];

430 
¶ab
 = 
∑ge
->slab;

431 
ty≥
 = 
∑ge
->
¥ev
 & 
NGX_SLAB_PAGE_MASK
;

433 
ty≥
) {

435 
NGX_SLAB_SMALL
:

437 
shi·
 = 
¶ab
 & 
NGX_SLAB_SHIFT_MASK
;

438 
size
 = 1 << 
shi·
;

440 i‡((
uöçå_t
Ë
p
 & (
size
 - 1)) {

441 
wr⁄g_chunk
;

444 
n
 = ((
uöçå_t
Ë
p
 & (
ngx_∑gesize
 - 1)Ë>> 
shi·
;

445 
m
 = (
uöçå_t
Ë1 << (
n
 & ((uintptr_t) * 8 - 1));

446 
n
 /((
uöçå_t
) * 8);

447 
bôm≠
 = (
uöçå_t
 *Ë((uöçå_tË
p
 & ~(
ngx_∑gesize
 - 1));

449 i‡(
bôm≠
[
n
] & 
m
) {

451 i‡(
∑ge
->
√xt
 =
NULL
) {

452 
¶Ÿs
 = (
ngx_¶ab_∑ge_t
 *)

453 ((
u_ch¨
 *Ë
poﬁ
 + (
ngx_¶ab_poﬁ_t
));

454 
¶Ÿ
 = 
shi·
 - 
poﬁ
->
mö_shi·
;

456 
∑ge
->
√xt
 = 
¶Ÿs
[
¶Ÿ
].next;

457 
¶Ÿs
[
¶Ÿ
].
√xt
 = 
∑ge
;

459 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
¶Ÿs
[
¶Ÿ
] | 
NGX_SLAB_SMALL
;

460 
∑ge
->
√xt
->
¥ev
 = (
uöçå_t
Ë∑gê| 
NGX_SLAB_SMALL
;

463 
bôm≠
[
n
] &~
m
;

465 
n
 = (1 << (
ngx_∑gesize_shi·
 - 
shi·
)) / 8 / (1 << shift);

467 i‡(
n
 == 0) {

468 
n
 = 1;

471 i‡(
bôm≠
[0] & ~(((
uöçå_t
Ë1 << 
n
) - 1)) {

472 
d⁄e
;

475 
m≠
 = (1 << (
ngx_∑gesize_shi·
 - 
shi·
)Ë/ ((
uöçå_t
) * 8);

477 
n
 = 1;Ç < 
m≠
;Ç++) {

478 i‡(
bôm≠
[
n
]) {

479 
d⁄e
;

483 
	`ngx_¶ab_‰ì_∑ges
(
poﬁ
, 
∑ge
, 1);

485 
d⁄e
;

488 
chunk_Æªady_‰ì
;

490 
NGX_SLAB_EXACT
:

492 
m
 = (
uöçå_t
) 1 <<

493 (((
uöçå_t
Ë
p
 & (
ngx_∑gesize
 - 1)Ë>> 
ngx_¶ab_exa˘_shi·
);

494 
size
 = 
ngx_¶ab_exa˘_size
;

496 i‡((
uöçå_t
Ë
p
 & (
size
 - 1)) {

497 
wr⁄g_chunk
;

500 i‡(
¶ab
 & 
m
) {

501 i‡(
¶ab
 =
NGX_SLAB_BUSY
) {

502 
¶Ÿs
 = (
ngx_¶ab_∑ge_t
 *)

503 ((
u_ch¨
 *Ë
poﬁ
 + (
ngx_¶ab_poﬁ_t
));

504 
¶Ÿ
 = 
ngx_¶ab_exa˘_shi·
 - 
poﬁ
->
mö_shi·
;

506 
∑ge
->
√xt
 = 
¶Ÿs
[
¶Ÿ
].next;

507 
¶Ÿs
[
¶Ÿ
].
√xt
 = 
∑ge
;

509 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
¶Ÿs
[
¶Ÿ
] | 
NGX_SLAB_EXACT
;

510 
∑ge
->
√xt
->
¥ev
 = (
uöçå_t
Ë∑gê| 
NGX_SLAB_EXACT
;

513 
∑ge
->
¶ab
 &~
m
;

515 i‡(
∑ge
->
¶ab
) {

516 
d⁄e
;

519 
	`ngx_¶ab_‰ì_∑ges
(
poﬁ
, 
∑ge
, 1);

521 
d⁄e
;

524 
chunk_Æªady_‰ì
;

526 
NGX_SLAB_BIG
:

528 
shi·
 = 
¶ab
 & 
NGX_SLAB_SHIFT_MASK
;

529 
size
 = 1 << 
shi·
;

531 i‡((
uöçå_t
Ë
p
 & (
size
 - 1)) {

532 
wr⁄g_chunk
;

535 
m
 = (
uöçå_t
Ë1 << ((((uöçå_tË
p
 & (
ngx_∑gesize
 - 1)Ë>> 
shi·
)

536 + 
NGX_SLAB_MAP_SHIFT
);

538 i‡(
¶ab
 & 
m
) {

540 i‡(
∑ge
->
√xt
 =
NULL
) {

541 
¶Ÿs
 = (
ngx_¶ab_∑ge_t
 *)

542 ((
u_ch¨
 *Ë
poﬁ
 + (
ngx_¶ab_poﬁ_t
));

543 
¶Ÿ
 = 
shi·
 - 
poﬁ
->
mö_shi·
;

545 
∑ge
->
√xt
 = 
¶Ÿs
[
¶Ÿ
].next;

546 
¶Ÿs
[
¶Ÿ
].
√xt
 = 
∑ge
;

548 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
¶Ÿs
[
¶Ÿ
] | 
NGX_SLAB_BIG
;

549 
∑ge
->
√xt
->
¥ev
 = (
uöçå_t
Ë∑gê| 
NGX_SLAB_BIG
;

552 
∑ge
->
¶ab
 &~
m
;

554 i‡(
∑ge
->
¶ab
 & 
NGX_SLAB_MAP_MASK
) {

555 
d⁄e
;

558 
	`ngx_¶ab_‰ì_∑ges
(
poﬁ
, 
∑ge
, 1);

560 
d⁄e
;

563 
chunk_Æªady_‰ì
;

565 
NGX_SLAB_PAGE
:

567 i‡((
uöçå_t
Ë
p
 & (
ngx_∑gesize
 - 1)) {

568 
wr⁄g_chunk
;

571 i‡(
¶ab
 =
NGX_SLAB_PAGE_FREE
) {

572 
	`ngx_¶ab_îr‹
(
poﬁ
, 
NGX_LOG_ALERT
,

574 
Áû
;

577 i‡(
¶ab
 =
NGX_SLAB_PAGE_BUSY
) {

578 
	`ngx_¶ab_îr‹
(
poﬁ
, 
NGX_LOG_ALERT
,

580 
Áû
;

583 
n
 = ((
u_ch¨
 *Ë
p
 - 
poﬁ
->
°¨t
Ë>> 
ngx_∑gesize_shi·
;

584 
size
 = 
¶ab
 & ~
NGX_SLAB_PAGE_START
;

586 
	`ngx_¶ab_‰ì_∑ges
(
poﬁ
, &poﬁ->
∑ges
[
n
], 
size
);

588 
	`ngx_¶ab_junk
(
p
, 
size
 << 
ngx_∑gesize_shi·
);

597 
d⁄e
:

599 
	`ngx_¶ab_junk
(
p
, 
size
);

603 
wr⁄g_chunk
:

605 
	`ngx_¶ab_îr‹
(
poﬁ
, 
NGX_LOG_ALERT
,

608 
Áû
;

610 
chunk_Æªady_‰ì
:

612 
	`ngx_¶ab_îr‹
(
poﬁ
, 
NGX_LOG_ALERT
,

615 
Áû
:

618 
	}
}

621 
ngx_¶ab_∑ge_t
 *

622 
	$ngx_¶ab_Æloc_∑ges
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
∑ges
)

624 
ngx_¶ab_∑ge_t
 *
∑ge
, *
p
;

626 
∑ge
 = 
poﬁ
->
‰ì
.
√xt
;Öage != &pool->free;Öage =Öage->next) {

628 i‡(
∑ge
->
¶ab
 >
∑ges
) {

630 i‡(
∑ge
->
¶ab
 > 
∑ges
) {

631 
∑ge
[
∑ges
].
¶ab
 =Öage->slab -Öages;

632 
∑ge
[
∑ges
].
√xt
 =Öage->next;

633 
∑ge
[
∑ges
].
¥ev
 =Öage->prev;

635 
p
 = (
ngx_¶ab_∑ge_t
 *Ë
∑ge
->
¥ev
;

636 
p
->
√xt
 = &
∑ge
[
∑ges
];

637 
∑ge
->
√xt
->
¥ev
 = (
uöçå_t
Ë&∑ge[
∑ges
];

640 
p
 = (
ngx_¶ab_∑ge_t
 *Ë
∑ge
->
¥ev
;

641 
p
->
√xt
 = 
∑ge
->next;

642 
∑ge
->
√xt
->
¥ev
 =Öage->prev;

645 
∑ge
->
¶ab
 = 
∑ges
 | 
NGX_SLAB_PAGE_START
;

646 
∑ge
->
√xt
 = 
NULL
;

647 
∑ge
->
¥ev
 = 
NGX_SLAB_PAGE
;

649 i‡(--
∑ges
 == 0) {

650  
∑ge
;

653 
p
 = 
∑ge
 + 1; 
∑ges
;Öages--) {

654 
p
->
¶ab
 = 
NGX_SLAB_PAGE_BUSY
;

655 
p
->
√xt
 = 
NULL
;

656 
p
->
¥ev
 = 
NGX_SLAB_PAGE
;

657 
p
++;

660  
∑ge
;

664 
	`ngx_¶ab_îr‹
(
poﬁ
, 
NGX_LOG_CRIT
, "ngx_slab_alloc() failed:Ço memory");

666  
NULL
;

667 
	}
}

671 
	$ngx_¶ab_‰ì_∑ges
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
ngx_¶ab_∑ge_t
 *
∑ge
,

672 
ngx_uöt_t
 
∑ges
)

674 
ngx_¶ab_∑ge_t
 *
¥ev
;

676 
∑ge
->
¶ab
 = 
∑ges
--;

678 i‡(
∑ges
) {

679 
	`ngx_memzîo
(&
∑ge
[1], 
∑ges
 * (
ngx_¶ab_∑ge_t
));

682 i‡(
∑ge
->
√xt
) {

683 
¥ev
 = (
ngx_¶ab_∑ge_t
 *Ë(
∑ge
->¥ev & ~
NGX_SLAB_PAGE_MASK
);

684 
¥ev
->
√xt
 = 
∑ge
->next;

685 
∑ge
->
√xt
->
¥ev
 =Öage->prev;

688 
∑ge
->
¥ev
 = (
uöçå_t
Ë&
poﬁ
->
‰ì
;

689 
∑ge
->
√xt
 = 
poﬁ
->
‰ì
.next;

691 
∑ge
->
√xt
->
¥ev
 = (
uöçå_t
)Öage;

693 
poﬁ
->
‰ì
.
√xt
 = 
∑ge
;

694 
	}
}

698 
	$ngx_¶ab_îr‹
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 
Àvñ
, *
ãxt
)

700 
	`ngx_log_îr‹
(
Àvñ
, 
ngx_cy˛e
->
log
, 0, "%s%s", 
ãxt
, 
poﬁ
->
log_˘x
);

701 
	}
}

	@ngx_slab.h

8 #i‚de‡
_NGX_SLAB_H_INCLUDED_


9 
	#_NGX_SLAB_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

16 
ngx_¶ab_∑ge_s
 
	tngx_¶ab_∑ge_t
;

18 
	sngx_¶ab_∑ge_s
 {

19 
uöçå_t
 
	m¶ab
;

20 
ngx_¶ab_∑ge_t
 *
	m√xt
;

21 
uöçå_t
 
	m¥ev
;

26 
ngx_shmtx_sh_t
 
	mlock
;

28 
size_t
 
	mmö_size
;

29 
size_t
 
	mmö_shi·
;

31 
ngx_¶ab_∑ge_t
 *
	m∑ges
;

32 
ngx_¶ab_∑ge_t
 
	m‰ì
;

34 
u_ch¨
 *
	m°¨t
;

35 
u_ch¨
 *
	míd
;

37 
ngx_shmtx_t
 
	mmuãx
;

39 
u_ch¨
 *
	mlog_˘x
;

40 
u_ch¨
 
	mzîo
;

42 *
	md©a
;

43 *
	maddr
;

44 } 
	tngx_¶ab_poﬁ_t
;

47 
ngx_¶ab_öô
(
ngx_¶ab_poﬁ_t
 *
poﬁ
);

48 *
ngx_¶ab_Æloc
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

49 *
ngx_¶ab_Æloc_locked
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, 
size_t
 
size
);

50 
ngx_¶ab_‰ì
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, *
p
);

51 
ngx_¶ab_‰ì_locked
(
ngx_¶ab_poﬁ_t
 *
poﬁ
, *
p
);

	@ngx_spinlock.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

13 
	$ngx_•ölock
(
ngx_©omic_t
 *
lock
, 
ngx_©omic_öt_t
 
vÆue
, 
ngx_uöt_t
 
•ö
)

16 #i‡(
NGX_HAVE_ATOMIC_OPS
)

18 
ngx_uöt_t
 
i
, 
n
;

22 i‡(*
lock
 =0 && 
	`ngx_©omic_cmp_£t
÷ock, 0, 
vÆue
)) {

26 i‡(
ngx_n˝u
 > 1) {

28 
n
 = 1;Ç < 
•ö
;Ç <<= 1) {

30 
i
 = 0; i < 
n
; i++) {

31 
	`ngx_˝u_∑u£
();

34 i‡(*
lock
 =0 && 
	`ngx_©omic_cmp_£t
÷ock, 0, 
vÆue
)) {

40 
	`ngx_sched_yõld
();

45 #i‡(
NGX_THREADS
)

47 #îr‹ 
	`ngx_•ölock
(Ë
‹
 
	`ngx_©omic_cmp_£t
(Ë
¨e
 
nŸ
 
deföed
 !

53 
	}
}

	@ngx_string.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

12 
u_ch¨
 *
ngx_•rötf_num
(u_ch¨ *
buf
, u_ch¨ *
œ°
, 
uöt64_t
 
ui64
,

13 
u_ch¨
 
zîo
, 
ngx_uöt_t
 
hexadecimÆ
,Çgx_uöt_à
width
);

14 
ngx_öt_t
 
ngx_decode_ba£64_öã∫Æ
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
,

15 c⁄° 
u_ch¨
 *
basis
);

19 
	$ngx_°æow
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
n
)

21 
n
) {

22 *
d°
 = 
	`ngx_tﬁowî
(*
§c
);

23 
d°
++;

24 
§c
++;

25 
n
--;

27 
	}
}

30 
u_ch¨
 *

31 
	$ngx_˝y°∫
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
n
)

33 i‡(
n
 == 0) {

34  
d°
;

37 --
n
) {

38 *
d°
 = *
§c
;

40 i‡(*
d°
 == '\0') {

41  
d°
;

44 
d°
++;

45 
§c
++;

48 *
d°
 = '\0';

50  
d°
;

51 
	}
}

54 
u_ch¨
 *

55 
	$ngx_p°rdup
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
§c
)

57 
u_ch¨
 *
d°
;

59 
d°
 = 
	`ngx_≤Æloc
(
poﬁ
, 
§c
->
Àn
);

60 i‡(
d°
 =
NULL
) {

61  
NULL
;

64 
	`ngx_mem˝y
(
d°
, 
§c
->
d©a
, src->
Àn
);

66  
d°
;

67 
	}
}

102 
u_ch¨
 * 
ngx_cde˛


103 
	$ngx_•rötf
(
u_ch¨
 *
buf
, c⁄° *
fmt
, ...)

105 
u_ch¨
 *
p
;

106 
va_li°
 
¨gs
;

108 
	`va_°¨t
(
¨gs
, 
fmt
);

109 
p
 = 
	`ngx_v¶¥ötf
(
buf
, (*Ë-1, 
fmt
, 
¨gs
);

110 
	`va_íd
(
¨gs
);

112  
p
;

113 
	}
}

116 
u_ch¨
 * 
ngx_cde˛


117 
	$ngx_¢¥ötf
(
u_ch¨
 *
buf
, 
size_t
 
max
, c⁄° *
fmt
, ...)

119 
u_ch¨
 *
p
;

120 
va_li°
 
¨gs
;

122 
	`va_°¨t
(
¨gs
, 
fmt
);

123 
p
 = 
	`ngx_v¶¥ötf
(
buf
, bu‡+ 
max
, 
fmt
, 
¨gs
);

124 
	`va_íd
(
¨gs
);

126  
p
;

127 
	}
}

130 
u_ch¨
 * 
ngx_cde˛


131 
	$ngx_¶¥ötf
(
u_ch¨
 *
buf
, u_ch¨ *
œ°
, c⁄° *
fmt
, ...)

133 
u_ch¨
 *
p
;

134 
va_li°
 
¨gs
;

136 
	`va_°¨t
(
¨gs
, 
fmt
);

137 
p
 = 
	`ngx_v¶¥ötf
(
buf
, 
œ°
, 
fmt
, 
¨gs
);

138 
	`va_íd
(
¨gs
);

140  
p
;

141 
	}
}

144 
u_ch¨
 *

145 
	$ngx_v¶¥ötf
(
u_ch¨
 *
buf
, u_ch¨ *
œ°
, c⁄° *
fmt
, 
va_li°
 
¨gs
)

147 
u_ch¨
 *
p
, 
zîo
;

148 
d
;

149 
f
;

150 
size_t
 
Àn
, 
¶í
;

151 
öt64_t
 
i64
;

152 
uöt64_t
 
ui64
, 
‰ac
;

153 
ngx_m£c_t
 
ms
;

154 
ngx_uöt_t
 
width
, 
sign
, 
hex
, 
max_width
, 
‰ac_width
, 
sˇÀ
, 
n
;

155 
ngx_°r_t
 *
v
;

156 
ngx_v¨übÀ_vÆue_t
 *
vv
;

158 *
fmt
 && 
buf
 < 
œ°
) {

165 i‡(*
fmt
 == '%') {

167 
i64
 = 0;

168 
ui64
 = 0;

170 
zîo
 = (
u_ch¨
Ë((*++
fmt
 == '0') ? '0' : ' ');

171 
width
 = 0;

172 
sign
 = 1;

173 
hex
 = 0;

174 
max_width
 = 0;

175 
‰ac_width
 = 0;

176 
¶í
 = (
size_t
) -1;

178 *
fmt
 >= '0' && *fmt <= '9') {

179 
width
 = width * 10 + *
fmt
++ - '0';

184 *
fmt
) {

187 
sign
 = 0;

188 
fmt
++;

192 
max_width
 = 1;

193 
fmt
++;

197 
hex
 = 2;

198 
sign
 = 0;

199 
fmt
++;

203 
hex
 = 1;

204 
sign
 = 0;

205 
fmt
++;

209 
fmt
++;

211 *
fmt
 >= '0' && *fmt <= '9') {

212 
‰ac_width
 = føc_width * 10 + *
fmt
++ - '0';

218 
¶í
 = 
	`va_¨g
(
¨gs
, 
size_t
);

219 
fmt
++;

230 *
fmt
) {

233 
v
 = 
	`va_¨g
(
¨gs
, 
ngx_°r_t
 *);

235 
Àn
 = 
	`ngx_mö
(((
size_t
Ë(
œ°
 - 
buf
)), 
v
->len);

236 
buf
 = 
	`ngx_˝ymem
(buf, 
v
->
d©a
, 
Àn
);

237 
fmt
++;

242 
vv
 = 
	`va_¨g
(
¨gs
, 
ngx_v¨übÀ_vÆue_t
 *);

244 
Àn
 = 
	`ngx_mö
(((
size_t
Ë(
œ°
 - 
buf
)), 
vv
->len);

245 
buf
 = 
	`ngx_˝ymem
(buf, 
vv
->
d©a
, 
Àn
);

246 
fmt
++;

251 
p
 = 
	`va_¨g
(
¨gs
, 
u_ch¨
 *);

253 i‡(
¶í
 =(
size_t
) -1) {

254 *
p
 && 
buf
 < 
œ°
) {

255 *
buf
++ = *
p
++;

259 
Àn
 = 
	`ngx_mö
(((
size_t
Ë(
œ°
 - 
buf
)), 
¶í
);

260 
buf
 = 
	`ngx_˝ymem
(buf, 
p
, 
Àn
);

263 
fmt
++;

268 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
off_t
);

269 
sign
 = 1;

273 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
ngx_pid_t
);

274 
sign
 = 1;

278 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
time_t
);

279 
sign
 = 1;

283 
ms
 = (
ngx_m£c_t
Ë
	`va_¨g
(
¨gs
,Çgx_msec_t);

284 i‡((
ngx_m£c_öt_t
Ë
ms
 == -1) {

285 
sign
 = 1;

286 
i64
 = -1;

288 
sign
 = 0;

289 
ui64
 = (
uöt64_t
Ë
ms
;

294 i‡(
sign
) {

295 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
ssize_t
);

297 
ui64
 = (
uöt64_t
Ë
	`va_¨g
(
¨gs
, 
size_t
);

302 i‡(
sign
) {

303 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
ngx_öt_t
);

305 
ui64
 = (
uöt64_t
Ë
	`va_¨g
(
¨gs
, 
ngx_uöt_t
);

308 i‡(
max_width
) {

309 
width
 = 
NGX_INT_T_LEN
;

315 i‡(
sign
) {

316 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, );

318 
ui64
 = (
uöt64_t
Ë
	`va_¨g
(
¨gs
, 
u_öt
);

323 i‡(
sign
) {

324 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, );

326 
ui64
 = (
uöt64_t
Ë
	`va_¨g
(
¨gs
, 
u_l⁄g
);

331 i‡(
sign
) {

332 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
öt32_t
);

334 
ui64
 = (
uöt64_t
Ë
	`va_¨g
(
¨gs
, 
uöt32_t
);

339 i‡(
sign
) {

340 
i64
 = 
	`va_¨g
(
¨gs
, 
öt64_t
);

342 
ui64
 = 
	`va_¨g
(
¨gs
, 
uöt64_t
);

347 i‡(
sign
) {

348 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
ngx_©omic_öt_t
);

350 
ui64
 = (
uöt64_t
Ë
	`va_¨g
(
¨gs
, 
ngx_©omic_uöt_t
);

353 i‡(
max_width
) {

354 
width
 = 
NGX_ATOMIC_T_LEN
;

360 
f
 = 
	`va_¨g
(
¨gs
, );

362 i‡(
f
 < 0) {

363 *
buf
++ = '-';

364 
f
 = -f;

367 
ui64
 = (
öt64_t
Ë
f
;

368 
‰ac
 = 0;

370 i‡(
‰ac_width
) {

372 
sˇÀ
 = 1;

373 
n
 = 
‰ac_width
;Ç;Ç--) {

374 
sˇÀ
 *= 10;

377 
‰ac
 = (
uöt64_t
Ë((
f
 - (Ë
ui64
Ë* 
sˇÀ
 + 0.5);

379 i‡(
‰ac
 =
sˇÀ
) {

380 
ui64
++;

381 
‰ac
 = 0;

385 
buf
 = 
	`ngx_•rötf_num
(buf, 
œ°
, 
ui64
, 
zîo
, 0, 
width
);

387 i‡(
‰ac_width
) {

388 i‡(
buf
 < 
œ°
) {

389 *
buf
++ = '.';

392 
buf
 = 
	`ngx_•rötf_num
(buf, 
œ°
, 
‰ac
, '0', 0, 
‰ac_width
);

395 
fmt
++;

399 #i‡!(
NGX_WIN32
)

401 
i64
 = (
öt64_t
Ë
	`va_¨g
(
¨gs
, 
æim_t
);

402 
sign
 = 1;

407 
ui64
 = (
uöçå_t
Ë
	`va_¨g
(
¨gs
, *);

408 
hex
 = 2;

409 
sign
 = 0;

410 
zîo
 = '0';

411 
width
 = 
NGX_PTR_SIZE
 * 2;

415 
d
 = 
	`va_¨g
(
¨gs
, );

416 *
buf
++ = (
u_ch¨
Ë(
d
 & 0xff);

417 
fmt
++;

422 *
buf
++ = '\0';

423 
fmt
++;

428 #i‡(
NGX_WIN32
)

429 *
buf
++ = 
CR
;

431 *
buf
++ = 
LF
;

432 
fmt
++;

437 *
buf
++ = '%';

438 
fmt
++;

443 *
buf
++ = *
fmt
++;

448 i‡(
sign
) {

449 i‡(
i64
 < 0) {

450 *
buf
++ = '-';

451 
ui64
 = (
uöt64_t
Ë-
i64
;

454 
ui64
 = (
uöt64_t
Ë
i64
;

458 
buf
 = 
	`ngx_•rötf_num
(buf, 
œ°
, 
ui64
, 
zîo
, 
hex
, 
width
);

460 
fmt
++;

463 *
buf
++ = *
fmt
++;

467  
buf
;

468 
	}
}

471 
u_ch¨
 *

472 
	$ngx_•rötf_num
(
u_ch¨
 *
buf
, u_ch¨ *
œ°
, 
uöt64_t
 
ui64
, u_ch¨ 
zîo
,

473 
ngx_uöt_t
 
hexadecimÆ
,Çgx_uöt_à
width
)

475 
u_ch¨
 *
p
, 
ãmp
[
NGX_INT64_LEN
 + 1];

480 
size_t
 
Àn
;

481 
uöt32_t
 
ui32
;

482 
u_ch¨
 
hex
[] = "0123456789abcdef";

483 
u_ch¨
 
HEX
[] = "0123456789ABCDEF";

485 
p
 = 
ãmp
 + 
NGX_INT64_LEN
;

487 i‡(
hexadecimÆ
 == 0) {

489 i‡(
ui64
 <
NGX_MAX_UINT32_VALUE
) {

506 
ui32
 = (
uöt32_t
Ë
ui64
;

509 *--
p
 = (
u_ch¨
Ë(
ui32
 % 10 + '0');

510 } 
ui32
 /= 10);

514 *--
p
 = (
u_ch¨
Ë(
ui64
 % 10 + '0');

515 } 
ui64
 /= 10);

518 } i‡(
hexadecimÆ
 == 1) {

523 *--
p
 = 
hex
[(
uöt32_t
Ë(
ui64
 & 0xf)];

525 } 
ui64
 >>= 4);

532 *--
p
 = 
HEX
[(
uöt32_t
Ë(
ui64
 & 0xf)];

534 } 
ui64
 >>= 4);

539 
Àn
 = (
ãmp
 + 
NGX_INT64_LEN
Ë- 
p
;

541 
Àn
++ < 
width
 && 
buf
 < 
œ°
) {

542 *
buf
++ = 
zîo
;

547 
Àn
 = (
ãmp
 + 
NGX_INT64_LEN
Ë- 
p
;

549 i‡(
buf
 + 
Àn
 > 
œ°
) {

550 
Àn
 = 
œ°
 - 
buf
;

553  
	`ngx_˝ymem
(
buf
, 
p
, 
Àn
);

554 
	}
}

564 
ngx_öt_t


565 
	$ngx_°rˇ£cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
)

567 
ngx_uöt_t
 
c1
, 
c2
;

570 
c1
 = (
ngx_uöt_t
Ë*
s1
++;

571 
c2
 = (
ngx_uöt_t
Ë*
s2
++;

573 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

574 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

576 i‡(
c1
 =
c2
) {

578 i‡(
c1
) {

585  
c1
 - 
c2
;

587 
	}
}

590 
ngx_öt_t


591 
	$ngx_°∫ˇ£cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n
)

593 
ngx_uöt_t
 
c1
, 
c2
;

595 
n
) {

596 
c1
 = (
ngx_uöt_t
Ë*
s1
++;

597 
c2
 = (
ngx_uöt_t
Ë*
s2
++;

599 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

600 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

602 i‡(
c1
 =
c2
) {

604 i‡(
c1
) {

605 
n
--;

612  
c1
 - 
c2
;

616 
	}
}

619 
u_ch¨
 *

620 
	$ngx_°∫°r
(
u_ch¨
 *
s1
, *
s2
, 
size_t
 
Àn
)

622 
u_ch¨
 
c1
, 
c2
;

623 
size_t
 
n
;

625 
c2
 = *(
u_ch¨
 *Ë
s2
++;

627 
n
 = 
	`ngx_°æí
(
s2
);

631 i‡(
Àn
-- == 0) {

632  
NULL
;

635 
c1
 = *
s1
++;

637 i‡(
c1
 == 0) {

638  
NULL
;

641 } 
c1
 !
c2
);

643 i‡(
n
 > 
Àn
) {

644  
NULL
;

647 } 
	`ngx_°∫cmp
(
s1
, (
u_ch¨
 *Ë
s2
, 
n
) != 0);

649  --
s1
;

650 
	}
}

659 
u_ch¨
 *

660 
	$ngx_°r°∫
(
u_ch¨
 *
s1
, *
s2
, 
size_t
 
n
)

662 
u_ch¨
 
c1
, 
c2
;

664 
c2
 = *(
u_ch¨
 *Ë
s2
++;

668 
c1
 = *
s1
++;

670 i‡(
c1
 == 0) {

671  
NULL
;

674 } 
c1
 !
c2
);

676 } 
	`ngx_°∫cmp
(
s1
, (
u_ch¨
 *Ë
s2
, 
n
) != 0);

678  --
s1
;

679 
	}
}

682 
u_ch¨
 *

683 
	$ngx_°rˇ£°∫
(
u_ch¨
 *
s1
, *
s2
, 
size_t
 
n
)

685 
ngx_uöt_t
 
c1
, 
c2
;

687 
c2
 = (
ngx_uöt_t
Ë*
s2
++;

688 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

692 
c1
 = (
ngx_uöt_t
Ë*
s1
++;

694 i‡(
c1
 == 0) {

695  
NULL
;

698 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

700 } 
c1
 !
c2
);

702 } 
	`ngx_°∫ˇ£cmp
(
s1
, (
u_ch¨
 *Ë
s2
, 
n
) != 0);

704  --
s1
;

705 
	}
}

714 
u_ch¨
 *

715 
	$ngx_°æˇ£°∫
(
u_ch¨
 *
s1
, u_ch¨ *
œ°
, u_ch¨ *
s2
, 
size_t
 
n
)

717 
ngx_uöt_t
 
c1
, 
c2
;

719 
c2
 = (
ngx_uöt_t
Ë*
s2
++;

720 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

721 
œ°
 -
n
;

725 i‡(
s1
 >
œ°
) {

726  
NULL
;

729 
c1
 = (
ngx_uöt_t
Ë*
s1
++;

731 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

733 } 
c1
 !
c2
);

735 } 
	`ngx_°∫ˇ£cmp
(
s1
, 
s2
, 
n
) != 0);

737  --
s1
;

738 
	}
}

741 
ngx_öt_t


742 
	$ngx_r°∫cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n
)

744 i‡(
n
 == 0) {

748 
n
--;

751 i‡(
s1
[
n
] !
s2
[n]) {

752  
s1
[
n
] - 
s2
[n];

755 i‡(
n
 == 0) {

759 
n
--;

761 
	}
}

764 
ngx_öt_t


765 
	$ngx_r°∫ˇ£cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n
)

767 
u_ch¨
 
c1
, 
c2
;

769 i‡(
n
 == 0) {

773 
n
--;

776 
c1
 = 
s1
[
n
];

777 i‡(
c1
 >= 'a' && c1 <= 'z') {

778 
c1
 -= 'a' - 'A';

781 
c2
 = 
s2
[
n
];

782 i‡(
c2
 >= 'a' && c2 <= 'z') {

783 
c2
 -= 'a' - 'A';

786 i‡(
c1
 !
c2
) {

787  
c1
 - 
c2
;

790 i‡(
n
 == 0) {

794 
n
--;

796 
	}
}

799 
ngx_öt_t


800 
	$ngx_memn2cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n1
, size_à
n2
)

802 
size_t
 
n
;

803 
ngx_öt_t
 
m
, 
z
;

805 i‡(
n1
 <
n2
) {

806 
n
 = 
n1
;

807 
z
 = -1;

810 
n
 = 
n2
;

811 
z
 = 1;

814 
m
 = 
	`ngx_memcmp
(
s1
, 
s2
, 
n
);

816 i‡(
m
 || 
n1
 =
n2
) {

817  
m
;

820  
z
;

821 
	}
}

824 
ngx_öt_t


825 
	$ngx_dns_°rcmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
)

827 
ngx_uöt_t
 
c1
, 
c2
;

830 
c1
 = (
ngx_uöt_t
Ë*
s1
++;

831 
c2
 = (
ngx_uöt_t
Ë*
s2
++;

833 
c1
 = (c1 >= 'A' && c1 <= 'Z') ? (c1 | 0x20) : c1;

834 
c2
 = (c2 >= 'A' && c2 <= 'Z') ? (c2 | 0x20) : c2;

836 i‡(
c1
 =
c2
) {

838 i‡(
c1
) {

847 
c1
 = (c1 == '.') ? ' ' : c1;

848 
c2
 = (c2 == '.') ? ' ' : c2;

850  
c1
 - 
c2
;

852 
	}
}

855 
ngx_öt_t


856 
	$ngx_©oi
(
u_ch¨
 *
löe
, 
size_t
 
n
)

858 
ngx_öt_t
 
vÆue
;

860 i‡(
n
 == 0) {

861  
NGX_ERROR
;

864 
vÆue
 = 0; 
n
--; 
löe
++) {

865 i‡(*
löe
 < '0' || *line > '9') {

866  
NGX_ERROR
;

869 
vÆue
 = vÆuê* 10 + (*
löe
 - '0');

872 i‡(
vÆue
 < 0) {

873  
NGX_ERROR
;

876  
vÆue
;

878 
	}
}

883 
ngx_öt_t


884 
	$ngx_©oÂ
(
u_ch¨
 *
löe
, 
size_t
 
n
, size_à
poöt
)

886 
ngx_öt_t
 
vÆue
;

887 
ngx_uöt_t
 
dŸ
;

889 i‡(
n
 == 0) {

890  
NGX_ERROR
;

893 
dŸ
 = 0;

895 
vÆue
 = 0; 
n
--; 
löe
++) {

897 i‡(
poöt
 == 0) {

898  
NGX_ERROR
;

901 i‡(*
löe
 == '.') {

902 i‡(
dŸ
) {

903  
NGX_ERROR
;

906 
dŸ
 = 1;

910 i‡(*
löe
 < '0' || *line > '9') {

911  
NGX_ERROR
;

914 
vÆue
 = vÆuê* 10 + (*
löe
 - '0');

915 
poöt
 -
dŸ
;

918 
poöt
--) {

919 
vÆue
 = value * 10;

922 i‡(
vÆue
 < 0) {

923  
NGX_ERROR
;

926  
vÆue
;

928 
	}
}

931 
ssize_t


932 
	$ngx_©osz
(
u_ch¨
 *
löe
, 
size_t
 
n
)

934 
ssize_t
 
vÆue
;

936 i‡(
n
 == 0) {

937  
NGX_ERROR
;

940 
vÆue
 = 0; 
n
--; 
löe
++) {

941 i‡(*
löe
 < '0' || *line > '9') {

942  
NGX_ERROR
;

945 
vÆue
 = vÆuê* 10 + (*
löe
 - '0');

948 i‡(
vÆue
 < 0) {

949  
NGX_ERROR
;

952  
vÆue
;

954 
	}
}

957 
off_t


958 
	$ngx_©oof
(
u_ch¨
 *
löe
, 
size_t
 
n
)

960 
off_t
 
vÆue
;

962 i‡(
n
 == 0) {

963  
NGX_ERROR
;

966 
vÆue
 = 0; 
n
--; 
löe
++) {

967 i‡(*
löe
 < '0' || *line > '9') {

968  
NGX_ERROR
;

971 
vÆue
 = vÆuê* 10 + (*
löe
 - '0');

974 i‡(
vÆue
 < 0) {

975  
NGX_ERROR
;

978  
vÆue
;

980 
	}
}

983 
time_t


984 
	$ngx_©Ÿm
(
u_ch¨
 *
löe
, 
size_t
 
n
)

986 
time_t
 
vÆue
;

988 i‡(
n
 == 0) {

989  
NGX_ERROR
;

992 
vÆue
 = 0; 
n
--; 
löe
++) {

993 i‡(*
löe
 < '0' || *line > '9') {

994  
NGX_ERROR
;

997 
vÆue
 = vÆuê* 10 + (*
löe
 - '0');

1000 i‡(
vÆue
 < 0) {

1001  
NGX_ERROR
;

1004  
vÆue
;

1006 
	}
}

1009 
ngx_öt_t


1010 
	$ngx_hextoi
(
u_ch¨
 *
löe
, 
size_t
 
n
)

1012 
u_ch¨
 
c
, 
ch
;

1013 
ngx_öt_t
 
vÆue
;

1015 i‡(
n
 == 0) {

1016  
NGX_ERROR
;

1019 
vÆue
 = 0; 
n
--; 
löe
++) {

1020 
ch
 = *
löe
;

1022 i‡(
ch
 >= '0' && ch <= '9') {

1023 
vÆue
 = vÆuê* 16 + (
ch
 - '0');

1027 
c
 = (
u_ch¨
Ë(
ch
 | 0x20);

1029 i‡(
c
 >= 'a' && c <= 'f') {

1030 
vÆue
 = vÆuê* 16 + (
c
 - 'a' + 10);

1034  
NGX_ERROR
;

1037 i‡(
vÆue
 < 0) {

1038  
NGX_ERROR
;

1041  
vÆue
;

1043 
	}
}

1046 
u_ch¨
 *

1047 
	$ngx_hex_dump
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
Àn
)

1049 
u_ch¨
 
hex
[] = "0123456789abcdef";

1051 
Àn
--) {

1052 *
d°
++ = 
hex
[*
§c
 >> 4];

1053 *
d°
++ = 
hex
[*
§c
++ & 0xf];

1056  
d°
;

1057 
	}
}

1061 
	$ngx_ícode_ba£64
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
)

1063 
u_ch¨
 *
d
, *
s
;

1064 
size_t
 
Àn
;

1065 
u_ch¨
 
basis64
[] =

1068 
Àn
 = 
§c
->len;

1069 
s
 = 
§c
->
d©a
;

1070 
d
 = 
d°
->
d©a
;

1072 
Àn
 > 2) {

1073 *
d
++ = 
basis64
[(
s
[0] >> 2) & 0x3f];

1074 *
d
++ = 
basis64
[((
s
[0] & 3) << 4) | (s[1] >> 4)];

1075 *
d
++ = 
basis64
[((
s
[1] & 0x0f) << 2) | (s[2] >> 6)];

1076 *
d
++ = 
basis64
[
s
[2] & 0x3f];

1078 
s
 += 3;

1079 
Àn
 -= 3;

1082 i‡(
Àn
) {

1083 *
d
++ = 
basis64
[(
s
[0] >> 2) & 0x3f];

1085 i‡(
Àn
 == 1) {

1086 *
d
++ = 
basis64
[(
s
[0] & 3) << 4];

1087 *
d
++ = '=';

1090 *
d
++ = 
basis64
[((
s
[0] & 3) << 4) | (s[1] >> 4)];

1091 *
d
++ = 
basis64
[(
s
[1] & 0x0f) << 2];

1094 *
d
++ = '=';

1097 
d°
->
Àn
 = 
d
 - d°->
d©a
;

1098 
	}
}

1101 
ngx_öt_t


1102 
	$ngx_decode_ba£64
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
)

1104 
u_ch¨
 
basis64
[] = {

1124  
	`ngx_decode_ba£64_öã∫Æ
(
d°
, 
§c
, 
basis64
);

1125 
	}
}

1128 
ngx_öt_t


1129 
	$ngx_decode_ba£64uæ
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
)

1131 
u_ch¨
 
basis64
[] = {

1151  
	`ngx_decode_ba£64_öã∫Æ
(
d°
, 
§c
, 
basis64
);

1152 
	}
}

1155 
ngx_öt_t


1156 
	$ngx_decode_ba£64_öã∫Æ
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
, c⁄° 
u_ch¨
 *
basis
)

1158 
size_t
 
Àn
;

1159 
u_ch¨
 *
d
, *
s
;

1161 
Àn
 = 0;Üí < 
§c
->len;Üen++) {

1162 i‡(
§c
->
d©a
[
Àn
] == '=') {

1166 i‡(
basis
[
§c
->
d©a
[
Àn
]] == 77) {

1167  
NGX_ERROR
;

1171 i‡(
Àn
 % 4 == 1) {

1172  
NGX_ERROR
;

1175 
s
 = 
§c
->
d©a
;

1176 
d
 = 
d°
->
d©a
;

1178 
Àn
 > 3) {

1179 *
d
++ = (
u_ch¨
Ë(
basis
[
s
[0]] << 2 | basis[s[1]] >> 4);

1180 *
d
++ = (
u_ch¨
Ë(
basis
[
s
[1]] << 4 | basis[s[2]] >> 2);

1181 *
d
++ = (
u_ch¨
Ë(
basis
[
s
[2]] << 6 | basis[s[3]]);

1183 
s
 += 4;

1184 
Àn
 -= 4;

1187 i‡(
Àn
 > 1) {

1188 *
d
++ = (
u_ch¨
Ë(
basis
[
s
[0]] << 2 | basis[s[1]] >> 4);

1191 i‡(
Àn
 > 2) {

1192 *
d
++ = (
u_ch¨
Ë(
basis
[
s
[1]] << 4 | basis[s[2]] >> 2);

1195 
d°
->
Àn
 = 
d
 - d°->
d©a
;

1197  
NGX_OK
;

1198 
	}
}

1210 
uöt32_t


1211 
	$ngx_utf8_decode
(
u_ch¨
 **
p
, 
size_t
 
n
)

1213 
size_t
 
Àn
;

1214 
uöt32_t
 
u
, 
i
, 
vÆid
;

1216 
u
 = **
p
;

1218 i‡(
u
 >= 0xf0) {

1220 
u
 &= 0x07;

1221 
vÆid
 = 0xffff;

1222 
Àn
 = 3;

1224 } i‡(
u
 >= 0xe0) {

1226 
u
 &= 0x0f;

1227 
vÆid
 = 0x7ff;

1228 
Àn
 = 2;

1230 } i‡(
u
 >= 0xc2) {

1232 
u
 &= 0x1f;

1233 
vÆid
 = 0x7f;

1234 
Àn
 = 1;

1237 (*
p
)++;

1241 i‡(
n
 - 1 < 
Àn
) {

1245 (*
p
)++;

1247 
Àn
) {

1248 
i
 = *(*
p
)++;

1250 i‡(
i
 < 0x80) {

1254 
u
 = (u << 6Ë| (
i
 & 0x3f);

1256 
Àn
--;

1259 i‡(
u
 > 
vÆid
) {

1260  
u
;

1264 
	}
}

1267 
size_t


1268 
	$ngx_utf8_Àngth
(
u_ch¨
 *
p
, 
size_t
 
n
)

1270 
u_ch¨
 
c
, *
œ°
;

1271 
size_t
 
Àn
;

1273 
œ°
 = 
p
 + 
n
;

1275 
Àn
 = 0; 
p
 < 
œ°
;Üen++) {

1277 
c
 = *
p
;

1279 i‡(
c
 < 0x80) {

1280 
p
++;

1284 i‡(
	`ngx_utf8_decode
(&
p
, 
n
) > 0x10ffff) {

1286  
n
;

1290  
Àn
;

1291 
	}
}

1294 
u_ch¨
 *

1295 
	$ngx_utf8_˝y°∫
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
n
, size_à
Àn
)

1297 
u_ch¨
 
c
, *
√xt
;

1299 i‡(
n
 == 0) {

1300  
d°
;

1303 --
n
) {

1305 
c
 = *
§c
;

1306 *
d°
 = 
c
;

1308 i‡(
c
 < 0x80) {

1310 i‡(
c
 != '\0') {

1311 
d°
++;

1312 
§c
++;

1313 
Àn
--;

1318  
d°
;

1321 
√xt
 = 
§c
;

1323 i‡(
	`ngx_utf8_decode
(&
√xt
, 
Àn
) > 0x10ffff) {

1328 
§c
 < 
√xt
) {

1329 *
d°
++ = *
§c
++;

1330 
Àn
--;

1334 *
d°
 = '\0';

1336  
d°
;

1337 
	}
}

1340 
uöçå_t


1341 
	$ngx_esˇ≥_uri
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
size
, 
ngx_uöt_t
 
ty≥
)

1343 
ngx_uöt_t
 
n
;

1344 
uöt32_t
 *
esˇ≥
;

1345 
u_ch¨
 
hex
[] = "0123456789abcdef";

1349 
uöt32_t
 
uri
[] = {

1369 
uöt32_t
 
¨gs
[] = {

1389 
uöt32_t
 
uri_comp⁄ít
[] = {

1409 
uöt32_t
 
html
[] = {

1429 
uöt32_t
 
ª‰esh
[] = {

1449 
uöt32_t
 
memˇched
[] = {

1469 
uöt32_t
 *
m≠
[] =

1470 { 
uri
, 
¨gs
, 
uri_comp⁄ít
, 
html
, 
ª‰esh
, 
memˇched
, memcached };

1473 
esˇ≥
 = 
m≠
[
ty≥
];

1475 i‡(
d°
 =
NULL
) {

1479 
n
 = 0;

1481 
size
) {

1482 i‡(
esˇ≥
[*
§c
 >> 5] & (1 << (*src & 0x1f))) {

1483 
n
++;

1485 
§c
++;

1486 
size
--;

1489  (
uöçå_t
Ë
n
;

1492 
size
) {

1493 i‡(
esˇ≥
[*
§c
 >> 5] & (1 << (*src & 0x1f))) {

1494 *
d°
++ = '%';

1495 *
d°
++ = 
hex
[*
§c
 >> 4];

1496 *
d°
++ = 
hex
[*
§c
 & 0xf];

1497 
§c
++;

1500 *
d°
++ = *
§c
++;

1502 
size
--;

1505  (
uöçå_t
Ë
d°
;

1506 
	}
}

1510 
	$ngx_u√sˇ≥_uri
(
u_ch¨
 **
d°
, u_ch¨ **
§c
, 
size_t
 
size
, 
ngx_uöt_t
 
ty≥
)

1512 
u_ch¨
 *
d
, *
s
, 
ch
, 
c
, 
decoded
;

1514 
sw_usuÆ
 = 0,

1515 
sw_quŸed
,

1516 
sw_quŸed_£c⁄d


1517 } 
°©e
;

1519 
d
 = *
d°
;

1520 
s
 = *
§c
;

1522 
°©e
 = 0;

1523 
decoded
 = 0;

1525 
size
--) {

1527 
ch
 = *
s
++;

1529 
°©e
) {

1530 
sw_usuÆ
:

1531 i‡(
ch
 == '?'

1532 && (
ty≥
 & (
NGX_UNESCAPE_URI
|
NGX_UNESCAPE_REDIRECT
)))

1534 *
d
++ = 
ch
;

1535 
d⁄e
;

1538 i‡(
ch
 == '%') {

1539 
°©e
 = 
sw_quŸed
;

1543 *
d
++ = 
ch
;

1546 
sw_quŸed
:

1548 i‡(
ch
 >= '0' && ch <= '9') {

1549 
decoded
 = (
u_ch¨
Ë(
ch
 - '0');

1550 
°©e
 = 
sw_quŸed_£c⁄d
;

1554 
c
 = (
u_ch¨
Ë(
ch
 | 0x20);

1555 i‡(
c
 >= 'a' && c <= 'f') {

1556 
decoded
 = (
u_ch¨
Ë(
c
 - 'a' + 10);

1557 
°©e
 = 
sw_quŸed_£c⁄d
;

1563 
°©e
 = 
sw_usuÆ
;

1565 *
d
++ = 
ch
;

1569 
sw_quŸed_£c⁄d
:

1571 
°©e
 = 
sw_usuÆ
;

1573 i‡(
ch
 >= '0' && ch <= '9') {

1574 
ch
 = (
u_ch¨
Ë((
decoded
 << 4) + ch - '0');

1576 i‡(
ty≥
 & 
NGX_UNESCAPE_REDIRECT
) {

1577 i‡(
ch
 > '%' && ch < 0x7f) {

1578 *
d
++ = 
ch
;

1582 *
d
++ = '%'; *d++ = *(
s
 - 2); *d++ = *(s - 1);

1587 *
d
++ = 
ch
;

1592 
c
 = (
u_ch¨
Ë(
ch
 | 0x20);

1593 i‡(
c
 >= 'a' && c <= 'f') {

1594 
ch
 = (
u_ch¨
Ë((
decoded
 << 4Ë+ 
c
 - 'a' + 10);

1596 i‡(
ty≥
 & 
NGX_UNESCAPE_URI
) {

1597 i‡(
ch
 == '?') {

1598 *
d
++ = 
ch
;

1599 
d⁄e
;

1602 *
d
++ = 
ch
;

1606 i‡(
ty≥
 & 
NGX_UNESCAPE_REDIRECT
) {

1607 i‡(
ch
 == '?') {

1608 *
d
++ = 
ch
;

1609 
d⁄e
;

1612 i‡(
ch
 > '%' && ch < 0x7f) {

1613 *
d
++ = 
ch
;

1617 *
d
++ = '%'; *d++ = *(
s
 - 2); *d++ = *(s - 1);

1621 *
d
++ = 
ch
;

1632 
d⁄e
:

1634 *
d°
 = 
d
;

1635 *
§c
 = 
s
;

1636 
	}
}

1639 
uöçå_t


1640 
	$ngx_esˇ≥_html
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
size
)

1642 
u_ch¨
 
ch
;

1643 
ngx_uöt_t
 
Àn
;

1645 i‡(
d°
 =
NULL
) {

1647 
Àn
 = 0;

1649 
size
) {

1650 *
§c
++) {

1653 
Àn
 += ("&lt;") - 2;

1657 
Àn
 += ("&gt;") - 2;

1661 
Àn
 += ("&amp;") - 2;

1665 
Àn
 += ("&quot;") - 2;

1671 
size
--;

1674  (
uöçå_t
Ë
Àn
;

1677 
size
) {

1678 
ch
 = *
§c
++;

1680 
ch
) {

1683 *
d°
++ = '&'; *dst++ = 'l'; *dst++ = 't'; *dst++ = ';';

1687 *
d°
++ = '&'; *dst++ = 'g'; *dst++ = 't'; *dst++ = ';';

1691 *
d°
++ = '&'; *dst++ = 'a'; *dst++ = 'm'; *dst++ = 'p';

1692 *
d°
++ = ';';

1696 *
d°
++ = '&'; *dst++ = 'q'; *dst++ = 'u'; *dst++ = 'o';

1697 *
d°
++ = 't'; *dst++ = ';';

1701 *
d°
++ = 
ch
;

1704 
size
--;

1707  (
uöçå_t
Ë
d°
;

1708 
	}
}

1712 
	$ngx_°r_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,

1713 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
)

1715 
ngx_°r_node_t
 *
n
, *
t
;

1716 
ngx_rbåì_node_t
 **
p
;

1720 
n
 = (
ngx_°r_node_t
 *Ë
node
;

1721 
t
 = (
ngx_°r_node_t
 *Ë
ãmp
;

1723 i‡(
node
->
key
 !
ãmp
->key) {

1725 
p
 = (
node
->
key
 < 
ãmp
->keyË? &ãmp->
À·
 : &ãmp->
right
;

1727 } i‡(
n
->
°r
.
Àn
 !
t
->str.len) {

1729 
p
 = (
n
->
°r
.
Àn
 < 
t
->°r.ÀnË? &
ãmp
->
À·
 : &ãmp->
right
;

1732 
p
 = (
	`ngx_memcmp
(
n
->
°r
.
d©a
, 
t
->°r.d©a,Ç->°r.
Àn
) < 0)

1733 ? &
ãmp
->
À·
 : &ãmp->
right
;

1736 i‡(*
p
 =
£¡öñ
) {

1740 
ãmp
 = *
p
;

1743 *
p
 = 
node
;

1744 
node
->
∑ª¡
 = 
ãmp
;

1745 
node
->
À·
 = 
£¡öñ
;

1746 
node
->
right
 = 
£¡öñ
;

1747 
	`ngx_rbt_ªd
(
node
);

1748 
	}
}

1751 
ngx_°r_node_t
 *

1752 
	$ngx_°r_rbåì_lookup
(
ngx_rbåì_t
 *
rbåì
, 
ngx_°r_t
 *
vÆ
, 
uöt32_t
 
hash
)

1754 
ngx_öt_t
 
rc
;

1755 
ngx_°r_node_t
 *
n
;

1756 
ngx_rbåì_node_t
 *
node
, *
£¡öñ
;

1758 
node
 = 
rbåì
->
roŸ
;

1759 
£¡öñ
 = 
rbåì
->sentinel;

1761 
node
 !
£¡öñ
) {

1763 
n
 = (
ngx_°r_node_t
 *Ë
node
;

1765 i‡(
hash
 !
node
->
key
) {

1766 
node
 = (
hash
 <Çode->
key
Ë?Çode->
À·
 :Çode->
right
;

1770 i‡(
vÆ
->
Àn
 !
n
->
°r
.len) {

1771 
node
 = (
vÆ
->
Àn
 < 
n
->
°r
.ÀnË?Çode->
À·
 :Çode->
right
;

1775 
rc
 = 
	`ngx_memcmp
(
vÆ
->
d©a
, 
n
->
°r
.d©a, vÆ->
Àn
);

1777 i‡(
rc
 < 0) {

1778 
node
 =Çode->
À·
;

1782 i‡(
rc
 > 0) {

1783 
node
 =Çode->
right
;

1787  
n
;

1790  
NULL
;

1791 
	}
}

1797 
ngx_s‹t
(*
ba£
, 
size_t
 
n
, size_à
size
,

1798 
	$ngx_öt_t
 (*
cmp
)(const *, const *))

1800 
u_ch¨
 *
p1
, *
p2
, *
p
;

1802 
p
 = 
	`ngx_Æloc
(
size
, 
ngx_cy˛e
->
log
);

1803 i‡(
p
 =
NULL
) {

1807 
p1
 = (
u_ch¨
 *Ë
ba£
 + 
size
;

1808 
p1
 < (
u_ch¨
 *Ë
ba£
 + 
n
 * 
size
;

1809 
p1
 +
size
)

1811 
	`ngx_mem˝y
(
p
, 
p1
, 
size
);

1813 
p2
 = 
p1
;

1814 
p2
 > (
u_ch¨
 *Ë
ba£
 && 
	`cmp
’2 - 
size
, 
p
) > 0;

1815 
p2
 -
size
)

1817 
	`ngx_mem˝y
(
p2
,Ö2 - 
size
, size);

1820 
	`ngx_mem˝y
(
p2
, 
p
, 
size
);

1823 
	`ngx_‰ì
(
p
);

1824 
	}
}

1827 #i‡(
NGX_MEMCPY_LIMIT
)

1830 
	$ngx_mem˝y
(*
d°
, *
§c
, 
size_t
 
n
)

1832 i‡(
n
 > 
NGX_MEMCPY_LIMIT
) {

1833 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
ngx_cy˛e
->
log
, 0, "mem˝y %uz byãs", 
n
);

1834 
	`ngx_debug_poöt
();

1837  
	`mem˝y
(
d°
, 
§c
, 
n
);

1838 
	}
}

	@ngx_string.h

8 #i‚de‡
_NGX_STRING_H_INCLUDED_


9 
	#_NGX_STRING_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

17 
size_t
 
	mÀn
;

18 
u_ch¨
 *
	md©a
;

19 } 
	tngx_°r_t
;

23 
ngx_°r_t
 
	mkey
;

24 
ngx_°r_t
 
	mvÆue
;

25 } 
	tngx_keyvÆ_t
;

29 
	mÀn
:28;

31 
	mvÆid
:1;

32 
	mno_ˇchóbÀ
:1;

33 
	mnŸ_found
:1;

34 
	mesˇ≥
:1;

36 
u_ch¨
 *
	md©a
;

37 } 
	tngx_v¨übÀ_vÆue_t
;

40 
	#ngx_°rög
(
°r
Ë{ (°rË- 1, (
u_ch¨
 *Ë°∏}

	)

41 
	#ngx_nuŒ_°rög
 { 0, 
NULL
 }

	)

42 
	#ngx_°r_£t
(
°r
, 
ãxt
) \

43 (
°r
)->
Àn
 = (
ãxt
Ë- 1; (°r)->
d©a
 = (
u_ch¨
 *Ë
	)
text

44 
	#ngx_°r_nuŒ
(
°r
Ë(°r)->
Àn
 = 0; (°r)->
d©a
 = 
NULL


	)

47 
	#ngx_tﬁowî
(
c
Ë(
u_ch¨
Ë((¯>'A' && c <'Z'Ë? (¯| 0x20Ë: c)

	)

48 
	#ngx_touµî
(
c
Ë(
u_ch¨
Ë((¯>'a' && c <'z'Ë? (¯& ~0x20Ë: c)

	)

50 
ngx_°æow
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
n
);

53 
	#ngx_°∫cmp
(
s1
, 
s2
, 
n
Ë
	`°∫cmp
((c⁄° *Ës1, (c⁄° *Ës2,Ç)

	)

57 
	#ngx_°rcmp
(
s1
, 
s2
Ë
	`°rcmp
((c⁄° *Ës1, (c⁄° *Ës2)

	)

60 
	#ngx_°r°r
(
s1
, 
s2
Ë
	`°r°r
((c⁄° *Ës1, (c⁄° *Ës2)

	)

61 
	#ngx_°æí
(
s
Ë
	`°æí
((c⁄° *Ës)

	)

63 
	#ngx_°rchr
(
s1
, 
c
Ë
	`°rchr
((c⁄° *Ës1, (Ëc)

	)

65 
ngx_ölöe
 
u_ch¨
 *

66 
	$ngx_°æchr
(
u_ch¨
 *
p
, u_ch¨ *
œ°
, u_ch¨ 
c
)

68 
p
 < 
œ°
) {

70 i‡(*
p
 =
c
) {

71  
p
;

74 
p
++;

77  
NULL
;

78 
	}
}

86 
	#ngx_memzîo
(
buf
, 
n
Ë(Ë
	`mem£t
(buf, 0,Ç)

	)

87 
	#ngx_mem£t
(
buf
, 
c
, 
n
Ë(Ë
	`mem£t
(buf, c,Ç)

	)

90 #i‡(
NGX_MEMCPY_LIMIT
)

92 *
ngx_mem˝y
(*
d°
, *
§c
, 
size_t
 
n
);

93 
	#ngx_˝ymem
(
d°
, 
§c
, 
n
Ë(((
u_ch¨
 *Ë
	`ngx_mem˝y
(d°, src,Ç)Ë+ (n))

	)

102 
	#ngx_mem˝y
(
d°
, 
§c
, 
n
Ë(Ë
	`mem˝y
(d°, src,Ç)

	)

103 
	#ngx_˝ymem
(
d°
, 
§c
, 
n
Ë(((
u_ch¨
 *Ë
	`mem˝y
(d°, src,Ç)Ë+ (n))

	)

108 #i‡–
__INTEL_COMPILER
 >= 800 )

115 
ngx_ölöe
 
u_ch¨
 *

116 
	$ngx_c›y
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
Àn
)

118 i‡(
Àn
 < 17) {

120 
Àn
) {

121 *
d°
++ = *
§c
++;

122 
Àn
--;

125  
d°
;

128  
	`ngx_˝ymem
(
d°
, 
§c
, 
Àn
);

130 
	}
}

134 
	#ngx_c›y
 
ngx_˝ymem


	)

139 
	#ngx_memmove
(
d°
, 
§c
, 
n
Ë(Ë
	`memmove
(d°, src,Ç)

	)

140 
	#ngx_movemem
(
d°
, 
§c
, 
n
Ë(((
u_ch¨
 *Ë
	`memmove
(d°, src,Ç)Ë+ (n))

	)

144 
	#ngx_memcmp
(
s1
, 
s2
, 
n
Ë
	`memcmp
((c⁄° *Ës1, (c⁄° *Ës2,Ç)

	)

147 
u_ch¨
 *
ngx_˝y°∫
(u_ch¨ *
d°
, u_ch¨ *
§c
, 
size_t
 
n
);

148 
u_ch¨
 *
ngx_p°rdup
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
§c
);

149 
u_ch¨
 * 
ngx_cde˛
 
ngx_•rötf
(u_ch¨ *
buf
, c⁄° *
fmt
, ...);

150 
u_ch¨
 * 
ngx_cde˛
 
ngx_¢¥ötf
(u_ch¨ *
buf
, 
size_t
 
max
, c⁄° *
fmt
, ...);

151 
u_ch¨
 * 
ngx_cde˛
 
ngx_¶¥ötf
(u_ch¨ *
buf
, u_ch¨ *
œ°
, c⁄° *
fmt
,

153 
u_ch¨
 *
ngx_v¶¥ötf
(u_ch¨ *
buf
, u_ch¨ *
œ°
, c⁄° *
fmt
, 
va_li°
 
¨gs
);

154 
	#ngx_v¢¥ötf
(
buf
, 
max
, 
fmt
, 
¨gs
) \

155 
	`ngx_v¶¥ötf
(
buf
, bu‡+ (
max
), 
fmt
, 
¨gs
)

	)

157 
ngx_öt_t
 
ngx_°rˇ£cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
);

158 
ngx_öt_t
 
ngx_°∫ˇ£cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n
);

160 
u_ch¨
 *
ngx_°∫°r
(u_ch¨ *
s1
, *
s2
, 
size_t
 
n
);

162 
u_ch¨
 *
ngx_°r°∫
(u_ch¨ *
s1
, *
s2
, 
size_t
 
n
);

163 
u_ch¨
 *
ngx_°rˇ£°∫
(u_ch¨ *
s1
, *
s2
, 
size_t
 
n
);

164 
u_ch¨
 *
ngx_°æˇ£°∫
(u_ch¨ *
s1
, u_ch¨ *
œ°
, u_ch¨ *
s2
, 
size_t
 
n
);

166 
ngx_öt_t
 
ngx_r°∫cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n
);

167 
ngx_öt_t
 
ngx_r°∫ˇ£cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n
);

168 
ngx_öt_t
 
ngx_memn2cmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
, 
size_t
 
n1
, size_à
n2
);

169 
ngx_öt_t
 
ngx_dns_°rcmp
(
u_ch¨
 *
s1
, u_ch¨ *
s2
);

171 
ngx_öt_t
 
ngx_©oi
(
u_ch¨
 *
löe
, 
size_t
 
n
);

172 
ngx_öt_t
 
ngx_©oÂ
(
u_ch¨
 *
löe
, 
size_t
 
n
, size_à
poöt
);

173 
ssize_t
 
ngx_©osz
(
u_ch¨
 *
löe
, 
size_t
 
n
);

174 
off_t
 
ngx_©oof
(
u_ch¨
 *
löe
, 
size_t
 
n
);

175 
time_t
 
ngx_©Ÿm
(
u_ch¨
 *
löe
, 
size_t
 
n
);

176 
ngx_öt_t
 
ngx_hextoi
(
u_ch¨
 *
löe
, 
size_t
 
n
);

178 
u_ch¨
 *
ngx_hex_dump
(u_ch¨ *
d°
, u_ch¨ *
§c
, 
size_t
 
Àn
);

181 
	#ngx_ba£64_ícoded_Àngth
(
Àn
Ë((÷í + 2Ë/ 3Ë* 4)

	)

182 
	#ngx_ba£64_decoded_Àngth
(
Àn
Ë((÷í + 3Ë/ 4Ë* 3)

	)

184 
ngx_ícode_ba£64
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
);

185 
ngx_öt_t
 
ngx_decode_ba£64
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
);

186 
ngx_öt_t
 
ngx_decode_ba£64uæ
(
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
);

188 
uöt32_t
 
ngx_utf8_decode
(
u_ch¨
 **
p
, 
size_t
 
n
);

189 
size_t
 
ngx_utf8_Àngth
(
u_ch¨
 *
p
, size_à
n
);

190 
u_ch¨
 *
ngx_utf8_˝y°∫
(u_ch¨ *
d°
, u_ch¨ *
§c
, 
size_t
 
n
, size_à
Àn
);

193 
	#NGX_ESCAPE_URI
 0

	)

194 
	#NGX_ESCAPE_ARGS
 1

	)

195 
	#NGX_ESCAPE_URI_COMPONENT
 2

	)

196 
	#NGX_ESCAPE_HTML
 3

	)

197 
	#NGX_ESCAPE_REFRESH
 4

	)

198 
	#NGX_ESCAPE_MEMCACHED
 5

	)

199 
	#NGX_ESCAPE_MAIL_AUTH
 6

	)

201 
	#NGX_UNESCAPE_URI
 1

	)

202 
	#NGX_UNESCAPE_REDIRECT
 2

	)

204 
uöçå_t
 
ngx_esˇ≥_uri
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
size
,

205 
ngx_uöt_t
 
ty≥
);

206 
ngx_u√sˇ≥_uri
(
u_ch¨
 **
d°
, u_ch¨ **
§c
, 
size_t
 
size
, 
ngx_uöt_t
 
ty≥
);

207 
uöçå_t
 
ngx_esˇ≥_html
(
u_ch¨
 *
d°
, u_ch¨ *
§c
, 
size_t
 
size
);

211 
ngx_rbåì_node_t
 
	mnode
;

212 
ngx_°r_t
 
	m°r
;

213 } 
	tngx_°r_node_t
;

216 
ngx_°r_rbåì_ö£π_vÆue
(
ngx_rbåì_node_t
 *
ãmp
,

217 
ngx_rbåì_node_t
 *
node
,Çgx_rbåì_node_à*
£¡öñ
);

218 
ngx_°r_node_t
 *
ngx_°r_rbåì_lookup
(
ngx_rbåì_t
 *
rbåì
, 
ngx_°r_t
 *
«me
,

219 
uöt32_t
 
hash
);

222 
ngx_s‹t
(*
ba£
, 
size_t
 
n
, size_à
size
,

223 
	$ngx_öt_t
 (*
cmp
)(const *, const *));

224 
	#ngx_qs‹t
 
qs‹t


	)

227 
	#ngx_vÆue_hñ≥r
(
n
Ë#n

	)

228 
	#ngx_vÆue
(
n
Ë
	`ngx_vÆue_hñ≥r
“)

	)

	@ngx_times.c

8 
	~<ngx_c⁄fig.h
>

9 
	~<ngx_c‹e.h
>

21 
	#NGX_TIME_SLOTS
 64

	)

23 
ngx_uöt_t
 
	g¶Ÿ
;

24 
ngx_©omic_t
 
	gngx_time_lock
;

26 vﬁ©ûê
ngx_m£c_t
 
	gngx_cuºít_m£c
;

27 vﬁ©ûê
ngx_time_t
 *
	gngx_ˇched_time
;

28 vﬁ©ûê
ngx_°r_t
 
	gngx_ˇched_îr_log_time
;

29 vﬁ©ûê
ngx_°r_t
 
	gngx_ˇched_hâp_time
;

30 vﬁ©ûê
ngx_°r_t
 
	gngx_ˇched_hâp_log_time
;

31 vﬁ©ûê
ngx_°r_t
 
	gngx_ˇched_hâp_log_iso8601
;

33 #i‡!(
NGX_WIN32
)

41 
ngx_öt_t
 
	gˇched_gmtoff
;

44 
ngx_time_t
 
	gˇched_time
[
NGX_TIME_SLOTS
];

45 
u_ch¨
 
	gˇched_îr_log_time
[
NGX_TIME_SLOTS
]

47 
u_ch¨
 
	gˇched_hâp_time
[
NGX_TIME_SLOTS
]

49 
u_ch¨
 
	gˇched_hâp_log_time
[
NGX_TIME_SLOTS
]

51 
u_ch¨
 
	gˇched_hâp_log_iso8601
[
NGX_TIME_SLOTS
]

55 *
	gwìk
[] = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

56 *
	gm⁄ths
[] = { "Jan", "Feb", "Mar", "Apr", "May", "Jun",

60 
	$ngx_time_öô
()

62 
ngx_ˇched_îr_log_time
.
Àn
 = ("1970/09/28 12:00:00") - 1;

63 
ngx_ˇched_hâp_time
.
Àn
 = ("Mon, 28 Sep 1970 06:00:00 GMT") - 1;

64 
ngx_ˇched_hâp_log_time
.
Àn
 = ("28/Sep/1970:12:00:00 +0600") - 1;

65 
ngx_ˇched_hâp_log_iso8601
.
Àn
 = ("1970-09-28T12:00:00+06:00") - 1;

67 
ngx_ˇched_time
 = &
ˇched_time
[0];

69 
	`ngx_time_upd©e
();

70 
	}
}

74 
	$ngx_time_upd©e
()

76 
u_ch¨
 *
p0
, *
p1
, *
p2
, *
p3
;

77 
ngx_tm_t
 
tm
, 
gmt
;

78 
time_t
 
£c
;

79 
ngx_uöt_t
 
m£c
;

80 
ngx_time_t
 *
ç
;

81 
timevÆ
 
tv
;

83 i‡(!
	`ngx_åylock
(&
ngx_time_lock
)) {

87 
	`ngx_gëtimeofday
(&
tv
);

89 
£c
 = 
tv
.
tv_£c
;

90 
m£c
 = 
tv
.
tv_u£c
 / 1000;

92 
ngx_cuºít_m£c
 = (
ngx_m£c_t
Ë
£c
 * 1000 + 
m£c
;

94 
ç
 = &
ˇched_time
[
¶Ÿ
];

96 i‡(
ç
->
£c
 == sec) {

97 
ç
->
m£c
 = msec;

98 
	`ngx_u∆ock
(&
ngx_time_lock
);

102 i‡(
¶Ÿ
 =
NGX_TIME_SLOTS
 - 1) {

103 
¶Ÿ
 = 0;

105 
¶Ÿ
++;

108 
ç
 = &
ˇched_time
[
¶Ÿ
];

110 
ç
->
£c
 = sec;

111 
ç
->
m£c
 = msec;

113 
	`ngx_gmtime
(
£c
, &
gmt
);

116 
p0
 = &
ˇched_hâp_time
[
¶Ÿ
][0];

118 (Ë
	`ngx_•rötf
(
p0
, "%s, %02d %s %4d %02d:%02d:%02d GMT",

119 
wìk
[
gmt
.
ngx_tm_wday
], gmt.
ngx_tm_mday
,

120 
m⁄ths
[
gmt
.
ngx_tm_m⁄
 - 1], gmt.
ngx_tm_yór
,

121 
gmt
.
ngx_tm_hour
, gmt.
ngx_tm_mö
, gmt.
ngx_tm_£c
);

123 #i‡(
NGX_HAVE_GETTIMEZONE
)

125 
ç
->
gmtoff
 = 
	`ngx_gëtimez⁄e
();

126 
	`ngx_gmtime
(
£c
 + 
ç
->
gmtoff
 * 60, &
tm
);

128 #ñi‡(
NGX_HAVE_GMTOFF
)

130 
	`ngx_loˇ…ime
(
£c
, &
tm
);

131 
ˇched_gmtoff
 = (
ngx_öt_t
Ë(
tm
.
ngx_tm_gmtoff
 / 60);

132 
ç
->
gmtoff
 = 
ˇched_gmtoff
;

136 
	`ngx_loˇ…ime
(
£c
, &
tm
);

137 
ˇched_gmtoff
 = 
	`ngx_timez⁄e
(
tm
.
ngx_tm_isd°
);

138 
ç
->
gmtoff
 = 
ˇched_gmtoff
;

143 
p1
 = &
ˇched_îr_log_time
[
¶Ÿ
][0];

145 (Ë
	`ngx_•rötf
(
p1
, "%4d/%02d/%02d %02d:%02d:%02d",

146 
tm
.
ngx_tm_yór
,Åm.
ngx_tm_m⁄
,

147 
tm
.
ngx_tm_mday
,Åm.
ngx_tm_hour
,

148 
tm
.
ngx_tm_mö
,Åm.
ngx_tm_£c
);

151 
p2
 = &
ˇched_hâp_log_time
[
¶Ÿ
][0];

153 (Ë
	`ngx_•rötf
(
p2
, "%02d/%s/%d:%02d:%02d:%02d %c%02d%02d",

154 
tm
.
ngx_tm_mday
, 
m⁄ths
[tm.
ngx_tm_m⁄
 - 1],

155 
tm
.
ngx_tm_yór
,Åm.
ngx_tm_hour
,

156 
tm
.
ngx_tm_mö
,Åm.
ngx_tm_£c
,

157 
ç
->
gmtoff
 < 0 ? '-' : '+',

158 
	`ngx_abs
(
ç
->
gmtoff
 / 60),Çgx_abs(tp->gmtoff % 60));

160 
p3
 = &
ˇched_hâp_log_iso8601
[
¶Ÿ
][0];

162 (Ë
	`ngx_•rötf
(
p3
, "%4d-%02d-%02dT%02d:%02d:%02d%c%02d:%02d",

163 
tm
.
ngx_tm_yór
,Åm.
ngx_tm_m⁄
,

164 
tm
.
ngx_tm_mday
,Åm.
ngx_tm_hour
,

165 
tm
.
ngx_tm_mö
,Åm.
ngx_tm_£c
,

166 
ç
->
gmtoff
 < 0 ? '-' : '+',

167 
	`ngx_abs
(
ç
->
gmtoff
 / 60),Çgx_abs(tp->gmtoff % 60));

170 
	`ngx_mem‹y_b¨rõr
();

172 
ngx_ˇched_time
 = 
ç
;

173 
ngx_ˇched_hâp_time
.
d©a
 = 
p0
;

174 
ngx_ˇched_îr_log_time
.
d©a
 = 
p1
;

175 
ngx_ˇched_hâp_log_time
.
d©a
 = 
p2
;

176 
ngx_ˇched_hâp_log_iso8601
.
d©a
 = 
p3
;

178 
	`ngx_u∆ock
(&
ngx_time_lock
);

179 
	}
}

182 #i‡!(
NGX_WIN32
)

185 
	$ngx_time_sigß„_upd©e
()

187 
u_ch¨
 *
p
;

188 
ngx_tm_t
 
tm
;

189 
time_t
 
£c
;

190 
ngx_time_t
 *
ç
;

191 
timevÆ
 
tv
;

193 i‡(!
	`ngx_åylock
(&
ngx_time_lock
)) {

197 
	`ngx_gëtimeofday
(&
tv
);

199 
£c
 = 
tv
.
tv_£c
;

201 
ç
 = &
ˇched_time
[
¶Ÿ
];

203 i‡(
ç
->
£c
 == sec) {

204 
	`ngx_u∆ock
(&
ngx_time_lock
);

208 i‡(
¶Ÿ
 =
NGX_TIME_SLOTS
 - 1) {

209 
¶Ÿ
 = 0;

211 
¶Ÿ
++;

214 
	`ngx_gmtime
(
£c
 + 
ˇched_gmtoff
 * 60, &
tm
);

216 
p
 = &
ˇched_îr_log_time
[
¶Ÿ
][0];

218 (Ë
	`ngx_•rötf
(
p
, "%4d/%02d/%02d %02d:%02d:%02d",

219 
tm
.
ngx_tm_yór
,Åm.
ngx_tm_m⁄
,

220 
tm
.
ngx_tm_mday
,Åm.
ngx_tm_hour
,

221 
tm
.
ngx_tm_mö
,Åm.
ngx_tm_£c
);

223 
	`ngx_mem‹y_b¨rõr
();

225 
ngx_ˇched_îr_log_time
.
d©a
 = 
p
;

227 
	`ngx_u∆ock
(&
ngx_time_lock
);

228 
	}
}

233 
u_ch¨
 *

234 
	$ngx_hâp_time
(
u_ch¨
 *
buf
, 
time_t
 
t
)

236 
ngx_tm_t
 
tm
;

238 
	`ngx_gmtime
(
t
, &
tm
);

240  
	`ngx_•rötf
(
buf
, "%s, %02d %s %4d %02d:%02d:%02d GMT",

241 
wìk
[
tm
.
ngx_tm_wday
],

242 
tm
.
ngx_tm_mday
,

243 
m⁄ths
[
tm
.
ngx_tm_m⁄
 - 1],

244 
tm
.
ngx_tm_yór
,

245 
tm
.
ngx_tm_hour
,

246 
tm
.
ngx_tm_mö
,

247 
tm
.
ngx_tm_£c
);

248 
	}
}

251 
u_ch¨
 *

252 
	$ngx_hâp_cookõ_time
(
u_ch¨
 *
buf
, 
time_t
 
t
)

254 
ngx_tm_t
 
tm
;

256 
	`ngx_gmtime
(
t
, &
tm
);

263  
	`ngx_•rötf
(
buf
,

264 (
tm
.
ngx_tm_yór
 > 2037) ?

267 
wìk
[
tm
.
ngx_tm_wday
],

268 
tm
.
ngx_tm_mday
,

269 
m⁄ths
[
tm
.
ngx_tm_m⁄
 - 1],

270 (
tm
.
ngx_tm_yór
 > 2037) ?Åm.ngx_tm_year:

271 
tm
.
ngx_tm_yór
 % 100,

272 
tm
.
ngx_tm_hour
,

273 
tm
.
ngx_tm_mö
,

274 
tm
.
ngx_tm_£c
);

275 
	}
}

279 
	$ngx_gmtime
(
time_t
 
t
, 
ngx_tm_t
 *
ç
)

281 
ngx_öt_t
 
yday
;

282 
ngx_uöt_t
 
n
, 
£c
, 
mö
, 
hour
, 
mday
, 
m⁄
, 
yór
, 
wday
, 
days
, 
À≠
;

286 
n
 = (
ngx_uöt_t
Ë
t
;

288 
days
 = 
n
 / 86400;

292 
wday
 = (4 + 
days
) % 7;

294 
n
 %= 86400;

295 
hour
 = 
n
 / 3600;

296 
n
 %= 3600;

297 
mö
 = 
n
 / 60;

298 
£c
 = 
n
 % 60;

306 
days
 = days - (31 + 28) + 719527;

315 
yór
 = (
days
 + 2) * 400 / (365 * 400 + 100 - 4 + 1);

317 
yday
 = 
days
 - (365 * 
yór
 + year / 4 - year / 100 + year / 400);

319 i‡(
yday
 < 0) {

320 
À≠
 = (
yór
 % 4 == 0) && (year % 100 || (year % 400 == 0));

321 
yday
 = 365 + 
À≠
 + yday;

322 
yór
--;

333 
m⁄
 = (
yday
 + 31) * 10 / 306;

337 
mday
 = 
yday
 - (367 * 
m⁄
 / 12 - 30) + 1;

339 i‡(
yday
 >= 306) {

341 
yór
++;

342 
m⁄
 -= 10;

352 
m⁄
 += 2;

361 
ç
->
ngx_tm_£c
 = (
ngx_tm_£c_t
Ë
£c
;

362 
ç
->
ngx_tm_mö
 = (
ngx_tm_mö_t
Ë
mö
;

363 
ç
->
ngx_tm_hour
 = (
ngx_tm_hour_t
Ë
hour
;

364 
ç
->
ngx_tm_mday
 = (
ngx_tm_mday_t
Ë
mday
;

365 
ç
->
ngx_tm_m⁄
 = (
ngx_tm_m⁄_t
Ë
m⁄
;

366 
ç
->
ngx_tm_yór
 = (
ngx_tm_yór_t
Ë
yór
;

367 
ç
->
ngx_tm_wday
 = (
ngx_tm_wday_t
Ë
wday
;

368 
	}
}

371 
time_t


372 
	$ngx_√xt_time
(
time_t
 
whí
)

374 
time_t
 
now
, 
√xt
;

375 
tm
Åm;

377 
now
 = 
	`ngx_time
();

379 
	`ngx_libc_loˇ…ime
(
now
, &
tm
);

381 
tm
.
tm_hour
 = (Ë(
whí
 / 3600);

382 
whí
 %= 3600;

383 
tm
.
tm_mö
 = (Ë(
whí
 / 60);

384 
tm
.
tm_£c
 = (Ë(
whí
 % 60);

386 
√xt
 = 
	`mktime
(&
tm
);

388 i‡(
√xt
 == -1) {

392 i‡(
√xt
 - 
now
 > 0) {

393  
√xt
;

396 
tm
.
tm_mday
++;

400 
√xt
 = 
	`mktime
(&
tm
);

402 i‡(
√xt
 != -1) {

403  
√xt
;

407 
	}
}

	@ngx_times.h

8 #i‚de‡
_NGX_TIMES_H_INCLUDED_


9 
	#_NGX_TIMES_H_INCLUDED_


	)

12 
	~<ngx_c⁄fig.h
>

13 
	~<ngx_c‹e.h
>

17 
time_t
 
	m£c
;

18 
ngx_uöt_t
 
	mm£c
;

19 
ngx_öt_t
 
	mgmtoff
;

20 } 
	tngx_time_t
;

23 
ngx_time_öô
();

24 
ngx_time_upd©e
();

25 
ngx_time_sigß„_upd©e
();

26 
u_ch¨
 *
ngx_hâp_time
(u_ch¨ *
buf
, 
time_t
 
t
);

27 
u_ch¨
 *
ngx_hâp_cookõ_time
(u_ch¨ *
buf
, 
time_t
 
t
);

28 
ngx_gmtime
(
time_t
 
t
, 
ngx_tm_t
 *
ç
);

30 
time_t
 
ngx_√xt_time
—ime_à
whí
);

31 
	#ngx_√xt_time_n
 "mktime()"

	)

34 vﬁ©ûê
ngx_time_t
 *
ngx_ˇched_time
;

36 
	#ngx_time
(Ë
ngx_ˇched_time
->
£c


	)

37 
	#ngx_timeofday
(Ë(
ngx_time_t
 *Ë
ngx_ˇched_time


	)

39 vﬁ©ûê
ngx_°r_t
 
ngx_ˇched_îr_log_time
;

40 vﬁ©ûê
ngx_°r_t
 
ngx_ˇched_hâp_time
;

41 vﬁ©ûê
ngx_°r_t
 
ngx_ˇched_hâp_log_time
;

42 vﬁ©ûê
ngx_°r_t
 
ngx_ˇched_hâp_log_iso8601
;

48 vﬁ©ûê
ngx_m£c_t
 
ngx_cuºít_m£c
;

	@
1
.
1
/usr/include
61
781
nginx.c
nginx.h
ngx_array.c
ngx_array.h
ngx_buf.c
ngx_buf.h
ngx_conf_file.c
ngx_conf_file.h
ngx_config.h
ngx_connection.c
ngx_connection.h
ngx_core.h
ngx_cpuinfo.c
ngx_crc.h
ngx_crc32.c
ngx_crc32.h
ngx_crypt.c
ngx_crypt.h
ngx_cycle.c
ngx_cycle.h
ngx_file.c
ngx_file.h
ngx_hash.c
ngx_hash.h
ngx_inet.c
ngx_inet.h
ngx_list.c
ngx_list.h
ngx_log.c
ngx_log.h
ngx_md5.c
ngx_md5.h
ngx_murmurhash.c
ngx_murmurhash.h
ngx_open_file_cache.c
ngx_open_file_cache.h
ngx_output_chain.c
ngx_palloc.c
ngx_palloc.h
ngx_parse.c
ngx_parse.h
ngx_queue.c
ngx_queue.h
ngx_radix_tree.c
ngx_radix_tree.h
ngx_rbtree.c
ngx_rbtree.h
ngx_regex.c
ngx_regex.h
ngx_resolver.c
ngx_resolver.h
ngx_sha1.h
ngx_shmtx.c
ngx_shmtx.h
ngx_slab.c
ngx_slab.h
ngx_spinlock.c
ngx_string.c
ngx_string.h
ngx_times.c
ngx_times.h
